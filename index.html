<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Store Master v30 - Auto Scan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  /* --- DESIGN SYSTEM --- */
  :root {
    --primary: #0055AA; --accent: #E2001A; --success: #10b981; --warning: #f59e0b;
    --bg: #F4F6F9; --surface: #ffffff; --text: #1e293b; --radius: 16px;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, -apple-system, sans-serif; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* HEADER */
  header {
    background: var(--surface); padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
    display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.05); z-index: 50;
  }
  .brand { font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

  /* TABS */
  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
  .tab { flex: 1; text-align: center; padding: 12px; font-weight: 700; font-size: 13px; color: #64748b; border-radius: 10px; cursor: pointer; transition: 0.2s; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* MAIN */
  main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
  .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
  
  /* SCANNER VIDEO ZONE */
  #scanner-container { 
    width: 100%; height: 250px; background: black; border-radius: 12px; margin-bottom: 15px; 
    overflow: hidden; position: relative; display: none; 
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  .scan-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px solid var(--accent); opacity: 0.5; pointer-events: none; }
  .scan-btn { width: 100%; padding: 20px; background: var(--primary); color: white; font-weight: bold; font-size: 18px; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
  .scan-btn.active { background: var(--accent); }

  /* INPUTS */
  .input-group { margin-bottom: 12px; }
  .input-group label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; outline: none; }
  input:focus { border-color: var(--primary); background: #f8fafc; }
  
  /* LISTE DLC */
  .dlc-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border-radius: 12px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .dlc-red { border-left-color: var(--accent); background: #FEF2F2; }
  .dlc-orange { border-left-color: var(--warning); background: #FFF7ED; }
  .dlc-green { border-left-color: var(--success); }
  .dlc-img { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #eee; margin-right: 12px; }
  .dlc-info { flex: 1; }
  .dlc-qty { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 5px; }
  
  /* NAV & UTILS */
  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; }
  .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; cursor: pointer; }
  .nav-btn.active { color: var(--primary); } .nav-btn i { font-size: 24px; margin-bottom: 4px; }
  
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; }
  .hidden { display: none !important; }
  .overlay { position: fixed; inset: 0; background: var(--primary); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
</style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <h1 style="color: white; margin-bottom: 20px;">Store Master v30</h1>
    <input type="password" id="login-pass" placeholder="Code (2008)" style="text-align: center; margin-bottom: 20px; max-width: 200px;">
    <button class="btn" style="background: white; color: var(--primary); max-width: 200px;" onclick="window.app.login()">Connexion</button>
  </div>

  <header>
    <div class="brand">STORE MASTER</div>
    <div style="font-size:12px; font-weight:bold; color:var(--success);">CLOUD OK</div>
  </header>

  <main>
    <div id="view-home">
      <div class="card" onclick="window.app.nav('frais')" style="text-align:center; cursor:pointer; padding:30px;">
        <i class="fas fa-barcode" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
        <h3 style="margin:0;">SCANNER DLC</h3>
        <p style="color:#64748b; font-size:13px;">Auto-Scan Caméra</p>
      </div>
      <div class="card" onclick="window.app.exportCSV()" style="text-align:center; cursor:pointer;">
        <i class="fas fa-file-csv" style="font-size:30px; color:#64748b; margin-bottom:10px;"></i>
        <h4 style="margin:0;">Rapport</h4>
      </div>
    </div>

    <div id="view-frais" class="hidden">
      <div class="tabs">
        <div id="tab-scan" class="tab active" onclick="window.app.switchTab('scan')">SCANNER</div>
        <div id="tab-list" class="tab" onclick="window.app.switchTab('list')">LISTE</div>
      </div>

      <div id="content-scan">
        <div id="scanner-container">
            <video id="video"></video>
            <div class="scan-overlay"></div>
        </div>

        <button id="btn-scan-toggle" class="scan-btn" onclick="window.app.toggleScanner()">
            <i class="fas fa-camera"></i> LANCER SCAN
        </button>

        <div class="card">
          <div class="input-group">
            <label>EAN (Code Barre)</label>
            <input type="number" id="frais-ean" placeholder="Scanner ou taper..." oninput="if(this.value.length>=8) window.app.scanApi(this.value)">
          </div>
          
          <div id="frais-img-box" style="display:none; text-align:center; margin-bottom:10px;">
            <img id="frais-img" style="height:100px; border-radius:10px; object-fit:contain; border:1px solid #eee;">
          </div>

          <div class="input-group">
            <label>Nom du Produit</label>
            <input type="text" id="frais-name" placeholder="Remplissage auto...">
          </div>

          <div style="display: flex; gap: 10px;">
             <div class="input-group" style="flex:2;">
               <label>Date Limite (DLC)</label>
               <input type="date" id="frais-date">
             </div>
             <div class="input-group" style="flex:1;">
               <label>Quantité</label>
               <input type="number" id="frais-qty" value="1" style="text-align:center;">
             </div>
          </div>

          <button class="btn" onclick="window.app.addFrais()">VALIDER</button>
        </div>
      </div>

      <div id="content-list" class="hidden">
        <div style="text-align:center; font-size:12px; margin-bottom:10px; color:#666;">
          <span style="color:var(--accent)">● J-0/Périmé</span> &nbsp; 
          <span style="color:var(--warning)">● J+1</span> &nbsp; 
          <span style="color:var(--success)">● OK</span>
        </div>
        <div id="list-frais-container"></div>
      </div>
    </div>
  </main>

  <nav>
    <div class="nav-btn" onclick="window.app.nav('home')"><i class="fas fa-th-large"></i>Menu</div>
    <div class="nav-btn" onclick="window.app.nav('frais'); window.app.switchTab('scan')"><i class="fas fa-plus-circle"></i>Scan</div>
    <div class="nav-btn" onclick="window.app.nav('frais'); window.app.switchTab('list')"><i class="fas fa-list"></i>Stock</div>
  </nav>

  <audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA", authDomain: "araujo-exploitation.firebaseapp.com", databaseURL: "https://araujo-exploitation-default-rtdb.europe-west1.firebasedatabase.app", projectId: "araujo-exploitation", storageBucket: "araujo-exploitation.firebasestorage.app", messagingSenderId: "292878114487", appId: "1:292878114487:web:2a450227310e970ce1b732" };
  
  const db = getFirestore(initializeApp(firebaseConfig));
  const docRef = doc(db, "store_master", "v30");
  const codeReader = new ZXing.BrowserMultiFormatReader();

  window.app = {
    data: { frais: [] },
    scanning: false,
    
    init: function() {
      onSnapshot(docRef, (s) => {
        if(s.exists()) { this.data = {...this.data, ...s.data()}; this.renderList(); }
      });
    },

    save: async function() { await setDoc(docRef, this.data, {merge:true}); this.renderList(); },

    login: function() {
      if(document.getElementById('login-pass').value === "2008") {
        document.getElementById('login-overlay').classList.add('hidden');
        this.init();
      } else alert("Code erreur");
    },

    nav: function(v) {
      document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
      document.getElementById('view-'+v).classList.remove('hidden');
      if(this.scanning) this.stopScanner(); // Stop caméra si on change de page
    },

    switchTab: function(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      document.getElementById('content-scan').classList.add('hidden');
      document.getElementById('content-list').classList.add('hidden');
      document.getElementById('content-'+t).classList.remove('hidden');
      if(t === 'list') this.stopScanner();
    },

    // SCANNER CAMERA LOGIC
    toggleScanner: function() {
        if(this.scanning) {
            this.stopScanner();
        } else {
            this.startScanner();
        }
    },

    startScanner: function() {
        this.scanning = true;
        document.getElementById('scanner-container').style.display = "block";
        document.getElementById('btn-scan-toggle').innerHTML = "<i class='fas fa-stop'></i> STOP SCAN";
        document.getElementById('btn-scan-toggle').classList.add('active');
        
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                // CODE TROUVÉ !
                document.getElementById('beep').play();
                if(navigator.vibrate) navigator.vibrate(200);
                
                // Remplir champs
                document.getElementById('frais-ean').value = result.text;
                this.scanApi(result.text); // Chercher infos
                
                this.stopScanner(); // Fermer caméra après scan réussi
            }
        });
    },

    stopScanner: function() {
        this.scanning = false;
        codeReader.reset();
        document.getElementById('scanner-container').style.display = "none";
        document.getElementById('btn-scan-toggle').innerHTML = "<i class='fas fa-camera'></i> LANCER SCAN";
        document.getElementById('btn-scan-toggle').classList.remove('active');
    },

    // OPEN FOOD FACTS API
    scanApi: async function(ean) {
      try {
        let r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
        let d = await r.json();
        if(d.status === 1) {
          document.getElementById('frais-name').value = d.product.product_name_fr || d.product.product_name;
          let img = d.product.image_small_url;
          if(img) {
             document.getElementById('frais-img').src = img;
             document.getElementById('frais-img-box').style.display = 'block';
          }
        }
      } catch(e){}
    },

    addFrais: function() {
      let ean = document.getElementById('frais-ean').value;
      let name = document.getElementById('frais-name').value;
      let date = document.getElementById('frais-date').value;
      let qty = document.getElementById('frais-qty').value;
      let img = document.getElementById('frais-img').src;
      
      if(!name || !date) return alert("Nom et Date requis !");
      
      this.data.frais.push({
        id: Date.now(), ean, name, date, qty,
        img: img.includes('http') ? img : null
      });
      this.save();
      
      // Reset
      document.getElementById('frais-name').value = "";
      document.getElementById('frais-ean').value = "";
      document.getElementById('frais-qty').value = "1";
      document.getElementById('frais-img-box').style.display = 'none';
      alert("Produit ajouté !");
    },

    delItem: function(id) {
      if(confirm("Supprimer ?")) {
        this.data.frais = this.data.frais.filter(x => x.id !== id);
        this.save();
      }
    },

    renderList: function() {
      let today = new Date().toISOString().split('T')[0];
      
      let html = this.data.frais.sort((a,b) => a.date.localeCompare(b.date)).map(i => {
        let diff = (new Date(i.date) - new Date(today)) / (86400000);
        let cls = 'dlc-green';
        let txt = i.date;

        if (diff < 1) { cls = 'dlc-red'; txt = "AUJOURD'HUI"; } 
        else if (diff < 2) { cls = 'dlc-orange'; txt = "DEMAIN"; }

        return `
          <div class="dlc-item ${cls}">
            <img src="${i.img || 'https://via.placeholder.com/50'}" class="dlc-img">
            <div class="dlc-info">
              <div style="font-weight:bold;">${i.name}</div>
              <div style="font-size:13px; color:#555;">${txt} (${new Date(i.date).toLocaleDateString()}) <span class="dlc-qty">x${i.qty}</span></div>
            </div>
            <button onclick="window.app.delItem(${i.id})" style="background:none; border:none; color:#ccc; padding:10px;"><i class="fas fa-trash"></i></button>
          </div>
        `;
      }).join('');
      
      document.getElementById('list-frais-container').innerHTML = html || "<div style='text-align:center; padding:20px; color:#aaa'>Liste vide</div>";
    },

    exportCSV: function() {
      let csv = "Date;Nom;DLC;Quantite\n";
      this.data.frais.forEach(i => csv += `${new Date().toLocaleDateString()};${i.name};${i.date};${i.qty}\n`);
      let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'DLC_Stock.csv'; a.click();
    }
  };
</script>
</body>
</html>
