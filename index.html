<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Store Master v25</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
--bg:#f1f5f9;
--blue:#2563eb;
--red:#ef4444;
--green:#10b981;
--orange:#f97316;
--radius:16px;
}
body{margin:0;background:#cbd5e1;font-family:system-ui;display:flex;justify-content:center;}
#app{max-width:600px;width:100%;background:var(--bg);min-height:100vh;padding-bottom:80px;}
header{background:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
.card{background:white;margin:16px;border-radius:var(--radius);padding:16px;box-shadow:0 3px 8px rgba(0,0,0,.05);}
input{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:1px solid #ddd;font-size:16px;}
button{cursor:pointer}
.btn{width:100%;padding:14px;border:none;border-radius:12px;background:var(--blue);color:white;font-weight:800;margin-top:6px;}
.btn-small{padding:6px 10px;border:none;border-radius:8px;background:#e5e7eb;font-weight:900;}
video{width:100%;height:160px;background:black;border-radius:12px;display:none;}
.list-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee;}
.item-img{width:55px;height:55px;border-radius:8px;object-fit:contain;background:#f8fafc;border:1px solid #eee;margin-right:10px;}
.status-red{color:var(--red);font-weight:900;}
.status-orange{color:var(--orange);font-weight:700;}
</style>
</head>
<body>

<div id="app">

<header>
<b style="color:var(--blue)">CARREFOUR</b>
<div>Périmés : <b id="kpi" style="color:var(--red)">0</b></div>
</header>

<div class="card">
<h3>Nouveau Produit</h3>

<video id="video" playsinline></video>

<button class="btn" onclick="startScan()">
<i class="fas fa-camera"></i> Scanner EAN
</button>

<button class="btn" style="background:var(--red)" onclick="stopScan()">
Stop
</button>

<input type="number" id="ean" placeholder="EAN...">
<img id="imgPreview" style="width:80px;height:80px;object-fit:contain;display:none;margin:auto"/>

<input type="text" id="name" placeholder="Nom produit">
<div style="display:flex;gap:10px;">
<input type="date" id="date" style="flex:1;">
<input type="number" id="qty" value="1" min="1" style="width:100px;">
</div>

<button class="btn" onclick="addItem()">ENREGISTRER</button>
</div>

<div class="card">
<h3>Produits en rayon</h3>
<div id="list"></div>
</div>

</div>

<script>
let db = JSON.parse(localStorage.getItem("store_master")) || {frais:[]};
let currentImg="";
let reader=null;
let scanning=false;

function save(){
localStorage.setItem("store_master",JSON.stringify(db));
updateKPI();
}

function updateKPI(){
let today=new Date();
today.setHours(0,0,0,0);
let count=db.frais.filter(i=>new Date(i.date)<=today).length;
document.getElementById("kpi").innerText=count;
}

function startScan(){
if(scanning)return;
scanning=true;
document.getElementById("video").style.display="block";
reader=new ZXing.BrowserMultiFormatReader();
reader.decodeFromVideoDevice(null,"video",(result)=>{
if(result){
document.getElementById("ean").value=result.text;
if(navigator.vibrate)navigator.vibrate(100);
apiScan(result.text);
stopScan();
}
});
}

function stopScan(){
if(reader)reader.reset();
reader=null;
scanning=false;
document.getElementById("video").style.display="none";
}

async function apiScan(ean){
try{
let res=await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
let data=await res.json();
if(data.status===1){
document.getElementById("name").value=data.product.product_name_fr||data.product.product_name||"";
currentImg=data.product.image_small_url||data.product.image_url||"";
if(currentImg){
let img=document.getElementById("imgPreview");
img.src=currentImg;
img.style.display="block";
}
}
}catch(e){console.log(e);}
}

function addItem(){
let ean=document.getElementById("ean").value.trim();
let name=document.getElementById("name").value.trim();
let date=document.getElementById("date").value;
let qty=parseInt(document.getElementById("qty").value||1);

if(!name||!date)return alert("Nom et date obligatoires");

let existing=db.frais.find(i=>i.ean===ean && i.date===date);
if(existing){
existing.qty+=qty;
}else{
db.frais.push({
id:Date.now(),
ean,
name,
date,
qty,
img:currentImg
});
}

save();
render();

document.getElementById("ean").value="";
document.getElementById("name").value="";
document.getElementById("qty").value=1;
document.getElementById("imgPreview").style.display="none";
currentImg="";
}

function changeQty(id,delta){
let item=db.frais.find(i=>i.id===id);
if(!item)return;
item.qty=Math.max(1,item.qty+delta);
save();
render();
}

function deleteItem(id){
db.frais=db.frais.filter(i=>i.id!==id);
save();
render();
}

function render(){
let list=document.getElementById("list");
let today=new Date();
today.setHours(0,0,0,0);

db.frais.sort((a,b)=>new Date(a.date)-new Date(b.date));

list.innerHTML=db.frais.map(i=>{
let diff=(new Date(i.date)-today)/86400000;
let status=diff<=0?"status-red":(diff<=2?"status-orange":"");
return `
<div class="list-row">
<div style="display:flex;align-items:center;">
<img src="${i.img||'https://via.placeholder.com/55'}" class="item-img">
<div>
<b>${i.name}</b><br>
<small>EAN: ${i.ean||"-"} • Qté: <b>${i.qty}</b></small><br>
<small class="${status}">DLC: ${i.date}</small>
<div style="margin-top:4px;">
<button class="btn-small" onclick="changeQty(${i.id},-1)">−</button>
<button class="btn-small" onclick="changeQty(${i.id},1)">+</button>
<button class="btn-small" style="background:var(--red);color:white" onclick="deleteItem(${i.id})">X</button>
</div>
</div>
</div>
</div>
`;
}).join("");

updateKPI();
}

document.getElementById("date").valueAsDate=new Date();
render();
</script>

</body>
</html>
