<script type="module">
  // 1. IMPORTATION DES OUTILS FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2. TA CONFIGURATION (Celle que tu as envoyÃ©e)
  const firebaseConfig = {
    apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
    authDomain: "araujo-exploitation.firebaseapp.com",
    databaseURL: "https://araujo-exploitation-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "araujo-exploitation",
    storageBucket: "araujo-exploitation.firebasestorage.app",
    messagingSenderId: "292878114487",
    appId: "1:292878114487:web:2a450227310e970ce1b732"
  };

  // 3. DÃ‰MARRAGE DE LA BASE DE DONNÃ‰ES
  const appFirebase = initializeApp(firebaseConfig);
  const dbFirestore = getFirestore(appFirebase);
  
  // On pointe vers le dossier de sauvegarde "v26"
  const docRef = doc(dbFirestore, "store_master", "v26");

  // --- FONCTIONS GLOBALES (Accessibles par les boutons HTML) ---
  
  // Variable locale pour stocker les donnÃ©es
  window.db = { history: [] };
  window.currentUser = "";

  // FONCTION 1 : Connexion
  window.login = function() {
    const name = document.getElementById('user-name').value;
    const pass = document.getElementById('user-pass').value;
    if(name && pass === "2008") {
      window.currentUser = name;
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('user-display').innerText = "ðŸ“ " + name.toUpperCase();
      
      // Une fois connectÃ©, on Ã©coute la base de donnÃ©es
      startSync();
    } else { alert("AccÃ¨s refusÃ© (Code 2008)"); }
  };

  // FONCTION 2 : Synchronisation (Le coeur du systÃ¨me)
  function startSync() {
    onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        // On met Ã  jour les donnÃ©es locales avec celles du Cloud
        window.db = { ...window.db, ...docSnap.data() };
        // On rafraÃ®chit l'affichage
        updateConformite();
        if(!document.getElementById('mod-inspect').classList.contains('hidden')) renderInspect();
      } else {
        // Si la base est vide (premiÃ¨re fois), on l'initialise
        saveToCloud();
      }
    });
  }

  // FONCTION 3 : Sauvegarder (Envoie vers Firebase)
  window.saveToCloud = async function() {
    try {
      await setDoc(docRef, window.db, { merge: true });
      updateConformite();
    } catch(e) {
      console.error("Erreur sauvegarde:", e);
      alert("Erreur de sauvegarde. VÃ©rifiez votre connexion.");
    }
  };

  // --- FONCTIONS MÃ‰TIER (Celles qui font marcher l'appli) ---

  window.go = function(scr) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('scr-'+scr).classList.remove('hidden');
  }

  window.openModule = function(mod) {
    window.go('modules');
    document.querySelectorAll('#scr-modules > div').forEach(d => d.classList.add('hidden'));
    document.getElementById('mod-'+mod).classList.remove('hidden');
    if(mod === 'inspect') window.renderInspect();
  }

  window.apiScan = function(ean) {
    fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`)
    .then(r => r.json()).then(data => {
      if(data.status === 1) {
        document.getElementById('beep-sound').play();
        if(navigator.vibrate) navigator.vibrate(200);
        document.getElementById('f-name').value = data.product.product_name_fr || data.product.product_name;
        document.getElementById('f-img-preview').src = data.product.image_small_url || "";
      }
    });
  }

  window.addItem = function(type) {
    const item = {
      id: Date.now(),
      type: type,
      user: window.currentUser,
      time: new Date().toLocaleString('fr-FR'),
      name: type === 'TEMP' ? document.getElementById('t-zone').value : document.getElementById('f-name').value,
      val: type === 'TEMP' ? document.getElementById('t-val').value : document.getElementById('f-date').value,
      ean: type === 'DLC' ? document.getElementById('f-ean').value : ""
    };

    window.db.history.push(item);
    window.saveToCloud(); // On sauvegarde directement sur le cloud
    alert("TÃ¢che enregistrÃ©e !");
    window.go('home');
    
    // Reset champs
    if(document.getElementById('f-name')) document.getElementById('f-name').value = "";
    if(document.getElementById('t-val')) document.getElementById('t-val').value = "";
  }

  window.renderInspect = function() {
    const cont = document.getElementById('list-inspect-full');
    if(!cont) return;
    
    // On prend l'historique, on l'inverse (plus rÃ©cent en haut)
    cont.innerHTML = (window.db.history || []).slice().reverse().map(h => {
      let alertStyle = (h.type === 'TEMP' && parseFloat(h.val) > 4) ? 'color:var(--red); font-weight:bold;' : '';
      return `
        <div class="card history-row">
          <div>
            <span style="font-size:10px; color:var(--blue)">[${h.type}]</span> <br>
            <b style="${alertStyle}">${h.name}</b> <br>
            <small>${h.time} par ${h.user}</small>
          </div>
          <div style="text-align:right">
            <span style="${alertStyle}">${h.val}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  window.updateConformite = function() {
    const today = new Date().toLocaleDateString('fr-FR');
    const doneToday = (window.db.history || []).filter(h => h.time.includes(today)).length;
    const objectif = 10;
    const pct = Math.min(Math.round((doneToday / objectif) * 100), 100);
    
    const bar = document.getElementById('pct-bar');
    if(bar) {
        bar.style.width = pct + "%";
        document.getElementById('pct-text').innerText = pct + "%";
    }
  }

  window.downloadCSV = function() {
    let csv = "ID;Type;Date_Heure;Operateur;Libelle;Valeur_Echeance;EAN\n";
    (window.db.history || []).forEach(h => {
      csv += `${h.id};${h.type};${h.time};${h.user};${h.name};${h.val};${h.ean}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `HACCP_REPORT_${new Date().toLocaleDateString()}.csv`;
    a.click();
  }

</script>
