<script type="module">
  // 1. On importe les outils depuis Internet (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2. Ta configuration spécifique (Celle que tu m'as donnée)
  const firebaseConfig = {
    apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
    authDomain: "araujo-exploitation.firebaseapp.com",
    databaseURL: "https://araujo-exploitation-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "araujo-exploitation",
    storageBucket: "araujo-exploitation.firebasestorage.app",
    messagingSenderId: "292878114487",
    appId: "1:292878114487:web:2a450227310e970ce1b732"
  };

  // 3. Initialisation de la connexion
  const firebaseApp = initializeApp(firebaseConfig);
  const dbFirestore = getFirestore(firebaseApp);
  
  // On pointe vers le document de sauvegarde (v26 pour la dernière version)
  const docRef = doc(dbFirestore, "store_master", "v26");

  // --- LOGIQUE DE L'APPLICATION (Ne change pas) ---
  window.app = {
    data: { history: [], frais: [] }, // Structure de base
    
    // Initialisation et Synchronisation
    init: function() {
      // Écoute en temps réel les changements dans la base de données
      onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          // Si des données existent, on les charge
          this.data = { ...this.data, ...docSnap.data() };
          
          // Indicateur visuel que la connexion est OK
          const statusEl = document.getElementById('user-display');
          if(statusEl) statusEl.style.color = "#16a34a"; // Vert
          
          // On rafraîchit l'affichage
          if(typeof updateConformite === 'function') updateConformite();
          if(typeof renderInspect === 'function') renderInspect();
          if(typeof renderFrais === 'function') renderFrais();
          
        } else {
          // Si c'est la première fois, on crée la base
          this.save();
        }
      }, (error) => {
        console.error("Erreur connexion:", error);
        alert("Attention : Mode Hors Ligne ou Erreur de connexion Firebase");
      });
    },

    // Sauvegarde vers le Cloud
    save: async function() {
      try { 
        await setDoc(docRef, this.data, { merge: true }); 
      } catch(e) { 
        console.error("Erreur sauvegarde", e); 
      }
    }
  };
  
  // Rendre les fonctions accessibles globalement pour les boutons HTML
  window.login = login;
  window.go = go;
  window.openModule = openModule;
  window.apiScan = apiScan;
  window.addItem = addItem;
  window.renderInspect = renderInspect;
  window.downloadCSV = downloadCSV;

  // Si l'utilisateur est déjà connecté localement, on lance la sync
  // (La fonction login() dans le script principal appellera app.init())
</script>
