<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Store Master v30 - DLC & Exploitation</title>

    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root { --blue: #003896; --red: #ed1c24; --green: #10b981; --orange: #f59e0b; --bg: #f1f5f9; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); padding-bottom: 90px; }
        
        header { background: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--blue); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; color: var(--blue); letter-spacing: -1px; font-size: 1.2rem; }

        .screen { padding: 15px; max-width: 600px; margin: auto; }
        .hidden { display: none !important; }

        /* Menu Principal */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .mod-card { background: white; padding: 25px 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .mod-card:active { transform: scale(0.95); }
        .mod-card i { font-size: 32px; color: var(--blue); margin-bottom: 12px; display: block; }
        .mod-card span { font-weight: bold; font-size: 14px; }

        /* Module DLC & Scan */
        #scanner-view { width: 100%; height: 200px; background: #000; border-radius: 15px; overflow: hidden; position: relative; margin-bottom: 15px; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: var(--red); box-shadow: 0 0 10px var(--red); animation: scanAnim 2s infinite linear; }
        @keyframes scanAnim { 0% { top: 10%; } 50% { top: 90%; } 100% { top: 10%; } }

        .form-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn-add { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Liste des items */
        .dlc-item { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; border-left: 6px solid #ccc; }
        .dlc-item.RED { border-left-color: var(--red); }
        .dlc-item.ORANGE { border-left-color: var(--orange); }
        .dlc-item.GREEN { border-left-color: var(--green); }
        .item-img { width: 50px; height: 50px; border-radius: 8px; object-fit: contain; background: #fff; border: 1px solid #eee; }
        .item-content { flex: 1; }
        .item-content b { font-size: 14px; display: block; }
        .item-content small { color: #666; font-size: 12px; }
        .btn-del { color: #ccc; border: none; background: none; font-size: 18px; padding: 10px; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; }
        .nav-link { flex: 1; text-align: center; color: #94a3b8; font-size: 12px; cursor: pointer; border: none; background: none; }
        .nav-link.active { color: var(--blue); }
        .nav-link i { font-size: 20px; margin-bottom: 4px; }
    </style>
</head>
<body>

<header>
    <div class="logo">CARREFOUR <span style="font-weight:100">EXPLOTATION</span></div>
</header>

<div id="scr-home" class="screen">
    <div class="grid-menu">
        <div class="mod-card" onclick="showScreen('dlc')"><i class="fas fa-barcode"></i><span>Suivi DLC</span></div>
        <div class="mod-card" onclick="showScreen('clean')"><i class="fas fa-pump-soap"></i><span>M√©nage</span></div>
        <div class="mod-card" onclick="showScreen('temp')"><i class="fas fa-thermometer-half"></i><span>Temp√©ratures</span></div>
        <div class="mod-card" onclick="showScreen('check')"><i class="fas fa-tasks"></i><span>Checklist</span></div>
    </div>
</div>

<div id="scr-dlc" class="screen hidden">
    <button onclick="showScreen('home')" style="border:none; background:none; color:var(--blue); font-weight:bold; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Retour</button>
    
    <div id="scanner-view">
        <video id="video"></video>
        <div class="scan-line"></div>
    </div>

    <div class="form-card">
        <input type="text" id="in-ean" placeholder="Code EAN (Scann√©)">
        <input type="text" id="in-name" placeholder="Nom du produit">
        <div style="display: flex; gap: 10px;">
            <input type="date" id="in-date">
            <input type="number" id="in-qty" value="1" style="width: 80px;">
        </div>
        <div id="search-status" style="font-size: 11px; color: var(--blue); text-align: center; height: 15px;"></div>
        <button class="btn-add" onclick="saveDLC()">ENREGISTRER LE PRODUIT</button>
    </div>

    <div id="dlc-list-container"></div>
</div>

<nav>
    <button class="nav-link active" onclick="showScreen('home')"><i class="fas fa-home"></i><br>Accueil</button>
    <button class="nav-link" onclick="showScreen('dlc')"><i class="fas fa-barcode"></i><br>DLC</button>
</nav>

<script>
    // --- INITIALISATION DES DONN√âES ---
    let dlc_data = JSON.parse(localStorage.getItem('carrefour_dlc')) || [];
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentImage = "";

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('scr-' + id).classList.remove('hidden');
        
        // Arr√™ter le scanner si on quitte le module DLC
        if (id !== 'dlc') {
            codeReader.reset();
        } else {
            initScanner();
            renderDLC();
        }
    }

    // --- MODULE DLC : SCANNER & OPEN FOOD FACTS ---
    function initScanner() {
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                document.getElementById('in-ean').value = result.text;
                if(navigator.vibrate) navigator.vibrate(100);
                searchProduct(result.text);
            }
        });
    }

    async function searchProduct(ean) {
        const status = document.getElementById('search-status');
        status.innerText = "üîç Recherche base de donn√©es...";
        try {
            const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
            const data = await res.json();
            if (data.status === 1) {
                document.getElementById('in-name').value = data.product.product_name_fr || data.product.product_name;
                currentImage = data.product.image_small_url || "";
                status.innerText = "‚úÖ Produit trouv√©";
            } else {
                status.innerText = "‚ùå Inconnu (Saisie manuelle)";
            }
        } catch (e) {
            status.innerText = "‚ö†Ô∏è Erreur r√©seau";
        }
    }

    // --- SAUVEGARDE & CALCULS ---
    function saveDLC() {
        const name = document.getElementById('in-name').value;
        const date = document.getElementById('in-date').value;
        const qty = document.getElementById('in-qty').value;
        const ean = document.getElementById('in-ean').value;

        if (!name || !date) {
            alert("Veuillez remplir le nom et la date.");
            return;
        }

        const item = {
            id: Date.now(),
            name,
            date,
            qty,
            ean,
            img: currentImage
        };

        dlc_data.push(item);
        localStorage.setItem('carrefour_dlc', JSON.stringify(dlc_data));
        
        // Reset formulaire
        document.getElementById('in-name').value = "";
        document.getElementById('in-date').value = "";
        document.getElementById('in-ean').value = "";
        currentImage = "";
        document.getElementById('search-status').innerText = "";
        
        renderDLC();
    }

    function calculateStatus(dateStr) {
        const now = new Date();
        const expiry = new Date(dateStr);
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        if (expiry <= today) return 'RED'; // √Ä retirer aujourd'hui ou p√©rim√©
        
        const soon = new Date();
        soon.setDate(soon.getDate() + 3); // Orange si DLC √† J+3
        if (expiry <= soon) return 'ORANGE';
        
        return 'GREEN';
    }

    function renderDLC() {
        const container = document.getElementById('dlc-list-container');
        container.innerHTML = "";

        // Tri par date (plus urgent en haut)
        dlc_data.sort((a,b) => new Date(a.date) - new Date(b.date));

        dlc_data.forEach(item => {
            const status = calculateStatus(item.date);
            container.innerHTML += `
                <div class="dlc-item ${status}">
                    <img src="${item.img || 'https://via.placeholder.com/50?text=Scan'}" class="item-img">
                    <div class="item-content">
                        <b>${item.name}</b>
                        <small>√âch√©ance : ${new Date(item.date).toLocaleDateString()} | Qt√©: ${item.qty}</small>
                    </div>
                    <button class="btn-del" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });
    }

    function deleteItem(id) {
        if(confirm("Confirmer le retrait ?")) {
            dlc_data = dlc_data.filter(i => i.id !== id);
            localStorage.setItem('carrefour_dlc', JSON.stringify(dlc_data));
            renderDLC();
        }
    }

    // Lancer au d√©marrage
    window.onload = () => {
        renderDLC();
    };
</script>

</body>
</html>
