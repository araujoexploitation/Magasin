<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#003896"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Araujo App"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="application-name" content="Araujo App"/>
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png"/>
<link rel="manifest" id="pwa-manifest"/>
<title>Araujo App V5.0</title>
<script>
// Inject PWA manifest dynamically
const manifest={name:"Araujo App",short_name:"Araujo",display:"fullscreen",background_color:"#003896",theme_color:"#003896",start_url:window.location.href,icons:[{src:"https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png",sizes:"192x192",type:"image/png"}]};
const blob=new Blob([JSON.stringify(manifest)],{type:"application/json"});
document.getElementById('pwa-manifest').href=URL.createObjectURL(blob);
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
:root{
  --primary:#003896;--accent:#E2001A;--pvp:#d97706;--salad:#0f766e;--frigo:#0ea5e9;--todo:#7c3aed;
  --reception:#059669;--inspection:#7c3aed;
  --bg:#f3f4f6;--surface:#ffffff;--text:#1e293b;--success:#10b981;--danger:#ef4444;--muted:#64748b;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:system-ui,sans-serif;user-select:none;}
body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
/* iOS safe area */
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
.hidden{display:none!important;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast-container{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none;width:min(380px,92vw);}
.toast{background:#1e293b;color:#fff;padding:13px 16px;border-radius:14px;font-size:14px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1) forwards;pointer-events:auto;}
.toast.ok{background:#064e3b;border-left:4px solid #10b981;}
.toast.err{background:#7f1d1d;border-left:4px solid #ef4444;}
.toast.warn{background:#78350f;border-left:4px solid #f59e0b;}
.toast.info{background:#1e3a5f;border-left:4px solid #3b82f6;}
.toast-out{animation:toastOut .2s ease forwards;}
@keyframes toastIn{from{opacity:0;transform:translateY(-12px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes toastOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.94)}}

/* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
#spinner-overlay{position:fixed;inset:0;z-index:90000;background:rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.spinner{width:48px;height:48px;border:5px solid #e2e8f0;border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ CONFIRM / PROMPT ‚îÄ‚îÄ */
#modal-confirm,#modal-prompt{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:80000;display:flex;align-items:flex-end;justify-content:center;padding:16px;}
.dlg-card{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:420px;animation:slideUp .22s cubic-bezier(.34,1.56,.64,1);}
.dlg-title{font-size:17px;font-weight:950;margin:0 0 8px 0;}
.dlg-msg{color:var(--muted);font-size:14px;margin:0 0 20px 0;line-height:1.5;}
.dlg-btns{display:flex;gap:10px;}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}

/* ‚îÄ‚îÄ OFFLINE ‚îÄ‚îÄ */
#offline-banner{position:fixed;top:0;left:0;right:0;z-index:70000;background:#7f1d1d;color:#fff;text-align:center;padding:8px;font-size:13px;font-weight:800;transform:translateY(-100%);transition:transform .3s;}
#offline-banner.show{transform:translateY(0);}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-overlay{position:fixed;inset:0;z-index:10000;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;}
.login-card{width:min(380px,92vw);}
.login-help{font-size:12px;color:var(--muted);text-align:center;margin-top:10px;cursor:pointer;}
.login-error{display:none;background:#fee2e2;color:#991b1b;padding:10px 12px;border-radius:10px;font-weight:800;font-size:13px;margin-top:10px;}

/* ‚îÄ‚îÄ HEADER & NAV ‚îÄ‚îÄ */
header{background:var(--surface);padding:10px;height:80px;display:flex;justify-content:center;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,.05);position:relative;z-index:50;}
.logo-header{height:50px;object-fit:contain;}
.user-badge{position:absolute;right:15px;top:15px;font-size:11px;background:#e0f2fe;color:var(--primary);padding:4px 10px;border-radius:20px;font-weight:900;max-width:48vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logout-btn{position:absolute;left:15px;top:18px;border:none;background:#f1f5f9;color:#334155;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;}
main{flex:1;overflow-y:auto;padding:15px;padding-bottom:92px;}
nav{position:fixed;bottom:0;width:100%;background:#fff;height:70px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.05);z-index:100;padding:0 30px;}
.nav-btn{text-align:center;color:#94a3b8;cursor:pointer;font-size:12px;}
.nav-btn i{font-size:24px;margin-bottom:4px;}

/* ‚îÄ‚îÄ UI COMPONENTS ‚îÄ‚îÄ */
.card{background:var(--surface);border-radius:16px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.03);margin-bottom:15px;}
input,select,textarea{width:100%;padding:14px;border:1.5px solid #cbd5e1;border-radius:10px;font-size:16px;background:#fff;margin-bottom:10px;outline:none;transition:border-color .15s;}
input:focus,select:focus,textarea:focus{border-color:var(--primary);}
input.invalid{border-color:var(--danger)!important;background:#fff5f5;}
textarea{min-height:80px;resize:none;}
.field-err{font-size:12px;color:var(--danger);font-weight:700;margin-top:-8px;margin-bottom:8px;display:none;}
.field-err.show{display:block;}
.btn{width:100%;padding:16px;border-radius:12px;border:none;font-weight:900;font-size:16px;background:var(--primary);color:#fff;cursor:pointer;margin-top:5px;transition:opacity .15s,transform .1s;}
.btn:active{transform:scale(.97);opacity:.9;}
.btn.secondary{background:#eee;color:#333;}
.btn.danger{background:var(--danger);}
.btn.success{background:#00563f;}
.btn.pvp{background:var(--pvp);}
.btn.salad{background:var(--salad);}
.btn.frigo{background:var(--frigo);}
.btn.todo{background:var(--todo);}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.tabs{display:flex;background:#e2e8f0;padding:4px;border-radius:12px;margin-bottom:15px;gap:4px;}
.tab{flex:1;text-align:center;padding:10px 4px;font-weight:900;font-size:11px;color:#64748b;border-radius:9px;cursor:pointer;transition:all .15s;}
.tab.active     {background:#fff;color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-pvp {background:#fff;color:var(--pvp);   box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-salad{background:#fff;color:var(--salad); box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-frigo{background:#fff;color:var(--frigo); box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-todo{background:#fff;color:var(--todo);  box-shadow:0 2px 4px rgba(0,0,0,.1);}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
.home-btn{border-radius:18px;padding:18px 10px;color:#fff;text-align:center;font-weight:950;box-shadow:0 10px 25px rgba(0,0,0,.08);cursor:pointer;line-height:1.2;position:relative;transition:transform .15s;}
.home-btn:active{transform:scale(.97);}
.home-btn i{font-size:26px;margin-bottom:8px;}
.home-btn.wide{grid-column:1/-1;}
.home-badge{position:absolute;top:10px;right:10px;min-width:28px;height:28px;padding:0 8px;border-radius:999px;background:rgba(255,255,255,.92);color:#111827;display:flex;align-items:center;justify-content:center;font-weight:950;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,.2);}
.home-badge.red{background:rgba(255,255,255,.95);color:#991b1b;}
.home-badge.blue{background:rgba(255,255,255,.95);color:#075985;}
.home-badge.purple{background:rgba(255,255,255,.95);color:#5b21b6;}

/* ‚îÄ‚îÄ LISTS ‚îÄ‚îÄ */
.group-header{background:#334155;color:#fff;padding:12px 15px;border-radius:10px;margin-top:15px;font-weight:950;text-transform:uppercase;font-size:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.list-item{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,.05);min-height:72px;gap:10px;animation:itemIn .2s ease;}
@keyframes itemIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.swipe-wrapper{background:var(--danger);border-radius:12px;margin-bottom:8px;overflow:hidden;position:relative;}
.swipe-content{background:#fff;position:relative;z-index:2;transition:transform 0.12s;padding:12px;display:flex;align-items:center;justify-content:space-between;min-height:72px;width:100%;gap:10px;}
.item-img{width:52px;height:52px;border-radius:10px;object-fit:cover;background:#f1f5f9;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:20px;cursor:pointer;}
.item-info{flex:1;min-width:0;overflow:hidden;}
.item-title{font-weight:950;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;}
.item-sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.right-col{flex-shrink:0;display:flex;align-items:center;gap:8px;}
.qty-ctrl{display:flex;align-items:center;gap:8px;background:#f8fafc;width:fit-content;padding:4px 8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:5px;}
.qty-btn{width:30px;height:30px;border-radius:8px;border:none;background:#fff;box-shadow:0 2px 3px rgba(0,0,0,.1);font-weight:950;color:var(--primary);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s;}
.qty-btn:active{transform:scale(.9);}
.icon-btn{width:40px;height:40px;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;transition:transform .1s,opacity .1s;}
.icon-btn:active{transform:scale(.9);opacity:.85;}
.icon-btn.pvp{background:var(--pvp);}
.icon-btn.salad{background:var(--salad);}
.icon-btn.frigo{background:var(--frigo);}
.icon-btn.todo{background:var(--todo);}
.icon-btn.gray{background:#94a3b8;}
.icon-btn.red{background:var(--danger);}
.icon-btn.dark{background:#0f172a;}
.icon-btn.green{background:var(--success);}
.date-col{text-align:right;width:135px;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;}
.d-lbl{font-size:11px;color:#64748b;margin-bottom:2px;}
.d-val{font-size:13px;font-weight:950;color:var(--success);white-space:nowrap;}
.d-val.expired{color:var(--danger);}
.date-badge{width:52px;height:52px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-weight:950;flex-shrink:0;}
.bg-red{background:#ef4444;}.bg-orange{background:#f59e0b;}.bg-green{background:#10b981;}.bg-grey{background:#94a3b8;}
.chip{font-size:11px;padding:3px 8px;border-radius:999px;font-weight:950;display:inline-flex;align-items:center;gap:4px;}
.chip.warn{background:#ffedd5;color:#9a3412;}
.chip.admin{background:#fee2e2;color:#991b1b;}
.chip.staff{background:#e0f2fe;color:#075985;}
.chip.frigo{background:#e0f2fe;color:#075985;}
.chip.ok{background:#d1fae5;color:#065f46;}
.chip.late{background:#fee2e2;color:#991b1b;}
.chip.todo{background:#ede9fe;color:#5b21b6;}
.small{font-size:12px;color:var(--muted);}
.todo-check{width:36px;height:36px;border:2.5px solid #cbd5e1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;cursor:pointer;transition:all .2s;}
.todo-check.checked{background:var(--success);border-color:var(--success);color:#fff;}
.item-done{opacity:.65;background:#f8fafc;}
.item-done .item-title{text-decoration:line-through;color:#94a3b8;}

/* ‚îÄ‚îÄ TODO SPECIFIC ‚îÄ‚îÄ */
.zone-header{border-radius:14px;padding:14px 16px;color:#fff;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.zone-progress{height:6px;border-radius:3px;background:rgba(255,255,255,.3);margin-top:8px;overflow:hidden;}
.zone-progress-fill{height:100%;border-radius:3px;background:#fff;transition:width .4s ease;}
.task-card{background:#fff;border-radius:14px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:4px solid transparent;}
.task-card.done{opacity:.6;border-left-color:var(--success);}
.task-card.overdue{border-left-color:var(--danger);background:#fff5f5;}
.time-chip{font-size:12px;font-weight:900;padding:4px 10px;border-radius:8px;background:#f1f5f9;color:#334155;white-space:nowrap;flex-shrink:0;}
.time-chip.overdue{background:#fee2e2;color:#991b1b;}
.time-chip.done{background:#d1fae5;color:#065f46;}
.day-pill{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:800;cursor:pointer;}
.day-pill.on{background:var(--todo);color:#fff;}
.day-pill.off{background:#f1f5f9;color:#94a3b8;}
.progress-bar-wrap{background:#e2e8f0;border-radius:999px;height:8px;margin:10px 0 4px 0;overflow:hidden;}
.progress-bar-fill{height:100%;border-radius:999px;background:var(--todo);transition:width .4s ease;}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-state i{font-size:40px;margin-bottom:12px;opacity:.35;display:block;}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
.search-wrap{position:relative;margin-bottom:12px;}
.search-wrap i{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:15px;pointer-events:none;}
.search-input{padding:13px 13px 13px 40px!important;border-radius:12px!important;background:#f8fafc!important;border:1.5px solid #e2e8f0!important;font-size:15px!important;margin-bottom:0!important;}
.search-input:focus{border-color:var(--primary)!important;background:#fff!important;}
.search-no-result{text-align:center;padding:30px;color:var(--muted);font-size:14px;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-bc{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:5000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
#modal-barcode{z-index:6500;}
.modal-card{background:#fff;padding:25px;border-radius:20px;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;animation:mIn .22s cubic-bezier(.34,1.56,.64,1);}
@keyframes mIn{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
.row{display:flex;gap:10px;}
.divider{border:none;border-top:1px solid #e2e8f0;margin:16px 0;}
.color-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
.color-swatch{height:40px;border-radius:10px;cursor:pointer;border:3px solid transparent;transition:transform .1s;}
.color-swatch.selected{border-color:#1e293b;transform:scale(.95);}
.days-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}

/* ‚îÄ‚îÄ PERMISSIONS ‚îÄ‚îÄ */
.perm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.perm-toggle{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border-radius:10px;padding:10px 12px;gap:8px;}
.perm-toggle label{font-size:13px;font-weight:800;color:#334155;cursor:pointer;flex:1;}
.perm-toggle input[type=checkbox]{width:18px;height:18px;cursor:pointer;accent-color:var(--primary);flex-shrink:0;}
.perm-section-title{font-size:11px;font-weight:950;text-transform:uppercase;color:var(--muted);margin:12px 0 6px 0;grid-column:1/-1;}

/* ‚îÄ‚îÄ FREQUENCY SELECTOR ‚îÄ‚îÄ */
.freq-type-tabs{display:flex;gap:6px;margin-bottom:12px;}
.freq-tab{flex:1;padding:10px 6px;text-align:center;border-radius:10px;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;transition:all .15s;}
.freq-tab.active{border-color:var(--todo);background:var(--todo);color:#fff;}
.freq-panel{display:none;}
.freq-panel.active{display:block;}
.month-days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:10px;}
.month-day-btn{height:36px;border-radius:8px;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;background:#fff;transition:all .15s;}
.month-day-btn.on{background:var(--todo);border-color:var(--todo);color:#fff;}

/* ‚îÄ‚îÄ R√âCEPTION MODULE ‚îÄ‚îÄ */
.reception-card{background:var(--surface);border-radius:16px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);margin-bottom:12px;border-left:5px solid var(--reception);}
.supplier-chip{font-size:12px;padding:4px 10px;border-radius:20px;background:#d1fae5;color:#065f46;font-weight:900;}
.temp-display{font-size:28px;font-weight:950;color:var(--reception);}
.temp-ok{color:var(--success);}
.temp-warn{color:#f59e0b;}
.temp-err{color:var(--danger);}

/* ‚îÄ‚îÄ INSPECTION MODULE ‚îÄ‚îÄ */
.gear-btn{width:44px;height:44px;border-radius:50%;border:none;background:#f1f5f9;color:#334155;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:transform .3s;}
.gear-btn:hover{transform:rotate(90deg);}
.inspection-section{background:var(--surface);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.03);}
.inspection-section h4{margin:0 0 12px 0;color:var(--primary);font-size:15px;display:flex;align-items:center;gap:8px;}
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:8px;}
.kpi-card{border-radius:12px;padding:14px;text-align:center;}
.kpi-card .kpi-val{font-size:28px;font-weight:950;}
.kpi-card .kpi-lbl{font-size:11px;font-weight:800;opacity:.8;margin-top:2px;}
/* ‚îÄ‚îÄ SUPPLIER SELECT ‚îÄ‚îÄ */
.supplier-select-btn{padding:14px;border-radius:14px;background:linear-gradient(135deg,var(--reception),#047857);color:#fff;cursor:pointer;text-align:center;border:3px solid transparent;transition:all .15s;}
.supplier-select-btn:active{transform:scale(.97);}
.supplier-select-btn.selected{border-color:#fff;box-shadow:0 0 0 3px var(--reception);}

/* ‚îÄ‚îÄ √âTIQUETTES ‚îÄ‚îÄ */
.etiq-product-row{background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;border:2px solid #e9d5ff;display:flex;align-items:center;gap:12px;}
.etiq-product-row.selected{border-color:#9333ea;background:#faf5ff;}
.etiq-check{width:28px;height:28px;border-radius:8px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;}
.etiq-check.on{background:#9333ea;border-color:#9333ea;color:#fff;}
.etiq-qty-ctrl{display:flex;align-items:center;gap:8px;}
.etiq-qty-ctrl button{width:32px;height:32px;border-radius:8px;border:none;background:#f1f5f9;font-weight:900;font-size:16px;cursor:pointer;}
.etiq-label-preview{background:linear-gradient(135deg,#9333ea,#6b21a8);color:#fff;border-radius:16px;padding:20px;text-align:center;margin:12px 0;}
.etiq-label-preview .etiq-name{font-weight:950;font-size:18px;line-height:1.2;}
.etiq-label-preview .etiq-prix-original{font-size:14px;text-decoration:line-through;opacity:.7;margin-top:6px;}
.etiq-label-preview .etiq-prix-reduit{font-size:32px;font-weight:950;margin-top:4px;}
.etiq-label-preview .etiq-pct{font-size:14px;background:rgba(255,255,255,.25);border-radius:8px;padding:4px 10px;margin-top:6px;display:inline-block;}

.export-btn{width:100%;padding:14px;border-radius:12px;border:none;font-weight:900;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:opacity .15s;}
.export-btn:active{opacity:.85;}
</style>
</head>
<body>

<div id="offline-banner"><i class="fas fa-wifi-slash"></i> Hors ligne ‚Äì reconnexion en cours‚Ä¶</div>
<div id="toast-container"></div>
<div id="spinner-overlay" class="hidden"><div class="spinner"></div></div>

<!-- ‚îÄ‚îÄ CONFIRM ‚îÄ‚îÄ -->
<div id="modal-confirm" class="hidden">
  <div class="dlg-card">
    <p class="dlg-title" id="dlg-title">Confirmation</p>
    <p class="dlg-msg"   id="dlg-msg"></p>
    <div class="dlg-btns">
      <button class="btn secondary" style="margin:0" id="dlg-cancel">Annuler</button>
      <button class="btn danger"    style="margin:0" id="dlg-ok">Confirmer</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PROMPT ‚îÄ‚îÄ -->
<div id="modal-prompt" class="hidden">
  <div class="dlg-card">
    <p class="dlg-title" id="pmt-title">Saisie</p>
    <input id="pmt-input" type="text" style="margin-bottom:12px;">
    <div class="dlg-btns">
      <button class="btn secondary" style="margin:0" id="pmt-cancel">Annuler</button>
      <button class="btn"           style="margin:0" id="pmt-ok">OK</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
<div id="login-overlay">
  <div class="login-card">
    <div style="text-align:center;"><img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" style="width:200px;margin-bottom:20px;"></div>
    <input type="email" id="login-email" placeholder="Email" autocomplete="username" inputmode="email">
    <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
    <button class="btn success" id="login-btn" onclick="app.auth.login()"><i class="fas fa-right-to-bracket"></i> CONNEXION</button>
    <div class="login-help" onclick="app.auth.forgot()"><i class="fas fa-unlock-keyhole"></i> Mot de passe oubli√© ?</div>
    <div id="login-error" class="login-error"></div>
    <div class="small" style="text-align:center;margin-top:14px;">Astuce : apr√®s cr√©ation d'un compte staff, "Mot de passe oubli√©" permet de d√©finir le mot de passe.</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ BARCODE MODAL ‚îÄ‚îÄ -->
<div id="modal-barcode" class="modal-bc hidden">
  <div class="modal-card" style="text-align:center;">
    <h3 id="bc-name" style="margin-top:0;"></h3>
    <img id="bc-img-display" style="width:100%;height:220px;object-fit:contain;margin-bottom:15px;display:none;background:#f8fafc;border-radius:10px;">
    <svg id="barcode"></svg><br>
    <button class="btn secondary" style="margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ TRACE MODAL ‚îÄ‚îÄ -->
<div id="modal-trace" class="modal-bc hidden">
  <div class="modal-card">
    <h3 id="trace-h3" style="margin-top:0;display:flex;align-items:center;gap:10px;"><i class="fas fa-camera"></i> Tracabilit√©</h3>
    <div class="small" id="trace-title" style="margin-bottom:10px;"></div>
    <button class="btn" id="trace-btn-pick" onclick="document.getElementById('trace-file').click()"><i class="fas fa-image"></i> Prendre / choisir une photo</button>
    <input type="file" id="trace-file" accept="image/*" capture="environment" class="hidden">
    <img id="trace-preview" style="width:100%;height:200px;object-fit:contain;background:#f8fafc;border-radius:12px;display:none;margin-top:12px;">
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="trace-btn-save" style="margin-top:0;" onclick="app.trace.save()"><i class="fas fa-floppy-disk"></i> Enregistrer</button>
      <button class="btn secondary" style="margin-top:0;" onclick="app.trace.close()">Fermer</button>
    </div>
    <hr class="divider">
    <h4 style="margin:0 0 10px 0;">Historique (6 mois)</h4>
    <div id="trace-history" class="small">Chargement‚Ä¶</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ EDIT FRAIS ‚îÄ‚îÄ -->
<div id="modal-edit-frais" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;">Modifier Frais</h3>
    <input type="hidden" id="edit-id">
    <label>EAN</label><input type="text" id="edit-ean" inputmode="numeric">
    <label>Nom Produit</label><input type="text" id="edit-name">
    <label>Famille</label>
    <select id="edit-famille"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
    <label>Qt√©</label><input type="number" id="edit-qty">
    <label>DLC</label><input type="date" id="edit-date">
    <button class="btn success" onclick="app.frais.saveEdit()">Enregistrer</button>
    <button class="btn danger"  onclick="app.frais.del()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ PVP LIB ‚îÄ‚îÄ -->
<div id="modal-pvp-lib" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--pvp);margin-top:0;">Produit PVP</h3>
    <input type="hidden" id="lib-id"><input type="hidden" id="lib-img-data">
    <label>Famille</label><select id="lib-fam-select" onchange="app.pvp.toggleFamInput()"></select>
    <input type="text" id="lib-fam-new" placeholder="Nouvelle famille..." class="hidden">
    <label>Nom</label><input type="text" id="lib-name">
    <label>EAN</label><input type="text" id="lib-ean" inputmode="numeric" maxlength="13">
    <button class="btn secondary" onclick="document.getElementById('cam-input').click()" style="margin-bottom:10px;">Photo</button>
    <input type="file" id="cam-input" accept="image/*" capture="environment" class="hidden">
    <img id="img-preview" style="width:110px;height:110px;object-fit:cover;border-radius:12px;display:none;margin:0 auto 10px auto;">
    <label>Conservation</label><select id="lib-days"><option value="0">JOURN√âE</option><option value="48">48H</option><option value="72">72H</option></select>
    <label>Objectifs (L‚ÜíD)</label>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">
      <input type="number" id="t-1" placeholder="L" style="text-align:center;padding:6px;">
      <input type="number" id="t-2" placeholder="M" style="text-align:center;padding:6px;">
      <input type="number" id="t-3" placeholder="M" style="text-align:center;padding:6px;">
      <input type="number" id="t-4" placeholder="J" style="text-align:center;padding:6px;">
      <input type="number" id="t-5" placeholder="V" style="text-align:center;padding:6px;">
      <input type="number" id="t-6" placeholder="S" style="text-align:center;padding:6px;">
      <input type="number" id="t-0" placeholder="D" style="text-align:center;padding:6px;">
    </div>
    <button class="btn pvp"      onclick="app.pvp.saveLib()">Enregistrer</button>
    <button class="btn danger"   onclick="app.pvp.delLib()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-pvp-lib').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ PVP STOCK ‚îÄ‚îÄ -->
<div id="modal-pvp-stock" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--pvp);margin-top:0;">Correction Rayon</h3>
    <input type="hidden" id="stock-id"><h4 id="stock-name" style="text-align:center;margin:0 0 10px 0;"></h4>
    <label>Quantit√©</label><input type="number" id="stock-qty">
    <label>Sortie</label><input type="datetime-local" id="stock-start">
    <label>Fin</label><input type="datetime-local" id="stock-end">
    <button class="btn pvp"    onclick="app.pvp.saveStock()">Valider</button>
    <button class="btn danger" onclick="app.pvp.delStock()">Retirer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ SALAD LIB ‚îÄ‚îÄ -->
<div id="modal-salad-lib" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--salad);margin-top:0;">Produit Salad Bar</h3>
    <input type="hidden" id="sal-lib-id">
    <label>Groupe</label>
    <select id="sal-lib-fam"><option>SALADE</option><option>BASE</option><option>LEGUMES ET FRUITS</option><option>PROTEINE</option><option>FROMAGES</option><option>FECULENTS</option><option>TOPPING</option><option>DIVERS</option></select>
    <label>Nom</label><input type="text" id="sal-lib-name">
    <label>Dur√©e</label>
    <select id="sal-lib-hours"><option value="24">24H</option><option value="48">48H</option><option value="72">72H</option><option value="168">7J</option><option value="1920">80J</option></select>
    <button class="btn salad"  onclick="app.salad.saveLib()">Enregistrer</button>
    <button class="btn danger" onclick="app.salad.delLib()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-salad-lib').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ FRIGO LOG ‚îÄ‚îÄ -->
<div id="modal-frigo-log" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;color:var(--frigo);"><i class="fas fa-temperature-half"></i> Temp√©rature frigo</h3>
    <label>Frigo</label><select id="frigo-log-fridge"></select>
    <label>Temp√©rature (¬∞C)</label><input type="number" id="frigo-log-temp" inputmode="decimal" step="0.1" placeholder="Ex: 3.6">
    <label>Date / heure</label><input type="datetime-local" id="frigo-log-time">
    <div class="row" style="margin-top:12px;">
      <button class="btn frigo" style="margin-top:0;" onclick="app.frigo.saveLog()"><i class="fas fa-check"></i> Valider</button>
      <button class="btn secondary" style="margin-top:0;" onclick="document.getElementById('modal-frigo-log').classList.add('hidden')">Annuler</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TODO ZONE MODAL ‚îÄ‚îÄ -->
<div id="modal-todo-zone" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--todo);margin-top:0;" id="todo-zone-modal-title"><i class="fas fa-map-marker-alt"></i> Zone</h3>
    <input type="hidden" id="tz-id">
    <label>Nom de la zone</label>
    <input type="text" id="tz-name" placeholder="Ex: R√âSERVE, RAYON, CAISSE...">
    <div class="field-err" id="err-tz-name">Nom requis</div>
    <label>Couleur</label>
    <div class="color-grid" id="tz-color-grid"></div>
    <input type="hidden" id="tz-color" value="#7c3aed">
    <div class="row" style="margin-top:8px;">
      <button class="btn todo"   style="margin-top:0;" onclick="app.todo.saveZone()">Enregistrer</button>
      <button class="btn danger" style="margin-top:0;" id="tz-del-btn" onclick="app.todo.delZone()">Supprimer</button>
    </div>
    <button class="btn secondary" onclick="document.getElementById('modal-todo-zone').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ TODO TASK MODAL ‚îÄ‚îÄ -->
<div id="modal-todo-task" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--todo);margin-top:0;" id="todo-task-modal-title"><i class="fas fa-list-check"></i> T√¢che</h3>
    <input type="hidden" id="tt-id">
    <label>Zone</label>
    <select id="tt-zone"></select>
    <label>Nom de la t√¢che</label>
    <input type="text" id="tt-name" placeholder="Ex: Nettoyer le sol, Faire l'inventaire...">
    <div class="field-err" id="err-tt-name">Nom requis</div>
    <label>Heure cible</label>
    <input type="time" id="tt-time" placeholder="Ex: 08:00">
    <label>Fr√©quence</label>
    <div class="freq-type-tabs">
      <div class="freq-tab active" id="freq-daily-tab"   onclick="app.todo._setFreq('daily')">Journalier</div>
      <div class="freq-tab"        id="freq-weekly-tab"  onclick="app.todo._setFreq('weekly')">Hebdo</div>
      <div class="freq-tab"        id="freq-monthly-tab" onclick="app.todo._setFreq('monthly')">Mensuel</div>
      <div class="freq-tab"        id="freq-yearly-tab"  onclick="app.todo._setFreq('yearly')">Annuel</div>
    </div>
    <!-- Journalier : tous les jours -->
    <div class="freq-panel active" id="freq-panel-daily">
      <div class="small" style="color:var(--muted);text-align:center;padding:8px;">T√¢che active tous les jours</div>
    </div>
    <!-- Hebdomadaire : jours de la semaine -->
    <div class="freq-panel" id="freq-panel-weekly">
      <label>Jours d'application</label>
      <div class="days-row" id="tt-days-row"></div>
      <div class="field-err" id="err-tt-days">S√©lectionner au moins un jour</div>
    </div>
    <!-- Mensuel : jour du mois -->
    <div class="freq-panel" id="freq-panel-monthly">
      <label>Jours du mois</label>
      <div class="month-days-grid" id="tt-month-days-grid"></div>
      <div class="field-err" id="err-tt-days-m">S√©lectionner au moins un jour</div>
    </div>
    <!-- Annuel : date exacte -->
    <div class="freq-panel" id="freq-panel-yearly">
      <label>Date (chaque ann√©e)</label>
      <input type="text" id="tt-yearly-date" placeholder="JJ/MM (ex: 01/01)" inputmode="numeric" maxlength="5">
    </div>
    <label>Notes (optionnel)</label>
    <textarea id="tt-notes" placeholder="Instructions, d√©tails‚Ä¶"></textarea>
    <div class="row" style="margin-top:8px;">
      <button class="btn todo"   style="margin-top:0;" onclick="app.todo.saveTask()">Enregistrer</button>
      <button class="btn danger" style="margin-top:0;" id="tt-del-btn" onclick="app.todo.delTask()">Supprimer</button>
    </div>
    <button class="btn secondary" onclick="document.getElementById('modal-todo-task').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header id="app-header" class="hidden">
  <button class="logout-btn" onclick="app.auth.logout()"><i class="fas fa-right-from-bracket"></i></button>
  <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
  <div id="user-badge" class="user-badge">...</div>
</header>

<main>
  <!-- HOME -->
  <div id="view-home">
    <div id="alert-box" style="display:none;background:#ef4444;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;font-weight:950;">‚ö†Ô∏è Dates Courtes !</div>
    <div class="home-grid">
      <div class="home-btn" onclick="app.nav('frais')" style="background:linear-gradient(135deg,#003896,#002366);">
        <div id="badge-frais" class="home-badge red hidden">0</div>
        <i class="fas fa-barcode"></i><br>DLC FRAIS
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">DLC du jour</div>
      </div>
      <div class="home-btn" onclick="app.nav('pvp')" style="background:linear-gradient(135deg,#d97706,#b45309);">
        <i class="fas fa-bread-slice"></i><br>GESTION PVP
      </div>
      <div class="home-btn wide" onclick="app.nav('salad')" style="background:linear-gradient(135deg,#0f766e,#115e59);">
        <i class="fas fa-bowl-food"></i><br>SALAD BAR (DLC + TRACABILIT√â)
      </div>
      <div class="home-btn" onclick="app.nav('frigo')" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);">
        <div id="badge-frigo" class="home-badge blue hidden">0</div>
        <i class="fas fa-temperature-half"></i><br>TEMP√âRATURES
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Relev√©s restants</div>
      </div>
      <div class="home-btn" onclick="app.nav('todo')" style="background:linear-gradient(135deg,#7c3aed,#5b21b6);">
        <div id="badge-todo" class="home-badge purple hidden">0</div>
        <i class="fas fa-list-check"></i><br>CHECK-LIST
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">T√¢ches du jour</div>
      </div>
      <div class="home-btn" onclick="app.nav('reception')" style="background:linear-gradient(135deg,#059669,#047857);">
        <div id="badge-reception" class="home-badge hidden" style="background:rgba(255,255,255,.92);color:#065f46;">0</div>
        <i class="fas fa-truck-ramp-box"></i><br>R√âCEPTION
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Contr√¥le livraison</div>
      </div>
      <div class="home-btn" onclick="app.nav('inspection')" style="background:linear-gradient(135deg,#475569,#1e293b);">
        <i class="fas fa-chart-bar"></i><br>INSPECTION
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Rapports & export</div>
      </div>
      <div class="home-btn wide" onclick="app.nav('etiquettes')" style="background:linear-gradient(135deg,#9333ea,#6b21a8);">
        <i class="fas fa-tag"></i><br>√âTIQUETTES -50%
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Brother TD-2120N ‚Ä¢ Too Good To Go</div>
      </div>
    </div>
    <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;cursor:pointer;"><i class="fas fa-users"></i> √âquipe</div>
  </div>

  <!-- FRAIS -->
  <div id="view-frais" class="hidden">
    <div class="tabs">
      <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
      <div class="tab"        id="tf-3" onclick="app.frais.tab('tgtg')" style="color:#006B3C;">TOO GOOD TO GO</div>
      <div class="tab"        id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
    </div>
    <div class="card" id="frais-today-card" style="border-left:6px solid var(--primary);">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;">DLC aujourd'hui</div>
        <div class="chip warn" id="frais-today-chip"><i class="fas fa-calendar-day"></i> 0</div>
      </div>
    </div>
    <div id="frais-scan">
      <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;border-radius:12px;overflow:hidden;">
        <video id="video" style="width:100%;height:100%;object-fit:cover;"></video>
      </div>
      <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
      <div class="card">
        <input id="frais-ean" type="text" inputmode="numeric" placeholder="EAN" oninput="app.frais.handleInput(this.value)">
        <select id="frais-fam"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
        <input id="frais-name" placeholder="Nom">
        <div class="row"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qt√©"></div>
        <button class="btn" onclick="app.frais.add()">AJOUTER</button>
      </div>
    </div>
    <!-- TOO GOOD TO GO -->
    <div id="frais-tgtg" class="hidden">
      <div class="card" style="border-left:5px solid #006B3C;background:linear-gradient(135deg,#f0fdf4,#fff);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div style="font-size:32px;">üçÉ</div>
          <div>
            <div style="font-weight:950;font-size:16px;color:#006B3C;">Too Good To Go</div>
            <div class="small">Scannez ou cherchez un produit √† d√©duire du stock</div>
          </div>
        </div>
        <div id="tgtg-scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;border-radius:12px;overflow:hidden;">
          <video id="tgtg-video" style="width:100%;height:100%;object-fit:cover;"></video>
        </div>
        <button class="btn" style="background:#006B3C;" onclick="app.frais.tgtgToggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
        <div class="search-wrap" style="margin-top:10px;">
          <i class="fas fa-magnifying-glass"></i>
          <input class="search-input" type="search" id="tgtg-search" placeholder="Rechercher un produit‚Ä¶" oninput="app.frais.renderTgtg()" autocomplete="off">
        </div>
        <div id="tgtg-result-list" style="margin-top:8px;"></div>
      </div>
    </div>
    <div id="frais-list" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="frais-search" placeholder="Rechercher un produit frais‚Ä¶" oninput="app.frais.render()" autocomplete="off">
      </div>
      <div id="frais-list-items"></div>
    </div>
  </div>

  <!-- PVP -->
  <div id="view-pvp" class="hidden">
    <div class="tabs">
      <div class="tab active-pvp" id="tp-1" onclick="app.pvp.tab('stock')">RAYON</div>
      <div class="tab"            id="tp-2" onclick="app.pvp.tab('bib')">BIBLIOTH√àQUE</div>
      <div class="tab"            id="tp-3" onclick="app.pvp.tab('calc')">BESOINS</div>
    </div>
    <div id="pvp-stock"></div>
    <div id="pvp-bib" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="pvp-search" placeholder="Rechercher un produit PVP‚Ä¶" oninput="app.pvp.render()" autocomplete="off">
      </div>
      <button class="btn secondary" id="pvp-create-btn" onclick="app.pvp.openLib()" style="margin-bottom:12px;">+ Cr√©er Produit</button>
      <div id="lib-list"></div>
    </div>
    <div id="pvp-calc" class="hidden"></div>
  </div>

  <!-- SALAD BAR -->
  <div id="view-salad" class="hidden">
    <div class="tabs">
      <div class="tab active-salad" id="ts-1" onclick="app.salad.tab('stock')">RAYON</div>
      <div class="tab"              id="ts-2" onclick="app.salad.tab('bib')">BIBLIOTH√àQUE</div>
    </div>
    <div id="salad-stock"></div>
    <div id="salad-bib" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="salad-search" placeholder="Rechercher un produit Salad Bar‚Ä¶" oninput="app.salad.render()" autocomplete="off">
      </div>
      <button class="btn secondary" id="salad-create-btn" onclick="app.salad.openLib()" style="margin-bottom:12px;">+ Cr√©er Produit</button>
      <div id="salad-lib-list"></div>
    </div>
  </div>

  <!-- FRIGO -->
  <div id="view-frigo" class="hidden">
    <div class="tabs">
      <div class="tab active-frigo" id="tfr-1" onclick="app.frigo.tab('take')">√Ä FAIRE</div>
      <div class="tab"              id="tfr-2" onclick="app.frigo.tab('fridges')">FRIGOS</div>
      <div class="tab"              id="tfr-3" onclick="app.frigo.tab('history')">HISTO</div>
    </div>
    <div class="card" style="border-left:6px solid var(--frigo);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-weight:950;">Relev√©s du jour restants</div>
        <div class="chip frigo" id="frigo-remaining-chip"><i class="fas fa-list-check"></i> 0</div>
      </div>
      <div class="small" style="margin-top:6px;">Fr√©quence : <b id="frigo-perday-label">2</b> relev√©(s) / frigo / jour</div>
    </div>
    <div id="frigo-take"></div>
    <div id="frigo-fridges" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 10px 0;color:var(--frigo);">Param√®tres</h3>
        <label>Fr√©quence (relev√©s / frigo / jour)</label>
        <select id="frigo-perday" onchange="app.frigo.setPerDay(this.value)">
          <option value="1">1 / jour</option><option value="2">2 / jour</option>
          <option value="3">3 / jour</option><option value="4">4 / jour</option>
        </select>
      </div>
      <button class="btn frigo" onclick="app.frigo.addFridge()"><i class="fas fa-plus"></i> Ajouter un frigo</button>
      <div id="frigo-list" style="margin-top:12px;"></div>
    </div>
    <div id="frigo-history" class="hidden"></div>
  </div>

  <!-- TODO / CHECK-LIST -->
  <div id="view-todo" class="hidden">
    <div class="tabs">
      <div class="tab active-todo" id="tt-1" onclick="app.todo.tab('today')">AUJOURD'HUI</div>
      <div class="tab"             id="tt-4" onclick="app.todo.tab('tomorrow')">√Ä VENIR</div>
      <div class="tab"             id="tt-2" onclick="app.todo.tab('config')">CONFIGURER</div>
      <div class="tab"             id="tt-3" onclick="app.todo.tab('history')">HISTORIQUE</div>
    </div>
    <div id="todo-today"></div>
    <div id="todo-tomorrow" class="hidden"></div>
    <div id="todo-config" class="hidden"></div>
    <div id="todo-history" class="hidden"></div>
  </div>

  <!-- R√âCEPTION -->
  <div id="view-reception" class="hidden">
    <div class="tabs">
      <div class="tab active" style="color:var(--reception);" id="trec-1" onclick="app.reception.tab('new')">NOUVEAU</div>
      <div class="tab"        id="trec-2" onclick="app.reception.tab('history')">HISTORIQUE</div>
    </div>
    <div id="reception-new">
      <div class="card" style="border-left:5px solid var(--reception);">
        <h3 style="margin-top:0;color:var(--reception);"><i class="fas fa-truck-ramp-box"></i> Contr√¥le √† la r√©ception</h3>
        <label>Fournisseur</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;" id="rec-supplier-grid">
          <div class="supplier-select-btn" id="sup-btn-011" onclick="app.reception.selectSupplier('011','COLOMIERS 011','sec',null,null)">
            <div style="font-weight:950;">COLOMIERS</div><div style="font-size:11px;opacity:.8;">011 ‚Ä¢ SEC</div>
          </div>
          <div class="supplier-select-btn" id="sup-btn-392" onclick="app.reception.selectSupplier('392','PLAISANCE 392','frais',0,4)">
            <div style="font-weight:950;">PLAISANCE</div><div style="font-size:11px;opacity:.8;">392 ‚Ä¢ FRAIS 0‚Äì4¬∞C</div>
          </div>
          <div class="supplier-select-btn" id="sup-btn-032" onclick="app.reception.selectSupplier('032','ST GILES 032','surgele',-23,-18)" style="grid-column:1/-1;">
            <div style="font-weight:950;">ST GILES</div><div style="font-size:11px;opacity:.8;">032 ‚Ä¢ SURGEL√â -18 √† -23¬∞C</div>
          </div>
        </div>
        <div id="rec-selected-supplier" style="display:none;margin-bottom:12px;">
          <div style="background:#f0fdf4;border:2px solid var(--reception);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:950;" id="rec-sup-label">‚Äî</div>
              <div class="small" id="rec-sup-type-label">‚Äî</div>
            </div>
            <button onclick="app.reception.clearSupplier()" style="border:none;background:#fee2e2;color:#991b1b;border-radius:8px;padding:6px 10px;font-weight:900;cursor:pointer;">Changer</button>
          </div>
        </div>
        <div id="rec-temp-section" style="display:none;">
          <label>Temp√©rature √† r√©ception (¬∞C)</label>
          <div style="background:#f8fafc;border-radius:12px;padding:10px;margin-bottom:10px;">
            <div class="small" id="rec-temp-range-label" style="font-weight:800;color:#475569;margin-bottom:6px;"></div>
            <input type="number" id="rec-temp" inputmode="decimal" step="0.1" placeholder="Ex: 3.5" oninput="app.reception._updateTempStatus()">
            <div id="rec-temp-status"></div>
          </div>
        </div>
        <label>Produit / Nature de la livraison</label>
        <input type="text" id="rec-product" placeholder="Ex: Viande fra√Æche, L√©gumes, Poisson‚Ä¶">
        <label>Date et heure de contr√¥le</label>
        <input type="datetime-local" id="rec-datetime">
        <label>Observations / Non-conformit√©s</label>
        <textarea id="rec-notes" placeholder="√âtat emballage, odeur, couleur, quantit√©‚Ä¶"></textarea>
        <label>Photo (optionnel)</label>
        <button class="btn secondary" style="margin-bottom:8px;" onclick="document.getElementById('rec-photo-input').click()"><i class="fas fa-camera"></i> Prendre une photo</button>
        <input type="file" id="rec-photo-input" accept="image/*" capture="environment" class="hidden">
        <img id="rec-photo-preview" style="width:100%;max-height:180px;object-fit:contain;border-radius:12px;display:none;margin-bottom:10px;background:#f8fafc;">
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn success" style="margin-top:0;" onclick="app.reception.save(true)"><i class="fas fa-check"></i> CONFORME</button>
          <button class="btn danger"  style="margin-top:0;" onclick="app.reception.save(false)"><i class="fas fa-xmark"></i> NON CONFORME</button>
        </div>
      </div>
    </div>
    <div id="reception-history" class="hidden"></div>
  </div>

  <!-- INSPECTION -->
  <div id="view-inspection" class="hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h2 style="margin:0;font-size:18px;color:var(--primary);"><i class="fas fa-chart-bar"></i> Inspection & Rapports</h2>
      <button class="gear-btn" id="inspection-settings-btn" onclick="app.nav('team')" title="Param√®tres √©quipe"><i class="fas fa-gear"></i></button>
    </div>
    <div id="inspection-content"></div>
  </div>

  <!-- √âTIQUETTES -50% -->
  <div id="view-etiquettes" class="hidden">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
      <div style="font-size:28px;">üè∑Ô∏è</div>
      <div>
        <div style="font-weight:950;font-size:18px;color:#9333ea;">√âtiquettes -50%</div>
        <div class="small">Imprimante Brother TD-2120N</div>
      </div>
    </div>
    <div class="card" style="border-left:5px solid #9333ea;">
      <div style="font-weight:950;margin-bottom:10px;color:#9333ea;"><i class="fas fa-triangle-exclamation"></i> Produits √† date du jour</div>
      <div id="etiq-product-list"></div>
      <button class="btn" style="background:#9333ea;margin-top:8px;" onclick="app.etiquettes.loadProducts()"><i class="fas fa-rotate"></i> Actualiser la liste</button>
    </div>
    <div class="card" id="etiq-config-card" style="display:none;">
      <h3 style="margin-top:0;color:#9333ea;"><i class="fas fa-sliders"></i> Configuration impression</h3>
      <div id="etiq-items-config"></div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" style="background:#9333ea;" onclick="app.etiquettes.printAll()"><i class="fas fa-print"></i> IMPRIMER TOUT</button>
      </div>
    </div>
    <div class="card" style="background:#f8f4ff;border:1px dashed #9333ea;">
      <h4 style="margin-top:0;color:#9333ea;"><i class="fas fa-network-wired"></i> Connexion imprimante</h4>
      <input id="etiq-printer-ip" placeholder="IP imprimante (ex: 192.168.1.50)" style="margin-bottom:8px;">
      <input id="etiq-printer-port" placeholder="Port (d√©faut: 9100)" value="9100" style="margin-bottom:8px;">
      <div id="etiq-printer-status" class="small" style="color:var(--muted);margin-bottom:8px;">Non connect√©</div>
      <button class="btn secondary" onclick="app.etiquettes.testPrinter()"><i class="fas fa-plug"></i> Tester la connexion</button>
    </div>
  </div>

  <!-- TEAM -->
  <div id="view-team" class="hidden">
    <div class="card">
      <h3 style="margin-top:0;">Cr√©er un compte staff</h3>
      <input id="new-u-name"  placeholder="Nom (ex: LUCAS)" autocomplete="off">
      <input id="new-u-email" placeholder="Email (ex: lucas@...)" inputmode="email" autocomplete="off">
      <select id="new-u-role"><option value="staff">staff</option><option value="admin">admin</option></select>
      <button class="btn" onclick="app.team.createStaff()">Cr√©er + envoyer lien mot de passe</button>
      <div class="small">Le staff clique "Mot de passe oubli√©" sur l'√©cran de login.</div>
    </div>
    <div class="card">
      <h3 style="margin-top:0;">Utilisateurs</h3>
      <div id="user-list"></div>
    </div>
  </div>
</main>

<nav id="app-nav" class="hidden">
  <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i><br>RETOUR</div>
  <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large"></i><br>MENU</div>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,doc,setDoc,getDoc,collection,addDoc,getDocs,deleteDoc,
  query,where,orderBy,limit,doc as fDoc,onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,onAuthStateChanged,signInWithEmailAndPassword,signOut,
  sendPasswordResetEmail,createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getStorage,ref as sRef,uploadString,getDownloadURL,deleteObject
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const FB={
  apiKey:"AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
  authDomain:"araujo-exploitation.firebaseapp.com",
  projectId:"araujo-exploitation",
  storageBucket:"araujo-exploitation.firebasestorage.app",
  messagingSenderId:"292878114487",
  appId:"1:292878114487:web:2a450227310e970ce1b732"
};
const appFb=initializeApp(FB);
const db=getFirestore(appFb);
const auth=getAuth(appFb);
const storage=getStorage(appFb);
const sec=initializeApp(FB,"Secondary");
const secAuth=getAuth(sec);

const docUsers=doc(db,"store_master","DATA_USERS");
const docFrais=doc(db,"store_master","DATA_FRAIS");
const docPVP  =doc(db,"store_master","DATA_PVP");
const docSalad=doc(db,"store_master","DATA_SALAD");
const docFrigo=doc(db,"store_master","DATA_FRIGO");
const docTodo =doc(db,"store_master","DATA_TODO");
const colTodoLogs=collection(db,"todo_logs");
const colReception=collection(db,"reception_logs");
const TRACE_PREFIX={salad:"salad_traca",pvp:"pvp_traca"};
const colTraceFor=(mod,pid)=>collection(db,TRACE_PREFIX[mod],String(pid),"items");

const codeReader=new ZXing.BrowserMultiFormatReader();

// ‚îÄ‚îÄ ZONE COLOR PALETTE ‚îÄ‚îÄ
const ZONE_COLORS=[
  "#7c3aed","#1d4ed8","#0891b2","#15803d",
  "#d97706","#dc2626","#db2777","#475569"
];

// ‚îÄ‚îÄ FRENCH DAY LABELS (getDay() = 0=Sun) ‚îÄ‚îÄ
const DAY_LABELS=["D","L","M","M","J","V","S"];
const DAY_FULL  =["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];

// ‚îÄ‚îÄ DATE UTILITIES ‚îÄ‚îÄ
const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;};
const tsToInput=ts=>{const d=new Date(ts),l=new Date(d.getTime()-d.getTimezoneOffset()*60000);return l.toISOString().slice(0,16);};
const inputToTs=v=>{if(!v)return Date.now();const t=new Date(v).getTime();return isNaN(t)?Date.now():t;};
const formatDate=ts=>{const d=new Date(ts);if(isNaN(d.getTime()))return "--/--";return `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
const dayBounds=ts=>{const d=new Date(ts||Date.now()),s=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0).getTime(),e=new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999).getTime();return{start:s,end:e};};

// ‚îÄ‚îÄ TOAST / UI HELPERS ‚îÄ‚îÄ
const toast=(msg,type='info',dur=3200)=>{
  const icons={ok:'circle-check',err:'circle-xmark',warn:'triangle-exclamation',info:'circle-info'};
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<i class="fas fa-${icons[type]||'circle-info'}"></i><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{el.classList.add('toast-out');setTimeout(()=>el.remove(),220);},dur);
};
const spin=s=>document.getElementById('spinner-overlay').classList.toggle('hidden',!s);
const dlgConfirm=(title,msg,danger=true)=>new Promise(r=>{
  const m=document.getElementById('modal-confirm');
  const ok=document.getElementById('dlg-ok');
  const can=document.getElementById('dlg-cancel');
  document.getElementById('dlg-title').textContent=title;
  document.getElementById('dlg-msg').textContent=msg;
  ok.className=`btn ${danger?'danger':'success'}`;ok.style.margin='0';
  m.classList.remove('hidden');
  const done=v=>{m.classList.add('hidden');ok.onclick=null;can.onclick=null;r(v);};
  ok.onclick=()=>done(true);can.onclick=()=>done(false);
});
const dlgPrompt=(title,def='',type='text')=>new Promise(r=>{
  const m=document.getElementById('modal-prompt');
  const inp=document.getElementById('pmt-input');
  const ok=document.getElementById('pmt-ok');
  const can=document.getElementById('pmt-cancel');
  document.getElementById('pmt-title').textContent=title;
  inp.type=type;inp.value=def||'';
  m.classList.remove('hidden');
  setTimeout(()=>inp.focus(),120);
  const done=v=>{m.classList.add('hidden');ok.onclick=null;can.onclick=null;inp.onkeydown=null;r(v);};
  ok.onclick=()=>done(inp.value);
  can.onclick=()=>done(null);
  inp.onkeydown=e=>{if(e.key==='Enter')done(inp.value);if(e.key==='Escape')done(null);};
});

// ‚îÄ‚îÄ SALAD DEFAULTS ‚îÄ‚îÄ
const SALAD_DEF=[
  {family:"SALADE",name:"Batavia",hours:48},{family:"SALADE",name:"M√¢che",hours:48},{family:"SALADE",name:"Melange Gourmand",hours:48},{family:"SALADE",name:"Iceberg",hours:48},
  {family:"BASE",name:"Penne au basilic",hours:48},{family:"BASE",name:"Garganelli et graines de lin",hours:48},{family:"BASE",name:"Quinoa Boulgour,Tomates mi-s√©ches,feves de soja",hours:48},{family:"BASE",name:"Boulgour et lentilles",hours:48},{family:"BASE",name:"Farfalles au pesto",hours:48},
  {family:"LEGUMES ET FRUITS",name:"Tomates cerise marin√©es",hours:48},{family:"LEGUMES ET FRUITS",name:"L√©gumes Grill√©es",hours:48},{family:"LEGUMES ET FRUITS",name:"Duo de carrotes",hours:48},{family:"LEGUMES ET FRUITS",name:"Betrave",hours:48},{family:"LEGUMES ET FRUITS",name:"Pois Chiches",hours:48},{family:"LEGUMES ET FRUITS",name:"Avocat",hours:24},
  {family:"PROTEINE",name:"≈íufs durs",hours:48},{family:"PROTEINE",name:"Poulet √©minc√©",hours:48},{family:"PROTEINE",name:"Jambon Cuit",hours:48},{family:"PROTEINE",name:"Thon",hours:48},
  {family:"FROMAGES",name:"Billes mozzarella",hours:48},{family:"FROMAGES",name:"Emmental",hours:48},
  {family:"FECULENTS",name:"Boulgour",hours:48},{family:"FECULENTS",name:"Riz sauvage",hours:48},
  {family:"TOPPING",name:"Crumble Sal√©",hours:168},{family:"TOPPING",name:"Sauce Balsamique",hours:1920},{family:"TOPPING",name:"Sauce Caesar",hours:1920}
].map(x=>({...x,id:null}));

window.app={
  me:null,
  data:{
    frais:[],users:[],pvpLib:[],pvpStock:[],checkedNeeds:[],
    saladLib:[],saladStock:[],
    frigo:{perDay:2,fridges:[],logs:[]},
    todo:{zones:[],tasks:[]},
    todoLogs:[], // today's completions
    reception:[] // reception logs in memory (last 30 days)
  },
  viewHistory:[],closed:new Set(),debounceTimer:null,saveTimers:{},

  // ‚îÄ‚îÄ TOASTS / HELPERS ‚îÄ‚îÄ
  ok:m=>toast(m,'ok'),err:m=>toast(m,'err',5000),warn:m=>toast(m,'warn'),info:m=>toast(m,'info'),

  // ‚îÄ‚îÄ OFFLINE ‚îÄ‚îÄ
  initOffline(){
    const b=document.getElementById('offline-banner');
    window.addEventListener('offline',()=>b.classList.add('show'));
    window.addEventListener('online', ()=>b.classList.remove('show'));
    if(!navigator.onLine)b.classList.add('show');
  },

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
  auth:{
    login:async function(){
      const e=(document.getElementById('login-email').value||'').trim();
      const p=(document.getElementById('login-pass').value||'').trim();
      const box=document.getElementById('login-error');
      box.style.display='none';
      if(!e||!p){box.style.display='block';box.textContent='Email et mot de passe requis.';return;}
      const btn=document.getElementById('login-btn');
      btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
      try{await signInWithEmailAndPassword(auth,e,p);document.getElementById('login-pass').value='';}
      catch(err){box.style.display='block';box.textContent='Connexion refus√©e. V√©rifie l\'email / mot de passe.';}
      finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-right-to-bracket"></i> CONNEXION';}
    },
    forgot:async function(){
      const e=(document.getElementById('login-email').value||'').trim();
      const box=document.getElementById('login-error');
      if(!e){box.style.display='block';box.textContent='Tape ton email puis clique "Mot de passe oubli√©".';return;}
      try{await sendPasswordResetEmail(auth,e);toast('Email de r√©initialisation envoy√©.','ok');}
      catch(err){box.style.display='block';box.textContent='Impossible d\'envoyer le reset.';}
    },
    logout:async function(){
      if(window.app._todoUnsubscribe){try{window.app._todoUnsubscribe();}catch(e){}}
      try{await signOut(auth);}catch(e){}
    }
  },

  saveDebounced(sec,delay=350){
    if(this.saveTimers[sec])clearTimeout(this.saveTimers[sec]);
    this.saveTimers[sec]=setTimeout(async()=>{try{await this.save(sec);}catch(e){}},delay);
  },

  loadAll:async function(){
    const[uS,fS,pS,sS,frS,tdS]=await Promise.all([
      getDoc(docUsers),getDoc(docFrais),getDoc(docPVP),getDoc(docSalad),getDoc(docFrigo),getDoc(docTodo)
    ]);
    this.data.users=uS.exists()?(uS.data().list||[]):[];
    this.data.frais=fS.exists()?(fS.data().list||[]):[];
    if(pS.exists()){const d=pS.data();this.data.pvpLib=d.lib||[];this.data.pvpStock=d.stock||[];this.data.checkedNeeds=d.needs||[];}
    else{this.data.pvpLib=[];this.data.pvpStock=[];this.data.checkedNeeds=[];}
    if(sS.exists()){const d=sS.data();this.data.saladLib=d.lib||[];this.data.saladStock=d.stock||[];}
    else{this.data.saladLib=[];this.data.saladStock=[];}
    if(frS.exists()){const d=frS.data()||{};this.data.frigo.perDay=Number(d.perDay||2);this.data.frigo.fridges=d.fridges||[];this.data.frigo.logs=d.logs||[];}
    else{this.data.frigo={perDay:2,fridges:[],logs:[]};}
    if(tdS.exists()){const d=tdS.data()||{};this.data.todo.zones=d.zones||[];this.data.todo.tasks=d.tasks||[];}
    else{this.data.todo={zones:[],tasks:[]};}
  },

  _todoUnsubscribe:null,

  _startTodoSync(){
    if(this._todoUnsubscribe){try{this._todoUnsubscribe();}catch(e){}}
    const today=todayStr();
    try{
      const q=query(colTodoLogs,where("date","==",today));
      this._todoUnsubscribe=onSnapshot(q,snap=>{
        this.data.todoLogs=[];
        snap.forEach(d=>this.data.todoLogs.push({_id:d.id,...d.data()}));
        this.todo.renderToday();
        this.updateHomeBadges();
      },err=>{/* silently ignore permission errors */});
    }catch(e){}
  },

  loadReceptionLogs:async function(){
    try{
      const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);
      const cutTs=cutoff.getTime();
      const q=query(colReception,where("ts",">=",cutTs),orderBy("ts","desc"),limit(200));
      const snap=await getDocs(q);
      this.data.reception=[];
      snap.forEach(d=>this.data.reception.push({_id:d.id,...d.data()}));
    }catch(e){this.data.reception=[];}
  },

  loadTodoLogs:async function(){
    // Load today's completions
    const today=todayStr();
    try{
      const q=query(colTodoLogs,where("date","==",today));
      const snap=await getDocs(q);
      this.data.todoLogs=[];
      snap.forEach(d=>this.data.todoLogs.push({_id:d.id,...d.data()}));
    }catch(e){this.data.todoLogs=[];}
  },

  save:async function(sec){
    if(!auth.currentUser)throw new Error("Not logged");
    if(sec==='users')await setDoc(docUsers,{list:this.data.users});
    if(sec==='frais')await setDoc(docFrais,{list:this.data.frais});
    if(sec==='pvp')  await setDoc(docPVP,  {lib:this.data.pvpLib,stock:this.data.pvpStock,needs:this.data.checkedNeeds});
    if(sec==='salad')await setDoc(docSalad,{lib:this.data.saladLib,stock:this.data.saladStock});
    if(sec==='frigo')await setDoc(docFrigo,{perDay:Number(this.data.frigo.perDay||2),fridges:this.data.frigo.fridges||[],logs:this.data.frigo.logs||[]});
    if(sec==='todo') await setDoc(docTodo, {zones:this.data.todo.zones||[],tasks:this.data.todo.tasks||[]});
  },

  afterLoginBootstrap:async function(){
    spin(true);
    try{
      await this.loadAll();
      if(!this.data.users.length){
        const email=auth.currentUser.email||"";
        const name=(email.split("@")[0]||"ADMIN").toUpperCase();
        this.data.users=[{uid:auth.currentUser.uid,email,name,role:"admin"}];
        await this.save("users");
      }
      if(!this.data.saladLib.length){
        this.data.saladLib=SALAD_DEF.map(x=>({id:Date.now()+Math.floor(Math.random()*1000000),family:x.family,name:x.name,hours:x.hours}));
        await this.save("salad");
      }
      this.me=this.data.users.find(u=>u.uid===auth.currentUser.uid)||null;
      if(!this.me){toast('Compte non autoris√©.','err');await signOut(auth);return;}

      await this.loadTodoLogs();
      await this.loadReceptionLogs();

      // Start real-time sync for today's todo logs
      this._startTodoSync();

      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('app-header').classList.remove('hidden');
      document.getElementById('app-nav').classList.remove('hidden');
      document.getElementById('user-badge').innerText=this.me.name||(this.me.email||"USER");
      if(this.me.role==='admin')document.getElementById('btn-team').classList.remove('hidden');
      else document.getElementById('btn-team').classList.add('hidden');

      // Show/hide create buttons based on permissions
      const pvpCreateBtn=document.getElementById('pvp-create-btn');
      if(pvpCreateBtn)pvpCreateBtn.style.display=this.canDo('pvpLib')?'':'none';
      const saladCreateBtn=document.getElementById('salad-create-btn');
      if(saladCreateBtn)saladCreateBtn.style.display=this.canDo('saladLib')?'':'none';

      this.updateUI();
    }finally{spin(false);}
  },

  updateUI(){
    this.frais.render();this.pvp.render();this.salad.render();
    this.frigo.render();this.todo.renderToday();
    this.team.renderUsers();this.checkAlerts();this.updateHomeBadges();
  },

  updateHomeBadges(){
    // Frais
    const today=new Date();today.setHours(0,0,0,0);
    const fraisCnt=this.data.frais.filter(i=>{const d=new Date(i.date);return !isNaN(d.getTime())&&d<=today;}).length;
    const bf=document.getElementById('badge-frais');
    if(bf){bf.textContent=fraisCnt;bf.classList.toggle('hidden',fraisCnt===0);}
    const chip=document.getElementById('frais-today-chip');
    if(chip)chip.innerHTML=`<i class="fas fa-calendar-day"></i> ${fraisCnt}`;

    // Frigo
    const frigoRem=this.frigo.remainingTodayTotal();
    const bfr=document.getElementById('badge-frigo');
    if(bfr){bfr.textContent=frigoRem;bfr.classList.toggle('hidden',frigoRem===0);}
    const frigoChip=document.getElementById('frigo-remaining-chip');
    if(frigoChip)frigoChip.innerHTML=`<i class="fas fa-list-check"></i> ${frigoRem}`;
    const frigoLabel=document.getElementById('frigo-perday-label');
    if(frigoLabel)frigoLabel.textContent=this.data.frigo.perDay||2;

    // Todo
    const todayTasks=this.todo.todayTaskList();
    const doneTodayIds=new Set(this.data.todoLogs.map(l=>String(l.taskId)));
    const pending=todayTasks.filter(t=>!doneTodayIds.has(String(t.id))).length;
    const bt=document.getElementById('badge-todo');
    if(bt){bt.textContent=pending;bt.classList.toggle('hidden',pending===0);}
  },

  nav(v,saveHistory=true){
    if(this.frais&&this.frais.scanning)this.frais.toggleScan();
    if(this.frais&&this.frais.tgtgScanning)this.frais.tgtgToggleScan();
    const cur=document.querySelector('main > div:not(.hidden)');
    if(saveHistory&&cur)this.viewHistory.push(cur.id.replace('view-',''));
    document.querySelectorAll('main > div').forEach(e=>e.classList.add('hidden'));
    document.getElementById('view-'+v).classList.remove('hidden');
    if(v==='todo'){this.todo.renderToday();this.todo.tab('today');}
    if(v==='reception'){this.reception.init();this.reception.tab('new');}
    if(v==='inspection'){this.inspection.render();}
    if(v==='etiquettes'){this.etiquettes.loadProducts();}
  },
  goBack(){if(this.viewHistory.length)this.nav(this.viewHistory.pop(),false);else this.nav('home',false);},
  toggleFam(id){if(this.closed.has(id))this.closed.delete(id);else this.closed.add(id);this.updateUI();},
  checkAlerts(){
    const a=this.data.frais.some(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&(d-new Date())/(1000*60*60*24)<1;});
    document.getElementById('alert-box').style.display=a?'block':'none';
  },

  common:{
    showBarcode(ean,name,imgUrl=null){
      document.getElementById('modal-barcode').classList.remove('hidden');
      document.getElementById('bc-name').innerText=name||"";
      const imgEl=document.getElementById('bc-img-display');
      if(imgUrl){imgEl.src=imgUrl;imgEl.style.display='block';}else{imgEl.style.display='none';}
      if(ean){try{JsBarcode("#barcode",ean,{format:"EAN13",height:80,displayValue:true});}catch(e){try{JsBarcode("#barcode",ean,{format:"CODE128",height:80,displayValue:true});}catch(e2){}}}
      else{try{document.querySelector("#barcode").innerHTML="";}catch(e){}}
    },
    parseDateLocal(dateStr){if(!dateStr)return null;const p=dateStr.split('-');return new Date(p[0],p[1]-1,p[2],12,0,0).getTime();},
    dateToInputLocal(ts){if(!ts)return"";const d=new Date(ts);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;},
    tsToInput,formatDate,inputToTs,dayBounds,
    calculateEnd(startTs,hours){
      const h=parseInt(hours||0,10);
      if(h===0){
        // JOURN√âE ‚Üí fin du jour courant √† 22:00
        const d=new Date(startTs);
        return new Date(d.getFullYear(),d.getMonth(),d.getDate(),22,0,0,0).getTime();
      }
      // Calcul en millisecondes pur ‚Äî fiable quelle que soit la dur√©e
      return startTs + h * 3600 * 1000;
    },
    cleanName(name){return(name||"").toUpperCase().replace(/^[\d\s\.,xX]+(G|KG|ML|CL|L|P)?\s*/g,'');},
    randPwd(len=14){const c="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";let o="";for(let i=0;i<len;i++)o+=c[Math.floor(Math.random()*c.length)];return o;},
    compressImg(file,callback){const r=new FileReader();r.readAsDataURL(file);r.onload=e=>{const img=new Image();img.src=e.target.result;img.onload=()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');const mx=600;let w=img.width,h=img.height;if(w>h){if(w>mx){h*=mx/w;w=mx;}}else{if(h>mx){w*=mx/h;h=mx;}}c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);callback(c.toDataURL('image/jpeg',0.7));};};},
    isASaisir(dlcTs){if(!dlcTs)return false;const dlc=new Date(dlcTs);if(isNaN(dlc.getTime()))return false;const thr=new Date(dlc.getFullYear(),dlc.getMonth(),dlc.getDate()-1,18,0,0,0).getTime();const eod=new Date(dlc.getFullYear(),dlc.getMonth(),dlc.getDate(),23,59,59,999).getTime();const now=Date.now();return now>=thr&&now<=eod;}
  },

  // ‚îÄ‚îÄ PERMISSIONS ‚îÄ‚îÄ
  // D√©finition de toutes les permissions disponibles
  PERMS:{
    saladLib:    {label:'Modifier biblioth√®que Salad Bar', icon:'fa-leaf'},
    saladStock:  {label:'Saisir stock Salad Bar',         icon:'fa-bowl-food'},
    pvpLib:      {label:'Modifier biblioth√®que PVP',      icon:'fa-store'},
    pvpStock:    {label:'Saisir stock PVP',               icon:'fa-boxes-stacked'},
    frigoConfig: {label:'Configurer les frigos',          icon:'fa-temperature-low'},
    frigoSaisie: {label:'Saisir relev√©s frigo',           icon:'fa-pen-to-square'},
    todoConfig:  {label:'Configurer la check-list',       icon:'fa-list-check'},
    todoSaisie:  {label:'Valider t√¢ches check-list',      icon:'fa-circle-check'},
    fraisEdit:   {label:'Modifier / supprimer Frais',     icon:'fa-calendar-xmark'},
  },

  // V√©rifie si l'utilisateur courant peut faire une action
  // admin = tout par d√©faut, staff = selon permissions
  canDo(perm){
    const me=this.me;
    if(!me)return false;
    if(me.role==='admin')return true;
    if(me.permissions&&me.permissions[perm]===true)return true;
    return false;
  },

  // ‚îÄ‚îÄ TEAM ‚îÄ‚îÄ
  team:{
    ensureAdmin(){if(!window.app.me||window.app.me.role!=='admin'){toast('Acc√®s admin requis.','err');return false;}return true;},
    createStaff:async function(){
      if(!this.ensureAdmin())return;
      const name=(document.getElementById('new-u-name').value||'').trim().toUpperCase();
      const email=(document.getElementById('new-u-email').value||'').trim().toLowerCase();
      const role=document.getElementById('new-u-role').value||'staff';
      if(!name||!email)return toast('Nom + email requis.','warn');
      if(window.app.data.users.some(u=>(u.email||'').toLowerCase()===email))return toast('Email d√©j√† pr√©sent.','warn');
      spin(true);
      try{
        const tmp=window.app.common.randPwd();
        const cred=await createUserWithEmailAndPassword(secAuth,email,tmp);
        window.app.data.users.push({uid:cred.user.uid,email,name,role});
        await window.app.save('users');
        await sendPasswordResetEmail(secAuth,email);
        try{await signOut(secAuth);}catch(e){}
        document.getElementById('new-u-name').value='';document.getElementById('new-u-email').value='';
        toast('Compte cr√©√© + email reset envoy√©.','ok');this.renderUsers();
      }catch(e){
        const code=String(e?.code||'');
        if(code.includes('email-already-in-use'))toast('Email d√©j√† utilis√©.','err');
        else if(code.includes('invalid-email'))toast('Email invalide.','err');
        else toast('Erreur cr√©ation compte.','err');
        try{await signOut(secAuth);}catch(err){}
      }finally{spin(false);}
    },
    resetPwd:async function(email){if(!this.ensureAdmin())return;if(!email)return;try{await sendPasswordResetEmail(auth,email);toast('Reset envoy√©.','ok');}catch(e){toast('Impossible d\'envoyer le reset.','err');}},
    setRole:async function(uid,role){if(!this.ensureAdmin())return;const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;u.role=role;await window.app.save('users');this.renderUsers();},
    setName:async function(uid){if(!this.ensureAdmin())return;const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;const n=await dlgPrompt('Nom :',u.name||'');if(!n)return;u.name=n.trim().toUpperCase();await window.app.save('users');this.renderUsers();},
    renderUsers(){
      const wrap=document.getElementById('user-list');if(!wrap)return;
      const users=(window.app.data.users||[]).slice().sort((a,b)=>(a.role||'').localeCompare(b.role||'')||(a.name||'').localeCompare(b.name||''));
      if(!users.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-users-slash"></i>Aucun utilisateur.</div>`;return;}
      wrap.innerHTML=users.map(u=>{
        const chip=u.role==='admin'?`<span class="chip admin">ADMIN</span>`:`<span class="chip staff">STAFF</span>`;
        const permsBlock=u.role==='staff'?`
          <div style="margin-top:10px;">
            <div style="font-size:11px;font-weight:950;text-transform:uppercase;color:#64748b;margin-bottom:8px;">Permissions</div>
            <div class="perm-grid">
              ${Object.entries(window.app.PERMS).map(([key,def])=>`
              <div class="perm-toggle">
                <label for="perm-${u.uid}-${key}"><i class="fas ${def.icon}" style="margin-right:5px;color:#64748b;"></i>${def.label}</label>
                <input type="checkbox" id="perm-${u.uid}-${key}" ${(u.permissions||{})[key]?'checked':''} onchange="app.team.togglePerm('${u.uid}','${key}',this.checked)">
              </div>`).join('')}
            </div>
          </div>`:'<div class="small" style="margin-top:6px;color:var(--muted);">Admin : acc√®s complet √† tout.</div>';
        return `<div style="padding:12px;border-bottom:1px solid #eee;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="min-width:0;"><div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.name||"(Sans nom)"} ${chip}</div><div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email||""}</div></div>
            <div style="display:flex;gap:8px;flex-shrink:0;">
              <button class="qty-btn" onclick="app.team.setName('${u.uid}')"><i class="fas fa-pen"></i></button>
              <button class="qty-btn" onclick="app.team.resetPwd('${u.email||''}')"><i class="fas fa-unlock-keyhole"></i></button>
            </div>
          </div>
          <div style="margin-top:10px;">
            <select onchange="app.team.setRole('${u.uid}',this.value)" style="margin:0;padding:10px;font-size:14px;">
              <option value="staff" ${u.role==='staff'?'selected':''}>staff</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
            </select>
          </div>
          ${permsBlock}
        </div>`;
      }).join('');
    },

    togglePerm:async function(uid,perm,val){
      if(!this.ensureAdmin())return;
      const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;
      if(!u.permissions)u.permissions={};
      u.permissions[perm]=val;
      try{await window.app.save('users');toast(val?'Permission accord√©e.':'Permission retir√©e.','ok');}
      catch(e){toast('Erreur sauvegarde.','err');}
    }
  },

  // ‚îÄ‚îÄ TRACE ‚îÄ‚îÄ
  trace:{
    ctx:null,imgData:'',
    open:async function(mod,pid,name){
      document.getElementById('trace-file').value='';
      this.ctx={moduleKey:mod,productId:String(pid),productName:name||''};
      this.imgData='';
      document.getElementById('trace-preview').style.display='none';document.getElementById('trace-preview').src='';
      document.getElementById('trace-title').textContent=name||'';
      const h3=document.getElementById('trace-h3');
      const bp=document.getElementById('trace-btn-pick');
      const bs=document.getElementById('trace-btn-save');
      if(mod==='salad'){h3.style.color='var(--salad)';bp.className='btn salad';bs.className='btn salad';}
      else{h3.style.color='var(--pvp)';bp.className='btn pvp';bs.className='btn pvp';}
      document.getElementById('modal-trace').classList.remove('hidden');
      await this.loadHistory(true);
    },
    close(){document.getElementById('modal-trace').classList.add('hidden');this.ctx=null;this.imgData='';document.getElementById('trace-file').value='';},
    loadHistory:async function(cleanup=false){
      const wrap=document.getElementById('trace-history');wrap.textContent='Chargement‚Ä¶';
      const ctx=this.ctx;if(!ctx)return(wrap.textContent='‚Äî');
      const cutoff=Date.now()-(180*24*60*60*1000);
      if(cleanup){try{const qOld=query(colTraceFor(ctx.moduleKey,ctx.productId),where("createdAt","<",cutoff),limit(50));const s=await getDocs(qOld);const dels=[];s.forEach(d=>dels.push(deleteDoc(d.ref)));if(dels.length)await Promise.allSettled(dels);}catch(e){}}
      try{
        const q=query(colTraceFor(ctx.moduleKey,ctx.productId),orderBy("createdAt","desc"),limit(15));
        const snap=await getDocs(q);const rows=[];
        snap.forEach(d=>{const dt=d.data();if((dt.createdAt||0)>=cutoff)rows.push({_docId:d.id,...dt});});
        if(!rows.filter(r=>r.path).length){wrap.innerHTML="<div class='small'>Aucune photo r√©cente.</div>";return;}
        wrap.innerHTML=rows.filter(r=>r.path).map(r=>{
          const when=formatDate(r.createdAt);
          const sp=(r.path||'').replace(/'/g,"\\'");const si=(r._docId||'').replace(/'/g,"\\'");
          return `<div style="padding:10px;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="min-width:0;"><div style="font-weight:900;">${when}</div><div class="small" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.path||''}</div></div>
            <div style="display:flex;gap:8px;flex-shrink:0;">
              <button class="icon-btn dark" onclick="app.trace.view('${sp}')"><i class="fas fa-eye"></i></button>
              <button class="icon-btn red"  onclick="app.trace.delOne('${si}','${sp}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
        }).join('');
      }catch(e){wrap.innerHTML="<div class='small'>Impossible de charger (Firestore rules).</div>";}
    },
    view:async function(path){if(!path)return;try{const url=await getDownloadURL(sRef(storage,path));window.app.common.showBarcode("","Tracabilit√©",url);}catch(e){toast('Photo introuvable.','err');}},
    delOne:async function(docId,path){
      const ctx=this.ctx;if(!ctx||!docId)return;
      const ok=await dlgConfirm('Supprimer photo','Supprimer cette tracabilit√© ?');if(!ok)return;
      try{await deleteDoc(doc(db,TRACE_PREFIX[ctx.moduleKey],String(ctx.productId),"items",String(docId)));}catch(e){}
      try{if(path)await deleteObject(sRef(storage,path));}catch(e){}
      await this.loadHistory(false);
    },
    save:async function(){
      const ctx=this.ctx;if(!ctx)return;if(!this.imgData)return toast('Aucune photo.','warn');
      const ts=Date.now();const d=new Date(ts);
      const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const sid=String(ctx.productId).replace(/[^a-zA-Z0-9_-]/g,'_');
      const path=`${TRACE_PREFIX[ctx.moduleKey]}/${sid}/${ym}/${ts}.jpg`;
      spin(true);
      try{
        await uploadString(sRef(storage,path),this.imgData,'data_url');
        await addDoc(colTraceFor(ctx.moduleKey,ctx.productId),{productId:String(ctx.productId),productName:ctx.productName,createdAt:ts,path});
        toast('Tracabilit√© enregistr√©e.','ok');
        this.imgData='';document.getElementById('trace-preview').style.display='none';document.getElementById('trace-preview').src='';document.getElementById('trace-file').value='';
        await this.loadHistory(true);
      }catch(e){toast('Erreur tracabilit√©.','err');}
      finally{spin(false);}
    }
  },

  // ‚îÄ‚îÄ FRAIS ‚îÄ‚îÄ
  frais:{
    scanning:false,tgtgScanning:false,imgUrl:'',
    tab(t){
      document.querySelectorAll('#view-frais .tab').forEach(e=>e.classList.remove('active'));
      const tabMap={scan:'tf-1',tgtg:'tf-3',list:'tf-2'};
      document.getElementById(tabMap[t]).classList.add('active');
      ['frais-scan','frais-tgtg','frais-list'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('frais-'+t).classList.remove('hidden');
      if(t==='list'){this.render();}
      if(t==='tgtg'){this.renderTgtg();}
    },
    toggleScan(){
      if(this.scanning){this.scanning=false;document.getElementById('scanner-box').style.display='none';try{codeReader.reset();}catch(e){}}
      else{this.scanning=true;document.getElementById('scanner-box').style.display='block';codeReader.decodeFromVideoDevice(null,'video',(r)=>{if(r){this.handleInput(r.text);this.toggleScan();}});}
    },
    tgtgToggleScan(){
      if(this.tgtgScanning){this.tgtgScanning=false;document.getElementById('tgtg-scanner-box').style.display='none';try{codeReader.reset();}catch(e){}}
      else{this.tgtgScanning=true;document.getElementById('tgtg-scanner-box').style.display='block';codeReader.decodeFromVideoDevice(null,'tgtg-video',(r)=>{if(r){this.tgtgHandleScan(r.text);this.tgtgToggleScan();}});}
    },
    tgtgHandleScan(ean){
      // Find product by EAN in frais list and deduct qty
      const match=window.app.data.frais.find(i=>String(i.ean||'')===String(ean));
      if(match){this.tgtgDeduct(match.id,true);}
      else{document.getElementById('tgtg-search').value=ean;this.renderTgtg();}
    },
    tgtgDeduct:async function(id,fromScan=false){
      const idx=window.app.data.frais.findIndex(x=>x.id==id);
      if(idx<0)return;
      const item=window.app.data.frais[idx];
      const currentQty=Number(item.qty||0);
      if(currentQty<=1){
        // Remove completely
        window.app.data.frais.splice(idx,1);
        toast(`${item.name} retir√© du stock (Too Good To Go)`,fromScan?'ok':'info',3000);
      } else {
        window.app.data.frais[idx].qty=currentQty-1;
        toast(`${item.name} : ${currentQty}‚Üí${currentQty-1}`,'ok',2000);
      }
      spin(true);try{await window.app.save('frais');}catch(e){toast('Erreur synchro.','err');}finally{spin(false);}
      this.renderTgtg();this.render();window.app.updateHomeBadges();
    },
    renderTgtg(){
      const wrap=document.getElementById('tgtg-result-list');if(!wrap)return;
      const q=(document.getElementById('tgtg-search')?.value||'').toLowerCase().trim();
      const today=new Date();today.setHours(0,0,0,0);
      // Show products expiring today or with search
      const items=window.app.data.frais.filter(i=>{
        if(q){return(i.name||'').toLowerCase().includes(q)||(i.ean||'').includes(q);}
        const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;
      }).sort((a,b)=>new Date(a.date)-new Date(b.date));
      if(!items.length){
        wrap.innerHTML=`<div class="empty-state" style="padding:20px 0;"><i class="fas fa-check-circle" style="color:#006B3C;"></i>${q?'Aucun r√©sultat':'Aucun produit √† retirer aujourd\'hui üéâ'}</div>`;
        return;
      }
      wrap.innerHTML=items.map(i=>{
        const d=new Date(i.date);const dateStr=!isNaN(d.getTime())?d.toLocaleDateString('fr'):'?';
        return`<div class="list-item" style="border-left:4px solid #006B3C;">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:900;font-size:14px;">${i.name||''}</div>
            <div class="small">x${i.qty||0} ‚Ä¢ DLC: ${dateStr} ‚Ä¢ ${i.fam||''}</div>
          </div>
          <button onclick="app.frais.tgtgDeduct(${i.id})" style="background:#006B3C;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;white-space:nowrap;"><i class="fas fa-minus"></i> -1</button>
        </div>`;
      }).join('');
    },
    handleInput(val){
      const clean=String(val||'').replace(/\D/g,'').slice(0,13);
      document.getElementById('frais-ean').value=clean;
      if(window.app.debounceTimer)clearTimeout(window.app.debounceTimer);
      window.app.debounceTimer=setTimeout(()=>{if(clean.length===13)this.api(clean);},250);
    },
    api:async function(ean){try{const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);const d=await r.json();if(d.status==1){document.getElementById('frais-name').value=d.product.product_name_fr||'';this.imgUrl=d.product.image_front_small_url||'';}}catch(e){}},
    add:async function(){
      const dateVal=document.getElementById('frais-date').value;
      const name=document.getElementById('frais-name').value;
      if(!name||!dateVal){toast('Nom et date requis.','warn');return;}
      const o={id:Date.now(),ean:document.getElementById('frais-ean').value,fam:document.getElementById('frais-fam').value,name,qty:document.getElementById('frais-qty').value,date:window.app.common.parseDateLocal(dateVal),img:this.imgUrl};
      window.app.data.frais.push(o);
      spin(true);try{await window.app.save('frais');toast('Produit ajout√©.','ok');}catch(e){toast('Erreur sauvegarde.','err');}finally{spin(false);}
      this.imgUrl='';document.getElementById('frais-name').value='';document.getElementById('frais-ean').value='';
      window.app.updateHomeBadges();
    },
    render(){
      const div=document.getElementById('frais-list-items');if(!div)return;
      const q=(document.getElementById('frais-search')?.value||'').toLowerCase().trim();
      const grp={};
      const filtered=q?window.app.data.frais.filter(i=>(i.name||'').toLowerCase().includes(q)||(i.fam||'').toLowerCase().includes(q)||(i.ean||'').includes(q)):window.app.data.frais;
      filtered.slice().sort((a,b)=>(a.fam||'').localeCompare(b.fam||'')||(a.date||0)-(b.date||0)).forEach(i=>{if(!grp[i.fam])grp[i.fam]=[];grp[i.fam].push(i);});
      if(!Object.keys(grp).length){div.innerHTML=`<div class="empty-state"><i class="fas fa-box-open"></i>Aucun produit frais.</div>`;return;}
      const parts=[];
      for(const f in grp){
        const id='F-'+f;const c=window.app.closed.has(id);
        parts.push(`<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
        if(c)continue;
        grp[f].forEach(i=>{
          const d=new Date(i.date);let badge='bg-grey';
          if(!isNaN(d.getTime())){const diff=(d-new Date())/(1000*60*60*24);badge=diff<0?'bg-red':(diff<2?'bg-orange':'bg-green');}
          const sn=(i.name||'').replace(/'/g,' ');
          const img=i.img?`<img src="${i.img}" class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${sn}','${i.img}')">`:`<div class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${sn}')"><i class="fas fa-barcode"></i></div>`;
          const sc=window.app.common.isASaisir(i.date)?`<span class="chip warn"><i class="fas fa-triangle-exclamation"></i> √Ä SAISIR</span>`:'';
          parts.push(`<div class="swipe-wrapper"><div class="swipe-content" onclick="app.frais.openEdit(${i.id})">
            <div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div class="item-info"><div class="item-title">${i.name||''}</div><div class="item-sub">x${i.qty||0} ‚Ä¢ ${i.ean||'EAN ?'} ${sc}</div></div></div>
            <div class="right-col"><div class="date-badge ${badge}"><span>${!isNaN(d.getTime())?d.getDate():'?'}</span><span style="font-size:10px;">${!isNaN(d.getTime())?d.toLocaleString('fr',{month:'short'}):'Err'}</span></div></div>
          </div></div>`);
        });
      }
      div.innerHTML=parts.join('');
    },
    openEdit(id){
      if(!window.app.canDo('fraisEdit')){toast('Permission refus√©e.','err');return;}
      const i=window.app.data.frais.find(x=>x.id==id);
      document.getElementById('modal-edit-frais').classList.remove('hidden');
      document.getElementById('edit-id').value=id;document.getElementById('edit-famille').value=i.fam;
      document.getElementById('edit-qty').value=i.qty;document.getElementById('edit-name').value=i.name;
      document.getElementById('edit-ean').value=i.ean;document.getElementById('edit-date').value=window.app.common.dateToInputLocal(i.date);
    },
    saveEdit:async function(){
      const id=document.getElementById('edit-id').value;
      const idx=window.app.data.frais.findIndex(x=>String(x.id)===String(id));
      if(idx>-1){
        window.app.data.frais[idx].fam=document.getElementById('edit-famille').value;
        window.app.data.frais[idx].qty=document.getElementById('edit-qty').value;
        window.app.data.frais[idx].name=document.getElementById('edit-name').value;
        window.app.data.frais[idx].ean=document.getElementById('edit-ean').value;
        window.app.data.frais[idx].date=window.app.common.parseDateLocal(document.getElementById('edit-date').value);
        spin(true);try{await window.app.save('frais');}catch(e){toast('Erreur.','err');}finally{spin(false);}
        document.getElementById('modal-edit-frais').classList.add('hidden');
        this.render();window.app.checkAlerts();window.app.updateHomeBadges();toast('Modifi√©.','ok');
      }
    },
    del:async function(){
      const ok=await dlgConfirm('Supprimer','Supprimer ce produit ?');if(!ok)return;
      const id=document.getElementById('edit-id').value;
      window.app.data.frais=window.app.data.frais.filter(x=>String(x.id)!==String(id));
      spin(true);try{await window.app.save('frais');toast('Supprim√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-edit-frais').classList.add('hidden');
      this.render();window.app.checkAlerts();window.app.updateHomeBadges();
    }
  },

  // ‚îÄ‚îÄ PVP ‚îÄ‚îÄ
  pvp:{
    tab(t){
      document.querySelectorAll('#view-pvp .tab').forEach(e=>e.classList.remove('active-pvp'));
      document.getElementById(t==='stock'?'tp-1':(t==='bib'?'tp-2':'tp-3')).classList.add('active-pvp');
      ['pvp-stock','pvp-bib','pvp-calc'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('pvp-'+t).classList.remove('hidden');
    },
    toggleFamInput(){const v=document.getElementById('lib-fam-select').value;document.getElementById('lib-fam-new').classList.toggle('hidden',v!=='new');},
    openLib(id=null){
      if(!window.app.canDo('pvpLib')){toast('Permission refus√©e.','err');return;}
      document.getElementById('modal-pvp-lib').classList.remove('hidden');
      const uF=[...new Set(window.app.data.pvpLib.map(i=>i.family||'DIVERS'))].sort();
      document.getElementById('lib-fam-select').innerHTML=uF.map(f=>`<option value="${f}">${f}</option>`).join('')+`<option value="new">+ Cr√©er...</option>`;
      if(id){const i=window.app.data.pvpLib.find(x=>x.id==id);document.getElementById('lib-id').value=id;document.getElementById('lib-name').value=i.name;document.getElementById('lib-ean').value=i.ean||'';document.getElementById('lib-days').value=i.days||0;document.getElementById('lib-img-data').value=i.img||'';document.getElementById('img-preview').src=i.img||'';document.getElementById('img-preview').style.display=i.img?'block':'none';document.getElementById('lib-fam-select').value=i.family||'DIVERS';for(let k=0;k<7;k++)document.getElementById('t-'+k).value=(i.targets||{})[k]||'';}
      else{document.getElementById('lib-id').value='';document.getElementById('lib-name').value='';document.getElementById('lib-ean').value='';document.getElementById('lib-img-data').value='';document.getElementById('img-preview').style.display='none';for(let k=0;k<7;k++)document.getElementById('t-'+k).value='';}
    },
    saveLib:async function(){
      if(!document.getElementById('lib-name').value.trim())return toast('Nom requis.','warn');
      const id=document.getElementById('lib-id').value;
      const fam=document.getElementById('lib-fam-select').value==='new'?(document.getElementById('lib-fam-new').value||'DIVERS').toUpperCase():document.getElementById('lib-fam-select').value;
      const o={id:id?Number(id):Date.now(),family:fam,name:document.getElementById('lib-name').value,ean:document.getElementById('lib-ean').value,img:document.getElementById('lib-img-data').value,days:document.getElementById('lib-days').value,targets:{}};
      for(let k=0;k<7;k++)o.targets[k]=document.getElementById('t-'+k).value;
      if(id){const idx=window.app.data.pvpLib.findIndex(x=>String(x.id)===String(id));if(idx>-1)window.app.data.pvpLib[idx]=o;}else window.app.data.pvpLib.push(o);
      spin(true);try{await window.app.save('pvp');toast('Enregistr√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-pvp-lib').classList.add('hidden');this.render();
    },
    delLib:async function(){
      const ok=await dlgConfirm('Supprimer produit','Supprimer ce produit de la biblioth√®que ?');if(!ok)return;
      const id=document.getElementById('lib-id').value;
      window.app.data.pvpLib=window.app.data.pvpLib.filter(x=>String(x.id)!==String(id));
      spin(true);try{await window.app.save('pvp');toast('Supprim√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-pvp-lib').classList.add('hidden');this.render();
    },
    addStock:async function(libId){
      if(!window.app.canDo('pvpStock')){toast('Permission refus√©e.','err');return;}
      const l=window.app.data.pvpLib.find(x=>x.id==libId);
      const q=await dlgPrompt('Quantit√© ?','1','number');
      if(q===null)return;
      const n=Number(q||0);if(n<=0)return toast('Quantit√© invalide.','warn');
      const now=Date.now();
      const end=window.app.common.calculateEnd(now,l.days);
      const entry={id:now,libId,name:l.name,ean:l.ean,qty:n,out:now,end,days:l.days};
      window.app.data.pvpStock.push(entry);
      this.render();
      spin(true);
      try{await window.app.save('pvp');toast(`${n}√ó ${l.name} sorti ‚Äî fin: ${formatDate(end)}`,'ok',4000);}
      catch(e){toast('Erreur sauvegarde.','err');}
      finally{spin(false);}
    },
    openEditStock(id){
      const i=window.app.data.pvpStock.find(x=>x.id==id);
      document.getElementById('modal-pvp-stock').classList.remove('hidden');
      document.getElementById('stock-id').value=id;document.getElementById('stock-name').innerText=i.name;
      document.getElementById('stock-qty').value=i.qty;document.getElementById('stock-start').value=tsToInput(i.out);document.getElementById('stock-end').value=tsToInput(i.end);
    },
    saveStock:async function(){
      const idx=window.app.data.pvpStock.findIndex(x=>String(x.id)===String(document.getElementById('stock-id').value));if(idx<0)return;
      const qty=Number(document.getElementById('stock-qty').value||0);
      const out=new Date(document.getElementById('stock-start').value).getTime();
      const end=new Date(document.getElementById('stock-end').value).getTime();
      if(!isFinite(qty)||qty<0)return toast('Quantit√© invalide.','warn');
      if(isNaN(out)||isNaN(end))return toast('Dates invalides.','warn');
      window.app.data.pvpStock[idx].qty=qty;window.app.data.pvpStock[idx].out=out;window.app.data.pvpStock[idx].end=end;
      document.getElementById('modal-pvp-stock').classList.add('hidden');
      this.render();
      spin(true);try{await window.app.save('pvp');toast('Mis √† jour.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
    },
    delStock:async function(){
      const ok=await dlgConfirm('Retirer','Retirer ce produit du rayon ?');if(!ok)return;
      const id=document.getElementById('stock-id').value;
      window.app.data.pvpStock=window.app.data.pvpStock.filter(x=>String(x.id)!==String(id));
      document.getElementById('modal-pvp-stock').classList.add('hidden');
      this.render();
      spin(true);try{await window.app.save('pvp');toast('Retir√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
    },
    changeQty:async function(id,delta){
      const idx=window.app.data.pvpStock.findIndex(x=>x.id==id);
      if(idx>-1){
        const n=Number(window.app.data.pvpStock[idx].qty||0)+delta;
        if(n<=0)window.app.data.pvpStock.splice(idx,1);else window.app.data.pvpStock[idx].qty=n;
        this.render();
        try{await window.app.save('pvp');}catch(e){toast('Erreur synchro.','err');}
      }
    },
    toggleNeed:async function(libId){
      const idx=window.app.data.checkedNeeds.indexOf(libId);
      if(idx>-1)window.app.data.checkedNeeds.splice(idx,1);else window.app.data.checkedNeeds.push(libId);
      this.render();try{await window.app.save('pvp');}catch(e){}
    },
    render(){
      const bib=document.getElementById('lib-list');
      if(bib){
        const q=(document.getElementById('pvp-search')?.value||'').toLowerCase().trim();
        const allLib=window.app.data.pvpLib.slice().sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)));
        const filtered=q?allLib.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.family||'').toLowerCase().includes(q)||(l.ean||'').includes(q)):allLib;

        if(!window.app.data.pvpLib.length){bib.innerHTML=`<div class="empty-state"><i class="fas fa-bread-slice"></i>Biblioth√®que vide.</div>`;}
        else if(!filtered.length){bib.innerHTML=`<div class="search-no-result"><i class="fas fa-magnifying-glass" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px;"></i>Aucun r√©sultat pour "<b>${q}</b>"</div>`;}
        else{
          const canEdit=window.app.canDo('pvpLib');
          const canStock=window.app.canDo('pvpStock');
          if(q){
            // En mode recherche : liste plate sans groupes
            bib.innerHTML=filtered.map(l=>{
              const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
              const sn=(l.name||'').replace(/'/g,' ');
              const fam=`<span class="chip" style="background:#f1f5f9;color:#475569;">${l.family||'DIVERS'}</span>`;
              return `<div class="list-item" onclick="app.common.showBarcode('${l.ean||''}','${sn}','${l.img||''}')">
                <div style="display:flex;align-items:center;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.days||0}h ‚Ä¢ ${fam}</div></div></div>
                <div class="right-col">
                  ${canEdit?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                  <button class="icon-btn dark" onclick="event.stopPropagation();app.trace.open('pvp','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                  ${canStock?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                </div>
              </div>`;
            }).join('');
          } else {
            // Mode normal : group√© par famille
            const gL={};filtered.forEach(l=>{const f=l.family||'DIVERS';if(!gL[f])gL[f]=[];gL[f].push(l);});
            const parts=[];Object.keys(gL).sort().forEach(f=>{
              const id='L-'+f;const c=window.app.closed.has(id);
              parts.push(`<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
              if(c)return;
              gL[f].forEach(l=>{
                const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
                const sn=(l.name||'').replace(/'/g,' ');
                parts.push(`<div class="list-item" onclick="app.common.showBarcode('${l.ean||''}','${sn}','${l.img||''}')">
                  <div style="display:flex;align-items:center;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.days||0}h ‚Ä¢ ${l.ean||'EAN ?'}</div></div></div>
                  <div class="right-col">
                    ${canEdit?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                    <button class="icon-btn dark" onclick="event.stopPropagation();app.trace.open('pvp','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                    ${canStock?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                  </div>
                </div>`);
              });
            });
            bib.innerHTML=parts.join('');
          }
        }
      }
      const st=document.getElementById('pvp-stock');
      if(st){
        if(!window.app.data.pvpStock.length){st.innerHTML=`<div class="empty-state"><i class="fas fa-store-slash"></i>Rayon vide.</div>`;return;}
        const gS={};window.app.data.pvpStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s=>{const l=window.app.data.pvpLib.find(x=>x.id==s.libId);const f=l?l.family:'DIVERS';if(!gS[f])gS[f]=[];gS[f].push(s);});
        const parts=[];Object.keys(gS).sort().forEach(f=>{const id='S-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--pvp)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(c)return;gS[f].forEach(i=>{const dS=formatDate(i.out);const dE=formatDate(i.end);const isExp=new Date(i.end)<new Date();const l=window.app.data.pvpLib.find(x=>x.id==i.libId);const img=l?.img?`<img src="${l.img}" class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${(i.name||'').replace(/'/g,' ')}','${l.img}')">`:`<div class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${(i.name||'').replace(/'/g,' ')}')"><i class="fas fa-bread-slice"></i></div>`;parts.push(`<div class="swipe-wrapper"><div class="swipe-content"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title" onclick="app.pvp.openEditStock(${i.id})">${i.name}</div><div class="qty-ctrl"><button class="qty-btn" onclick="app.pvp.changeQty(${i.id},-1)">-</button><b>${i.qty}</b><button class="qty-btn" onclick="app.pvp.changeQty(${i.id},1)">+</button></div></div></div><div class="right-col"><button class="icon-btn dark" onclick="app.trace.open('pvp','${i.libId}','${(i.name||'').replace(/'/g,' ')}')"><i class="fas fa-camera"></i></button><div class="date-col"><div class="d-lbl">Sortie: ${dS}</div><div class="d-val ${isExp?'expired':''}">FIN: ${dE}</div></div></div></div></div>`);});});
        st.innerHTML=parts.join('');
      }
      const cl=document.getElementById('pvp-calc');
      if(cl){
        const tom=new Date();tom.setDate(tom.getDate()+1);const tn=new Date(tom.getFullYear(),tom.getMonth(),tom.getDate(),12,0,0,0).getTime();
        const gT={};let doneH='';let hasNeeds=false;const avail={};
        window.app.data.pvpStock.forEach(s=>{if((s.end||0)>=tn)avail[s.libId]=(avail[s.libId]||0)+Number(s.qty||0);});
        window.app.data.pvpLib.forEach(l=>{const target=Number((l.targets||{})[tom.getDay()]||0);if(target<=0)return;const av=Number(avail[l.id]||0);const need=Math.max(0,target-av);if(need<=0)return;hasNeeds=true;const isC=window.app.data.checkedNeeds.includes(l.id);const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;const h=`<div class="list-item ${isC?'item-done':''}" style="border-left:5px solid var(--pvp);"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div style="color:var(--pvp);font-weight:950;">√Ä SORTIR : ${need} <span class="small">(objectif ${target} ‚Ä¢ dispo ${av})</span></div></div></div><div class="todo-check ${isC?'checked':''}" onclick="app.pvp.toggleNeed(${l.id})"><i class="fas fa-check"></i></div></div>`;if(isC)doneH+=h;else{const f=l.family||'DIVERS';if(!gT[f])gT[f]=[];gT[f].push(h);}});
        const parts=[`<h4 style="text-align:center;color:var(--primary);">√Ä SORTIR DEMAIN</h4>`];
        if(!hasNeeds)parts.push(`<div class="empty-state"><i class="fas fa-check-circle"></i>Rien de pr√©vu</div>`);
        else Object.keys(gT).sort().forEach(f=>{const id='N-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--primary)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(!c)parts.push(gT[f].join(''));});
        parts.push(`<h4 style="text-align:center;color:#64748b;margin-top:20px;">TERMIN√â</h4>`);
        parts.push(doneH||`<div class="empty-state" style="padding:20px;"><i class="fas fa-hourglass-start"></i>Rien de fait</div>`);
        cl.innerHTML=parts.join('');
      }
    }
  },

  // ‚îÄ‚îÄ SALAD ‚îÄ‚îÄ
  salad:{
    tab(t){document.querySelectorAll('#view-salad .tab').forEach(e=>e.classList.remove('active-salad'));document.getElementById(t==='stock'?'ts-1':'ts-2').classList.add('active-salad');document.getElementById('salad-stock').classList.add('hidden');document.getElementById('salad-bib').classList.add('hidden');document.getElementById('salad-'+t).classList.remove('hidden');},
    openLib(id=null){if(!window.app.canDo('saladLib')){toast('Permission refus√©e.','err');return;}document.getElementById('modal-salad-lib').classList.remove('hidden');if(id){const i=window.app.data.saladLib.find(x=>x.id==id);document.getElementById('sal-lib-id').value=i.id;document.getElementById('sal-lib-fam').value=i.family||'DIVERS';document.getElementById('sal-lib-name').value=i.name||'';document.getElementById('sal-lib-hours').value=String(i.hours||48);}else{document.getElementById('sal-lib-id').value='';document.getElementById('sal-lib-fam').value='SALADE';document.getElementById('sal-lib-name').value='';document.getElementById('sal-lib-hours').value='48';}},
    saveLib:async function(){if(!window.app.canDo('saladLib')){toast('Permission refus√©e.','err');return;}const id=document.getElementById('sal-lib-id').value;const name=(document.getElementById('sal-lib-name').value||'').trim();if(!name)return toast('Nom requis.','warn');const o={id:id?Number(id):Date.now(),family:document.getElementById('sal-lib-fam').value||'DIVERS',name,hours:Number(document.getElementById('sal-lib-hours').value||48)};if(id){const idx=window.app.data.saladLib.findIndex(x=>String(x.id)===String(id));if(idx>-1)window.app.data.saladLib[idx]=o;}else window.app.data.saladLib.push(o);document.getElementById('modal-salad-lib').classList.add('hidden');this.render();spin(true);try{await window.app.save('salad');toast('Enregistr√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);};},
    delLib:async function(){if(!window.app.canDo('saladLib')){toast('Permission refus√©e.','err');return;}const ok=await dlgConfirm('Supprimer','Supprimer ce produit ?');if(!ok)return;const id=document.getElementById('sal-lib-id').value;window.app.data.saladLib=window.app.data.saladLib.filter(x=>String(x.id)!==String(id));document.getElementById('modal-salad-lib').classList.add('hidden');this.render();spin(true);try{await window.app.save('salad');toast('Supprim√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);};},
    addStock:async function(libId){
      if(!window.app.canDo('saladStock')){toast('Permission refus√©e.','err');return;}
      const l=window.app.data.saladLib.find(x=>x.id==libId);
      if(!l)return toast('Produit introuvable.','err');
      const q=await dlgPrompt('Quantit√© ?','1','number');
      if(q===null)return;
      const n=Number(q||0);
      if(n<=0)return toast('Quantit√© invalide.','warn');
      const now=Date.now();
      const entry={id:now,libId,name:l.name,qty:n,out:now,end:window.app.common.calculateEnd(now,l.hours),hours:l.hours};
      window.app.data.saladStock.push(entry);
      spin(true);
      try{
        await window.app.save('salad');
        toast(`${n}√ó ${l.name} sorti ‚Äî fin: ${formatDate(entry.end)}`,'ok',4000);
        this.render();
      }catch(e){
        // Rollback on error
        window.app.data.saladStock=window.app.data.saladStock.filter(x=>x.id!==entry.id);
        toast('Erreur sauvegarde.','err');
      }finally{spin(false);}
    },
    changeQty:async function(id,delta){
      const idx=window.app.data.saladStock.findIndex(x=>x.id==id);
      if(idx>-1){
        const n=Number(window.app.data.saladStock[idx].qty||0)+delta;
        if(n<=0)window.app.data.saladStock.splice(idx,1);
        else window.app.data.saladStock[idx].qty=n;
        this.render();
        try{await window.app.save('salad');}catch(e){toast('Erreur synchro.','err');}
      }
    },
    openEditStock:async function(id){
      const i=window.app.data.saladStock.find(x=>x.id==id);
      const q=await dlgPrompt('Quantit√© :',String(i.qty||0),'number');
      if(q===null)return;
      const n=Number(q||0);
      if(n<=0)window.app.data.saladStock=window.app.data.saladStock.filter(x=>x.id!==id);
      else i.qty=n;
      this.render();
      try{await window.app.save('salad');}catch(e){toast('Erreur synchro.','err');}
    },
    render(){
      const bib=document.getElementById('salad-lib-list');
      if(bib){
        const q=(document.getElementById('salad-search')?.value||'').toLowerCase().trim();
        const allLib=window.app.data.saladLib.slice().sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)));
        const filtered=q?allLib.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.family||'').toLowerCase().includes(q)):allLib;

        if(!window.app.data.saladLib.length){bib.innerHTML=`<div class="empty-state"><i class="fas fa-bowl-food"></i>Biblioth√®que vide.</div>`;}
        else if(!filtered.length){bib.innerHTML=`<div class="search-no-result"><i class="fas fa-magnifying-glass" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px;"></i>Aucun r√©sultat pour "<b>${q}</b>"</div>`;}
        else{
          const canEdit=window.app.canDo('saladLib');
          const canStock=window.app.canDo('saladStock');
          if(q){
            bib.innerHTML=filtered.map(l=>{
              const sn=(l.name||'').replace(/'/g,' ');
              const fam=`<span class="chip" style="background:#f1f5f9;color:#475569;">${l.family||'DIVERS'}</span>`;
              return `<div class="list-item">
                <div style="display:flex;align-items:center;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.hours||48}h ‚Ä¢ ${fam}</div></div></div>
                <div class="right-col">
                  ${canEdit?`<button class="icon-btn salad" onclick="app.salad.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                  <button class="icon-btn dark" onclick="app.trace.open('salad','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                  ${canStock?`<button class="icon-btn salad" onclick="app.salad.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                </div>
              </div>`;
            }).join('');
          } else {
            const gL={};filtered.forEach(l=>{const f=l.family||'DIVERS';if(!gL[f])gL[f]=[];gL[f].push(l);});
            const parts=[];Object.keys(gL).sort().forEach(f=>{
              const id='SL-'+f;const c=window.app.closed.has(id);
              parts.push(`<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
              if(c)return;
              gL[f].forEach(l=>{
                const sn=(l.name||'').replace(/'/g,' ');
                parts.push(`<div class="list-item">
                  <div style="display:flex;align-items:center;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.hours||48}h</div></div></div>
                  <div class="right-col">
                    ${canEdit?`<button class="icon-btn salad" onclick="app.salad.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                    <button class="icon-btn dark" onclick="app.trace.open('salad','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                    ${canStock?`<button class="icon-btn salad" onclick="app.salad.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                  </div>
                </div>`);
              });
            });
            bib.innerHTML=parts.join('');
          }
        }
      }
      const st=document.getElementById('salad-stock');
      if(st){
        if(!window.app.data.saladStock.length){st.innerHTML=`<div class="empty-state"><i class="fas fa-store-slash"></i>Rayon vide.</div>`;return;}
        const gS={};window.app.data.saladStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s=>{const l=window.app.data.saladLib.find(x=>x.id==s.libId);const f=l?l.family:'DIVERS';if(!gS[f])gS[f]=[];gS[f].push(s);});
        const parts=[];Object.keys(gS).sort().forEach(f=>{const id='SS-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(c)return;gS[f].forEach(i=>{const dS=formatDate(i.out);const dE=formatDate(i.end);const isExp=new Date(i.end)<new Date();const sn=(i.name||'').replace(/'/g,' ');parts.push(`<div class="swipe-wrapper" style="background:#0b4f4a;"><div class="swipe-content"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title" onclick="app.salad.openEditStock(${i.id})">${i.name}</div><div class="qty-ctrl"><button class="qty-btn" onclick="app.salad.changeQty(${i.id},-1)">-</button><b>${i.qty}</b><button class="qty-btn" onclick="app.salad.changeQty(${i.id},1)">+</button></div></div></div><div class="right-col"><button class="icon-btn dark" onclick="app.trace.open('salad','${i.libId}','${sn}')"><i class="fas fa-camera"></i></button><div class="date-col"><div class="d-lbl">Sortie: ${dS}</div><div class="d-val ${isExp?'expired':''}">FIN: ${dE}</div></div></div></div></div>`);});});
        st.innerHTML=parts.join('');
      }
    }
  },

  // ‚îÄ‚îÄ FRIGO ‚îÄ‚îÄ
  frigo:{
    tab(t){document.querySelectorAll('#view-frigo .tab').forEach(e=>e.classList.remove('active-frigo'));document.getElementById(t==='take'?'tfr-1':(t==='fridges'?'tfr-2':'tfr-3')).classList.add('active-frigo');['frigo-take','frigo-fridges','frigo-history'].forEach(id=>document.getElementById(id).classList.add('hidden'));document.getElementById('frigo-'+t).classList.remove('hidden');},
    remainingTodayTotal(){const pd=Number(window.app.data.frigo.perDay||2);const{start,end}=dayBounds();const today=(window.app.data.frigo.logs||[]).filter(l=>(l.ts||0)>=start&&(l.ts||0)<=end);let tot=0;(window.app.data.frigo.fridges||[]).forEach(fr=>{const done=today.filter(l=>String(l.fridgeId)===String(fr.id)).length;tot+=Math.max(0,pd-done);});return tot;},
    remainingForFridgeToday(fid){const pd=Number(window.app.data.frigo.perDay||2);const{start,end}=dayBounds();const done=(window.app.data.frigo.logs||[]).filter(l=>String(l.fridgeId)===String(fid)&&(l.ts||0)>=start&&(l.ts||0)<=end).length;return Math.max(0,pd-done);},
    setPerDay:async function(v){if(!window.app.canDo('frigoConfig')){toast('Permission refus√©e.','err');this.render();return;}window.app.data.frigo.perDay=Number(v||2);await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    addFridge:async function(){if(!window.app.canDo('frigoConfig')){toast('Permission refus√©e.','err');return;}const n=await dlgPrompt('Nom du frigo :',`FRIGO ${(window.app.data.frigo.fridges||[]).length+1}`);if(!n)return;window.app.data.frigo.fridges.push({id:Date.now(),name:n.trim().toUpperCase()});await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    renameFridge:async function(id){if(!window.app.canDo('frigoConfig')){toast('Permission refus√©e.','err');return;}const f=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(id));if(!f)return;const n=await dlgPrompt('Renommer :',f.name||'');if(!n)return;f.name=n.trim().toUpperCase();await window.app.save('frigo');this.render();},
    delFridge:async function(id){if(!window.app.canDo('frigoConfig')){toast('Permission refus√©e.','err');return;}const f=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(id));if(!f)return;const ok=await dlgConfirm(`Supprimer ${f.name}`,`Supprimer ce frigo ? Les relev√©s restent en historique.`);if(!ok)return;window.app.data.frigo.fridges=window.app.data.frigo.fridges.filter(x=>String(x.id)!==String(id));await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    openLogModal(fid=null){if(!window.app.canDo('frigoSaisie')){toast('Permission refus√©e.','err');return;}const sel=document.getElementById('frigo-log-fridge');sel.innerHTML=(window.app.data.frigo.fridges||[]).map(fr=>`<option value="${fr.id}">${fr.name||"FRIGO"}</option>`).join('');if(fid)sel.value=String(fid);document.getElementById('frigo-log-temp').value='';document.getElementById('frigo-log-time').value=tsToInput(Date.now());document.getElementById('modal-frigo-log').classList.remove('hidden');},
    saveLog:async function(){
      const fid=document.getElementById('frigo-log-fridge').value;const fr=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(fid));
      const temp=Number(document.getElementById('frigo-log-temp').value);const ts=inputToTs(document.getElementById('frigo-log-time').value);
      if(!fr)return toast('Frigo invalide.','warn');if(isNaN(temp))return toast('Temp√©rature invalide.','warn');
      window.app.data.frigo.logs.push({id:Date.now(),fridgeId:fr.id,fridgeName:fr.name||'',temp,ts,user:window.app.me?.name||window.app.me?.email||'USER'});
      const cutoff=Date.now()-(90*24*60*60*1000);window.app.data.frigo.logs=window.app.data.frigo.logs.filter(l=>(l.ts||0)>=cutoff);
      spin(true);try{await window.app.save('frigo');toast('Relev√© enregistr√©.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-frigo-log').classList.add('hidden');this.render();window.app.updateHomeBadges();
    },
    render(){
      try{document.getElementById('frigo-perday').value=String(window.app.data.frigo.perDay||2);}catch(e){}
      const take=document.getElementById('frigo-take');
      if(take){
        const fridges=window.app.data.frigo.fridges||[];
        if(!fridges.length){take.innerHTML=`<div class="card"><b>Aucun frigo</b><div class="small">Cr√©ez des frigos dans l'onglet FRIGOS.</div></div>`;return;}
        take.innerHTML=fridges.map(fr=>{const rem=window.app.frigo.remainingForFridgeToday(fr.id);const done=(window.app.data.frigo.perDay||2)-rem;const chip=rem>0?`<span class="chip warn"><i class="fas fa-circle-exclamation"></i> ${rem} restant</span>`:`<span class="chip ok"><i class="fas fa-check"></i> OK</span>`;return`<div class="list-item" style="border-left:6px solid var(--frigo);"><div style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;"><div class="item-img" style="color:var(--frigo)"><i class="fas fa-snowflake"></i></div><div style="min-width:0;"><div class="item-title">${fr.name||"FRIGO"}</div><div class="item-sub">${done}/${window.app.data.frigo.perDay||2} relev√©(s) ‚Ä¢ ${chip}</div></div></div><div class="right-col"><button class="icon-btn frigo" onclick="app.frigo.openLogModal('${fr.id}')"><i class="fas fa-plus"></i></button></div></div>`;}).join('');
      }
      const list=document.getElementById('frigo-list');
      if(list){
        const fridges=window.app.data.frigo.fridges||[];
        const canCfg=window.app.canDo('frigoConfig');
        // Show/hide add fridge button
        const addBtn=document.querySelector('#view-frigo .btn.frigo');
        if(addBtn)addBtn.style.display=canCfg?'':'none';
        // Show/hide frequency config
        const paramCard=document.querySelector('#frigo-fridges .card');
        if(paramCard)paramCard.style.display=canCfg?'':'none';
        list.innerHTML=fridges.length?fridges.map(fr=>`<div class="list-item"><div style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;"><div class="item-img" style="color:var(--frigo)"><i class="fas fa-snowflake"></i></div><div style="min-width:0;"><div class="item-title">${fr.name||"FRIGO"}</div><div class="item-sub">fr√©quence: ${window.app.data.frigo.perDay||2}/jour</div></div></div><div class="right-col">${canCfg?`<button class="icon-btn frigo" onclick="app.frigo.renameFridge('${fr.id}')"><i class="fas fa-pen"></i></button><button class="icon-btn red" onclick="app.frigo.delFridge('${fr.id}')"><i class="fas fa-trash"></i></button>`:''}</div></div>`).join(''):`<div class="empty-state"><i class="fas fa-snowflake"></i>Aucun frigo.</div>`;
      }
      const hist=document.getElementById('frigo-history');
      if(hist){
        const logs=(window.app.data.frigo.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
        const cutoff=Date.now()-(7*24*60*60*1000);const recent=logs.filter(l=>(l.ts||0)>=cutoff);
        if(!recent.length){hist.innerHTML=`<div class="card"><b>Aucun relev√© r√©cent</b><div class="small">Les 7 derniers jours s'affichent ici.</div></div>`;return;}
        const byDay={};recent.forEach(l=>{const d=new Date(l.ts);const k=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;if(!byDay[k])byDay[k]=[];byDay[k].push(l);});
        hist.innerHTML=Object.keys(byDay).sort().reverse().map(k=>{const d=new Date(k.replace(/-/g,'/'));const title=d.toLocaleDateString('fr',{weekday:'long',year:'numeric',month:'short',day:'numeric'});return`<div class="group-header" style="background:var(--frigo)"><span>${title}</span><span class="small" style="color:rgba(255,255,255,.8)">${byDay[k].length} relev√©(s)</span></div>${byDay[k].map(l=>`<div style="padding:10px;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:8px;"><div style="display:flex;align-items:center;justify-content:space-between;gap:10px;"><div style="font-weight:950;">${l.fridgeName||"FRIGO"} ‚Ä¢ <span style="color:var(--frigo)">${l.temp}¬∞C</span></div><div class="small">${formatDate(l.ts)}</div></div><div class="small">Par ${l.user||"USER"}</div></div>`).join('')}`;}).join('');
      }
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ TODO MODULE (with real-time sync) ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  todo:{
    _editingTaskDays: new Set(),
    _editingMonthDays: new Set(),
    _editingFreq: 'weekly',
    _unsubscribeLogs: null,

    tab(t){
      document.querySelectorAll('#view-todo .tab').forEach(e=>e.classList.remove('active-todo'));
      const tabMap={today:'tt-1',tomorrow:'tt-4',config:'tt-2',history:'tt-3'};
      if(document.getElementById(tabMap[t]))document.getElementById(tabMap[t]).classList.add('active-todo');
      ['todo-today','todo-tomorrow','todo-config','todo-history'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
      const panel=document.getElementById('todo-'+t);if(panel)panel.classList.remove('hidden');
      if(t==='today')this.renderToday();
      if(t==='tomorrow')this.renderTomorrow();
      if(t==='config'){
        if(!window.app.canDo('todoConfig')){
          document.getElementById('todo-config').innerHTML='<div class="empty-state"><i class="fas fa-lock"></i>Acc√®s r√©serv√© aux administrateurs et aux utilisateurs autoris√©s.</div>';
          return;
        }
        this.renderConfig();
      }
      if(t==='history')this.renderHistory();
    },

    // Realtime listener for today's logs
    subscribeToday(){
      if(this._unsubscribeLogs){try{this._unsubscribeLogs();}catch(e){}}
      const {onSnapshot}=window._fsImports||{};
      if(!onSnapshot){return;}
      const today=todayStr();
      try{
        const q=window._fsQuery(colTodoLogs,window._fsWhere("date","==",today));
        this._unsubscribeLogs=onSnapshot(q,snap=>{
          window.app.data.todoLogs=[];
          snap.forEach(d=>window.app.data.todoLogs.push({_id:d.id,...d.data()}));
          this.renderToday();window.app.updateHomeBadges();
        });
      }catch(e){}
    },

    // Check if a task is applicable for a given date
    isTaskForDate(task, date){
      const freq=task.freq||'weekly';
      const dow=date.getDay();
      const dom=date.getDate();
      const month=date.getMonth()+1;
      if(freq==='daily') return true;
      if(freq==='weekly') return (task.days||[]).includes(dow);
      if(freq==='monthly') return (task.monthDays||[]).includes(dom);
      if(freq==='yearly'){
        const md=task.yearlyDate||'';if(!md)return false;
        const[d,m]=(md.split('/')).map(Number);
        return dom===d&&month===m;
      }
      return false;
    },

    todayTaskList(){
      const today=new Date();
      return (window.app.data.todo.tasks||[]).filter(t=>this.isTaskForDate(t,today));
    },

    tomorrowTaskList(){
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      return (window.app.data.todo.tasks||[]).filter(t=>this.isTaskForDate(t,tomorrow));
    },

    isDone(taskId){
      return window.app.data.todoLogs.some(l=>String(l.taskId)===String(taskId));
    },

    checkTask:async function(taskId){
      if(!window.app.canDo('todoSaisie')){toast('Permission refus√©e.','err');return;}
      if(this.isDone(taskId))return;
      const task=(window.app.data.todo.tasks||[]).find(t=>String(t.id)===String(taskId));
      const zone=(window.app.data.todo.zones||[]).find(z=>String(z.id)===String(task?.zoneId));
      const today=todayStr();
      const logEntry={taskId:String(taskId),taskName:task?.name||'',zoneId:String(task?.zoneId||''),zoneName:zone?.name||'',date:today,ts:Date.now(),user:window.app.me?.name||(window.app.me?.email||'USER')};
      try{
        const ref=await addDoc(colTodoLogs,logEntry);
        window.app.data.todoLogs.push({_id:ref.id,...logEntry});
        this.renderToday();window.app.updateHomeBadges();
        toast(`‚úì ${task?.name||'T√¢che'} effectu√©e !`,'ok',2000);
      }catch(e){toast('Erreur enregistrement.','err');}
    },

    uncheckTask:async function(taskId){
      const log=window.app.data.todoLogs.find(l=>String(l.taskId)===String(taskId));
      if(!log)return;
      try{
        await deleteDoc(fDoc(db,'todo_logs',log._id));
        window.app.data.todoLogs=window.app.data.todoLogs.filter(l=>l._id!==log._id);
        this.renderToday();window.app.updateHomeBadges();
        toast('T√¢che d√©coch√©e.','info',2000);
      }catch(e){toast('Erreur.','err');}
    },

    renderToday(){
      const wrap=document.getElementById('todo-today');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=this.todayTaskList();
      const now=new Date();
      const nowMin=now.getHours()*60+now.getMinutes();
      const dateLabel=now.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'long'});
      const done=tasks.filter(t=>this.isDone(t.id)).length;
      const pct=tasks.length>0?Math.round(done/tasks.length*100):0;

      if(!zones.length||!tasks.length){
        wrap.innerHTML=`
          <div style="text-align:center;padding:20px;">
            <div style="font-weight:950;font-size:18px;color:var(--todo);margin-bottom:4px;">${dateLabel}</div>
          </div>
          <div class="empty-state">
            <i class="fas fa-list-check"></i>
            ${!zones.length?'Cr√©ez des zones et des t√¢ches dans l\'onglet <b>CONFIGURER</b>.':'Aucune t√¢che pr√©vue aujourd\'hui.'}
          </div>`;
        return;
      }

      const parts=[`
        <div style="background:linear-gradient(135deg,var(--todo),#5b21b6);border-radius:18px;padding:18px;margin-bottom:16px;color:#fff;">
          <div style="font-weight:950;font-size:17px;">${dateLabel}</div>
          <div style="font-size:13px;opacity:.85;margin-bottom:12px;">${done} / ${tasks.length} t√¢che${tasks.length>1?'s':''}</div>
          <div style="background:rgba(255,255,255,.25);border-radius:999px;height:8px;overflow:hidden;">
            <div style="height:100%;border-radius:999px;background:#fff;width:${pct}%;transition:width .5s ease;"></div>
          </div>
          <div style="text-align:right;font-size:12px;margin-top:4px;opacity:.9;">${pct}%</div>
        </div>
      `];

      zones.forEach(z=>{
        const zoneTasks=tasks.filter(t=>String(t.zoneId)===String(z.id)).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
        if(!zoneTasks.length)return;
        const zDone=zoneTasks.filter(t=>this.isDone(t.id)).length;
        const zPct=zoneTasks.length>0?Math.round(zDone/zoneTasks.length*100):0;
        parts.push(`
          <div style="background:${z.color||'var(--todo)'};border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:950;font-size:15px;text-transform:uppercase;">${z.name||'ZONE'}</div>
              <div style="font-size:12px;opacity:.9;">${zDone}/${zoneTasks.length}</div>
            </div>
            <div style="height:5px;border-radius:3px;background:rgba(255,255,255,.3);margin-top:8px;overflow:hidden;">
              <div style="height:100%;border-radius:3px;background:#fff;width:${zPct}%;transition:width .5s;"></div>
            </div>
          </div>
        `);
        zoneTasks.forEach(t=>{
          const done=this.isDone(t.id);
          const log=done?window.app.data.todoLogs.find(l=>String(l.taskId)===String(t.id)):null;
          let taskMin=Infinity;
          if(t.time){const[h,m]=(t.time||'00:00').split(':').map(Number);taskMin=h*60+(m||0);}
          const overdue=!done&&taskMin!==Infinity&&nowMin>taskMin+15;
          const cardClass=done?'done':(overdue?'overdue':'');
          const freqLabel=t.freq==='monthly'?'mensuel':t.freq==='yearly'?'annuel':t.freq==='daily'?'quotidien':'';
          parts.push(`
            <div class="task-card ${cardClass}" style="border-left-color:${z.color||'var(--todo)'};${done?'border-left-color:var(--success);':''}${overdue?'border-left-color:var(--danger);':''}">
              ${t.time?`<span class="time-chip ${done?'done':(overdue?'overdue':'')}">${t.time}</span>`:''}
              <div style="flex:1;min-width:0;">
                <div style="font-weight:900;font-size:14px;${done?'text-decoration:line-through;color:#94a3b8;':''}">${t.name||''}${freqLabel?` <span class="chip" style="background:#f1f5f9;color:#64748b;font-size:10px;">${freqLabel}</span>`:''}</div>
                ${t.notes?`<div class="small" style="margin-top:2px;">${t.notes}</div>`:''}
                ${done&&log?`<div class="small" style="margin-top:3px;color:var(--success);"><i class="fas fa-check-circle"></i> ${log.user} ‚Ä¢ ${formatDate(log.ts)}</div>`:''}
                ${overdue?`<div class="small" style="color:var(--danger);margin-top:2px;"><i class="fas fa-clock"></i> En retard</div>`:''}
              </div>
              <div class="todo-check ${done?'checked':''}" onclick="app.todo.${done?'uncheckTask':'checkTask'}('${t.id}')">
                <i class="fas fa-check"></i>
              </div>
            </div>
          `);
        });
        parts.push('<div style="margin-bottom:8px;"></div>');
      });

      const unzonedTasks=tasks.filter(t=>!zones.find(z=>String(z.id)===String(t.zoneId))).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
      if(unzonedTasks.length){
        parts.push(`<div style="background:#475569;border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;">SANS ZONE</div></div>`);
        unzonedTasks.forEach(t=>{
          const done=this.isDone(t.id);
          const log=done?window.app.data.todoLogs.find(l=>String(l.taskId)===String(t.id)):null;
          parts.push(`<div class="task-card ${done?'done':''}"><div style="flex:1;min-width:0;"><div style="font-weight:900;${done?'text-decoration:line-through;color:#94a3b8;':''}">${t.name||''}</div>${done&&log?`<div class="small" style="color:var(--success);"><i class="fas fa-check-circle"></i> ${log.user}</div>`:''}${t.notes?`<div class="small">${t.notes}</div>`:''}</div><div class="todo-check ${done?'checked':''}" onclick="app.todo.${done?'uncheckTask':'checkTask'}('${t.id}')"><i class="fas fa-check"></i></div></div>`);
        });
      }
      wrap.innerHTML=parts.join('');
    },

    renderTomorrow(){
      const wrap=document.getElementById('todo-tomorrow');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=this.tomorrowTaskList();
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      const dateLabel=tomorrow.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'long'});
      const FREQ_LABELS={daily:'Quotidien',weekly:'Hebdo',monthly:'Mensuel',yearly:'Annuel'};

      if(!tasks.length){
        wrap.innerHTML=`
          <div style="text-align:center;padding:20px;">
            <div style="font-weight:950;font-size:18px;color:var(--todo);margin-bottom:4px;">${dateLabel}</div>
          </div>
          <div class="empty-state"><i class="fas fa-calendar-check"></i>Aucune t√¢che pr√©vue demain.</div>`;
        return;
      }

      const parts=[`
        <div style="background:linear-gradient(135deg,#475569,#334155);border-radius:18px;padding:18px;margin-bottom:16px;color:#fff;">
          <div style="font-weight:950;font-size:17px;">${dateLabel}</div>
          <div style="font-size:13px;opacity:.85;margin-top:4px;">${tasks.length} t√¢che${tasks.length>1?'s':''} pr√©vue${tasks.length>1?'s':''}</div>
        </div>
      `];

      zones.forEach(z=>{
        const zoneTasks=tasks.filter(t=>String(t.zoneId)===String(z.id)).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
        if(!zoneTasks.length)return;
        parts.push(`<div style="background:${z.color||'var(--todo)'};border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;font-size:15px;">${z.name||'ZONE'}</div></div>`);
        zoneTasks.forEach(t=>{
          const freqLabel=FREQ_LABELS[t.freq||'weekly']||'';
          parts.push(`<div class="task-card">
            ${t.time?`<span class="time-chip">${t.time}</span>`:''}
            <div style="flex:1;min-width:0;">
              <div style="font-weight:900;font-size:14px;">${t.name||''} <span class="chip" style="background:#f1f5f9;color:#64748b;font-size:10px;">${freqLabel}</span></div>
              ${t.notes?`<div class="small" style="margin-top:2px;">${t.notes}</div>`:''}
            </div>
            <div style="width:32px;height:32px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;color:#94a3b8;"><i class="fas fa-clock"></i></div>
          </div>`);
        });
        parts.push('<div style="margin-bottom:8px;"></div>');
      });

      const unzoned=tasks.filter(t=>!zones.find(z=>String(z.id)===String(t.zoneId)));
      if(unzoned.length){
        parts.push(`<div style="background:#475569;border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;">SANS ZONE</div></div>`);
        unzoned.forEach(t=>{parts.push(`<div class="task-card"><div style="flex:1;font-weight:900;">${t.name||''}</div></div>`);});
      }
      wrap.innerHTML=parts.join('');
    },

    renderConfig(){
      const wrap=document.getElementById('todo-config');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=window.app.data.todo.tasks||[];
      const FREQ_LABELS={daily:'Quotidien',weekly:'Hebdo',monthly:'Mensuel',yearly:'Annuel'};
      const parts=[`<button class="btn todo" style="margin-bottom:15px;" onclick="app.todo.openZone()"><i class="fas fa-plus"></i> Cr√©er une zone</button>`];
      if(!zones.length){
        parts.push(`<div class="empty-state"><i class="fas fa-map-marker-alt"></i>Aucune zone cr√©√©e.<br><span class="small">Une zone = un espace physique (R√©serve, Rayon, Caisse‚Ä¶)</span></div>`);
      } else {
        zones.forEach(z=>{
          const zt=tasks.filter(t=>String(t.zoneId)===String(z.id));
          parts.push(`
            <div class="card" style="border-left:5px solid ${z.color||'var(--todo)'};">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;">
                <div>
                  <div style="font-weight:950;font-size:16px;color:${z.color||'var(--todo)'};">${z.name||'Zone'}</div>
                  <div class="small">${zt.length} t√¢che${zt.length>1?'s':''}</div>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="icon-btn todo" onclick="app.todo.openZone('${z.id}')"><i class="fas fa-pen"></i></button>
                  <button class="icon-btn todo" onclick="app.todo.openTask(null,'${z.id}')" title="Ajouter t√¢che"><i class="fas fa-plus"></i></button>
                </div>
              </div>
          `);
          if(zt.length){
            zt.sort((a,b)=>(a.time||'').localeCompare(b.time||'')).forEach(t=>{
              const freqLabel=FREQ_LABELS[t.freq||'weekly']||'Hebdo';
              let schedLabel='';
              if(!t.freq||t.freq==='weekly')schedLabel=(t.days||[]).map(d=>DAY_LABELS[d]).join(' ');
              else if(t.freq==='daily')schedLabel='Tous les jours';
              else if(t.freq==='monthly')schedLabel='Jours: '+(t.monthDays||[]).join(', ');
              else if(t.freq==='yearly')schedLabel=t.yearlyDate||'?/?';
              parts.push(`
                <div class="list-item" style="min-height:60px;border-left:3px solid ${z.color||'var(--todo)'};">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:900;font-size:14px;">${t.time?`<span class="time-chip" style="font-size:11px;margin-right:6px;">${t.time}</span>`:''}${t.name||''}</div>
                    <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
                      <span class="chip" style="background:#ede9fe;color:#5b21b6;">${freqLabel}</span>
                      <span class="small">${schedLabel}</span>
                    </div>
                    ${t.notes?`<div class="small" style="margin-top:3px;">${t.notes}</div>`:''}
                  </div>
                  <button class="icon-btn todo" style="flex-shrink:0;" onclick="app.todo.openTask('${t.id}')"><i class="fas fa-pen"></i></button>
                </div>
              `);
            });
          } else {
            parts.push(`<div class="small" style="text-align:center;padding:10px;color:#cbd5e1;">Aucune t√¢che ‚Äî <span style="color:var(--todo);cursor:pointer;" onclick="app.todo.openTask(null,'${z.id}')">+ ajouter</span></div>`);
          }
          parts.push('</div>');
        });
      }
      wrap.innerHTML=parts.join('');
    },

    renderHistory:async function(){
      const wrap=document.getElementById('todo-history');if(!wrap)return;
      wrap.innerHTML=`<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin" style="font-size:30px;color:var(--todo);"></i></div>`;
      try{
        const sevenDaysAgo=new Date();sevenDaysAgo.setDate(sevenDaysAgo.getDate()-6);
        const cutStr=`${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth()+1).padStart(2,'0')}-${String(sevenDaysAgo.getDate()).padStart(2,'0')}`;
        const q=query(colTodoLogs,where("date",">=",cutStr),orderBy("date","desc"),limit(500));
        const snap=await getDocs(q);
        const logs=[];snap.forEach(d=>logs.push({_id:d.id,...d.data()}));
        if(!logs.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-clock-rotate-left"></i>Aucun historique cette semaine.</div>`;return;}
        const byDay={};
        logs.forEach(l=>{if(!byDay[l.date])byDay[l.date]=[];byDay[l.date].push(l);});
        const parts=[];
        Object.keys(byDay).sort().reverse().forEach(day=>{
          const d=new Date(day+'T12:00:00');
          const label=d.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'short'});
          const dl=byDay[day];
          const byZone={};dl.forEach(l=>{const k=l.zoneName||'Sans zone';if(!byZone[k])byZone[k]=[];byZone[k].push(l);});
          parts.push(`<div class="group-header" style="background:var(--todo)"><span>${label}</span><span class="small" style="color:rgba(255,255,255,.8)">${dl.length} t√¢che${dl.length>1?'s':''}</span></div>`);
          Object.keys(byZone).sort().forEach(zn=>{
            parts.push(`<div style="padding:4px 0 4px 10px;font-weight:800;font-size:12px;color:var(--todo);text-transform:uppercase;">${zn}</div>`);
            byZone[zn].sort((a,b)=>(a.ts||0)-(b.ts||0)).forEach(l=>{
              parts.push(`<div style="padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
                <div><div style="font-weight:900;font-size:13px;">${l.taskName||''}</div><div class="small"><i class="fas fa-user"></i> ${l.user||''}</div></div>
                <div class="small" style="white-space:nowrap;color:var(--todo);font-weight:800;">${formatDate(l.ts)}</div>
              </div>`);
            });
          });
        });
        wrap.innerHTML=parts.join('');
      }catch(e){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-circle-exclamation"></i>Impossible de charger l'historique.</div>`;}
    },

    // ‚îÄ‚îÄ ZONE MODAL ‚îÄ‚îÄ
    openZone(id=null){
      const m=document.getElementById('modal-todo-zone');m.classList.remove('hidden');
      document.getElementById('todo-zone-modal-title').innerHTML=id?'<i class="fas fa-pen"></i> Modifier Zone':'<i class="fas fa-plus"></i> Cr√©er une Zone';
      document.getElementById('tz-del-btn').style.display=id?'block':'none';
      document.getElementById('tz-id').value=id||'';
      const grid=document.getElementById('tz-color-grid');
      const cur=id?(window.app.data.todo.zones||[]).find(z=>String(z.id)===String(id))?.color||ZONE_COLORS[0]:ZONE_COLORS[0];
      grid.innerHTML=ZONE_COLORS.map(c=>`<div class="color-swatch ${c===cur?'selected':''}" style="background:${c};" onclick="app.todo._selectColor('${c}',this)"></div>`).join('');
      document.getElementById('tz-color').value=cur;
      if(id){const z=(window.app.data.todo.zones||[]).find(x=>String(x.id)===String(id));document.getElementById('tz-name').value=z?.name||'';}
      else{document.getElementById('tz-name').value='';}
      document.getElementById('err-tz-name').classList.remove('show');document.getElementById('tz-name').classList.remove('invalid');
    },
    _selectColor(color,el){
      document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
      el.classList.add('selected');document.getElementById('tz-color').value=color;
    },
    saveZone:async function(){
      const name=(document.getElementById('tz-name').value||'').trim().toUpperCase();
      if(!name){document.getElementById('tz-name').classList.add('invalid');document.getElementById('err-tz-name').classList.add('show');return;}
      const id=document.getElementById('tz-id').value;
      const color=document.getElementById('tz-color').value||ZONE_COLORS[0];
      const o={id:id?Number(id):Date.now(),name,color};
      if(id){const idx=(window.app.data.todo.zones||[]).findIndex(z=>String(z.id)===String(id));if(idx>-1)window.app.data.todo.zones[idx]=o;}
      else{if(!window.app.data.todo.zones)window.app.data.todo.zones=[];window.app.data.todo.zones.push(o);}
      spin(true);try{await window.app.save('todo');toast('Zone enregistr√©e.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-zone').classList.add('hidden');this.renderConfig();this.renderToday();
    },
    delZone:async function(){
      const id=document.getElementById('tz-id').value;if(!id)return;
      const ok=await dlgConfirm('Supprimer zone','Supprimer cette zone ? Les t√¢ches de cette zone seront aussi supprim√©es.');if(!ok)return;
      window.app.data.todo.zones=(window.app.data.todo.zones||[]).filter(z=>String(z.id)!==String(id));
      window.app.data.todo.tasks=(window.app.data.todo.tasks||[]).filter(t=>String(t.zoneId)!==String(id));
      spin(true);try{await window.app.save('todo');toast('Zone supprim√©e.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-zone').classList.add('hidden');this.renderConfig();this.renderToday();
    },

    // ‚îÄ‚îÄ FREQUENCY HELPERS ‚îÄ‚îÄ
    _setFreq(freq){
      this._editingFreq=freq;
      ['daily','weekly','monthly','yearly'].forEach(f=>{
        document.getElementById(`freq-${f}-tab`).classList.toggle('active',f===freq);
        document.getElementById(`freq-panel-${f}`).classList.toggle('active',f===freq);
      });
    },
    _renderMonthDaysGrid(){
      const grid=document.getElementById('tt-month-days-grid');if(!grid)return;
      let html='';
      for(let d=1;d<=31;d++){
        const on=this._editingMonthDays.has(d);
        html+=`<button type="button" class="month-day-btn ${on?'on':''}" onclick="app.todo._toggleMonthDay(${d})">${d}</button>`;
      }
      grid.innerHTML=html;
    },
    _toggleMonthDay(d){
      if(this._editingMonthDays.has(d))this._editingMonthDays.delete(d);else this._editingMonthDays.add(d);
      this._renderMonthDaysGrid();
    },

    // ‚îÄ‚îÄ TASK MODAL ‚îÄ‚îÄ
    openTask(id=null,defaultZoneId=null){
      const m=document.getElementById('modal-todo-task');m.classList.remove('hidden');
      document.getElementById('todo-task-modal-title').innerHTML=id?'<i class="fas fa-pen"></i> Modifier T√¢che':'<i class="fas fa-plus"></i> Cr√©er une T√¢che';
      document.getElementById('tt-del-btn').style.display=id?'block':'none';
      document.getElementById('tt-id').value=id||'';
      const zSel=document.getElementById('tt-zone');
      zSel.innerHTML=(window.app.data.todo.zones||[]).map(z=>`<option value="${z.id}">${z.name||'Zone'}</option>`).join('');
      if(id){
        const t=(window.app.data.todo.tasks||[]).find(x=>String(x.id)===String(id));
        if(t){
          zSel.value=String(t.zoneId||'');
          document.getElementById('tt-name').value=t.name||'';
          document.getElementById('tt-time').value=t.time||'';
          document.getElementById('tt-notes').value=t.notes||'';
          const freq=t.freq||'weekly';
          this._editingFreq=freq;
          this._editingTaskDays=new Set((t.days||[]).map(d=>Number(d)));
          this._editingMonthDays=new Set((t.monthDays||[]).map(d=>Number(d)));
          document.getElementById('tt-yearly-date').value=t.yearlyDate||'';
          this._setFreq(freq);
        }
      } else {
        document.getElementById('tt-name').value='';document.getElementById('tt-time').value='';document.getElementById('tt-notes').value='';
        document.getElementById('tt-yearly-date').value='';
        if(defaultZoneId)zSel.value=String(defaultZoneId);
        this._editingFreq='weekly';
        this._editingTaskDays=new Set([1,2,3,4,5]);
        this._editingMonthDays=new Set();
        this._setFreq('weekly');
      }
      this._renderDayPills();
      this._renderMonthDaysGrid();
      document.getElementById('err-tt-name').classList.remove('show');
      document.getElementById('tt-name').classList.remove('invalid');
    },
    _renderDayPills(){
      const row=document.getElementById('tt-days-row');if(!row)return;
      const order=[1,2,3,4,5,6,0];
      row.innerHTML=order.map(d=>{
        const on=this._editingTaskDays.has(d);
        return`<span class="day-pill ${on?'on':'off'}" onclick="app.todo._toggleDay(${d})">${DAY_LABELS[d]}</span>`;
      }).join('');
    },
    _toggleDay(d){
      if(this._editingTaskDays.has(d))this._editingTaskDays.delete(d);else this._editingTaskDays.add(d);
      this._renderDayPills();
    },
    saveTask:async function(){
      const name=(document.getElementById('tt-name').value||'').trim();
      if(!name){document.getElementById('tt-name').classList.add('invalid');document.getElementById('err-tt-name').classList.add('show');return;}
      const freq=this._editingFreq||'weekly';
      // Validate
      if(freq==='weekly'&&!this._editingTaskDays.size){document.getElementById('err-tt-days').classList.add('show');return;}
      if(freq==='monthly'&&!this._editingMonthDays.size){document.getElementById('err-tt-days-m').classList.add('show');return;}
      const id=document.getElementById('tt-id').value;
      const o={
        id:id?Number(id):Date.now(),
        zoneId:Number(document.getElementById('tt-zone').value)||0,
        name,
        time:document.getElementById('tt-time').value||'',
        freq,
        days:freq==='weekly'?[...this._editingTaskDays].sort():[],
        monthDays:freq==='monthly'?[...this._editingMonthDays].sort():[],
        yearlyDate:freq==='yearly'?(document.getElementById('tt-yearly-date').value||''):'',
        notes:(document.getElementById('tt-notes').value||'').trim()
      };
      if(id){const idx=(window.app.data.todo.tasks||[]).findIndex(t=>String(t.id)===String(id));if(idx>-1)window.app.data.todo.tasks[idx]=o;}
      else{if(!window.app.data.todo.tasks)window.app.data.todo.tasks=[];window.app.data.todo.tasks.push(o);}
      spin(true);try{await window.app.save('todo');toast('T√¢che enregistr√©e.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-task').classList.add('hidden');this.renderConfig();this.renderToday();window.app.updateHomeBadges();
    },
    delTask:async function(){
      const id=document.getElementById('tt-id').value;if(!id)return;
      const ok=await dlgConfirm('Supprimer t√¢che','Supprimer cette t√¢che ?');if(!ok)return;
      window.app.data.todo.tasks=(window.app.data.todo.tasks||[]).filter(t=>String(t.id)!==String(id));
      spin(true);try{await window.app.save('todo');toast('T√¢che supprim√©e.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-task').classList.add('hidden');this.renderConfig();this.renderToday();window.app.updateHomeBadges();
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ R√âCEPTION MODULE ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  reception:{
    _photoData:'',
    _currentSupplier:null, // {code, name, type, tempMin, tempMax}

    SUPPLIERS:[
      {code:'011',name:'COLOMIERS 011',type:'sec',   tempMin:null,tempMax:null,  color:'#92400e',icon:'fa-box'},
      {code:'392',name:'PLAISANCE 392', type:'frais', tempMin:0,   tempMax:4,    color:'#065f46',icon:'fa-snowflake'},
      {code:'032',name:'ST GILES 032',  type:'surgele',tempMin:-23, tempMax:-18, color:'#1e3a8a',icon:'fa-temperature-arrow-down'}
    ],

    init(){
      const inp=document.getElementById('rec-datetime');
      if(inp)inp.value=tsToInput(Date.now());
      const fi=document.getElementById('rec-photo-input');
      if(fi&&!fi._wired){fi._wired=true;fi.addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{window.app.reception._photoData=b64;const prev=document.getElementById('rec-photo-preview');prev.src=b64;prev.style.display='block';});});}
    },

    selectSupplier(code,name,type,tempMin,tempMax){
      this._currentSupplier={code,name,type,tempMin,tempMax};
      // Highlight selected
      document.querySelectorAll('.supplier-select-btn').forEach(b=>b.classList.remove('selected'));
      const btn=document.getElementById('sup-btn-'+code);if(btn)btn.classList.add('selected');
      // Show selected label
      document.getElementById('rec-selected-supplier').style.display='block';
      document.getElementById('rec-sup-label').textContent=name;
      const sup=this.SUPPLIERS.find(s=>s.code===code);
      let typeLabel='';
      if(type==='sec')typeLabel='SEC ‚Äî Pas de contr√¥le temp√©rature';
      else if(type==='frais')typeLabel=`FRAIS ‚Äî Plage: ${tempMin}¬∞C √† ${tempMax}¬∞C`;
      else if(type==='surgele')typeLabel=`SURGEL√â ‚Äî Plage: ${tempMin}¬∞C √† ${tempMax}¬∞C`;
      document.getElementById('rec-sup-type-label').textContent=typeLabel;
      // Show/hide temp section
      const tempSec=document.getElementById('rec-temp-section');
      if(type==='sec'){
        tempSec.style.display='none';
        document.getElementById('rec-temp').value='';
      } else {
        tempSec.style.display='block';
        const rangeLabel=`Plage accept√©e : ${tempMin}¬∞C √† ${tempMax}¬∞C`;
        document.getElementById('rec-temp-range-label').textContent=rangeLabel;
        document.getElementById('rec-temp').placeholder=`Ex: ${type==='frais'?'2.5':'-20'}`;
        document.getElementById('rec-temp-status').innerHTML='';
      }
    },

    clearSupplier(){
      this._currentSupplier=null;
      document.querySelectorAll('.supplier-select-btn').forEach(b=>b.classList.remove('selected'));
      document.getElementById('rec-selected-supplier').style.display='none';
      document.getElementById('rec-temp-section').style.display='none';
    },

    _updateTempStatus(){
      const sup=this._currentSupplier;if(!sup||sup.type==='sec')return;
      const v=parseFloat(document.getElementById('rec-temp').value);
      const div=document.getElementById('rec-temp-status');
      if(isNaN(v)){div.innerHTML='';return;}
      const ok=v>=sup.tempMin&&v<=sup.tempMax;
      if(ok){div.innerHTML=`<div style="background:#d1fae5;color:#065f46;padding:10px;border-radius:10px;font-weight:900;margin-bottom:8px;"><i class="fas fa-check-circle"></i> ${v}¬∞C ‚Äî DANS LA NORME (${sup.tempMin}¬∞C √† ${sup.tempMax}¬∞C)</div>`;}
      else{div.innerHTML=`<div style="background:#fee2e2;color:#991b1b;padding:10px;border-radius:10px;font-weight:900;margin-bottom:8px;"><i class="fas fa-triangle-exclamation"></i> ${v}¬∞C ‚Äî HORS NORME ! (plage: ${sup.tempMin}¬∞C √† ${sup.tempMax}¬∞C)</div>`;}
    },

    tab(t){
      document.querySelectorAll('#view-reception .tab').forEach(e=>e.classList.remove('active'));
      document.getElementById(t==='new'?'trec-1':'trec-2').classList.add('active');
      document.getElementById('reception-new').classList.toggle('hidden',t!=='new');
      document.getElementById('reception-history').classList.toggle('hidden',t!=='history');
      if(t==='history')this.renderHistory();
    },

    save:async function(conform){
      const sup=this._currentSupplier;
      if(!sup)return toast('S√©lectionnez un fournisseur.','warn');
      const product=(document.getElementById('rec-product').value||'').trim();
      if(!product)return toast('Produit requis.','warn');
      const ts=inputToTs(document.getElementById('rec-datetime').value)||Date.now();
      let temp=null;let tempOk=true;
      if(sup.type!=='sec'){
        const tv=document.getElementById('rec-temp').value;
        if(tv===''||isNaN(parseFloat(tv)))return toast('Temp√©rature requise.','warn');
        temp=parseFloat(tv);
        tempOk=temp>=sup.tempMin&&temp<=sup.tempMax;
        // Auto-set conform based on temp
        if(!tempOk&&conform){const ok=await dlgConfirm('Temp√©rature hors norme','La temp√©rature est hors norme. Confirmer quand m√™me comme CONFORME ?');if(!ok)return;}
      }
      const entry={ts,date:todayStr(),supplier:sup.name,supplierCode:sup.code,supplierType:sup.type,product,temp,tempMin:sup.tempMin,tempMax:sup.tempMax,tempOk,conform,notes:(document.getElementById('rec-notes').value||'').trim(),photo:this._photoData||'',user:window.app.me?.name||(window.app.me?.email||'USER')};
      spin(true);
      try{
        const ref=await addDoc(colReception,entry);
        window.app.data.reception.unshift({_id:ref.id,...entry});
        document.getElementById('rec-product').value='';document.getElementById('rec-notes').value='';
        if(document.getElementById('rec-temp'))document.getElementById('rec-temp').value='';
        document.getElementById('rec-temp-status').innerHTML='';
        document.getElementById('rec-photo-preview').style.display='none';
        document.getElementById('rec-datetime').value=tsToInput(Date.now());
        document.getElementById('rec-photo-input').value='';this._photoData='';
        toast(conform?`‚úì ${sup.name} ‚Äî Conforme`:`‚ö† ${sup.name} ‚Äî NON CONFORME`,'ok',4000);
      }catch(e){toast('Erreur sauvegarde.','err');}finally{spin(false);}
    },

    renderHistory(){
      const wrap=document.getElementById('reception-history');if(!wrap)return;
      const logs=(window.app.data.reception||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
      if(!logs.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-truck-ramp-box"></i>Aucun contr√¥le enregistr√©.</div>`;return;}
      const byDay={};logs.forEach(l=>{const d=l.date||todayStr();if(!byDay[d])byDay[d]=[];byDay[d].push(l);});
      const parts=[];
      Object.keys(byDay).sort().reverse().forEach(day=>{
        const d=new Date(day+'T12:00:00');
        const label=d.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'short',year:'numeric'});
        parts.push(`<div class="group-header" style="background:var(--reception)"><span>${label}</span><span class="small" style="color:rgba(255,255,255,.8)">${byDay[day].length} contr√¥le(s)</span></div>`);
        byDay[day].forEach(l=>{
          const conformBadge=l.conform?`<span class="chip ok"><i class="fas fa-check"></i> CONFORME</span>`:`<span class="chip warn"><i class="fas fa-triangle-exclamation"></i> NON CONFORME</span>`;
          const typeColors={frais:'#065f46',surgele:'#1e3a8a',sec:'#92400e'};
          const typeColor=typeColors[l.supplierType]||'#475569';
          const tempInfo=l.temp!==null&&l.temp!==undefined?`<span style="font-weight:950;color:${l.tempOk!==false?'#10b981':'#ef4444'};font-size:16px;">${l.temp}¬∞C</span> <span class="small">(${l.tempMin??'?'}¬∞C √† ${l.tempMax??'?'}¬∞C)</span>`:'<span class="small">Sec ‚Äî pas de temp√©rature</span>';
          parts.push(`<div class="reception-card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
              <div style="font-weight:950;font-size:15px;color:${typeColor};">${l.supplier||''}</div>${conformBadge}
            </div>
            <div style="font-size:14px;font-weight:700;margin-bottom:6px;">${l.product||''}</div>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">${tempInfo}<span class="small">${formatDate(l.ts)}</span><span class="small"><i class="fas fa-user"></i> ${l.user||''}</span></div>
            ${l.notes?`<div class="small" style="margin-top:4px;color:#475569;font-style:italic;">${l.notes}</div>`:''}
            ${l.photo?`<img src="${l.photo}" style="width:100%;max-height:140px;object-fit:contain;border-radius:10px;margin-top:8px;background:#f8fafc;">`:''}</div>`);
        });
      });
      wrap.innerHTML=parts.join('');
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ INSPECTION MODULE ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  inspection:{
    render:async function(){
      const wrap=document.getElementById('inspection-content');if(!wrap)return;
      wrap.innerHTML=`<div style="text-align:center;padding:30px;"><i class="fas fa-spinner fa-spin" style="font-size:30px;color:var(--primary);"></i></div>`;
      try{
        const today=new Date();today.setHours(0,0,0,0);const todayTs=today.getTime();
        const weekAgo=todayTs-(7*24*60*60*1000);const monthAgo=todayTs-(30*24*60*60*1000);
        const todoLogs=window.app.data.todoLogs||[];const todayTasks=window.app.todo.todayTaskList();
        const todoDone=todoLogs.length;const todoTotal=todayTasks.length;const todoPct=todoTotal>0?Math.round(todoDone/todoTotal*100):0;
        const frigoRem=window.app.frigo.remainingTodayTotal();const frigoTotal=(window.app.data.frigo.fridges||[]).length*(window.app.data.frigo.perDay||2);const frigoDone=frigoTotal-frigoRem;
        const recLogs=(window.app.data.reception||[]).filter(r=>(r.ts||0)>=monthAgo);const recConform=recLogs.filter(r=>r.conform).length;const recNonConform=recLogs.filter(r=>!r.conform).length;
        const fraisAlerts=window.app.data.frais.filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;}).length;
        const users=window.app.data.users||[];const frigoLogs7=(window.app.data.frigo.logs||[]).filter(l=>(l.ts||0)>=weekAgo);
        const parts=[];
        parts.push(`<div class="kpi-grid"><div class="kpi-card" style="background:linear-gradient(135deg,var(--todo),#5b21b6);color:#fff;"><div class="kpi-val">${todoPct}%</div><div class="kpi-lbl">CHECK-LIST</div></div><div class="kpi-card" style="background:linear-gradient(135deg,var(--frigo),#0369a1);color:#fff;"><div class="kpi-val">${frigoDone}/${frigoTotal}</div><div class="kpi-lbl">RELEV√âS FRIGO</div></div><div class="kpi-card" style="background:linear-gradient(135deg,var(--reception),#047857);color:#fff;"><div class="kpi-val">${recConform}</div><div class="kpi-lbl">CONF. (30J)</div></div><div class="kpi-card" style="background:linear-gradient(135deg,${recNonConform>0?'#ef4444,#b91c1c':'#6b7280,#374151'});color:#fff;"><div class="kpi-val">${recNonConform}</div><div class="kpi-lbl">NON CONF. (30J)</div></div></div>${fraisAlerts>0?`<div style="background:#fee2e2;border-left:5px solid #ef4444;border-radius:12px;padding:14px;margin-bottom:12px;font-weight:900;color:#991b1b;"><i class="fas fa-triangle-exclamation"></i> ${fraisAlerts} produit(s) frais √† DLC !</div>`:''}`);
        parts.push(`<div class="inspection-section"><h4><i class="fas fa-users"></i> √âquipe (${users.length})</h4>${users.map(u=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;"><div style="font-weight:800;">${u.name||u.email||'?'} ${u.role==='admin'?'<span class="chip admin">ADMIN</span>':'<span class="chip staff">STAFF</span>'}</div><div class="small">${u.email||''}</div></div>`).join('')}</div>`);
        if(frigoLogs7.length){const avgTemp=(frigoLogs7.reduce((s,l)=>s+(l.temp||0),0)/frigoLogs7.length).toFixed(1);const maxTemp=Math.max(...frigoLogs7.map(l=>l.temp||0)).toFixed(1);const minTemp=Math.min(...frigoLogs7.map(l=>l.temp||0)).toFixed(1);parts.push(`<div class="inspection-section"><h4><i class="fas fa-temperature-half" style="color:var(--frigo);"></i> Temp√©ratures (7 jours)</h4><div class="kpi-grid"><div class="kpi-card" style="background:#f0f9ff;"><div class="kpi-val" style="color:var(--frigo);font-size:22px;">${avgTemp}¬∞C</div><div class="kpi-lbl" style="color:#0369a1;">MOYENNE</div></div><div class="kpi-card" style="background:#f0f9ff;"><div class="kpi-val" style="color:#ef4444;font-size:22px;">${maxTemp}¬∞C</div><div class="kpi-lbl" style="color:#0369a1;">MAX</div></div></div><div class="small">Min: ${minTemp}¬∞C ‚Ä¢ ${frigoLogs7.length} relev√©(s)</div></div>`);}
        const recNC=(window.app.data.reception||[]).filter(r=>!r.conform&&(r.ts||0)>=monthAgo);
        if(recNC.length){parts.push(`<div class="inspection-section" style="border-left:4px solid #ef4444;"><h4 style="color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Non-conformit√©s (30J)</h4>${recNC.slice(0,5).map(r=>`<div style="padding:8px 0;border-bottom:1px solid #fee2e2;"><div style="font-weight:800;">${r.supplier||'?'} ‚Äî ${r.product||'?'}</div><div class="small">${formatDate(r.ts)} ‚Ä¢ ${r.temp}¬∞C (lim. ${r.tempLimit}¬∞C) ‚Ä¢ ${r.user||''}</div>${r.notes?`<div class="small" style="color:#7f1d1d;">${r.notes}</div>`:''}</div>`).join('')}${recNC.length>5?`<div class="small" style="text-align:center;margin-top:8px;">+ ${recNC.length-5} autre(s)</div>`:''}</div>`);}
        parts.push(`<div class="inspection-section"><h4><i class="fas fa-file-export"></i> Exporter</h4><button class="export-btn" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('frigo')"><i class="fas fa-temperature-half"></i> Export temp√©ratures (CSV)</button><button class="export-btn" style="background:linear-gradient(135deg,var(--reception),#047857);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('reception')"><i class="fas fa-truck-ramp-box"></i> Export r√©ceptions (CSV)</button><button class="export-btn" style="background:linear-gradient(135deg,var(--todo),#5b21b6);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('todo')"><i class="fas fa-list-check"></i> Export check-list (CSV)</button></div>`);
        wrap.innerHTML=parts.join('');
      }catch(e){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-circle-exclamation"></i>Erreur de chargement.</div>`;}
    },
    exportCSV(type){
      let rows=[];let filename='';
      if(type==='frigo'){filename='temperatures.csv';rows=[['Frigo','Temperature','Date','Heure','Operateur']];(window.app.data.frigo.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(l=>{const d=new Date(l.ts||0);rows.push([l.fridgeName||'',l.temp||'',d.toLocaleDateString('fr'),d.toLocaleTimeString('fr'),l.user||'']);});}
      else if(type==='reception'){filename='receptions.csv';rows=[['Date','Heure','Fournisseur','Produit','Temperature','Limite','Conforme','Operateur','Observations']];(window.app.data.reception||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(l=>{const d=new Date(l.ts||0);rows.push([d.toLocaleDateString('fr'),d.toLocaleTimeString('fr'),l.supplier||'',l.product||'',l.temp||'',l.tempLimit||'',l.conform?'OUI':'NON',l.user||'',l.notes||'']);});}
      else if(type==='todo'){filename='checklist.csv';rows=[['Date','Zone','Tache','Operateur','Heure']];(window.app.data.todoLogs||[]).forEach(l=>{const d=new Date(l.ts||0);rows.push([l.date||'',l.zoneName||'',l.taskName||'',l.user||'',d.toLocaleTimeString('fr')]);});}
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
      toast('Export CSV t√©l√©charg√©.','ok');
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ √âTIQUETTES MODULE (Brother TD-2120N) ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  etiquettes:{
    _items:[],

    loadProducts(){
      const today=new Date();today.setHours(23,59,59,999);
      const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);yesterday.setHours(23,59,59,999);
      this._items=window.app.data.frais
        .filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;})
        .map(i=>({fraisId:i.id,name:i.name,fam:i.fam||'',qty:Number(i.qty||0),date:i.date,price:'',pct:50,printQty:1,selected:true}));
      this.renderProductList();
    },

    renderProductList(){
      const wrap=document.getElementById('etiq-product-list');if(!wrap)return;
      if(!this._items.length){
        wrap.innerHTML=`<div style="text-align:center;padding:20px;color:#9333ea;"><i class="fas fa-check-circle" style="font-size:30px;margin-bottom:8px;display:block;"></i><div style="font-weight:900;">Aucun produit √† DLC aujourd\'hui üéâ</div></div>`;
        document.getElementById('etiq-config-card').style.display='none';
        return;
      }
      wrap.innerHTML=this._items.map((it,idx)=>`
        <div class="etiq-product-row ${it.selected?'selected':''}">
          <div class="etiq-check ${it.selected?'on':''}" onclick="app.etiquettes.toggleItem(${idx})">
            <i class="fas fa-check" style="${it.selected?'':'opacity:0'}"></i>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:900;font-size:14px;">${it.name}</div>
            <div class="small">${it.fam} ‚Ä¢ x${it.qty} ‚Ä¢ DLC: ${new Date(it.date).toLocaleDateString('fr')}</div>
          </div>
        </div>
      `).join('');
      document.getElementById('etiq-config-card').style.display='block';
      this.renderConfigSection();
    },

    toggleItem(idx){this._items[idx].selected=!this._items[idx].selected;this.renderProductList();},

    renderConfigSection(){
      const wrap=document.getElementById('etiq-items-config');if(!wrap)return;
      const selected=this._items.filter(it=>it.selected);
      if(!selected.length){wrap.innerHTML=`<div class="small" style="text-align:center;padding:10px;color:var(--muted);">S√©lectionnez des produits ci-dessus</div>`;return;}
      wrap.innerHTML=selected.map(it=>{
        const realIdx=this._items.indexOf(it);
        const prixOrig=parseFloat(it.price||0);
        const prixReduit=it.price?(prixOrig*(1-it.pct/100)).toFixed(2):'';
        return`<div style="background:#faf5ff;border-radius:14px;padding:14px;margin-bottom:12px;border:2px solid #e9d5ff;">
          <div style="font-weight:950;font-size:15px;color:#9333ea;margin-bottom:10px;"><i class="fas fa-tag"></i> ${it.name}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
            <div>
              <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">Prix original (‚Ç¨)</label>
              <input type="number" step="0.01" min="0" placeholder="Ex: 4.90" value="${it.price}" oninput="app.etiquettes.setPrice(${realIdx},this.value)" style="margin:0;padding:10px;border-radius:8px;border:1.5px solid #d8b4fe;font-size:14px;">
            </div>
            <div>
              <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">R√©duction %</label>
              <input type="number" min="1" max="99" value="${it.pct}" oninput="app.etiquettes.setPct(${realIdx},this.value)" style="margin:0;padding:10px;border-radius:8px;border:1.5px solid #d8b4fe;font-size:14px;">
            </div>
          </div>
          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">Nb d'√©tiquettes √† imprimer</label>
            <div class="etiq-qty-ctrl">
              <button onclick="app.etiquettes.setPrintQty(${realIdx},${it.printQty-1})">‚àí</button>
              <span style="font-weight:950;font-size:20px;min-width:36px;text-align:center;">${it.printQty}</span>
              <button onclick="app.etiquettes.setPrintQty(${realIdx},${it.printQty+1})">+</button>
              <span class="small" style="margin-left:4px;">/ 50 max</span>
            </div>
          </div>
          ${it.price?`<div class="etiq-label-preview">
            <div class="etiq-name">${it.name}</div>
            <div class="etiq-prix-original">${prixOrig.toFixed(2)} ‚Ç¨</div>
            <div class="etiq-prix-reduit">${prixReduit} ‚Ç¨</div>
            <div class="etiq-pct">-${it.pct}%</div>
            <div style="font-size:11px;margin-top:6px;opacity:.85;">DLC: ${new Date(it.date).toLocaleDateString('fr')} ‚Ä¢ TOO GOOD TO GO ‚Ä¢ ${it.printQty} √©tiquette(s)</div>
          </div>`:`<div class="small" style="text-align:center;color:#9333ea;opacity:.6;padding:8px;">Entrez un prix pour voir l'aper√ßu</div>`}
        </div>`;
      }).join('');
    },

    setPrice(idx,v){this._items[idx].price=v;this.renderConfigSection();},
    setPct(idx,v){this._items[idx].pct=Math.max(1,Math.min(99,parseInt(v)||50));this.renderConfigSection();},
    setPrintQty(idx,v){this._items[idx].printQty=Math.max(1,Math.min(50,parseInt(v)||1));this.renderConfigSection();},

    buildZpl(it){
      const prixOrig=parseFloat(it.price||0).toFixed(2);
      const prixReduit=(parseFloat(it.price||0)*(1-it.pct/100)).toFixed(2);
      const dlcStr=new Date(it.date).toLocaleDateString('fr');
      const nameLine1=(it.name||'').substring(0,22);
      const nameLine2=(it.name||'').length>22?(it.name||'').substring(22,44):'';
      // ZPL for Brother TD-2120N 62mm width, 203dpi
      return `^XA^MMT
^PW480
^LL320
^CF0,30^FO15,10^FD${nameLine1}^FS
${nameLine2?`^CF0,30^FO15,45^FD${nameLine2}^FS`:''}
^FO15,${nameLine2?85:55}^GB450,3,3^FS
^CF0,60^FO15,${nameLine2?95:65}^FD${prixReduit} EUR^FS
^CF0,22^FO250,${nameLine2?105:75}^FDau lieu de ${prixOrig} EUR^FS
^FO15,${nameLine2?160:130}^GB450,3,3^FS
^CF0,48^FO15,${nameLine2?170:140}^FD-${it.pct}%^FS
^CF0,22^FO110,${nameLine2?183:153}^FDTOO GOOD TO GO^FS
^CF0,18^FO15,${nameLine2?225:195}^FDDLC: ${dlcStr}^FS
^XZ`;
    },

    printAll:async function(){
      const toprint=this._items.filter(it=>it.selected&&it.price&&parseFloat(it.price)>0);
      if(!toprint.length)return toast('S√©lectionnez des produits avec un prix valide.','warn');
      const ip=(document.getElementById('etiq-printer-ip')?.value||'').trim();
      const port=parseInt(document.getElementById('etiq-printer-port')?.value||'9100');
      let allZpl='';
      toprint.forEach(it=>{for(let i=0;i<it.printQty;i++)allZpl+=this.buildZpl(it)+'\n';});
      const totalLabels=toprint.reduce((s,it)=>s+it.printQty,0);

      if(!ip){
        toast(`Pas d'IP configur√©e ‚Äî t√©l√©chargement ZPL (${totalLabels} √©tiquettes).`,'warn',5000);
        this._downloadZpl(allZpl,totalLabels);return;
      }
      toast(`Envoi de ${totalLabels} √©tiquette(s) vers ${ip}:${port}‚Ä¶`,'info',3000);
      try{
        const resp=await fetch(`http://${ip}/print`,{method:'POST',headers:{'Content-Type':'text/plain','Accept':'*/*'},body:allZpl,signal:AbortSignal.timeout(10000)});
        if(resp.ok){toast(`‚úì ${totalLabels} √©tiquette(s) imprim√©e(s) !`,'ok',4000);}
        else{throw new Error('HTTP '+resp.status);}
      }catch(e){
        toast('Connexion imprimante √©chou√©e ‚Äî t√©l√©chargement ZPL.','warn',4000);
        this._downloadZpl(allZpl,totalLabels);
      }
    },

    _downloadZpl(zpl,n){
      const blob=new Blob([zpl],{type:'application/octet-stream'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`etiquettes_${n}x.zpl`;a.click();URL.revokeObjectURL(url);
    },

    testPrinter:async function(){
      const ip=(document.getElementById('etiq-printer-ip')?.value||'').trim();
      if(!ip)return toast('Entrez l\'IP de l\'imprimante.','warn');
      const port=parseInt(document.getElementById('etiq-printer-port')?.value||'9100');
      const status=document.getElementById('etiq-printer-status');
      status.textContent='Test en cours‚Ä¶';status.style.color='#f59e0b';
      try{
        const r=await fetch(`http://${ip}/`,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(4000)});
        status.textContent=`‚úì Imprimante accessible ‚Äî ${ip}:${port}`;status.style.color='#10b981';
        toast('Imprimante accessible !','ok');
      }catch(e){
        status.textContent=`‚úó Non accessible ‚Äî v√©rifiez IP et r√©seau`;status.style.color='#ef4444';
        toast('Imprimante non accessible. V√©rifiez l\'IP et le r√©seau Wi-Fi.','warn',5000);
      }
    }
  }

};
window.app.initOffline();

// Wire photo inputs
document.getElementById('cam-input').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{document.getElementById('img-preview').src=b64;document.getElementById('img-preview').style.display='block';document.getElementById('lib-img-data').value=b64;});});
document.getElementById('trace-file').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{window.app.trace.imgData=b64;document.getElementById('trace-preview').src=b64;document.getElementById('trace-preview').style.display='block';});});

// Auth state
onAuthStateChanged(auth,async user=>{
  if(!user){
    document.getElementById('login-overlay').classList.remove('hidden');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('app-nav').classList.add('hidden');
    window.app.me=null;
    window.app.data={frais:[],users:[],pvpLib:[],pvpStock:[],checkedNeeds:[],saladLib:[],saladStock:[],frigo:{perDay:2,fridges:[],logs:[]},todo:{zones:[],tasks:[]},todoLogs:[],reception:[]};
    return;
  }
  await window.app.afterLoginBootstrap();
});
</script>
</body>
</html>
