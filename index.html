<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Araujo Exploitation v77 (Final)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root {
    --primary: #003896;
    --accent: #E2001A;
    --pvp: #d97706;
    --bg: #f3f4f6;
    --surface: #ffffff;
    --text: #1e293b;
    --success: #10b981;
    --danger: #ef4444;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; user-select: none; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  .hidden { display: none !important; }
  main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
  .card { background: var(--surface); border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }

  /* HEADER & NAV */
  header { background: var(--surface); padding: 10px; height: 90px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
  .logo-header { height: 60px; object-fit: contain; }
  .user-badge { position: absolute; right: 15px; top: 15px; font-size: 11px; background: #e0f2fe; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-weight: bold; }
  
  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; padding: 0 30px; }
  .nav-btn { text-align:center; color:#94a3b8; cursor: pointer; }
  .nav-btn.active { color: var(--primary); }

  /* LOGIN */
  .overlay { position: fixed; inset: 0; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
  #login-user-select { width: 220px; padding: 12px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #cbd5e1; background: #f8fafc; font-size: 16px; font-weight: bold; text-align: center; }
  #login-pass { width: 220px; padding: 12px; font-size: 20px; text-align: center; border: 1px solid #e2e8f0; border-radius: 50px; margin-bottom: 20px; font-weight: bold; }

  /* TABS */
  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
  .tab { flex: 1; text-align: center; padding: 12px; font-weight: 700; font-size: 12px; color: #64748b; border-radius: 9px; cursor: pointer; transition: 0.2s; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .tab.active-pvp { background: white; color: var(--pvp); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* UI ELEMENTS */
  input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; margin-bottom: 10px; outline: none; }
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; margin-top: 5px; }
  .btn-orange { background: var(--pvp); } .btn-red { background: #ef4444; }

  /* ACCORDION */
  .group-header { background: #334155; color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; text-transform: uppercase; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .group-header i { transition: transform 0.3s; }
  .group-header.closed i { transform: rotate(-90deg); }
  .group-content { overflow: hidden; transition: max-height 0.3s ease-out; }
  .group-content.closed { display: none; }

  /* TARGET GRID (PREVISIONS) */
  .target-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
  .target-box { display: flex; flex-direction: column; align-items: center; }
  .target-box label { font-size: 10px; font-weight: bold; margin-bottom: 2px; color: #64748b; }
  .target-box input { padding: 5px; text-align: center; font-weight: bold; border-radius: 8px; height: 45px; width: 100%; font-size: 18px; margin: 0; }

  /* ITEMS */
  .swipe-wrapper { background: #ef4444; overflow: hidden; margin-bottom: 8px; border-radius: 12px; }
  .pvp-row-container { position: relative; overflow: hidden; margin-bottom: 8px; background: #fee2e2; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .pvp-row-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; padding-left: 20px; color: #ef4444; font-weight: bold; font-size: 14px; z-index: 1; }
  .pvp-item { position: relative; z-index: 2; background: white; display: flex; justify-content: space-between; align-items: center; padding: 12px; width: 100%; border-radius: 12px; will-change: transform; min-height: 80px; }
  
  .wek-img { width: 55px; height: 55px; border-radius: 10px; object-fit: cover; background: #f1f5f9; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #cbd5e1; flex-shrink: 0; cursor: pointer; border: 1px solid #e2e8f0; }
  
  /* STOCK DATES */
  .stock-dates { text-align: right; display: flex; flex-direction: column; justify-content: center; min-width: 90px; }
  .date-out { font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
  .date-end { font-size: 14px; font-weight: 800; color: var(--success); }
  .date-end.expired { color: var(--danger); }

  .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .home-btn { padding: 30px 10px; text-align: center; border-radius: 16px; color: white; cursor: pointer; font-weight: bold; }

  /* CHECKBOX */
  .checkbox-circle { width: 32px; height: 32px; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; font-size: 16px; margin-left: 10px; flex-shrink: 0; }
  .checkbox-circle.checked { background: var(--success); border-color: var(--success); color: white; }
  .done-item { opacity: 0.5; filter: grayscale(1); background: #f1f5f9; }
  .done-item b { text-decoration: line-through; }

  /* MODALS */
  .modal-bc { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .modal-card { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
  #bc-img-display { width: 100%; height: 250px; object-fit: contain; background: #f8fafc; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; }
</style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="login-logo" style="width:200px; margin-bottom:30px;">
    <select id="login-user-select"></select>
    <input type="password" id="login-pass" placeholder="CODE">
    <button class="btn" onclick="app.login()" style="width:220px;border-radius:50px;background:#00563f;">CONNEXION</button>
  </div>

  <div id="modal-barcode" class="modal-bc hidden">
    <div class="modal-card" style="text-align:center;">
        <h3 id="bc-name">Produit</h3>
        <img id="bc-img-display" style="display:none;">
        <svg id="barcode"></svg>
        <button class="btn" style="background:#eee;color:#333;margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <div id="modal-edit-frais" class="modal-bc hidden">
    <div class="modal-card">
        <h3>Modifier Frais</h3>
        <input type="hidden" id="edit-id">
        <label>Famille</label><select id="edit-famille"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
        <label>Qté</label><input type="number" id="edit-qty">
        <label>DLC</label><input type="date" id="edit-date">
        <button class="btn" onclick="app.frais.saveEdit()" style="background:#00563f;">Enregistrer</button>
        <button class="btn" onclick="app.frais.del()" style="background:#ef4444;">Supprimer</button>
        <button class="btn" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')" style="background:#eee;color:#333;">Annuler</button>
    </div>
  </div>

  <div id="modal-pvp-lib" class="modal-bc hidden">
    <div class="modal-card">
        <h3 style="color:#d97706">Fiche Produit PVP</h3>
        <input type="hidden" id="lib-id"> 
        <input type="hidden" id="lib-img-data">
        
        <label>Famille</label>
        <select id="lib-fam-select" onchange="app.pvp.toggleFamInput()"></select>
        <input type="text" id="lib-fam-new" placeholder="Nom de la nouvelle famille..." class="hidden">

        <label>Nom du Produit</label><input type="text" id="lib-name" placeholder="Ex: Donut Sucre">
        <label>EAN (Code Barre)</label><input type="number" id="lib-ean">
        
        <label>Photo</label>
        <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none" onchange="app.pvp.handleImg(this)">
        <button class="btn" onclick="document.getElementById('cam-input').click()" style="background:#eee;color:#333;margin-bottom:10px;"><i class="fas fa-camera"></i> Prendre Photo</button>
        <img id="img-preview" style="width:100px;height:100px;object-fit:cover;border-radius:10px;display:none;margin:0 auto 10px auto;">

        <label>Règle de Date</label>
        <select id="lib-days">
            <option value="0">JOURNÉE (Jetter Soir 22h)</option>
            <option value="48">48 Heures (Donuts...)</option>
            <option value="72">72 Heures</option>
        </select>
        
        <label>Objectif de Cuisson (Lundi -> Dim)</label>
        <div class="target-grid">
            <div class="target-box"><label>L</label><input type="number" id="t-1"></div>
            <div class="target-box"><label>M</label><input type="number" id="t-2"></div>
            <div class="target-box"><label>M</label><input type="number" id="t-3"></div>
            <div class="target-box"><label>J</label><input type="number" id="t-4"></div>
            <div class="target-box"><label>V</label><input type="number" id="t-5"></div>
            <div class="target-box"><label>S</label><input type="number" id="t-6"></div>
            <div class="target-box"><label>D</label><input type="number" id="t-0"></div>
        </div>

        <button class="btn" onclick="app.pvp.saveLib()" style="background:#d97706;">Enregistrer</button>
        <button class="btn" onclick="app.pvp.delLib()" style="background:#ef4444;" id="btn-del-lib">Supprimer</button>
        <button class="btn" onclick="document.getElementById('modal-pvp-lib').classList.add('hidden')" style="background:#eee;color:#333;">Fermer</button>
    </div>
  </div>

  <div id="modal-pvp-stock" class="modal-bc hidden">
      <div class="modal-card">
          <h3 style="color:#d97706">Modifier Rayon</h3>
          <input type="hidden" id="stock-id">
          <h4 id="stock-name" style="text-align:center;"></h4>
          <label>Quantité</label><input type="number" id="stock-qty">
          <label style="margin-top:15px;color:#64748b">Date Sortie (Prod)</label><input type="datetime-local" id="stock-start">
          <label style="color:#ef4444">Date Fin (Jeter)</label><input type="datetime-local" id="stock-end">
          <button class="btn" onclick="app.pvp.saveStock()" style="background:#d97706;">Valider Correction</button>
          <button class="btn" onclick="app.pvp.delStock()" style="background:#ef4444;">Retirer du Rayon</button>
          <button class="btn" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')" style="background:#eee;color:#333;">Annuler</button>
      </div>
  </div>

  <header id="app-header" class="hidden">
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
    <div id="user-badge" class="user-badge">...</div>
  </header>

  <main>
    <div id="view-home">
        <div id="alert-box" style="display:none;background:#ef4444;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;font-weight:bold;">⚠️ Vérifier Dates !</div>
        
        <div class="home-grid">
            <div class="home-btn" onclick="app.nav('frais')" style="background: linear-gradient(135deg, #003896 0%, #002366 100%);"><i class="fas fa-barcode home-icon"></i><br>DLC FRAIS</div>
            <div class="home-btn" onclick="app.nav('pvp')" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%);"><i class="fas fa-bread-slice home-icon"></i><br>GESTION PVP</div>
        </div>
        <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;"><i class="fas fa-users"></i> Équipe</div>
    </div>

    <div id="view-frais" class="hidden">
        <div class="tabs">
            <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
            <div class="tab" id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
        </div>
        <div id="frais-scan">
            <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;"><video id="video" style="width:100%;height:100%;object-fit:cover;"></video></div>
            <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
            <div class="card">
                <input id="frais-ean" placeholder="EAN" oninput="if(this.value.length>8) app.frais.api(this.value)">
                <select id="frais-fam"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
                <input id="frais-name" placeholder="Nom">
                <div style="display:flex;gap:10px;"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qté"></div>
                <button class="btn" onclick="app.frais.add()">AJOUTER</button>
            </div>
        </div>
        <div id="frais-list" class="hidden"></div>
    </div>

    <div id="view-pvp" class="hidden">
        <div class="tabs">
            <div class="tab active" id="tp-1" onclick="app.pvp.tab('stock')">RAYON</div>
            <div class="tab" id="tp-2" onclick="app.pvp.tab('bib')">BIBLIOTHÈQUE</div>
            <div class="tab" id="tp-3" onclick="app.pvp.tab('calc')">BESOINS</div>
        </div>
        <div id="pvp-stock"></div>
        <div id="pvp-bib" class="hidden">
            <button class="btn" onclick="app.pvp.openLib()" style="background:#eee;color:#333;margin-bottom:15px;">+ Créer Produit</button>
            <div id="lib-list"></div>
        </div>
        <div id="pvp-calc" class="hidden"></div>
    </div>

    <div id="view-team" class="hidden">
        <div class="card">
            <input id="new-u-name" placeholder="Nom"><input id="new-u-code" placeholder="Code">
            <button class="btn" onclick="app.saveUser()">Créer Staff</button>
        </div>
        <div class="card" id="user-list"></div>
    </div>
  </main>

  <nav id="app-nav" class="hidden">
      <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left" style="font-size:24px;"></i><br><span style="font-size:10px;">RETOUR</span></div>
      <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large" style="font-size:24px;"></i><br><span style="font-size:10px;">MENU</span></div>
  </nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const db = getFirestore(initializeApp({ apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA", authDomain: "araujo-exploitation.firebaseapp.com", projectId: "araujo-exploitation" }));
const docRef = doc(db, "store_master", "STOCK_MAGASIN_LIVE");
const codeReader = new ZXing.BrowserMultiFormatReader();

window.app = {
    data: { frais: [], users: [], pvpLib: [], pvpStock: [], checkedNeeds: [] },
    viewHistory: [],
    closedFamilies: new Set(),
    
    common: {
        showBarcode: function(ean, name, imgUrl=null) { 
            document.getElementById('modal-barcode').classList.remove('hidden'); 
            document.getElementById('bc-name').innerText=name; 
            let imgEl = document.getElementById('bc-img-display');
            if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display='block'; } else { imgEl.style.display='none'; }
            if(ean) {
                try{JsBarcode("#barcode", ean, {format:"EAN13", height:80, displayValue:true});}
                catch(e){try{JsBarcode("#barcode", ean, {format:"CODE128", height:80, displayValue:true});}catch(e2){}}
            } else { document.getElementById('barcode').style.display='none'; }
        },
        tsToInput: function(ts) {
            let d = new Date(ts);
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        },
        calculateEnd: function(startTs, hours) {
            let start = new Date(startTs);
            let end = new Date(startTs);
            let h = parseInt(hours);
            if (h === 0) { end.setHours(22, 0, 0, 0); } else { end.setHours(end.getHours() + h); }
            return end.getTime();
        },
        cleanName: function(name) { return name.toUpperCase().replace(/^[\d\s\.,xX]+(G|KG|ML|CL|L|P)?\s*/g, ''); },
        compressImg: function(file, callback) {
            let reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                let img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    let canvas = document.createElement('canvas'); let ctx = canvas.getContext('2d');
                    let max = 600; let w = img.width, h = img.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        }
    },

    init: function() {
        onSnapshot(docRef, (s) => {
            if(s.exists()) {
                let d = s.data();
                this.data = {
                    frais: d.frais || [],
                    users: d.users || [{name:"MANAGER",code:"2008",role:"admin"}],
                    pvpLib: d.pvpLib || [],
                    pvpStock: d.pvpStock || [],
                    checkedNeeds: d.checkedNeeds || []
                };
            } else {
                this.data = { frais:[], users:[{name:"MANAGER",code:"2008",role:"admin"}], pvpLib:[], pvpStock:[], checkedNeeds: [] };
                this.save();
            }
            this.updateUI();
        });
    },

    save: function() { setDoc(docRef, this.data, {merge:true}); },
    
    updateUI: function() {
        let sel = document.getElementById('login-user-select');
        sel.innerHTML = this.data.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        this.frais.render();
        this.pvp.render();
        this.renderUsers();
        this.checkAlerts();
    },

    login: function() {
        let name = document.getElementById('login-user-select').value;
        let code = document.getElementById('login-pass').value;
        let u = this.data.users.find(x => x.name == name && x.code == code);
        if(u) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('user-badge').innerText = u.name;
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('app-nav').classList.remove('hidden');
            if(u.role=='admin') document.getElementById('btn-team').classList.remove('hidden');
        } else alert('Code Erreur');
    },

    nav: function(v, saveHistory = true) {
        let current = document.querySelector('div[id^="view-"]:not(.hidden)');
        if(saveHistory && current) {
            let id = current.id.replace('view-', '');
            if(id !== v) this.viewHistory.push(id);
        }
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-'+v).classList.remove('hidden');
    },
    
    goBack: function() {
        if(this.viewHistory.length > 0) { let prev = this.viewHistory.pop(); this.nav(prev, false); }
        else { this.nav('home', false); }
    },

    toggleFam: function(famName) {
        if(this.closedFamilies.has(famName)) this.closedFamilies.delete(famName);
        else this.closedFamilies.add(famName);
        this.frais.render();
        this.pvp.render();
    },

    // --- MODULE FRAIS ---
    frais: {
        scanning: false,
        imgUrl: "",
        tab: function(t) {
            document.querySelectorAll('#view-frais .tab').forEach(e => e.classList.remove('active'));
            document.getElementById(t=='scan'?'tf-1':'tf-2').classList.add('active');
            document.getElementById('frais-scan').classList.add('hidden');
            document.getElementById('frais-list').classList.add('hidden');
            document.getElementById('frais-'+t).classList.remove('hidden');
        },
        toggleScan: function() {
            if(this.scanning) { this.scanning=false; document.getElementById('scanner-box').style.display='none'; codeReader.reset(); }
            else { 
                this.scanning=true; document.getElementById('scanner-box').style.display='block';
                codeReader.decodeFromVideoDevice(null, 'video', (r) => { if(r){ this.api(r.text); document.getElementById('frais-ean').value=r.text; this.toggleScan(); } });
            }
        },
        api: async function(ean) {
            try {
                let r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
                let d = await r.json();
                if(d.status==1) {
                    document.getElementById('frais-name').value = d.product.product_name_fr || "";
                    this.imgUrl = d.product.image_front_small_url || "";
                }
            } catch(e){}
        },
        add: function() {
            let o = {
                id: Date.now(),
                ean: document.getElementById('frais-ean').value,
                fam: document.getElementById('frais-fam').value,
                name: document.getElementById('frais-name').value,
                qty: document.getElementById('frais-qty').value,
                date: document.getElementById('frais-date').value,
                img: this.imgUrl
            };
            if(!o.name || !o.date) return alert('Date requise');
            window.app.data.frais.push(o); window.app.save(); alert('Ajouté');
            this.imgUrl=""; document.getElementById('frais-name').value=""; document.getElementById('frais-ean').value="";
        },
        render: function() {
            let div = document.getElementById('frais-list'); div.innerHTML="";
            let grp = {};
            window.app.data.frais.sort((a,b) => {
                if(a.fam !== b.fam) return a.fam.localeCompare(b.fam);
                return window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name));
            });
            window.app.data.frais.forEach(i=>{ if(!grp[i.fam])grp[i.fam]=[]; grp[i.fam].push(i); });
            for(let f in grp) {
                let isClosed = window.app.closedFamilies.has(f);
                let icon = isClosed ? 'fa-chevron-right' : 'fa-chevron-down';
                div.innerHTML += `<div class="group-header" onclick="app.toggleFam('${f}')"><span>${f}</span><i class="fas ${icon}"></i></div>`;
                let content = document.createElement('div');
                content.className = isClosed ? 'group-content closed' : 'group-content';
                grp[f].forEach(i => {
                    let d = new Date(i.date);
                    let diff = (d - new Date())/(1000*60*60*24);
                    let badge = diff<0?'badge-red':(diff<2?'badge-orange':'badge-green');
                    let clickAction = `onclick="event.stopPropagation(); window.app.common.showBarcode('${i.ean}','${i.name.replace(/'/g," ")}','${i.img||""}')"`;
                    let img = i.img ? `<img src="${i.img}" class="wek-img" ${clickAction}>` : `<div class="wek-img" ${clickAction}><i class="fas fa-barcode"></i></div>`;
                    content.innerHTML += `
                    <div class="swipe-wrapper"><div class="wek-item-frais" onclick="app.frais.openEdit(${i.id})">
                        <div style="display:flex;align-items:center;">${img}<div><div style="font-weight:bold;">${i.name}</div><span class="wek-qty">x${i.qty}</span></div></div>
                        <div class="date-badge ${badge}"><span style="font-size:16px;">${d.getDate()}</span><span style="font-size:10px;text-transform:uppercase;">${d.toLocaleString('fr',{month:'short'})}</span></div>
                    </div></div>`;
                });
                div.appendChild(content);
            }
        },
        openEdit: function(id) {
            let i = window.app.data.frais.find(x => x.id == id);
            document.getElementById('modal-edit-frais').classList.remove('hidden');
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-famille').value = i.fam;
            document.getElementById('edit-qty').value = i.qty;
            document.getElementById('edit-date').value = i.date;
        },
        saveEdit: function() {
            let id = document.getElementById('edit-id').value;
            let idx = window.app.data.frais.findIndex(x => x.id == id);
            if(idx>-1) {
                window.app.data.frais[idx].fam = document.getElementById('edit-famille').value;
                window.app.data.frais[idx].qty = document.getElementById('edit-qty').value;
                window.app.data.frais[idx].date = document.getElementById('edit-date').value;
                window.app.save(); document.getElementById('modal-edit-frais').classList.add('hidden');
            }
        },
        del: function() {
            let id = document.getElementById('edit-id').value;
            window.app.data.frais = window.app.data.frais.filter(x => x.id != id);
            window.app.save(); document.getElementById('modal-edit-frais').classList.add('hidden');
        }
    },

    // --- MODULE PVP ---
    pvp: {
        tab: function(t) {
            document.querySelectorAll('#view-pvp .tab').forEach(e => e.classList.remove('active-pvp'));
            document.getElementById(t=='stock'?'tp-1':(t=='bib'?'tp-2':'tp-3')).classList.add('active-pvp');
            ['pvp-stock','pvp-bib','pvp-calc'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('pvp-'+t).classList.remove('hidden');
        },
        handleImg: function(input) {
            if(input.files && input.files[0]) {
                window.app.common.compressImg(input.files[0], (base64) => {
                    document.getElementById('img-preview').src = base64; 
                    document.getElementById('img-preview').style.display='block';
                    document.getElementById('lib-img-data').value = base64;
                });
            }
        },
        toggleFamInput: function() {
            let val = document.getElementById('lib-fam-select').value;
            if(val === 'new') document.getElementById('lib-fam-new').classList.remove('hidden');
            else document.getElementById('lib-fam-new').classList.add('hidden');
        },
        openLib: function(id=null) {
            document.getElementById('modal-pvp-lib').classList.remove('hidden');
            document.getElementById('img-preview').style.display='none';
            let uniqueFams = [...new Set(window.app.data.pvpLib.map(i => i.family || "DIVERS"))].sort();
            let sel = document.getElementById('lib-fam-select');
            sel.innerHTML = uniqueFams.map(f => `<option value="${f}">${f}</option>`).join('') + `<option value="new">Créer une nouvelle...</option>`;
            if(id) {
                let i = window.app.data.pvpLib.find(x=>x.id==id);
                document.getElementById('lib-id').value=id;
                document.getElementById('lib-name').value=i.name;
                document.getElementById('lib-ean').value=i.ean||"";
                document.getElementById('lib-days').value=i.days||0;
                document.getElementById('lib-img-data').value=i.img||"";
                document.getElementById('lib-fam-select').value = i.family || "DIVERS";
                document.getElementById('lib-fam-new').classList.add('hidden');
                if(i.img){ document.getElementById('img-preview').src=i.img; document.getElementById('img-preview').style.display='block'; }
                document.getElementById('btn-del-lib').classList.remove('hidden');
                for(let k=0;k<7;k++) document.getElementById('t-'+k).value = (i.targets||{})[k]||"";
            } else {
                document.getElementById('lib-id').value=""; document.getElementById('lib-name').value=""; document.getElementById('lib-ean').value="";
                document.getElementById('lib-img-data').value=""; document.getElementById('lib-days').value=0;
                document.getElementById('btn-del-lib').classList.add('hidden');
                document.getElementById('lib-fam-new').classList.add('hidden');
                for(let k=0;k<7;k++) document.getElementById('t-'+k).value = "";
            }
        },
        saveLib: function() {
            let id = document.getElementById('lib-id').value;
            let famSelect = document.getElementById('lib-fam-select').value;
            let famNew = document.getElementById('lib-fam-new').value;
            let finalFam = (famSelect === 'new' && famNew) ? famNew.toUpperCase() : famSelect;
            let o = {
                id: id ? Number(id) : Date.now(),
                family: finalFam,
                name: document.getElementById('lib-name').value,
                ean: document.getElementById('lib-ean').value,
                img: document.getElementById('lib-img-data').value,
                days: document.getElementById('lib-days').value,
                targets: {}
            };
            for(let k=0;k<7;k++) o.targets[k] = document.getElementById('t-'+k).value;
            if(!o.name) return alert("Nom du produit requis !");
            if(id) {
                let idx = window.app.data.pvpLib.findIndex(x=>x.id==id);
                if(idx>-1) window.app.data.pvpLib[idx] = o;
            } else { window.app.data.pvpLib.push(o); }
            window.app.save(); document.getElementById('modal-pvp-lib').classList.add('hidden');
        },
        delLib: function() {
            let id = document.getElementById('lib-id').value;
            window.app.data.pvpLib = window.app.data.pvpLib.filter(x=>x.id!=id);
            window.app.save(); document.getElementById('modal-pvp-lib').classList.add('hidden');
        },
        addStock: function(libId) {
            let l = window.app.data.pvpLib.find(x=>x.id==libId);
            let qty = prompt('Quantité ?', "1");
            if(qty && qty>0) {
                let now = new Date();
                let endTs = window.app.common.calculateEnd(now.getTime(), l.days);
                window.app.data.pvpStock.push({ id:Date.now(), libId:libId, name:l.name, ean:l.ean, qty:qty, out:now.getTime(), end:endTs, days:l.days });
                window.app.save();
                alert("Ajouté au rayon !");
            }
        },
        openEditStock: function(id) {
            let i = window.app.data.pvpStock.find(x=>x.id==id);
            document.getElementById('modal-pvp-stock').classList.remove('hidden');
            document.getElementById('stock-id').value=id;
            document.getElementById('stock-name').innerText=i.name;
            document.getElementById('stock-qty').value=i.qty;
            document.getElementById('stock-start').value = window.app.common.tsToInput(i.out);
            document.getElementById('stock-end').value = window.app.common.tsToInput(i.end);
            document.getElementById('stock-start').onchange = function() {
                let newStart = new Date(this.value).getTime();
                let newEnd = window.app.common.calculateEnd(newStart, i.days);
                document.getElementById('stock-end').value = window.app.common.tsToInput(newEnd);
            };
        },
        saveStock: function() {
            let id = document.getElementById('stock-id').value;
            let idx = window.app.data.pvpStock.findIndex(x=>x.id==id);
            if(idx>-1) {
                window.app.data.pvpStock[idx].qty = document.getElementById('stock-qty').value;
                window.app.data.pvpStock[idx].out = new Date(document.getElementById('stock-start').value).getTime();
                window.app.data.pvpStock[idx].end = new Date(document.getElementById('stock-end').value).getTime();
                window.app.save(); document.getElementById('modal-pvp-stock').classList.add('hidden');
            }
        },
        delStock: function() {
            let id = document.getElementById('stock-id').value;
            window.app.data.pvpStock = window.app.data.pvpStock.filter(x=>x.id!=id);
            window.app.save(); document.getElementById('modal-pvp-stock').classList.add('hidden');
        },
        attachSwipe: function(el, id) {
            let startX = 0;
            el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; el.style.transition = 'none'; });
            el.addEventListener('touchmove', e => { if(e.touches[0].clientX - startX > 0) el.style.transform = `translateX(${e.touches[0].clientX - startX}px)`; });
            el.addEventListener('touchend', e => {
                el.style.transition = 'transform 0.3s ease';
                if(e.changedTouches[0].clientX - startX > 250) {
                     el.style.transform = `translateX(100%)`;
                     setTimeout(() => { window.app.data.pvpStock = window.app.data.pvpStock.filter(x=>x.id!=id); window.app.save(); }, 300);
                } else { el.style.transform = `translateX(0)`; }
            });
        },
        toggleNeed: function(libId) {
            let idx = window.app.data.checkedNeeds.indexOf(libId);
            if(idx > -1) window.app.data.checkedNeeds.splice(idx, 1);
            else window.app.data.checkedNeeds.push(libId);
            window.app.save();
        },
        render: function() {
            // 1. BIB (Library)
            let bib = document.getElementById('lib-list'); bib.innerHTML = window.app.data.pvpLib.length ? "" : "Vide";
            let groupedLib = {};
            window.app.data.pvpLib.sort((a,b) => window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)));
            window.app.data.pvpLib.forEach(l => { let f = l.family || "DIVERS"; if(!groupedLib[f]) groupedLib[f] = []; groupedLib[f].push(l); });
            Object.keys(groupedLib).sort().forEach(fam => {
                let isClosed = window.app.closedFamilies.has('L-'+fam);
                let icon = isClosed ? 'fa-chevron-right' : 'fa-chevron-down';
                bib.innerHTML += `<div class="group-header" onclick="app.toggleFam('L-${fam}')"><span>${fam}</span><i class="fas ${icon}"></i></div>`;
                let content = document.createElement('div'); content.className = isClosed ? 'group-content closed' : 'group-content';
                groupedLib[fam].forEach(l => {
                    let clickAction = `onclick="event.stopPropagation(); window.app.common.showBarcode('${l.ean}','${l.name.replace(/'/g," ")}','${l.img||""}')"`
                    let img = l.img ? `<img src="${l.img}" class="wek-img" ${clickAction}>` : `<div class="wek-img" ${clickAction}><i class="fas fa-bread-slice"></i></div>`;
                    content.innerHTML += `<div class="pvp-item" style="justify-content:space-between;"><div style="display:flex;align-items:center;" onclick="app.pvp.openLib(${l.id})">${img}<div><b>${l.name}</b><br><small>${l.days}h</small></div></div><button class="btn-orange" style="width:40px;height:40px;border-radius:50%;padding:0;" onclick="app.pvp.addStock(${l.id})">+</button></div>`;
                });
                bib.appendChild(content);
            });

            // 2. STOCK
            let st = document.getElementById('pvp-stock'); st.innerHTML = window.app.data.pvpStock.length ? "" : "<div style='text-align:center;margin-top:20px;color:#999'>Rayon Vide</div>";
            let groupedStock = {};
            window.app.data.pvpStock.sort((a,b)=>a.end-b.end);
            window.app.data.pvpStock.forEach(s => {
                let libItem = window.app.data.pvpLib.find(l => l.id == s.libId);
                let fam = libItem ? (libItem.family || "DIVERS") : "DIVERS";
                if(!groupedStock[fam]) groupedStock[fam] = [];
                groupedStock[fam].push(s);
            });

            let now = new Date(); let todayStr = now.toDateString();
            Object.keys(groupedStock).sort().forEach(fam => {
                 let isClosed = window.app.closedFamilies.has('S-'+fam);
                 let icon = isClosed ? 'fa-chevron-right' : 'fa-chevron-down';
                 st.innerHTML += `<div class="group-header" style="background:#d97706" onclick="app.toggleFam('S-${fam}')"><span>${fam}</span><i class="fas ${icon}"></i></div>`;
                 let content = document.createElement('div'); content.className = isClosed ? 'group-content closed' : 'group-content';
                 
                 groupedStock[fam].forEach(i => {
                    let dStart = new Date(i.out); let dEnd = new Date(i.end);
                    let isToday = dEnd.toDateString() === todayStr; let dateColor = isToday ? 'expired' : '';
                    let lib = window.app.data.pvpLib.find(x => x.id == i.libId);
                    let displayImg = lib && lib.img ? lib.img : null;
                    let clickAction = `onclick="event.stopPropagation(); window.app.common.showBarcode('${i.ean}','${i.name.replace(/'/g," ")}','${displayImg||""}')"`
                    let imgHTML = displayImg ? `<img src="${displayImg}" class="wek-img" ${clickAction}>` : `<div class="wek-img" ${clickAction}><i class="fas fa-bread-slice"></i></div>`;
                    
                    let container = document.createElement('div'); container.className = 'pvp-row-container';
                    container.innerHTML = `<div class="pvp-row-bg"><i class="fas fa-trash"></i> JETER</div>`;
                    let item = document.createElement('div'); item.className = 'pvp-item';
                    item.innerHTML = `
                    <div style="display:flex;align-items:center;flex:1;">
                        ${imgHTML}
                        <div style="overflow:hidden;margin-right:10px;">
                            <div style="font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:15px;">${i.name}</div>
                            <span class="wek-qty">Qté: x${i.qty}</span>
                        </div>
                    </div>
                    <div class="stock-dates">
                        <div class="date-out">Sortie: ${dStart.getDate()}/${dStart.getMonth()+1} ${dStart.getHours()}h${dStart.getMinutes()<10?'0':''}${dStart.getMinutes()}</div>
                        <div class="date-end ${dateColor}">FIN: ${dEnd.getDate()}/${dEnd.getMonth()+1} ${dEnd.getHours()}h${dEnd.getMinutes()<10?'0':''}${dEnd.getMinutes()}</div>
                    </div>`;
                    item.onclick = () => window.app.pvp.openEditStock(i.id);
                    this.attachSwipe(item, i.id);
                    container.appendChild(item);
                    content.appendChild(container);
                 });
                 st.appendChild(content);
            });

            // 3. BESOINS (A SORTIR) - Grouped by Family
            let cl = document.getElementById('pvp-calc'); 
            let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            let tomDayIndex = tomorrow.getDay(); 
            let dayNames = ['DIMANCHE','LUNDI','MARDI','MERCREDI','JEUDI','VENDREDI','SAMEDI'];
            let criticalTime = new Date(tomorrow); criticalTime.setHours(10, 0, 0, 0);

            let groupedTodo = {};
            let doneListHTML = "";
            let hasNeeds = false;

            window.app.data.pvpLib.forEach(l => {
                let valid = window.app.data.pvpStock.filter(s => s.libId == l.id && s.end > criticalTime.getTime()).reduce((a,b)=>a+parseInt(b.qty),0);
                let target = (l.targets && l.targets[tomDayIndex]) ? parseInt(l.targets[tomDayIndex]) : 0;
                let need = target - valid;
                
                if(need > 0) {
                    hasNeeds = true;
                    let isChecked = window.app.data.checkedNeeds.includes(l.id);
                    let displayImg = l.img ? l.img : null;
                    let clickAction = `onclick="event.stopPropagation(); window.app.common.showBarcode('${l.ean}','${l.name.replace(/'/g," ")}','${displayImg||""}')"`
                    let imgHTML = displayImg ? `<img src="${displayImg}" class="wek-img" ${clickAction}>` : `<div class="wek-img" ${clickAction}><i class="fas fa-bread-slice"></i></div>`;

                    let htmlItem = `
                    <div class="${isChecked?'pvp-item done-item':'pvp-item'}" style="margin-bottom:10px; border-left:5px solid #d97706;">
                        <div style="flex:1;display:flex;align-items:center;">
                            ${imgHTML}
                            <div>
                                <b>${l.name}</b><br>
                                <small style="color:#666">Obj: ${target} - Stock: ${valid}</small>
                                <div style="color:#d97706;font-weight:bold;font-size:18px;">A SORTIR: ${need}</div>
                            </div>
                        </div>
                        <div class="${isChecked?'checkbox-circle checked':'checkbox-circle'}" onclick="app.pvp.toggleNeed(${l.id})">${isChecked?'<i class="fas fa-check"></i>':''}</div>
                    </div>`;

                    if(isChecked) {
                        doneListHTML += htmlItem;
                    } else {
                        let fam = l.family || "DIVERS";
                        if(!groupedTodo[fam]) groupedTodo[fam] = [];
                        groupedTodo[fam].push(htmlItem);
                    }
                }
            });

            let finalHTML = `<h4 style="text-align:center;color:#003896;margin:0 0 15px 0;">A SORTIR (POUR ${dayNames[tomDayIndex]})</h4>`;
            
            if(!hasNeeds) {
                finalHTML += "<div style='text-align:center;margin-top:20px;color:#999'>Rien à préparer.</div>";
            } else {
                // Render Grouped TODOs
                Object.keys(groupedTodo).sort().forEach(fam => {
                    let isClosed = window.app.closedFamilies.has('N-'+fam);
                    let icon = isClosed ? 'fa-chevron-right' : 'fa-chevron-down';
                    finalHTML += `<div class="group-header" style="background:#003896" onclick="app.toggleFam('N-${fam}')"><span>${fam}</span><i class="fas ${icon}"></i></div>`;
                    let contentClass = isClosed ? 'group-content closed' : 'group-content';
                    finalHTML += `<div class="${contentClass}">${groupedTodo[fam].join('')}</div>`;
                });
            }

            finalHTML += `<h4 style="text-align:center;color:#64748b;margin:30px 0 15px 0;">DÉJÀ SORTI</h4>`;
            finalHTML += doneListHTML || "<div style='text-align:center;color:#ccc;font-size:12px;'>Aucun produit sorti</div>";

            cl.innerHTML = finalHTML;
        }
    },

    saveUser: function() { window.app.common.saveUser(); },
    checkAlerts: function() {
        let alert = window.app.data.frais.some(i => { return (new Date(i.date) - new Date())/(1000*60*60*24) < 1; });
        document.getElementById('alert-box').style.display = alert ? 'block' : 'none';
    },
    renderUsers: function() { window.app.common.renderUsers(); }
};

window.app.init();
</script>
</body>
</html>
