<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Araujo Exploitation v35</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  :root {
    --primary: #003896; /* Bleu Carrefour */
    --accent: #E2001A; /* Rouge Carrefour */
    --success: #10b981; --warning: #f59e0b;
    --bg: #F4F6F9; --surface: #ffffff; --text: #1e293b; --radius: 16px; --gray: #64748b;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, -apple-system, sans-serif; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* HEADER */
  header {
    background: var(--surface); padding: 10px 20px; padding-top: max(10px, env(safe-area-inset-top));
    display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 0 rgba(0,0,0,0.05); z-index: 50;
  }
  /* LOGO SVG */
  .logo-svg { height: 40px; width: 40px; }

  .brand { font-size: 16px; font-weight: 900; color: var(--primary); letter-spacing: -0.5px; text-transform: uppercase; line-height: 1.2; }

  /* TABS */
  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
  .tab { flex: 1; text-align: center; padding: 10px; font-weight: 700; font-size: 11px; color: #64748b; border-radius: 9px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* FILTRES */
  .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
  .filter-btn { flex: 1; border: 1px solid #cbd5e1; background: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #64748b; white-space: nowrap; cursor: pointer; }
  .filter-btn.active.red { background: var(--accent); color: white; border-color: var(--accent); }
  .filter-btn.active.orange { background: var(--warning); color: white; border-color: var(--warning); }
  .filter-btn.active.green { background: var(--success); color: white; border-color: var(--success); }
  .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  /* MAIN */
  main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
  .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }

  /* SCANNER */
  #scanner-container { width: 100%; height: 250px; background: black; border-radius: 12px; margin-bottom: 15px; overflow: hidden; display: none; }
  video { width: 100%; height: 100%; object-fit: cover; }
  .scan-btn { width: 100%; padding: 20px; background: var(--primary); color: white; font-weight: bold; font-size: 18px; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }

  /* LISTE DLC */
  .dlc-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border-radius: 12px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .dlc-red { border-left-color: var(--accent); background: #FEF2F2; }
  .dlc-orange { border-left-color: var(--warning); background: #FFF7ED; }
  .dlc-green { border-left-color: var(--success); }
  .dlc-gray { border-left-color: var(--gray); background: #f1f5f9; opacity: 0.8; }
  
  .dlc-img { width: 50px; height: 50px; border-radius: 8px; object-fit: contain; background: white; border: 1px solid #eee; margin-right: 12px; }
  .dlc-info { flex: 1; }
  .family-tag { font-size: 10px; background: #e0f2fe; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; margin-top: 4px; display: inline-block; }

  /* INPUTS */
  .input-group label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; outline: none; }

  /* NAV (SIMPLE) */
  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: center; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; }
  .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; cursor: pointer; width: 80px; }
  .nav-btn.active { color: var(--primary); } .nav-btn i { font-size: 24px; margin-bottom: 4px; }
  
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; }
  .hidden { display: none !important; }
  .overlay { position: fixed; inset: 0; background: var(--primary); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
</style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <svg class="logo-svg" style="height:80px; width:80px; margin-bottom:20px;" viewBox="0 0 100 100">
      <path fill="white" d="M50 0L93.3 25V75L50 100L6.7 75V25L50 0Z"/>
      <path fill="var(--primary)" d="M45 20 C25 20 20 40 20 50 C20 60 25 80 45 80 L55 80 L55 70 L45 70 C35 70 30 60 30 50 C30 40 35 30 45 30 L55 30 L55 20 Z"/>
      <path fill="white" d="M55 20 L55 30 L65 30 C75 30 80 40 80 50 C80 60 75 70 65 70 L55 70 L55 80 L65 80 C85 80 90 60 90 50 C90 40 85 20 65 20 Z"/>
    </svg>
    <h1 style="color: white; margin-bottom: 10px; font-size:20px;">ARAUJO EXPLOITATION</h1>
    <p style="color:white; margin-bottom:30px; opacity:0.8">v35.0</p>
    <input type="password" id="login-pass" placeholder="Code (2008)" style="text-align: center; margin-bottom: 20px; max-width: 200px;">
    <button class="btn" style="background: white; color: var(--primary); max-width: 200px;" onclick="window.app.login()">Connexion</button>
  </div>

  <header>
    <svg class="logo-svg" viewBox="0 0 100 100">
      <path fill="var(--accent)" d="M6.7 25 L50 0 L50 100 L6.7 75 Z"/>
      <path fill="var(--primary)" d="M50 0 L93.3 25 L93.3 75 L50 100 Z"/>
      <path fill="white" d="M45 20 C25 20 20 40 20 50 C20 60 25 80 45 80 L65 80 C85 80 90 60 90 50 C90 40 85 20 65 20 Z"/>
      <path fill="var(--primary)" d="M45 20 L55 20 L55 30 L45 30 C35 30 30 40 30 50 C30 60 35 70 45 70 L55 70 L55 80 L45 80 C25 80 20 60 20 50 C20 40 25 20 45 20"/>
      <path fill="var(--accent)" d="M65 20 C85 20 90 40 90 50 C90 60 85 80 65 80 L55 80 L55 70 L65 70 C75 70 80 60 80 50 C80 40 75 30 65 30 L55 30 L55 20 L65 20"/>
    </svg>
    <div class="brand">ARAUJO<br>EXPLOITATION</div>
  </header>

  <main>
    <div id="view-home">
      <div class="card" onclick="window.app.nav('frais')" style="text-align:center; cursor:pointer; padding:40px;">
        <i class="fas fa-barcode" style="font-size:60px; color:var(--primary); margin-bottom:20px;"></i>
        <h2 style="margin:0; color:var(--primary)">GESTION DLC</h2>
        <p style="color:#64748b; font-size:14px; margin-top:5px;">AccÃ©der au module</p>
      </div>
    </div>

    <div id="view-frais" class="hidden">
      <div class="tabs">
        <div id="tab-scan" class="tab active" onclick="window.app.switchTab('scan')">SCANNER</div>
        <div id="tab-list" class="tab" onclick="window.app.switchTab('list')">LISTE</div>
        <div id="tab-hist" class="tab" onclick="window.app.switchTab('hist')">HISTORIQUE</div>
      </div>

      <div id="content-scan">
        <div id="scanner-container"><video id="video"></video></div>
        <button id="btn-scan-toggle" class="scan-btn" onclick="window.app.toggleScanner()">
            <i class="fas fa-camera"></i> LANCER SCAN
        </button>

        <div class="card">
          <div id="frais-img-box" style="display:none; justify-content:center; margin-bottom:15px;">
            <img id="frais-img" style="height:120px; border-radius:12px; object-fit:contain; border:1px solid #eee;">
          </div>
          <div class="input-group"><label>EAN</label><input type="number" id="frais-ean" placeholder="Code..." oninput="if(this.value.length>=8) window.app.scanApi(this.value)"></div>
          
          <div class="input-group">
            <label>Famille (Auto)</label>
            <select id="frais-famille">
                <option value="DIVERS">DIVERS</option>
                <option value="ULTRA FRAIS">ULTRA FRAIS</option>
                <option value="CHARCUTERIE">CHARCUTERIE</option>
                <option value="VOLAILLE">VOLAILLE</option>
                <option value="BOUCHERIE">BOUCHERIE</option>
                <option value="TRAITEUR">TRAITEUR</option>
                <option value="FROMAGE">FROMAGE</option>
            </select>
          </div>

          <div class="input-group"><label>Nom</label><input type="text" id="frais-name" placeholder="Auto..."></div>
          <div style="display: flex; gap: 10px;">
             <div class="input-group" style="flex:2;"><label>DLC</label><input type="date" id="frais-date"></div>
             <div class="input-group" style="flex:1;"><label>QtÃ©</label><input type="number" id="frais-qty" value="1" style="text-align:center;"></div>
          </div>
          <button class="btn" onclick="window.app.addFrais()">VALIDER</button>
        </div>
      </div>

      <div id="content-list" class="hidden">
        <div class="filter-bar">
          <button class="filter-btn active" id="filter-all" onclick="window.app.filterList('all')">TOUT</button>
          <button class="filter-btn red" id="filter-red" onclick="window.app.filterList('red')">ðŸ”´ J-0</button>
          <button class="filter-btn orange" id="filter-orange" onclick="window.app.filterList('orange')">ðŸŸ  J+1</button>
          <button class="filter-btn green" id="filter-green" onclick="window.app.filterList('green')">ðŸŸ¢ J+2</button>
        </div>
        <div id="list-frais-container"></div>
      </div>

      <div id="content-hist" class="hidden">
        <div class="card" onclick="window.app.exportHistory()" style="text-align:center; cursor:pointer; background:#f1f5f9; padding:15px; margin-bottom:15px;">
            <i class="fas fa-file-csv" style="color:#64748b; font-size:24px;"></i>
            <h4 style="margin:5px 0;">Exporter CSV (Casse)</h4>
        </div>
        <div id="list-hist-container"></div>
        <button class="btn" onclick="window.app.clearHistory()" style="background:#64748b; margin-top:20px;">Vider Historique (Code Requis)</button>
      </div>
    </div>
  </main>

  <nav>
    <div class="nav-btn" onclick="window.app.nav('home')"><i class="fas fa-th-large"></i>Menu</div>
  </nav>

  <audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA", authDomain: "araujo-exploitation.firebaseapp.com", databaseURL: "https://araujo-exploitation-default-rtdb.europe-west1.firebasedatabase.app", projectId: "araujo-exploitation", storageBucket: "araujo-exploitation.firebasestorage.app", messagingSenderId: "292878114487", appId: "1:292878114487:web:2a450227310e970ce1b732" };
  const db = getFirestore(initializeApp(firebaseConfig));
  const docRef = doc(db, "store_master", "v35");
  const codeReader = new ZXing.BrowserMultiFormatReader();

  window.app = {
    data: { frais: [], history: [] },
    scanning: false,
    currentFilter: 'all',
    currentImgUrl: "",

    init: function() {
      onSnapshot(docRef, (s) => {
        if(s.exists()) { 
            this.data = {...this.data, ...s.data()};
            if(!this.data.history) this.data.history = []; 
            this.renderList(); 
            this.renderHistory();
        }
      });
    },
    save: async function() { await setDoc(docRef, this.data, {merge:true}); this.renderList(); this.renderHistory(); },
    
    login: function() {
      if(document.getElementById('login-pass').value === "2008") {
        document.getElementById('login-overlay').classList.add('hidden');
        this.init();
      } else alert("Code erreur");
    },

    nav: function(v) {
      document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
      document.getElementById('view-'+v).classList.remove('hidden');
      if(this.scanning) this.stopScanner();
    },

    switchTab: function(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      ['content-scan','content-list','content-hist'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('content-'+t).classList.remove('hidden');
      if(t !== 'scan') this.stopScanner();
    },

    toggleScanner: function() { if(this.scanning) this.stopScanner(); else this.startScanner(); },
    startScanner: function() {
        this.scanning = true;
        document.getElementById('scanner-container').style.display = "block";
        document.getElementById('btn-scan-toggle').innerHTML = "STOP SCAN";
        codeReader.decodeFromVideoDevice(null, 'video', (result) => {
            if (result) {
                document.getElementById('beep').play();
                if(navigator.vibrate) navigator.vibrate(200);
                document.getElementById('frais-ean').value = result.text;
                this.scanApi(result.text);
                this.stopScanner();
            }
        });
    },
    stopScanner: function() {
        this.scanning = false; codeReader.reset();
        document.getElementById('scanner-container').style.display = "none";
        document.getElementById('btn-scan-toggle').innerHTML = "<i class='fas fa-camera'></i> LANCER SCAN";
    },

    detectFamily: function(prod) {
        let cats = (prod.categories || "") + " " + (prod.pnns_groups_2 || "") + " " + (prod.product_name || "");
        cats = cats.toUpperCase();
        if(cats.includes("YAOURT") || cats.includes("LAIT") || cats.includes("CRÃˆME") || cats.includes("DESSERT") || cats.includes("FROMAGE BLANC")) return "ULTRA FRAIS";
        if(cats.includes("JAMBON") || cats.includes("SAUCIS") || cats.includes("LARD") || cats.includes("PÃ‚TÃ‰") || cats.includes("RILLETTE")) return "CHARCUTERIE";
        if(cats.includes("POULET") || cats.includes("DINDE") || cats.includes("CANARD") || cats.includes("VOLAILLE")) return "VOLAILLE";
        if(cats.includes("STEAK") || cats.includes("BOEUF") || cats.includes("PORC") || cats.includes("VIANDE")) return "BOUCHERIE";
        if(cats.includes("PIZZA") || cats.includes("QUICHE") || cats.includes("SANDWICH") || cats.includes("SALADE")) return "TRAITEUR";
        if(cats.includes("FROMAGE") || cats.includes("CAMEMBERT") || cats.includes("COMTÃ‰") || cats.includes("EMMENTAL")) return "FROMAGE";
        return "DIVERS"; 
    },

    scanApi: async function(ean) {
      try {
        let r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
        let d = await r.json();
        if(d.status === 1) {
          document.getElementById('frais-name').value = d.product.product_name_fr || d.product.product_name;
          let fam = this.detectFamily(d.product);
          document.getElementById('frais-famille').value = fam;
          this.currentImgUrl = d.product.image_url || d.product.image_small_url || "";
          if(this.currentImgUrl) {
             document.getElementById('frais-img').src = this.currentImgUrl;
             document.getElementById('frais-img-box').style.display = 'flex';
          }
        }
      } catch(e){}
    },

    addFrais: function() {
      let ean = document.getElementById('frais-ean').value;
      let name = document.getElementById('frais-name').value;
      let date = document.getElementById('frais-date').value;
      let qty = document.getElementById('frais-qty').value;
      let fam = document.getElementById('frais-famille').value;
      if(!name || !date) return alert("Date requise !");
      this.data.frais.push({ id: Date.now(), ean, name, date, qty, fam, img: this.currentImgUrl });
      this.save();
      document.getElementById('frais-name').value = ""; document.getElementById('frais-ean').value = "";
      document.getElementById('frais-qty').value = "1"; document.getElementById('frais-img-box').style.display = 'none';
      this.currentImgUrl = ""; alert("AjoutÃ© !");
    },

    moveToHistory: function(id) {
      let code = prompt("Code Manager requis pour supprimer :");
      if(code !== "2008") return alert("AccÃ¨s refusÃ©");
      let item = this.data.frais.find(x => x.id === id);
      if(item) {
          this.data.history.push({...item, deletedAt: new Date().toISOString()});
          this.data.frais = this.data.frais.filter(x => x.id !== id);
          this.save();
      }
    },

    clearHistory: function() {
        let code = prompt("Code Manager requis pour vider l'historique :");
        if(code !== "2008") return alert("AccÃ¨s refusÃ©");
        if(confirm("Vider dÃ©finitivement ?")) { this.data.history = []; this.save(); }
    },

    filterList: function(type) {
        this.currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('filter-'+type).classList.add('active');
        this.renderList();
    },

    formatDateFR: function(dateStr) {
        if(!dateStr) return "";
        let d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR');
    },

    renderList: function() {
      let today = new Date().toISOString().split('T')[0];
      const cont = document.getElementById('list-frais-container');
      cont.innerHTML = "";
      this.data.frais.sort((a,b) => a.date.localeCompare(b.date)).forEach(i => {
        let diff = (new Date(i.date) - new Date(today)) / (86400000);
        let cls = 'dlc-green'; let txt = this.formatDateFR(i.date); let show = false;
        
        if (diff < 1) { cls = 'dlc-red'; txt = "J-0"; if(['all','red'].includes(this.currentFilter)) show = true; } 
        else if (diff < 2) { cls = 'dlc-orange'; txt = "J+1"; if(['all','orange'].includes(this.currentFilter)) show = true; } 
        else { cls = 'dlc-green'; if(['all','green'].includes(this.currentFilter)) show = true; }

        if(show) {
            cont.innerHTML += `
              <div class="dlc-item ${cls}">
                <img src="${i.img || 'https://via.placeholder.com/50?text=IMG'}" class="dlc-img">
                <div class="dlc-info">
                  <span class="family-tag">${i.fam || 'DIVERS'}</span>
                  <div style="font-weight:bold;">${i.name}</div>
                  <div style="font-size:12px; color:#555;">${txt} â€¢ <b>x${i.qty}</b></div>
                </div>
                <button onclick="window.app.moveToHistory(${i.id})" style="background:none; border:none; color:#999; padding:15px;"><i class="fas fa-trash"></i></button>
              </div>`;
        }
      });
      if(cont.innerHTML === "") cont.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa'>Vide</div>";
    },

    renderHistory: function() {
        const cont = document.getElementById('list-hist-container');
        cont.innerHTML = this.data.history.slice().reverse().map(i => `
            <div class="dlc-item dlc-gray">
                <div class="dlc-info">
                   <span class="family-tag">${i.fam || 'DIVERS'}</span><br>
                   <b>${i.name}</b> <br> <small>RetirÃ© le ${this.formatDateFR(i.deletedAt)}</small>
                </div>
                <span style="font-weight:bold;">x${i.qty}</span>
            </div>
        `).join('');
    },

    exportHistory: function() {
      let csv = "Date Retrait;Famille;Nom;DLC;Quantite\n";
      this.data.history.forEach(i => csv += `${this.formatDateFR(i.deletedAt)};${i.fam || 'DIVERS'};${i.name};${this.formatDateFR(i.date)};${i.qty}\n`);
      let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'Casse_Magasin.csv'; a.click();
    }
  };
</script>
</body>
</html>
