<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Araujo App V3.1</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root { --primary: #003896; --accent: #E2001A; --pvp: #d97706; --salad:#16a34a; --bg: #f3f4f6; --surface: #ffffff; --text: #1e293b; --success: #10b981; --danger: #ef4444; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; user-select: none; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  .hidden { display: none !important; }

  /* LOGIN */
  #login-overlay { position: fixed; inset: 0; z-index: 10000; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; padding: 18px; }
  .login-card { width: min(380px, 92vw); }
  .login-help { font-size: 12px; color:#64748b; text-align:center; margin-top:10px; cursor:pointer; }
  .login-error { display:none; background:#fee2e2; color:#991b1b; padding:10px 12px; border-radius:10px; font-weight:700; font-size:13px; margin-top:10px; }

  /* HEADER & NAV */
  header { background: var(--surface); padding: 10px; height: 80px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; z-index: 50; }
  .logo-header { height: 50px; object-fit: contain; }
  .user-badge { position: absolute; right: 15px; top: 15px; font-size: 11px; background: #e0f2fe; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: bold; max-width: 52vw; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
  .logout-btn { position:absolute; left:15px; top:18px; border:none; background:#f1f5f9; color:#334155; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; }

  main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; padding: 0 30px; }
  .nav-btn { text-align:center; color:#94a3b8; cursor: pointer; font-size: 12px; }
  .nav-btn i { font-size: 24px; margin-bottom: 4px; }

  /* UI ELEMENTS */
  .card { background: var(--surface); border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
  input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; margin-bottom: 10px; outline: none; }
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; margin-top: 5px; }
  .btn.secondary { background:#eee; color:#333; }
  .btn.danger { background:#ef4444; }
  .btn.success { background:#00563f; }
  .btn.salad { background: var(--salad); }

  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; gap:4px; }
  .tab { flex: 1; text-align: center; padding: 12px; font-weight: 800; font-size: 12px; color: #64748b; border-radius: 9px; cursor: pointer; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .tab.active-pvp { background: white; color: var(--pvp); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .tab.active-salad { background: white; color: var(--salad); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* HOME GRID */
  .home-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:15px;}
  .home-btn{background:var(--surface);border-radius:18px;padding:18px;box-shadow:0 4px 10px rgba(0,0,0,0.03);text-align:center;font-weight:900;cursor:pointer}
  .home-btn i{font-size:28px;margin-bottom:8px}

  /* LISTES */
  .group-header { background: #334155; color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; text-transform: uppercase; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .list-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.05); min-height: 80px; }

  /* Swipe Elements */
  .swipe-wrapper { background: #ef4444; border-radius: 12px; margin-bottom: 8px; overflow: hidden; position: relative; }
  .swipe-content { background: white; position: relative; z-index: 2; transition: transform 0.2s; padding: 12px; display: flex; align-items: center; justify-content: space-between; min-height: 80px; width: 100%; }

  .item-img { width: 55px; height: 55px; border-radius: 10px; object-fit: cover; background: #f1f5f9; margin-right: 12px; flex-shrink: 0; display:flex; align-items:center; justify-content:center; color:#cbd5e1; font-size: 20px; cursor: pointer; }
  .item-info { flex: 1; overflow: hidden; margin-right: 10px; min-width:0; }
  .item-title { font-weight: 900; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; max-width: 48vw; }
  .line2 { font-size:12px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* PVP Controls */
  .qty-ctrl { display: flex; align-items: center; gap: 10px; background: #f8fafc; width: fit-content; padding: 4px 8px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 5px; }
  .qty-btn { width: 30px; height: 30px; border-radius: 6px; border: none; background: white; box-shadow: 0 2px 3px rgba(0,0,0,0.1); font-weight: bold; color: var(--primary); font-size: 18px; display:flex; align-items:center; justify-content:center; cursor: pointer; }
  .qty-btn:active{transform:scale(.96)}
  .qty-btn.pvp { color: var(--pvp); }
  .qty-btn.salad { color: var(--salad); }

  .date-col { text-align: right; width: 125px; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; }
  .d-lbl { font-size: 11px; color: #64748b; margin-bottom: 2px; }
  .d-val { font-size: 13px; font-weight: 900; color: var(--success); }
  .d-val.expired { color: var(--danger); }
  .d-val.tosaisir{ color:#b45309; }

  /* Frais Badges */
  .date-badge { width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; margin-left: 10px; }
  .bg-red { background: #ef4444; } .bg-orange { background: #f59e0b; } .bg-green { background: #10b981; } .bg-grey { background: #94a3b8; }
  .badge-saisir{background:#fde68a;color:#92400e;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:900;margin-top:6px;display:inline-block}

  /* Modals */
  .modal-bc { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .modal-card { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 420px; max-height: 85vh; overflow-y: auto; }
  .row { display:flex; gap:10px; }
  .chip { font-size:11px; padding:3px 8px; border-radius:999px; font-weight:800; }
  .chip.admin { background:#fee2e2; color:#991b1b; }
  .chip.staff { background:#e0f2fe; color:#075985; }
  .small { font-size:12px; color:#64748b; }

  /* Toast */
  #toast { position:fixed; left:50%; bottom:88px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 12px; border-radius:999px; font-size:12px; font-weight:800; z-index:99999; display:none; max-width:92vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
</style>
</head>

<body>

  <div id="toast"></div>

  <!-- LOGIN -->
  <div id="login-overlay">
    <div class="login-card">
      <div style="text-align:center;">
        <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" style="width:200px; margin-bottom:20px;">
      </div>

      <input type="email" id="login-email" placeholder="Email" autocomplete="username" inputmode="email">
      <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
      <button class="btn success" onclick="app.auth.login()"><i class="fas fa-right-to-bracket"></i> CONNEXION</button>

      <div class="login-help" onclick="app.auth.forgot()"><i class="fas fa-unlock-keyhole"></i> Mot de passe oubli√© ?</div>
      <div id="login-error" class="login-error"></div>

      <div class="small" style="text-align:center;margin-top:14px;">
        Astuce : si tu viens de cr√©er un compte staff, utilise ‚ÄúMot de passe oubli√©‚Äù pour d√©finir son mot de passe.
      </div>
    </div>
  </div>

  <!-- BARCODE MODAL -->
  <div id="modal-barcode" class="modal-bc hidden">
    <div class="modal-card" style="text-align:center;">
        <h3 id="bc-name"></h3>
        <img id="bc-img-display" style="width:100%;height:200px;object-fit:contain;margin-bottom:15px;display:none;background:#f8fafc;border-radius:10px;">
        <svg id="barcode"></svg><br>
        <button class="btn secondary" style="margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <!-- EDIT FRAIS MODAL -->
  <div id="modal-edit-frais" class="modal-bc hidden">
    <div class="modal-card">
        <h3>Modifier Frais</h3>
        <input type="hidden" id="edit-id">
        <label>EAN (Code Barre)</label><input type="text" id="edit-ean" inputmode="numeric">
        <label>Nom Produit</label><input type="text" id="edit-name">
        <label>Famille</label>
        <select id="edit-famille">
          <option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option>
          <option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option>
        </select>
        <label>Qt√©</label><input type="number" id="edit-qty">
        <label>DLC</label><input type="date" id="edit-date">
        <button class="btn success" onclick="app.frais.saveEdit()">Enregistrer</button>
        <button class="btn danger" onclick="app.frais.del()">Supprimer</button>
        <button class="btn secondary" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- PVP MODALS -->
  <div id="modal-pvp-lib" class="modal-bc hidden">
    <div class="modal-card">
        <h3 style="color:#d97706">Produit PVP</h3>
        <input type="hidden" id="lib-id"><input type="hidden" id="lib-img-data">
        <label>Famille</label><select id="lib-fam-select" onchange="app.pvp.toggleFamInput()"></select>
        <input type="text" id="lib-fam-new" placeholder="Nouvelle famille..." class="hidden">
        <label>Nom</label><input type="text" id="lib-name">
        <label>EAN</label><input type="text" id="lib-ean" inputmode="numeric" maxlength="13">
        <button class="btn secondary" onclick="document.getElementById('cam-input').click()" style="margin-bottom:10px;">Photo</button>
        <input type="file" id="cam-input" accept="image/*" capture="environment" class="hidden" onchange="app.pvp.handleImg(this)">
        <img id="img-preview" style="width:100px;height:100px;object-fit:cover;border-radius:10px;display:none;margin:0 auto 10px auto;">
        <label>Conservation</label><select id="lib-days"><option value="0">JOURN√âE</option><option value="48">48H</option><option value="72">72H</option></select>
        <label>Objectifs (L->D)</label>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">
            <input type="number" id="t-1" placeholder="L" style="text-align:center;padding:5px;">
            <input type="number" id="t-2" placeholder="M" style="text-align:center;padding:5px;">
            <input type="number" id="t-3" placeholder="M" style="text-align:center;padding:5px;">
            <input type="number" id="t-4" placeholder="J" style="text-align:center;padding:5px;">
            <input type="number" id="t-5" placeholder="V" style="text-align:center;padding:5px;">
            <input type="number" id="t-6" placeholder="S" style="text-align:center;padding:5px;">
            <input type="number" id="t-0" placeholder="D" style="text-align:center;padding:5px;">
        </div>
        <button class="btn" onclick="app.pvp.saveLib()" style="background:#d97706;">Enregistrer</button>
        <button class="btn danger" onclick="app.pvp.delLib()">Supprimer</button>
        <button class="btn secondary" onclick="document.getElementById('modal-pvp-lib').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <div id="modal-pvp-stock" class="modal-bc hidden">
    <div class="modal-card">
      <h3 style="color:#d97706">Correction Rayon</h3>
      <input type="hidden" id="stock-id"><h4 id="stock-name" style="text-align:center;"></h4>
      <label>Quantit√©</label><input type="number" id="stock-qty">
      <label>Sortie</label><input type="datetime-local" id="stock-start">
      <label>Fin</label><input type="datetime-local" id="stock-end">
      <button class="btn" onclick="app.pvp.saveStock()" style="background:#d97706;">Valider</button>
      <button class="btn danger" onclick="app.pvp.delStock()">Retirer</button>
      <button class="btn secondary" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- SALAD MODALS -->
  <div id="modal-salad-lib" class="modal-bc hidden">
    <div class="modal-card">
        <h3 style="color:var(--salad)">Ingr√©dient Salad Bar</h3>
        <input type="hidden" id="slib-id">
        <label>Groupe</label>
        <select id="slib-group"></select>
        <input type="text" id="slib-group-new" placeholder="Nouveau groupe..." class="hidden">
        <label>Nom</label><input type="text" id="slib-name">
        <label>Conservation</label>
        <select id="slib-hours">
          <option value="24">24H</option>
          <option value="48">48H</option>
          <option value="168">7J</option>
          <option value="1920">80J</option>
        </select>
        <button class="btn salad" onclick="app.salad.saveLib()">Enregistrer</button>
        <button class="btn danger" onclick="app.salad.delLib()">Supprimer</button>
        <button class="btn secondary" onclick="document.getElementById('modal-salad-lib').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <div id="modal-salad-stock" class="modal-bc hidden">
    <div class="modal-card">
      <h3 style="color:var(--salad)">Correction Rayon (Salad Bar)</h3>
      <input type="hidden" id="sstock-id"><h4 id="sstock-name" style="text-align:center;"></h4>
      <label>Quantit√©</label><input type="number" id="sstock-qty">
      <label>Sortie</label><input type="datetime-local" id="sstock-start">
      <label>Fin</label><input type="datetime-local" id="sstock-end">
      <button class="btn salad" onclick="app.salad.saveStock()">Valider</button>
      <button class="btn danger" onclick="app.salad.delStock()">Retirer</button>
      <button class="btn secondary" onclick="document.getElementById('modal-salad-stock').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- Tracabilit√© modal -->
  <div id="modal-traca" class="modal-bc hidden">
    <div class="modal-card">
      <h3 style="color:var(--salad)">Tracabilit√©</h3>
      <div class="small" id="traca-title" style="margin-bottom:10px;"></div>
      <button class="btn secondary" onclick="document.getElementById('traca-input').click()"><i class="fas fa-camera"></i> Prendre une photo</button>
      <input type="file" id="traca-input" accept="image/*" capture="environment" class="hidden" onchange="app.salad.traca.handleFile(this)">
      <div id="traca-preview" class="hidden" style="margin-top:10px;text-align:center;">
        <img id="traca-img-preview" style="width:100%;max-height:220px;object-fit:contain;background:#f8fafc;border-radius:12px;">
        <button class="btn salad" onclick="app.salad.traca.saveCurrent()" style="margin-top:10px;"><i class="fas fa-floppy-disk"></i> Enregistrer la tracabilit√©</button>
      </div>

      <h4 style="margin:18px 0 10px 0;">Historique (6 mois)</h4>
      <div id="traca-history" class="small">Aucune photo.</div>

      <button class="btn secondary" onclick="document.getElementById('modal-traca').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <!-- HEADER -->
  <header id="app-header" class="hidden">
    <button class="logout-btn" onclick="app.auth.logout()"><i class="fas fa-right-from-bracket"></i></button>
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
    <div id="user-badge" class="user-badge">...</div>
  </header>

  <main>
    <div id="view-home">
      <div id="alert-box" style="display:none;background:#ef4444;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;font-weight:bold;">‚ö†Ô∏è Dates Courtes !</div>
      <div class="home-grid">
        <div class="home-btn" onclick="app.nav('frais')" style="background: linear-gradient(135deg, #003896 0%, #002366 100%); color:white;"><i class="fas fa-barcode"></i><br>DLC FRAIS</div>
        <div class="home-btn" onclick="app.nav('pvp')" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color:white;"><i class="fas fa-bread-slice"></i><br>GESTION PVP</div>
        <div class="home-btn" onclick="app.nav('salad')" style="background: linear-gradient(135deg, #16a34a 0%, #0f766e 100%); color:white;"><i class="fas fa-leaf"></i><br>SALAD BAR</div>
      </div>
      <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;"><i class="fas fa-users"></i> √âquipe</div>
    </div>

    <div id="view-frais" class="hidden">
      <div class="tabs">
        <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
        <div class="tab" id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
      </div>
      <div id="frais-scan">
        <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;"><video id="video" style="width:100%;height:100%;object-fit:cover;"></video></div>
        <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
        <div class="card">
          <input id="frais-ean" type="text" inputmode="numeric" placeholder="EAN" oninput="app.frais.handleInput(this.value)">
          <select id="frais-fam">
            <option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option>
            <option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option>
          </select>
          <input id="frais-name" placeholder="Nom">
          <div class="row"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qt√©"></div>
          <button class="btn" onclick="app.frais.add()">AJOUTER</button>
        </div>
      </div>
      <div id="frais-list" class="hidden"></div>
    </div>

    <div id="view-pvp" class="hidden">
      <div class="tabs">
        <div class="tab active-pvp" id="tp-1" onclick="app.pvp.tab('stock')">RAYON</div>
        <div class="tab" id="tp-2" onclick="app.pvp.tab('bib')">BIBLIOTH√àQUE</div>
        <div class="tab" id="tp-3" onclick="app.pvp.tab('calc')">BESOINS</div>
      </div>
      <div id="pvp-stock"></div>
      <div id="pvp-bib" class="hidden">
        <button class="btn secondary" onclick="app.pvp.openLib()" style="margin-bottom:15px;">+ Cr√©er Produit</button>
        <div id="lib-list"></div>
      </div>
      <div id="pvp-calc" class="hidden"></div>
    </div>

    <div id="view-salad" class="hidden">
      <div class="tabs">
        <div class="tab active-salad" id="ts-1" onclick="app.salad.tab('stock')">RAYON</div>
        <div class="tab" id="ts-2" onclick="app.salad.tab('bib')">BIBLIOTH√àQUE</div>
      </div>

      <div id="salad-stock"></div>

      <div id="salad-bib" class="hidden">
        <button class="btn secondary" onclick="app.salad.openLib()" style="margin-bottom:15px;">+ Cr√©er Ingr√©dient</button>
        <div id="salad-lib-list"></div>
      </div>
    </div>

    <!-- TEAM -->
    <div id="view-team" class="hidden">
      <div class="card">
        <h3 style="margin-top:0;">Cr√©er un compte staff</h3>
        <input id="new-u-name" placeholder="Nom (ex: LUCAS)" autocomplete="off">
        <input id="new-u-email" placeholder="Email (ex: lucas@...)" inputmode="email" autocomplete="off">
        <select id="new-u-role">
          <option value="staff">staff</option>
          <option value="admin">admin</option>
        </select>
        <button class="btn" onclick="app.team.createStaff()">Cr√©er + envoyer lien ‚Äúmot de passe oubli√©‚Äù</button>
        <div class="small">Le staff clique ensuite ‚ÄúMot de passe oubli√©‚Äù sur l‚Äô√©cran de login, ou re√ßoit le mail si ton template est configur√©.</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Utilisateurs</h3>
        <div id="user-list"></div>
      </div>
    </div>

  </main>

  <nav id="app-nav" class="hidden">
    <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i><br>RETOUR</div>
    <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large"></i><br>MENU</div>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";
  import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
    authDomain: "araujo-exploitation.firebaseapp.com",
    projectId: "araujo-exploitation"
  };

  const appFb = initializeApp(firebaseConfig);
  const db = getFirestore(appFb);
  const auth = getAuth(appFb);
  const storage = getStorage(appFb);

  // Secondary app/auth => cr√©er des comptes sans d√©connecter l‚Äôadmin
  const secondaryApp = initializeApp(firebaseConfig, "Secondary");
  const secondaryAuth = getAuth(secondaryApp);

  // ---- App Check (reCAPTCHA v3)
  // IMPORTANT : en local, tu peux activer le debug token (d√©commente) :
  // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
  self.FIREBASE_APPCHECK_DEBUG_TOKEN = false;

  try {
    initializeAppCheck(appFb, {
      // ‚úÖ COLLE TA CL√â ICI :
      provider: new ReCaptchaV3Provider("6LfmVXAsAAAAAKDTlkBqoKB-zSkgd5FrSk5dCylf"),
      isTokenAutoRefreshEnabled: true
    });
  } catch(e) {
    // si d√©j√† initialis√©
  }

  // Firestore docs
  const docUsers = doc(db, "store_master", "DATA_USERS");
  const docFrais = doc(db, "store_master", "DATA_FRAIS");
  const docPVP   = doc(db, "store_master", "DATA_PVP");
  const docSalad = doc(db, "store_master", "DATA_SALAD");

  // Tracabilit√© Salad Bar (historique 6 mois)
  const colSaladTraca = collection(db, "store_master", "DATA_SALAD_TRACA", "items");

  const codeReader = new ZXing.BrowserMultiFormatReader();

  window.app = {
    me: null,
    data: { frais: [], users: [], pvpLib: [], pvpStock: [], checkedNeeds: [], saladLib: [], saladStock: [] },
    viewHistory: [],
    closed: new Set(),
    debounceTimer: null,

    _saveTimers: {},
    _saving: new Set(),

    toast: function(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(this._toastTimer);
      this._toastTimer = setTimeout(()=>{ t.style.display='none'; }, 1600);
    },

    queueSave: function(sec, delay=220) {
      clearTimeout(this._saveTimers[sec]);
      this._saveTimers[sec] = setTimeout(async () => {
        if(this._saving.has(sec)) return;
        this._saving.add(sec);
        try {
          await this._saveNow(sec);
        } catch(e) {
          console.warn(e);
          this.toast("‚ö†Ô∏è Sauvegarde √©chou√©e (r√©seau / App Check / rules).");
        } finally {
          this._saving.delete(sec);
        }
      }, delay);
    },

    ui: {
      err: (msg) => {
        const box = document.getElementById("login-error");
        box.style.display = "block";
        box.textContent = msg;
      },
      clearErr: () => {
        const box = document.getElementById("login-error");
        box.style.display = "none";
        box.textContent = "";
      }
    },

    common: {
      showBarcode: function(ean, name, imgUrl=null) {
        document.getElementById('modal-barcode').classList.remove('hidden');
        document.getElementById('bc-name').innerText = name || "";
        let imgEl = document.getElementById('bc-img-display');
        if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display='block'; } else { imgEl.style.display='none'; }
        if(ean) {
          try { JsBarcode("#barcode", ean, {format:"EAN13", height:80, displayValue:true}); }
          catch(e) { try{ JsBarcode("#barcode", ean, {format:"CODE128", height:80, displayValue:true}); } catch(e2){} }
        }
      },
      parseDateLocal: function(dateStr) {
        if(!dateStr) return null;
        let parts = dateStr.split('-');
        return new Date(parts[0], parts[1]-1, parts[2], 12, 0, 0).getTime();
      },
      dateToInputLocal: function(ts) {
        if(!ts) return "";
        let d = new Date(ts);
        let y = d.getFullYear();
        let m = String(d.getMonth()+1).padStart(2,'0');
        let day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      },
      tsToInput: function(ts) {
        let d = new Date(ts);
        let local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
        return local.toISOString().slice(0, 16);
      },
      calculateEnd: function(startTs, hours) {
        let end = new Date(startTs);
        let h = parseInt(hours);
        if (h === 0) end.setHours(22, 0, 0, 0);
        else end.setHours(end.getHours() + h);
        return end.getTime();
      },
      cleanName: function(name) {
        return (name||"").toUpperCase().replace(/^[\d\s\.,xX]+(G|KG|ML|CL|L|P)?\s*/g, '');
      },
      compressImg: function(file, callback) {
        let reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          let img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');
            let max = 300; let w = img.width, h = img.height;
            if (w > h) { if (w > max) { h *= max/w; w = max; } }
            else { if (h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', 0.5));
          };
        };
      },
      formatDate: function(ts) {
        let d = new Date(ts);
        if(isNaN(d.getTime())) return "--/--";
        let h = d.getHours(); let m = d.getMinutes();
        return `${d.getDate()}/${String(d.getMonth()+1).padStart(2,'0')} ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      },
      randPwd: function(len=14) {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
        let out = "";
        for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
        return out;
      },
      startOfDay: function(ts) {
        const d = new Date(ts);
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0).getTime();
      }
    },

    auth: {
      login: async function() {
        window.app.ui.clearErr();
        const email = (document.getElementById("login-email").value || "").trim();
        const pass  = (document.getElementById("login-pass").value || "").trim();
        if(!email || !pass) return window.app.ui.err("Email et mot de passe requis.");
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          document.getElementById("login-pass").value = "";
        } catch(e) {
          window.app.ui.err("Connexion refus√©e. V√©rifie l‚Äôemail / mot de passe.");
        }
      },
      forgot: async function() {
        window.app.ui.clearErr();
        const email = (document.getElementById("login-email").value || "").trim();
        if(!email) return window.app.ui.err("Tape ton email puis clique ‚ÄúMot de passe oubli√©‚Äù.");
        try {
          await sendPasswordResetEmail(auth, email);
          alert("Email de r√©initialisation envoy√©.");
        } catch(e) {
          window.app.ui.err("Impossible d‚Äôenvoyer le reset. V√©rifie l‚Äôemail.");
        }
      },
      logout: async function() { try { await signOut(auth); } catch(e){} }
    },

    // ---- Firestore load/save
    loadAll: async function() {
      const [uSnap, fSnap, pSnap, sSnap] = await Promise.all([getDoc(docUsers), getDoc(docFrais), getDoc(docPVP), getDoc(docSalad)]);
      this.data.users = uSnap.exists() ? (uSnap.data().list || []) : [];
      this.data.frais = fSnap.exists() ? (fSnap.data().list || []) : [];

      if(pSnap.exists()) {
        let d = pSnap.data();
        this.data.pvpLib = d.lib || [];
        this.data.pvpStock = d.stock || [];
        this.data.checkedNeeds = d.needs || [];
      } else {
        this.data.pvpLib = []; this.data.pvpStock = []; this.data.checkedNeeds = [];
      }

      if(sSnap.exists()) {
        let d = sSnap.data() || {};
        this.data.saladLib = d.lib || [];
        this.data.saladStock = d.stock || [];
      } else {
        this.data.saladLib = [];
        this.data.saladStock = [];
      }

      // Seed Salad lib si vide
      if(!this.data.saladLib.length) {
        this.data.saladLib = this.salad.seedLib();
        this.queueSave('salad', 0);
      }
    },

    _saveNow: async function(sec) {
      if(!auth.currentUser) throw new Error("Not logged");
      if(sec==='users') await setDoc(docUsers, { list: this.data.users }, { merge: true });
      if(sec==='frais') await setDoc(docFrais, { list: this.data.frais }, { merge: true });
      if(sec==='pvp')   await setDoc(docPVP,   { lib: this.data.pvpLib, stock: this.data.pvpStock, needs: this.data.checkedNeeds }, { merge: true });
      if(sec==='salad') await setDoc(docSalad, { lib: this.data.saladLib, stock: this.data.saladStock }, { merge: true });
    },

    afterLoginBootstrap: async function() {
      await this.loadAll();

      // Si aucun user en base => on bootstrap l‚Äôadmin avec le user connect√©
      if(!this.data.users.length) {
        const email = auth.currentUser.email || "";
        const name = (email.split("@")[0] || "ADMIN").toUpperCase();
        this.data.users = [{ uid: auth.currentUser.uid, email, name, role:"admin" }];
        this.queueSave("users", 0);
      }

      // Trouver profil
      this.me = this.data.users.find(u => u.uid === auth.currentUser.uid) || null;
      if(!this.me) {
        alert("Votre compte n‚Äôest pas autoris√© (UID inconnu dans DATA_USERS).");
        await signOut(auth);
        return;
      }

      // UI
      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('app-header').classList.remove('hidden');
      document.getElementById('app-nav').classList.remove('hidden');
      document.getElementById('user-badge').innerText = this.me.name || (this.me.email || "USER");

      // Admin UI
      if(this.me.role === 'admin') document.getElementById('btn-team').classList.remove('hidden');
      else document.getElementById('btn-team').classList.add('hidden');

      // prune traca old
      try { await this.salad.traca.pruneOld(); } catch(e){}

      this.updateUI();
    },

    updateUI: function() {
      this.frais.render();
      this.pvp.render();
      this.salad.render();
      this.team.renderUsers();
      this.checkAlerts();
    },

    nav: function(v, saveHistory = true) {
      if(this.frais.scanning) this.frais.toggleScan();
      let current = document.querySelector('main > div:not(.hidden)');
      if(saveHistory && current) this.viewHistory.push(current.id.replace('view-',''));
      document.querySelectorAll('main > div').forEach(e => e.classList.add('hidden'));
      document.getElementById('view-'+v).classList.remove('hidden');
    },
    goBack: function() { if(this.viewHistory.length) this.nav(this.viewHistory.pop(), false); else this.nav('home', false); },
    toggleFam: function(id) { if(this.closed.has(id)) this.closed.delete(id); else this.closed.add(id); this.frais.render(); this.pvp.render(); this.salad.render(); },

    // ---- TEAM (admin)
    team: {
      ensureAdmin: function() {
        if(!window.app.me || window.app.me.role !== "admin") {
          alert("Acc√®s admin requis.");
          return false;
        }
        return true;
      },
      createStaff: async function() {
        if(!this.ensureAdmin()) return;

        const name = (document.getElementById("new-u-name").value || "").trim().toUpperCase();
        const email = (document.getElementById("new-u-email").value || "").trim().toLowerCase();
        const role = document.getElementById("new-u-role").value || "staff";
        if(!name || !email) return alert("Nom + email requis.");

        if(window.app.data.users.some(u => (u.email||"").toLowerCase() === email)) {
          return alert("Email d√©j√† pr√©sent dans la liste.");
        }

        try {
          const tmpPwd = window.app.common.randPwd();
          const cred = await createUserWithEmailAndPassword(secondaryAuth, email, tmpPwd);

          window.app.data.users.push({
            uid: cred.user.uid,
            email,
            name,
            role
          });
          window.app.queueSave("users", 0);

          await sendPasswordResetEmail(secondaryAuth, email);

          try { await signOut(secondaryAuth); } catch(e) {}
          document.getElementById("new-u-name").value = "";
          document.getElementById("new-u-email").value = "";
          document.getElementById("new-u-role").value = "staff";
          alert("Compte cr√©√© + email envoy√© (reset mot de passe).");
          window.app.team.renderUsers();
        } catch(e) {
          if(String(e?.code||"").includes("auth/email-already-in-use")) {
            alert("Email d√©j√† utilis√© dans Firebase Auth. Utilise un autre email ou supprime l‚Äôancien compte via console.");
          } else if(String(e?.code||"").includes("auth/invalid-email")) {
            alert("Email invalide.");
          } else {
            alert("Erreur cr√©ation compte. V√©rifie Auth activ√© + domain autoris√©.");
          }
          try { await signOut(secondaryAuth); } catch(err) {}
        }
      },

      resetPwd: async function(email) {
        if(!this.ensureAdmin()) return;
        if(!email) return alert("Pas d‚Äôemail.");
        try {
          await sendPasswordResetEmail(auth, email);
          alert("Reset envoy√©.");
        } catch(e) {
          alert("Impossible d‚Äôenvoyer le reset.");
        }
      },

      setRole: async function(uid, role) {
        if(!this.ensureAdmin()) return;
        const u = window.app.data.users.find(x => x.uid === uid);
        if(!u) return;
        u.role = role;
        window.app.queueSave("users", 0);
        this.renderUsers();
      },

      setName: async function(uid) {
        if(!this.ensureAdmin()) return;
        const u = window.app.data.users.find(x => x.uid === uid);
        if(!u) return;
        const n = prompt("Nom :", u.name || "");
        if(!n) return;
        u.name = n.trim().toUpperCase();
        window.app.queueSave("users", 0);
        this.renderUsers();
      },

      renderUsers: function() {
        const wrap = document.getElementById("user-list");
        if(!wrap) return;

        const users = (window.app.data.users || []).slice()
          .sort((a,b) => (a.role||"").localeCompare(b.role||"") || (a.name||"").localeCompare(b.name||""));

        wrap.innerHTML = users.map(u => {
          const chip = u.role === "admin"
            ? `<span class="chip admin">ADMIN</span>`
            : `<span class="chip staff">STAFF</span>`;

          return `
            <div style="padding:12px;border-bottom:1px solid #eee;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="min-width:0;">
                  <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    ${u.name || "(Sans nom)"} ${chip}
                  </div>
                  <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    ${u.email || "<i>email manquant</i>"}<br>
                    <span class="small">uid: ${(u.uid||"").slice(0,10)}...</span>
                  </div>
                </div>

                <div style="display:flex;gap:8px;flex-shrink:0;">
                  <button class="qty-btn" title="Renommer" onclick="app.team.setName('${u.uid}')"><i class="fas fa-pen"></i></button>
                  <button class="qty-btn" title="Reset MDP" onclick="app.team.resetPwd('${u.email||""}')"><i class="fas fa-unlock-keyhole"></i></button>
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:10px;">
                <select onchange="app.team.setRole('${u.uid}', this.value)" style="margin:0; padding:10px; font-size:14px;">
                  <option value="staff" ${u.role==="staff"?"selected":""}>staff</option>
                  <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
                </select>
              </div>
            </div>
          `;
        }).join("") || "<div class='small'>Aucun utilisateur.</div>";
      }
    },

    // ---- FRAIS
    frais: {
      scanning: false,
      imgUrl: "",
      tab: function(t) {
        document.querySelectorAll('#view-frais .tab').forEach(e => e.classList.remove('active'));
        document.getElementById(t=='scan'?'tf-1':'tf-2').classList.add('active');
        document.getElementById('frais-scan').classList.add('hidden');
        document.getElementById('frais-list').classList.add('hidden');
        document.getElementById('frais-'+t).classList.remove('hidden');
      },
      toggleScan: function() {
        if(this.scanning) {
          this.scanning=false; document.getElementById('scanner-box').style.display='none'; codeReader.reset();
        } else {
          this.scanning=true; document.getElementById('scanner-box').style.display='block';
          codeReader.decodeFromVideoDevice(null, 'video', (r) => { if(r){ this.handleInput(r.text); this.toggleScan(); } });
        }
      },
      handleInput: function(val) {
        let clean = String(val||"").replace(/\D/g, '').slice(0, 13);
        document.getElementById('frais-ean').value = clean;
        if(window.app.debounceTimer) clearTimeout(window.app.debounceTimer);
        window.app.debounceTimer = setTimeout(() => { if(clean.length === 13) this.api(clean); }, 250);
      },
      api: async function(ean) {
        try {
          let r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
          let d = await r.json();
          if(d.status==1) {
            document.getElementById('frais-name').value = d.product.product_name_fr || "";
            this.imgUrl = d.product.image_front_small_url || "";
          }
        } catch(e){}
      },
      add: async function() {
        let dateVal = document.getElementById('frais-date').value;
        let finalDate = window.app.common.parseDateLocal(dateVal);
        let o = {
          id: Date.now(),
          ean: document.getElementById('frais-ean').value,
          fam: document.getElementById('frais-fam').value,
          name: document.getElementById('frais-name').value,
          qty: document.getElementById('frais-qty').value,
          date: finalDate,
          img: this.imgUrl
        };
        if(!o.name || !o.date) return alert('Date requise');
        window.app.data.frais.push(o);
        window.app.queueSave('frais', 0);
        window.app.toast("‚úÖ Ajout√©");
        this.imgUrl="";
        document.getElementById('frais-name').value="";
        document.getElementById('frais-ean').value="";
        this.render();
        window.app.checkAlerts();
      },
      render: function() {
        let div = document.getElementById('frais-list'); div.innerHTML="";
        let grp = {};
        window.app.data.frais.sort((a,b) => (a.fam||"").localeCompare(b.fam||"") || (a.date||0)-(b.date||0))
          .forEach(i=>{ if(!grp[i.fam])grp[i.fam]=[]; grp[i.fam].push(i); });

        const now = Date.now();

        for(let f in grp) {
          let id = 'F-'+f; let c = window.app.closed.has(id);
          div.innerHTML += `<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) {
            grp[f].forEach(i => {
              let d = new Date(i.date);
              let badge = 'bg-grey';
              if(!isNaN(d.getTime())) {
                let diff = (d - new Date())/(1000*60*60*24);
                badge = diff<0?'bg-red':(diff<2?'bg-orange':'bg-green');
              }

              // √Ä SAISIR : la veille √† 18h (si DLC le 18 => √† saisir d√®s 17 √† 18h)
              const dlcDayStart = window.app.common.startOfDay(i.date);
              const saisieStart = dlcDayStart - (6*60*60*1000); // veille 18:00
              const showSaisir = now >= saisieStart && now < dlcDayStart;

              let safeName = (i.name||"").replace(/'/g," ");
              let img = i.img
                ? `<img src="${i.img}" class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean}','${safeName}','${i.img}')">`
                : `<div class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean}','${safeName}')"><i class="fas fa-barcode"></i></div>`;

              div.innerHTML += `
                <div class="swipe-wrapper"><div class="swipe-content" onclick="app.frais.openEdit(${i.id})">
                  <div style="display:flex;align-items:center;flex:1;min-width:0;">${img}
                    <div class="item-info">
                      <div class="item-title">${i.name||""}</div>
                      <div class="line2"><b>Qt√©:</b> ${i.qty||0} &nbsp; ‚Ä¢ &nbsp; <b>EAN:</b> ${i.ean||"-"}</div>
                      ${showSaisir ? `<span class="badge-saisir">√Ä SAISIR</span>` : ``}
                    </div>
                  </div>
                  <div class="date-badge ${badge}">
                    <span>${!isNaN(d.getTime())?d.getDate():'?'}</span>
                    <span style="font-size:10px;">${!isNaN(d.getTime())?d.toLocaleString('fr',{month:'short'}):'Err'}</span>
                  </div>
                </div></div>`;
            });
          }
        }
      },
      openEdit: function(id) {
        let i = window.app.data.frais.find(x => x.id == id);
        document.getElementById('modal-edit-frais').classList.remove('hidden');
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-famille').value = i.fam;
        document.getElementById('edit-qty').value = i.qty;
        document.getElementById('edit-name').value = i.name;
        document.getElementById('edit-ean').value = i.ean;
        document.getElementById('edit-date').value = window.app.common.dateToInputLocal(i.date);
      },
      saveEdit: async function() {
        let id = document.getElementById('edit-id').value;
        let idx = window.app.data.frais.findIndex(x => String(x.id) === String(id));
        if(idx>-1) {
          window.app.data.frais[idx].fam  = document.getElementById('edit-famille').value;
          window.app.data.frais[idx].qty  = document.getElementById('edit-qty').value;
          window.app.data.frais[idx].name = document.getElementById('edit-name').value;
          window.app.data.frais[idx].ean  = document.getElementById('edit-ean').value;
          window.app.data.frais[idx].date = window.app.common.parseDateLocal(document.getElementById('edit-date').value);
          window.app.queueSave('frais', 0);
          document.getElementById('modal-edit-frais').classList.add('hidden');
          window.app.frais.render();
          window.app.checkAlerts();
          window.app.toast("‚úÖ Modifi√©");
        }
      },
      del: async function() {
        let id = document.getElementById('edit-id').value;
        window.app.data.frais = window.app.data.frais.filter(x => String(x.id) !== String(id));
        window.app.queueSave('frais', 0);
        document.getElementById('modal-edit-frais').classList.add('hidden');
        window.app.frais.render();
        window.app.checkAlerts();
        window.app.toast("üóëÔ∏è Supprim√©");
      }
    },

    // ---- PVP
    pvp: {
      tab: function(t) {
        document.querySelectorAll('#view-pvp .tab').forEach(e => e.classList.remove('active-pvp'));
        document.getElementById(t=='stock'?'tp-1':(t=='bib'?'tp-2':'tp-3')).classList.add('active-pvp');
        ['pvp-stock','pvp-bib','pvp-calc'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('pvp-'+t).classList.remove('hidden');
      },
      handleImg: function(input) {
        if(input.files[0]) window.app.common.compressImg(input.files[0], (b64) => {
          document.getElementById('img-preview').src = b64;
          document.getElementById('img-preview').style.display='block';
          document.getElementById('lib-img-data').value = b64;
        });
      },
      toggleFamInput: function() {
        let val = document.getElementById('lib-fam-select').value;
        document.getElementById('lib-fam-new').classList.toggle('hidden', val !== 'new');
      },

      openLib: function(id=null) {
        document.getElementById('modal-pvp-lib').classList.remove('hidden');
        let uniqueFams = [...new Set(window.app.data.pvpLib.map(i => i.family || "DIVERS"))].sort();
        document.getElementById('lib-fam-select').innerHTML =
          uniqueFams.map(f => `<option value="${f}">${f}</option>`).join('') + `<option value="new">+ Cr√©er...</option>`;

        if(id) {
          let i = window.app.data.pvpLib.find(x=>x.id==id);
          document.getElementById('lib-id').value=id;
          document.getElementById('lib-name').value=i.name;
          document.getElementById('lib-ean').value=i.ean||"";
          document.getElementById('lib-days').value=i.days||0;
          document.getElementById('lib-img-data').value=i.img||"";
          document.getElementById('img-preview').src=i.img||"";
          document.getElementById('img-preview').style.display=i.img?'block':'none';
          document.getElementById('lib-fam-select').value = i.family || "DIVERS";
          for(let k=0;k<7;k++) document.getElementById('t-'+k).value = (i.targets||{})[k]||"";
        } else {
          document.getElementById('lib-id').value="";
          document.getElementById('lib-name').value="";
          document.getElementById('lib-ean').value="";
          document.getElementById('lib-img-data').value="";
          document.getElementById('img-preview').style.display='none';
          for(let k=0;k<7;k++) document.getElementById('t-'+k).value = "";
        }
      },

      saveLib: function() {
        let id = document.getElementById('lib-id').value;
        let fam = document.getElementById('lib-fam-select').value === 'new'
          ? (document.getElementById('lib-fam-new').value || "DIVERS").toUpperCase()
          : document.getElementById('lib-fam-select').value;

        let o = {
          id: id ? Number(id) : Date.now(),
          family: fam,
          name: document.getElementById('lib-name').value,
          ean: document.getElementById('lib-ean').value,
          img: document.getElementById('lib-img-data').value,
          days: document.getElementById('lib-days').value,
          targets: {}
        };
        for(let k=0;k<7;k++) o.targets[k] = document.getElementById('t-'+k).value;

        if(!o.name) return alert("Nom requis");

        if(id) {
          let idx = window.app.data.pvpLib.findIndex(x=>String(x.id)===String(id));
          if(idx>-1) window.app.data.pvpLib[idx] = o;
        } else {
          window.app.data.pvpLib.push(o);
        }

        window.app.queueSave('pvp', 0);
        document.getElementById('modal-pvp-lib').classList.add('hidden');
        window.app.pvp.render();
        window.app.toast("‚úÖ Biblioth√®que enregistr√©e");
      },

      delLib: function() {
        let id = document.getElementById('lib-id').value;
        window.app.data.pvpLib = window.app.data.pvpLib.filter(x=>String(x.id)!==String(id));
        window.app.queueSave('pvp', 0);
        document.getElementById('modal-pvp-lib').classList.add('hidden');
        window.app.pvp.render();
        window.app.toast("üóëÔ∏è Supprim√©");
      },

      addStock: async function(libId) {
        let l = window.app.data.pvpLib.find(x=>x.id==libId);
        let q = prompt('Quantit√© ?', "1");
        if(q > 0) {
          let now = new Date();
          let endTs = window.app.common.calculateEnd(now.getTime(), l.days);
          window.app.data.pvpStock.push({ id:Date.now(), libId:libId, name:l.name, ean:l.ean, qty:Number(q), out:now.getTime(), end:endTs, days:l.days });
          window.app.queueSave('pvp', 0);
          window.app.pvp.render();
        }
      },

      openEditStock: function(id) {
        let i = window.app.data.pvpStock.find(x=>x.id==id);
        document.getElementById('modal-pvp-stock').classList.remove('hidden');
        document.getElementById('stock-id').value=id;
        document.getElementById('stock-name').innerText=i.name;
        document.getElementById('stock-qty').value=i.qty;
        document.getElementById('stock-start').value = window.app.common.tsToInput(i.out);
        document.getElementById('stock-end').value = window.app.common.tsToInput(i.end);
      },

      saveStock: function() {
        let idx = window.app.data.pvpStock.findIndex(x=>String(x.id)===String(document.getElementById('stock-id').value));
        if(idx<0) return;
        window.app.data.pvpStock[idx].qty = Number(document.getElementById('stock-qty').value || 0);
        window.app.data.pvpStock[idx].out = new Date(document.getElementById('stock-start').value).getTime();
        window.app.data.pvpStock[idx].end = new Date(document.getElementById('stock-end').value).getTime();
        window.app.queueSave('pvp', 0);
        document.getElementById('modal-pvp-stock').classList.add('hidden');
        window.app.pvp.render();
        window.app.toast("‚úÖ Rayon modifi√©");
      },

      delStock: function() {
        let id = document.getElementById('stock-id').value;
        window.app.data.pvpStock = window.app.data.pvpStock.filter(x=>String(x.id)!==String(id));
        window.app.queueSave('pvp', 0);
        document.getElementById('modal-pvp-stock').classList.add('hidden');
        window.app.pvp.render();
        window.app.toast("üóëÔ∏è Retir√© du rayon");
      },

      changeQty: function(id, delta) {
        let idx = window.app.data.pvpStock.findIndex(x => x.id == id);
        if(idx > -1) {
          let n = parseInt(window.app.data.pvpStock[idx].qty) + delta;
          if(n <= 0) window.app.data.pvpStock.splice(idx, 1);
          else window.app.data.pvpStock[idx].qty = n;

          // Ultra responsive : render imm√©diat + save debounced
          window.app.pvp.render();
          window.app.queueSave('pvp', 260);
        }
      },

      toggleNeed: function(libId) {
        let idx = window.app.data.checkedNeeds.indexOf(libId);
        if(idx > -1) window.app.data.checkedNeeds.splice(idx, 1);
        else window.app.data.checkedNeeds.push(libId);
        window.app.pvp.render();
        window.app.queueSave('pvp', 260);
      },

      render: function() {
        // BIBLIO
        let bib = document.getElementById('lib-list'); if(!bib) return;
        bib.innerHTML = "";
        let gLib = {};
        window.app.data.pvpLib
          .slice()
          .sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)))
          .forEach(l => { let f = l.family||"DIVERS"; if(!gLib[f]) gLib[f]=[]; gLib[f].push(l); });

        Object.keys(gLib).sort().forEach(f => {
          let id = 'L-'+f; let c = window.app.closed.has(id);
          bib.innerHTML += `<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) gLib[f].forEach(l => {
            let img = l.img ? `<img src="${l.img}" class="item-img">` : `<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
            bib.innerHTML += `<div class="list-item" onclick="app.common.showBarcode('${l.ean}','${(l.name||"").replace(/'/g," ")}','${l.img||""}')">
              <div style="display:flex;align-items:center;min-width:0;">${img}<div style="min-width:0;"><b>${l.name}</b><br><small>${l.days}h</small></div></div>
              <button class="qty-btn pvp" style="background:var(--pvp);color:white;width:40px;height:40px;" onclick="event.stopPropagation(); app.pvp.openLib(${l.id})"><i class="fas fa-pen"></i></button>
              <button class="qty-btn pvp" style="background:var(--pvp);color:white;width:40px;height:40px;margin-left:10px;" onclick="event.stopPropagation(); app.pvp.addStock(${l.id})">+</button>
            </div>`;
          });
        });

        // STOCK
        let st = document.getElementById('pvp-stock'); st.innerHTML = "";
        let gStock = {};
        window.app.data.pvpStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s => {
          let l = window.app.data.pvpLib.find(x=>x.id==s.libId);
          let f = l ? l.family : "DIVERS";
          if(!gStock[f]) gStock[f]=[];
          gStock[f].push(s);
        });

        Object.keys(gStock).sort().forEach(f => {
          let id = 'S-'+f; let c = window.app.closed.has(id);
          st.innerHTML += `<div class="group-header" style="background:var(--pvp)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) gStock[f].forEach(i => {
            let dS = window.app.common.formatDate(i.out);
            let dE = window.app.common.formatDate(i.end);
            let isExp = new Date(i.end) < new Date();
            let l = window.app.data.pvpLib.find(x=>x.id==i.libId), img = l?l.img:null;
            let safeName = (i.name||"").replace(/'/g," ");
            let displayImg = img
              ? `<img src="${img}" class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean}','${safeName}','${img}')">`
              : `<div class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean}','${safeName}')"><i class="fas fa-bread-slice"></i></div>`;

            st.innerHTML += `
              <div class="swipe-wrapper"><div class="swipe-content">
                <div style="display:flex;align-items:center;flex:1;min-width:0;">${displayImg}
                  <div style="min-width:0;">
                    <div class="item-title" onclick="app.pvp.openEditStock(${i.id})">${i.name}</div>
                    <div class="qty-ctrl">
                      <button class="qty-btn pvp" onclick="app.pvp.changeQty(${i.id},-1)">-</button>
                      <b>${i.qty}</b>
                      <button class="qty-btn pvp" onclick="app.pvp.changeQty(${i.id},1)">+</button>
                    </div>
                  </div>
                </div>
                <div class="date-col">
                  <div class="d-lbl">Sortie: ${dS}</div>
                  <div class="d-val ${isExp?'expired':''}">FIN: ${dE}</div>
                </div>
              </div></div>`;
          });
        });

        // BESOINS
        let cl = document.getElementById('pvp-calc');
        let now = new Date();
        let tom = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
        const noonTomorrow = new Date(tom.getFullYear(), tom.getMonth(), tom.getDate(), 12, 0, 0, 0).getTime();

        let gTodo = {}; let doneH = ""; let hasNeeds = false;

        window.app.data.pvpLib.forEach(l => {
          let target = Number((l.targets||{})[tom.getDay()] || 0);
          if(target > 0) {
            // compter ce qui reste en rayon demain midi
            let stillAvail = window.app.data.pvpStock
              .filter(s => s.libId == l.id && Number(s.qty) > 0 && Number(s.end) >= noonTomorrow)
              .reduce((acc, s) => acc + Number(s.qty||0), 0);

            let need = Math.max(0, target - stillAvail);

            if(need > 0) {
              hasNeeds = true;
              let isC = window.app.data.checkedNeeds.includes(l.id);
              let img = l.img ? `<img src="${l.img}" class="item-img">` : `<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
              let h = `
                <div class="list-item ${isC?'item-done':''}" style="border-left:5px solid var(--pvp);">
                  <div style="display:flex;align-items:center;flex:1;min-width:0;">${img}
                    <div style="min-width:0;">
                      <div class="item-title">${l.name}</div>
                      <div style="color:var(--pvp);font-weight:900;">A SORTIR : ${need}</div>
                      <div class="small">Objectif: ${target} ‚Ä¢ En rayon demain midi: ${stillAvail}</div>
                    </div>
                  </div>
                  <div class="todo-check ${isC?'checked':''}" onclick="app.pvp.toggleNeed(${l.id})" style="width:36px;height:36px;border-radius:10px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-check" style="color:${isC?'var(--pvp)':'#94a3b8'}"></i>
                  </div>
                </div>`;
              if(isC) doneH += h;
              else { let f = l.family||"DIVERS"; if(!gTodo[f]) gTodo[f]=[]; gTodo[f].push(h); }
            }
          }
        });

        let resH = `<h4 style="text-align:center;color:var(--primary);">√Ä SORTIR DEMAIN</h4>`;
        if(!hasNeeds) resH += "<p style='text-align:center;color:#999'>Rien de pr√©vu</p>";
        else Object.keys(gTodo).sort().forEach(f => {
          let id = 'N-'+f; let c = window.app.closed.has(id);
          resH += `<div class="group-header" style="background:var(--primary)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) resH += gTodo[f].join('');
        });
        cl.innerHTML = resH + `<h4 style="text-align:center;color:#64748b;margin-top:20px;">TERMIN√â</h4>` + (doneH || "<p style='text-align:center;color:#ccc;'>Rien de fait</p>");
      }
    },

    // ---- SALAD BAR
    salad: {
      tab: function(t) {
        document.querySelectorAll('#view-salad .tab').forEach(e => e.classList.remove('active-salad'));
        document.getElementById(t=='stock'?'ts-1':'ts-2').classList.add('active-salad');
        ['salad-stock','salad-bib'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('salad-'+t).classList.remove('hidden');
      },

      seedLib: function() {
        const mk = (group, name, hours) => ({ id: Date.now()+Math.floor(Math.random()*99999), group, name, hours });
        const list = [];

        // SALADE
        list.push(mk("SALADE","Batavia",48));
        list.push(mk("SALADE","M√¢che",48));
        list.push(mk("SALADE","M√©lange Gourmand",48));
        list.push(mk("SALADE","Iceberg",48));

        // BASE
        list.push(mk("BASE","Penne au basilic",48));
        list.push(mk("BASE","Radiatori au tomates mi-s√©ch√©es",48));
        list.push(mk("BASE","Garganelli et graines de lin",48));
        list.push(mk("BASE","Quinoa Boulgour,Tomates mi-s√©ches,f√®ves de soja",48));
        list.push(mk("BASE","Boulgour et lentilles",48));
        list.push(mk("BASE","Farfalles au pesto",48));
        list.push(mk("BASE","Duo de riz √† l'algue wakam√©",48));
        list.push(mk("BASE","Nouilles Asiatiques",48));
        list.push(mk("BASE","Trio de quinoa lentilles corail",48));
        list.push(mk("BASE","F√©ta, bl√©, l√©gumes",48));

        // LEGUMES ET FRUITS
        list.push(mk("L√âGUMES & FRUITS","Tomates cerise marin√©es",48));
        list.push(mk("L√âGUMES & FRUITS","L√©gumes grill√©s",48));
        list.push(mk("L√âGUMES & FRUITS","Duo de carottes",48));
        list.push(mk("L√âGUMES & FRUITS","Betterave",48));
        list.push(mk("L√âGUMES & FRUITS","F√®ves de soja",48));
        list.push(mk("L√âGUMES & FRUITS","Pois chiches",48));
        list.push(mk("L√âGUMES & FRUITS","Avocat",24));
        list.push(mk("L√âGUMES & FRUITS","D√©s de mangue",48));
        list.push(mk("L√âGUMES & FRUITS","Tartare de concombre",48));
        list.push(mk("L√âGUMES & FRUITS","Tartare de tomates",48));
        list.push(mk("L√âGUMES & FRUITS","Coleslaw pommes cranberry",48));

        // PROT√âINE
        list.push(mk("PROT√âINE","≈íufs durs",48));
        list.push(mk("PROT√âINE","P√¢tes saumon fum√© √† l'aneth",48));
        list.push(mk("PROT√âINE","Poulet √©minc√©",48));
        list.push(mk("PROT√âINE","Poulet pan√©",48));
        list.push(mk("PROT√âINE","Jambon cuit",48));
        list.push(mk("PROT√âINE","Thon",48));
        list.push(mk("PROT√âINE","Farfalles",48));
        list.push(mk("PROT√âINE","Poulet marin√©",48));
        list.push(mk("PROT√âINE","Ditali chorizo",48));

        // FROMAGES
        list.push(mk("FROMAGES","Billes mozzarella",48));
        list.push(mk("FROMAGES","Emmental",48));
        list.push(mk("FROMAGES","Fromages italien",48));

        // F√âCULENTS
        list.push(mk("F√âCULENTS","Radiatori tomate mi s√©ch√©e",48));
        list.push(mk("F√âCULENTS","P√¢tes penne au basilic",48));
        list.push(mk("F√âCULENTS","Boulgour",48));
        list.push(mk("F√âCULENTS","Riz sauvage",48));

        // TOPPING
        list.push(mk("TOPPING","Noix/Amandes/Noix de cajou/Graines de courge/Raisin",168));
        list.push(mk("TOPPING","Crumble sal√©",168));
        list.push(mk("TOPPING","Sauce balsamique",1920));
        list.push(mk("TOPPING","Sauce Caesar",1920));
        list.push(mk("TOPPING","Sauce soja citron vert",1920));

        return list;
      },

      openLib: function(id=null) {
        document.getElementById('modal-salad-lib').classList.remove('hidden');

        const groups = [...new Set(window.app.data.saladLib.map(i => i.group || "DIVERS"))].sort();
        document.getElementById('slib-group').innerHTML =
          groups.map(g => `<option value="${g}">${g}</option>`).join('') + `<option value="new">+ Cr√©er...</option>`;

        const groupSel = document.getElementById('slib-group');
        const groupNew = document.getElementById('slib-group-new');
        groupSel.onchange = () => groupNew.classList.toggle('hidden', groupSel.value !== 'new');

        if(id) {
          const i = window.app.data.saladLib.find(x => x.id == id);
          document.getElementById('slib-id').value = id;
          document.getElementById('slib-name').value = i.name || "";
          document.getElementById('slib-hours').value = i.hours || 48;
          document.getElementById('slib-group').value = i.group || "DIVERS";
          groupNew.classList.add('hidden');
        } else {
          document.getElementById('slib-id').value = "";
          document.getElementById('slib-name').value = "";
          document.getElementById('slib-hours').value = 48;
          document.getElementById('slib-group').value = groups[0] || "DIVERS";
          groupNew.classList.add('hidden');
        }
      },

      saveLib: function() {
        const id = document.getElementById('slib-id').value;
        const groupSel = document.getElementById('slib-group').value;
        const group = groupSel === 'new'
          ? (document.getElementById('slib-group-new').value || "DIVERS").toUpperCase()
          : groupSel;

        const o = {
          id: id ? Number(id) : Date.now(),
          group,
          name: (document.getElementById('slib-name').value || "").trim(),
          hours: Number(document.getElementById('slib-hours').value || 48)
        };

        if(!o.name) return alert("Nom requis");

        if(id) {
          const idx = window.app.data.saladLib.findIndex(x => String(x.id) === String(id));
          if(idx > -1) window.app.data.saladLib[idx] = o;
        } else {
          window.app.data.saladLib.push(o);
        }

        window.app.queueSave('salad', 0);
        document.getElementById('modal-salad-lib').classList.add('hidden');
        window.app.salad.render();
        window.app.toast("‚úÖ Biblioth√®que enregistr√©e");
      },

      delLib: function() {
        const id = document.getElementById('slib-id').value;
        window.app.data.saladLib = window.app.data.saladLib.filter(x => String(x.id) !== String(id));
        window.app.queueSave('salad', 0);
        document.getElementById('modal-salad-lib').classList.add('hidden');
        window.app.salad.render();
        window.app.toast("üóëÔ∏è Supprim√©");
      },

      addStock: function(libId, qty = 1, goStock = true) {
        const l = window.app.data.saladLib.find(x => x.id == libId);
        if(!l) return;

        // UX : ajout direct (par d√©faut 1) => √©vite les prompts lents sur mobile
        let q = parseInt(qty, 10);
        if(!q || q < 1) q = 1;

        const now = new Date();
        const endTs = window.app.common.calculateEnd(now.getTime(), l.hours);

        window.app.data.saladStock.push({
          id: Date.now(),
          libId,
          name: l.name,
          qty: q,
          out: now.getTime(),
          end: endTs,
          hours: l.hours
        });

        window.app.queueSave('salad');

        // Si on ajoute depuis la biblioth√®que, on revient sur Rayon pour voir l‚Äôajout
        if(goStock) this.tab('stock');

        window.app.salad.render();
      },

      openTraca: function(stockId) {
        const s = window.app.data.saladStock.find(x => x.id == stockId);
        if(!s) return;

        document.getElementById('modal-traca').classList.remove('hidden');
        document.getElementById('traca-title').textContent = `${s.name} ‚Ä¢ sortie ${window.app.common.formatDate(s.out)}`;

        // store current
        this.traca._current = { stockId, libId: s.libId, name: s.name, fileB64: null };

        document.getElementById('traca-preview').classList.add('hidden');
        document.getElementById('traca-history').innerHTML = "<span class='small'>Chargement‚Ä¶</span>";

        this.traca.loadForLib(s.libId);
      },

      openEditStock: function(id) {
        let i = window.app.data.saladStock.find(x=>x.id==id);
        document.getElementById('modal-salad-stock').classList.remove('hidden');
        document.getElementById('sstock-id').value=id;
        document.getElementById('sstock-name').innerText=i.name;
        document.getElementById('sstock-qty').value=i.qty;
        document.getElementById('sstock-start').value = window.app.common.tsToInput(i.out);
        document.getElementById('sstock-end').value = window.app.common.tsToInput(i.end);
      },

      saveStock: function() {
        let idx = window.app.data.saladStock.findIndex(x=>String(x.id)===String(document.getElementById('sstock-id').value));
        if(idx<0) return;
        window.app.data.saladStock[idx].qty = Number(document.getElementById('sstock-qty').value || 0);
        window.app.data.saladStock[idx].out = new Date(document.getElementById('sstock-start').value).getTime();
        window.app.data.saladStock[idx].end = new Date(document.getElementById('sstock-end').value).getTime();
        window.app.queueSave('salad', 0);
        document.getElementById('modal-salad-stock').classList.add('hidden');
        window.app.salad.render();
        window.app.toast("‚úÖ Rayon modifi√©");
      },

      delStock: function() {
        let id = document.getElementById('sstock-id').value;
        window.app.data.saladStock = window.app.data.saladStock.filter(x=>String(x.id)!==String(id));
        window.app.queueSave('salad', 0);
        document.getElementById('modal-salad-stock').classList.add('hidden');
        window.app.salad.render();
        window.app.toast("üóëÔ∏è Retir√© du rayon");
      },

      changeQty: function(id, delta) {
        let idx = window.app.data.saladStock.findIndex(x => x.id == id);
        if(idx > -1) {
          let n = parseInt(window.app.data.saladStock[idx].qty) + delta;
          if(n <= 0) window.app.data.saladStock.splice(idx, 1);
          else window.app.data.saladStock[idx].qty = n;

          window.app.salad.render();
          window.app.queueSave('salad', 260);
        }
      },

      render: function() {
        // BIBLIO
        let bib = document.getElementById('salad-lib-list'); if(!bib) return;
        bib.innerHTML = "";

        let gLib = {};
        window.app.data.saladLib
          .slice()
          .sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)))
          .forEach(l => { let g = l.group || "DIVERS"; if(!gLib[g]) gLib[g]=[]; gLib[g].push(l); });

        Object.keys(gLib).sort().forEach(g => {
          let id = 'SL-'+g; let c = window.app.closed.has(id);
          bib.innerHTML += `<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${g}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) gLib[g].forEach(l => {
            bib.innerHTML += `
              <div class="list-item" onclick="app.salad.addStock(${l.id})">
                <div style="display:flex;align-items:center;min-width:0;">
                  <div class="item-img"><i class="fas fa-leaf" style="color:var(--salad)"></i></div>
                  <div style="min-width:0;">
                    <b>${l.name}</b><br>
                    <small>${l.hours}h</small>
                  </div>
                </div>

                <div style="display:flex;gap:8px;flex-shrink:0;">
                  <button class="qty-btn salad" style="background:var(--salad);color:white;width:40px;height:40px;" onclick="event.stopPropagation(); app.salad.openLib(${l.id})"><i class="fas fa-pen"></i></button>
                  <button class="qty-btn salad" style="background:var(--salad);color:white;width:40px;height:40px;" onclick="event.stopPropagation(); app.salad.addStock(${l.id})">+</button>
                </div>
              </div>`;
          });
        });

        // STOCK
        let st = document.getElementById('salad-stock'); st.innerHTML = "";
        let gStock = {};
        window.app.data.saladStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s => {
          let l = window.app.data.saladLib.find(x=>x.id==s.libId);
          let g = l ? (l.group || "DIVERS") : "DIVERS";
          if(!gStock[g]) gStock[g]=[];
          gStock[g].push(s);
        });

        Object.keys(gStock).sort().forEach(g => {
          let id = 'SS-'+g; let c = window.app.closed.has(id);
          st.innerHTML += `<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${g}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`;
          if(!c) gStock[g].forEach(i => {
            let dS = window.app.common.formatDate(i.out);
            let dE = window.app.common.formatDate(i.end);
            let isExp = new Date(i.end) < new Date();

            st.innerHTML += `
              <div class="swipe-wrapper" style="background:var(--salad)">
                <div class="swipe-content">
                  <div style="display:flex;align-items:center;flex:1;min-width:0;">
                    <div class="item-img" onclick="event.stopPropagation(); app.salad.openTraca(${i.id})"><i class="fas fa-camera" style="color:var(--salad)"></i></div>
                    <div style="min-width:0;">
                      <div class="item-title" onclick="app.salad.openEditStock(${i.id})">${i.name}</div>
                      <div class="qty-ctrl">
                        <button class="qty-btn salad" onclick="app.salad.changeQty(${i.id},-1)">-</button>
                        <b>${i.qty}</b>
                        <button class="qty-btn salad" onclick="app.salad.changeQty(${i.id},1)">+</button>
                      </div>
                      <div class="small">Tracabilit√© : clique sur l‚Äôic√¥ne cam√©ra</div>
                    </div>
                  </div>
                  <div class="date-col">
                    <div class="d-lbl">Sortie: ${dS}</div>
                    <div class="d-val ${isExp?'expired':''}">FIN: ${dE}</div>
                  </div>
                </div>
              </div>`;
          });
        });
      },

      traca: {
        _current: null,

        handleFile: function(input) {
          const file = input.files && input.files[0];
          if(!file || !window.app.salad.traca._current) return;

          window.app.common.compressImg(file, (b64) => {
            window.app.salad.traca._current.fileB64 = b64;
            document.getElementById('traca-img-preview').src = b64;
            document.getElementById('traca-preview').classList.remove('hidden');
          });
        },

        saveCurrent: async function() {
          const cur = window.app.salad.traca._current;
          if(!cur || !cur.fileB64) return alert("Prends une photo d‚Äôabord.");

          try {
            // 1) upload sur Storage
            const key = `salad_traca/${cur.libId}/${Date.now()}.jpg`;
            const r = ref(storage, key);
            await uploadString(r, cur.fileB64, 'data_url');
            const url = await getDownloadURL(r);

            // 2) save meta dans Firestore (6 mois)
            await addDoc(colSaladTraca, {
              libId: cur.libId,
              name: cur.name,
              storagePath: key,
              url,
              createdAt: serverTimestamp()
            });

            window.app.toast("‚úÖ Tracabilit√© enregistr√©e");
            document.getElementById('traca-preview').classList.add('hidden');
            document.getElementById('traca-input').value = "";
            cur.fileB64 = null;

            await window.app.salad.traca.loadForLib(cur.libId);
          } catch(e) {
            console.warn(e);
            alert("Erreur tracabilit√©. V√©rifie Storage + Rules + App Check.");
          }
        },

        loadForLib: async function(libId) {
          const wrap = document.getElementById('traca-history');
          wrap.innerHTML = "<span class='small'>Chargement‚Ä¶</span>";

          try {
            const cutoff = new Date();
            cutoff.setMonth(cutoff.getMonth() - 6);

            const qy = query(colSaladTraca,
              where("libId", "==", libId)
            );

            const snap = await getDocs(qy);

            const items = [];
            snap.forEach(docu => items.push({ id: docu.id, ...(docu.data()||{}) }));

            // tri (client-side) par createdAt desc
            items.sort((a,b) => {
              const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
              const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
              return tb - ta;
            });

            const recent = items.filter(x => {
              const t = x.createdAt?.toDate ? x.createdAt.toDate() : null;
              return t ? (t >= cutoff) : true;
            }).slice(0, 30); // limite affichage

            if(!recent.length) {
              wrap.innerHTML = "<span class='small'>Aucune photo.</span>";
              return;
            }

            wrap.innerHTML = recent.map(x => {
              const t = x.createdAt?.toDate ? x.createdAt.toDate() : null;
              const when = t ? `${t.getDate()}/${String(t.getMonth()+1).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}` : "date inconnue";
              return `
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
                  <img src="${x.url}" style="width:70px;height:70px;object-fit:cover;border-radius:12px;background:#f8fafc;">
                  <div style="min-width:0;">
                    <div style="font-weight:900;">${when}</div>
                    <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:230px;">${x.storagePath||""}</div>
                  </div>
                </div>
              `;
            }).join("");

          } catch(e) {
            console.warn(e);
            wrap.innerHTML = "<span class='small'>Erreur chargement historique.</span>";
          }
        },

        pruneOld: async function() {
          // delete > 6 months
          const cutoff = new Date();
          cutoff.setMonth(cutoff.getMonth() - 6);

          const snap = await getDocs(colSaladTraca);
          const toDelete = [];
          snap.forEach(docu => {
            const d = docu.data() || {};
            const t = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            if(t && t < cutoff) toDelete.push({ id: docu.id, ...d });
          });

          // limite pour √©viter d'exploser en une fois
          for(const item of toDelete.slice(0, 25)) {
            try { if(item.storagePath) await deleteObject(ref(storage, item.storagePath)); } catch(e){}
            try { await deleteDoc(doc(db, "store_master", "DATA_SALAD_TRACA", "items", item.id)); } catch(e){}
          }
        }
      }
    },

    checkAlerts: function() {
      let alert = window.app.data.frais.some(i => {
        let d = new Date(i.date);
        return !isNaN(d.getTime()) && (d - new Date())/(1000*60*60*24) < 1;
      });
      document.getElementById('alert-box').style.display = alert ? 'block' : 'none';
    }
  };

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if(!user) {
      document.getElementById('login-overlay').classList.remove('hidden');
      document.getElementById('app-header').classList.add('hidden');
      document.getElementById('app-nav').classList.add('hidden');
      window.app.me = null;
      window.app.data = { frais: [], users: [], pvpLib: [], pvpStock: [], checkedNeeds: [], saladLib: [], saladStock: [] };
      return;
    }
    await window.app.afterLoginBootstrap();
  });
</script>

</body>
</html>
