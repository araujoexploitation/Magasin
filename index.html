<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#2563eb" />
<title>Store Master v24.1 - Carrefour</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  :root {
    --bg:#f1f5f9; --card:#ffffff; 
    --blue:#2563eb; --red:#ef4444; --green:#10b981; --orange:#f97316; --purple:#8b5cf6; --teal:#0ea5e9; --indigo:#6366f1;
    --text:#0f172a; --muted:#64748b; --radius:16px; --app-width: 600px;
  }
  * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family: system-ui, -apple-system, sans-serif; }
  body { margin:0; background:#cbd5e1; color:var(--text); padding-bottom:90px; overflow-x:hidden; display: flex; justify-content: center; min-height: 100vh; }
  #app-container { width: 100%; max-width: var(--app-width); background: var(--bg); min-height: 100vh; box-shadow: 0 0 25px rgba(0,0,0,0.2); position: relative; }
  header { padding:10px 16px; background:white; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50; height: 70px; }
  .logo-container img { height: 50px; width: auto; object-fit: contain; }
  .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; }
  .module-card { background: white; border-radius: 20px; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 4px 6px -2px rgba(0,0,0,0.05); cursor: pointer; height: 120px; border:1px solid white; transition:0.2s; }
  .module-card i { font-size: 32px; margin-bottom: 10px; }
  .module-card h4 { margin:0; font-size:14px; color:var(--text); font-weight:600; }
  .screen { animation: fadeIn 0.3s; padding-bottom:20px; }
  .card { background:white; padding:20px; border-radius:var(--radius); box-shadow:0 2px 8px -2px rgba(0,0,0,0.05); margin: 0 16px 16px; position:relative; }
  .hidden { display:none !important; }
  .back-btn { padding: 10px 16px; color: var(--blue); cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; margin-top:5px; }
  input, select { width:100%; padding:14px; margin:8px 0 16px; border-radius:12px; border:1px solid #cbd5e1; background:#f8fafc; font-size:16px; }
  button.btn-main { width:100%; padding:16px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:16px; background:var(--blue); color:white; display:flex; align-items:center; justify-content:center; gap:10px; }
  .list-row { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9; }
  .item-img { width:45px; height:45px; border-radius:8px; object-fit:cover; background:#f1f5f9; border:1px solid #e2e8f0; margin-right:12px; display:flex; align-items:center; justify-content:center; color:#cbd5e1; flex-shrink:0; }
  .del-btn { color:var(--red); background:none; border:none; cursor:pointer; font-size:16px; }
  .body-admin .adm-tools { display:inline-flex; }
  .admin-btn { padding:8px; border-radius:8px; background:#f1f5f9; cursor:pointer; border:none; }
  .admin-active { background:var(--red); color:white; }
  
  /* Status DLC colors */
  .status-red { color: var(--red); font-weight: bold; }
  .status-orange { color: var(--orange); font-weight: bold; }
</style>
</head>
<body id="main-body">

<div id="app-container">
  <header>
    <div class="logo-container"><b>Carrefour</b><br>Express</div>
    <button id="lock-btn" class="admin-btn" onclick="toggleAdmin()"><i class="fas fa-lock"></i></button>
  </header>

  <div id="scr-home" class="screen">
    <div style="display:flex; gap:10px; padding:20px 16px 0;">
        <div style="flex:1; background:white; padding:15px; border-radius:16px; text-align:center;">
            <b style="color:var(--red); font-size:24px" id="kpi-alert">0</b><br><small style="color:var(--muted)">DLC Alertes</small>
        </div>
        <div style="flex:1; background:white; padding:15px; border-radius:16px; text-align:center;">
             <b style="color:var(--green); font-size:24px" id="kpi-clean">0%</b><br><small style="color:var(--muted)">Nettoyage</small>
        </div>
    </div>
    <div class="grid-menu">
      <div class="module-card" onclick="openModule('frais')"><i class="fas fa-barcode" style="color:var(--blue)"></i><h4>DLC / Frais</h4></div>
      <div class="module-card" onclick="openModule('trace')"><i class="fas fa-box-open" style="color:var(--indigo)"></i><h4>Traçabilité</h4></div>
      <div class="module-card" onclick="openModule('clean')"><i class="fas fa-pump-soap" style="color:var(--purple)"></i><h4>Nettoyage</h4></div>
      <div class="module-card" onclick="openModule('pvp')"><i class="fas fa-bread-slice" style="color:var(--orange)"></i><h4>PVP</h4></div>
      <div class="module-card" onclick="openModule('temp')"><i class="fas fa-temperature-low" style="color:var(--orange)"></i><h4>Frigos</h4></div>
    </div>
  </div>

  <div id="scr-modules" class="screen hidden">
    <div class="back-btn" onclick="go('home')"><i class="fas fa-arrow-left"></i> Retour</div>

    <div id="mod-frais" class="hidden">
        <div class="card">
            <h3 style="margin-top:0; color:var(--blue)">Saisie DLC</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px">
                <input type="number" id="f-ean" placeholder="Scan EAN..." oninput="if(this.value.length >= 8) apiScan(this.value)">
                <img id="f-img" style="width:50px;height:50px;display:none;border-radius:8px;border:1px solid #ccc">
            </div>
            <input type="text" id="f-name" placeholder="Libellé produit">
            <input type="date" id="f-date">
            <button class="btn-main" onclick="addFrais()">Valider DLC</button>
        </div>
        <div class="card">
            <h4>Liste des Dates</h4>
            <div id="list-frais"></div>
        </div>
    </div>

    <div id="mod-trace" class="hidden">
        <div class="card">
            <h3>Traçabilité</h3>
            <select id="trace-name"></select>
            <input type="file" id="trace-img" accept="image/*" capture="environment">
            <button class="btn-main" style="background:var(--indigo)" onclick="addTrace()">Ouvrir Carton</button>
        </div>
        <div id="list-trace-active"></div>
    </div>

    <div id="mod-temp" class="hidden">
        <div class="card">
            <h3>Relevé Frigos</h3>
            <select id="temp-zone"></select>
            <input type="number" id="temp-val" placeholder="°C">
            <button class="btn-main" onclick="addTemp()">Valider</button>
        </div>
        <div class="card"><div id="list-temp"></div></div>
    </div>
  </div>
</div>

<script>
/* --- DATABASE --- */
let db = JSON.parse(localStorage.getItem('store_v24')) || { 
    trace: [], frais: [], pvp: [], cleaning_log: {},
    cleaning: [{id:1, name:"Cuisine", tasks:[{n:"Sol", days:[0,1,2,3,4,5,6], freq:1}]}],
    config: {
        trace: ["Pain", "Viennoiseries"],
        frigos: ["Mural", "Réserve"],
        pvp: ["Baguette", "Croissant"]
    }
};

let isAdmin = false;

/* --- NAVIGATION --- */
function go(scr){
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('scr-'+scr).classList.remove('hidden');
    updateKPIs();
}

function openModule(mod){
    go('modules');
    document.querySelectorAll('#scr-modules > div[id^="mod-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById('mod-'+mod).classList.remove('hidden');
    if(mod==='frais') renderFraisList();
    if(mod==='trace') { updateSelect('trace-name','trace'); renderTraceList(); }
    if(mod==='temp') { updateSelect('temp-zone','frigos'); renderTempList(); }
}

/* --- LOGIQUE DLC (OFF) --- */
async function apiScan(ean) {
    const imgEl = document.getElementById('f-img');
    const nameEl = document.getElementById('f-name');
    try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
        const data = await res.json();
        if(data.status === 1) {
            nameEl.value = data.product.product_name_fr || data.product.product_name;
            imgEl.src = data.product.image_small_url;
            imgEl.style.display = 'block';
        }
    } catch(e) { console.error("Erreur API"); }
}

function addFrais() {
    const name = document.getElementById('f-name').value;
    const date = document.getElementById('f-date').value;
    const img = document.getElementById('f-img').src;
    if(!name || !date) return alert("Nom et Date requis");
    
    db.frais.push({ id: Date.now(), name, date, img: img.includes('data') ? img : img });
    save();
    renderFraisList();
    // Reset
    document.getElementById('f-name').value = "";
    document.getElementById('f-ean').value = "";
    document.getElementById('f-img').style.display = 'none';
}

function renderFraisList() {
    const container = document.getElementById('list-frais');
    const now = new Date();
    now.setHours(0,0,0,0);

    // Tri par date
    db.frais.sort((a,b) => new Date(a.date) - new Date(b.date));

    container.innerHTML = db.frais.map(item => {
        const dlc = new Date(item.date);
        const diff = (dlc - now) / (1000 * 3600 * 24);
        let statusClass = "";
        if(diff <= 0) statusClass = "status-red";
        else if(diff <= 2) statusClass = "status-orange";

        return `
            <div class="list-row">
                <div style="display:flex; align-items:center">
                    <img src="${item.img || ''}" class="item-img" onerror="this.src='https://via.placeholder.com/45'">
                    <div>
                        <b>${item.name}</b><br>
                        <small class="${statusClass}">DLC: ${new Date(item.date).toLocaleDateString()}</small>
                    </div>
                </div>
                <button class="del-btn" onclick="delFrais(${item.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;
    }).join('');
    updateKPIs();
}

function delFrais(id) {
    db.frais = db.frais.filter(i => i.id !== id);
    save(); renderFraisList();
}

/* --- TRACE --- */
async function addTrace() {
    let name = document.getElementById('trace-name').value;
    let imgInput = document.getElementById('trace-img');
    let imgData = "";
    if(imgInput.files[0]) {
        const reader = new FileReader();
        reader.readAsDataURL(imgInput.files[0]);
        await new Promise(r => reader.onload = r);
        imgData = reader.result;
    }
    db.trace.push({id: Date.now(), name, start: new Date().toISOString(), end: null, img: imgData});
    save(); renderTraceList();
}

function renderTraceList() {
    document.getElementById('list-trace-active').innerHTML = db.trace.filter(i => !i.end).map(i => `
        <div class="list-row">
            <div style="display:flex; align-items:center">
                <img src="${i.img || ''}" class="item-img">
                <b>${i.name}</b>
            </div>
            <button class="btn-main" style="width:auto; padding:8px" onclick="closeTrace(${i.id})">Fin</button>
        </div>
    `).join('');
}

function closeTrace(id) {
    db.trace.find(i => i.id === id).end = new Date().toISOString();
    save(); renderTraceList();
}

/* --- UTILS --- */
function updateKPIs() {
    const today = new Date(); today.setHours(0,0,0,0);
    const alerts = db.frais.filter(i => new Date(i.date) <= today).length;
    document.getElementById('kpi-alert').innerText = alerts;
}

function updateSelect(id, key) {
    document.getElementById(id).innerHTML = db.config[key].map(x => `<option>${x}</option>`).join('');
}

function toggleAdmin() {
    isAdmin = !isAdmin;
    document.getElementById('lock-btn').classList.toggle('admin-active', isAdmin);
    document.body.classList.toggle('body-admin', isAdmin);
}

function save() { localStorage.setItem('store_v24', JSON.stringify(db)); }

// Start
updateKPIs();
</script>
</body>
</html>
