<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Araujo Exploitation v79 (Split Data)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root {
    --primary: #003896; --accent: #E2001A; --pvp: #d97706; --bg: #f3f4f6; --surface: #ffffff; --text: #1e293b; --success: #10b981; --danger: #ef4444;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; user-select: none; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  .hidden { display: none !important; }
  main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
  .card { background: var(--surface); border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }

  /* HEADER & NAV */
  header { background: var(--surface); padding: 10px; height: 90px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
  .logo-header { height: 60px; object-fit: contain; }
  .user-badge { position: absolute; right: 15px; top: 15px; font-size: 11px; background: #e0f2fe; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-weight: bold; }
  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; padding: 0 30px; }
  .nav-btn { text-align:center; color:#94a3b8; cursor: pointer; }
  .nav-btn.active { color: var(--primary); }

  /* TABS */
  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
  .tab { flex: 1; text-align: center; padding: 12px; font-weight: 700; font-size: 12px; color: #64748b; border-radius: 9px; cursor: pointer; transition: 0.2s; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .tab.active-pvp { background: white; color: var(--pvp); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* UI ELEMENTS */
  input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; margin-bottom: 10px; outline: none; }
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; margin-top: 5px; }
  .btn-orange { background: var(--pvp); } .btn-red { background: #ef4444; }

  /* ACCORDION */
  .group-header { background: #334155; color: white; padding: 12px 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; text-transform: uppercase; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .group-header i { transition: transform 0.3s; }
  .group-header.closed i { transform: rotate(-90deg); }
  .group-content { overflow: hidden; transition: max-height 0.3s ease-out; }
  .group-content.closed { display: none; }

  /* TARGET GRID (PREVISIONS) */
  .target-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
  .target-box { display: flex; flex-direction: column; align-items: center; }
  .target-box label { font-size: 10px; font-weight: bold; margin-bottom: 2px; color: #64748b; }
  .target-box input { padding: 5px; text-align: center; font-weight: bold; border-radius: 8px; height: 45px; width: 100%; font-size: 18px; margin: 0; }

  /* LIST ITEMS */
  .swipe-wrapper { background: #ef4444; overflow: hidden; margin-bottom: 8px; border-radius: 12px; }
  .pvp-row-container { position: relative; overflow: hidden; margin-bottom: 8px; background: #fee2e2; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .pvp-row-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; padding-left: 20px; color: #ef4444; font-weight: bold; font-size: 14px; z-index: 1; }
  .pvp-item { position: relative; z-index: 2; background: white; display: flex; justify-content: space-between; align-items: center; padding: 12px; width: 100%; border-radius: 12px; will-change: transform; min-height: 80px; }
  
  .wek-item-frais { background: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2; transition: transform 0.2s; }
  .wek-img { width: 55px; height: 55px; border-radius: 10px; object-fit: cover; background: #f1f5f9; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #cbd5e1; flex-shrink: 0; cursor: pointer; border: 1px solid #e2e8f0; }
  .date-badge { width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; margin-left: 10px; }
  .badge-red { background: #ef4444; } .badge-orange { background: #f59e0b; } .badge-green { background: #10b981; } .badge-grey { background: #94a3b8; }

  /* PVP SPECIFIC */
  .qty-ctrl { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 5px 10px; border-radius: 10px; border: 1px solid #e2e8f0; }
  .qty-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; font-size: 18px; color: var(--primary); }
  .stock-dates { text-align: right; display: flex; flex-direction: column; justify-content: center; min-width: 90px; }
  .date-out { font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
  .date-end { font-size: 14px; font-weight: 800; color: var(--success); }
  .date-end.expired { color: var(--danger); }

  .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .home-btn { padding: 30px 10px; text-align: center; border-radius: 16px; color: white; cursor: pointer; font-weight: bold; }

  /* CHECKBOX */
  .checkbox-circle { width: 32px; height: 32px; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; font-size: 16px; margin-left: 10px; flex-shrink: 0; }
  .checkbox-circle.checked { background: var(--success); border-color: var(--success); color: white; }
  .done-item { opacity: 0.5; filter: grayscale(1); background: #f1f5f9; }
  .done-item b { text-decoration: line-through; }

  /* MODALS */
  .modal-bc { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .modal-card { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
  #bc-img-display { width: 100%; height: 250px; object-fit: contain; background: #f8fafc; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; }
</style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="login-logo" style="width:200px; margin-bottom:30px;">
    <select id="login-user-select"></select>
    <input type="password" id="login-pass" placeholder="CODE">
    <button class="btn" onclick="app.login()" style="width:220px;border-radius:50px;background:#00563f;">CONNEXION</button>
  </div>

  <div id="modal-barcode" class="modal-bc hidden">
    <div class="modal-card" style="text-align:center;">
        <h3 id="bc-name">Produit</h3>
        <img id="bc-img-display" style="display:none;">
        <svg id="barcode"></svg>
        <button class="btn" style="background:#eee;color:#333;margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <div id="modal-edit-frais" class="modal-bc hidden">
    <div class="modal-card">
        <h3>Modifier Frais</h3>
        <input type="hidden" id="edit-id">
        <label>Famille</label><select id="edit-famille"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
        <label>Qté</label><input type="number" id="edit-qty">
        <label>DLC</label><input type="date" id="edit-date">
        <button class="btn" onclick="app.frais.saveEdit()" style="background:#00563f;">Enregistrer</button>
        <button class="btn" onclick="app.frais.del()" style="background:#ef4444;">Supprimer</button>
        <button class="btn" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')" style="background:#eee;color:#333;">Annuler</button>
    </div>
  </div>

  <div id="modal-pvp-lib" class="modal-bc hidden">
    <div class="modal-card">
        <h3 style="color:#d97706">Fiche Produit PVP</h3>
        <input type="hidden" id="lib-id"> 
        <input type="hidden" id="lib-img-data">
        
        <label>Famille</label>
        <select id="lib-fam-select" onchange="app.pvp.toggleFamInput()"></select>
        <input type="text" id="lib-fam-new" placeholder="Nom de la nouvelle famille..." class="hidden">

        <label>Nom du Produit</label><input type="text" id="lib-name" placeholder="Ex: Donut Sucre">
        <label>EAN (Code Barre)</label><input type="number" id="lib-ean">
        
        <label>Photo</label>
        <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none" onchange="app.pvp.handleImg(this)">
        <button class="btn" onclick="document.getElementById('cam-input').click()" style="background:#eee;color:#333;margin-bottom:10px;"><i class="fas fa-camera"></i> Prendre Photo</button>
        <img id="img-preview" style="width:100px;height:100px;object-fit:cover;border-radius:10px;display:none;margin:0 auto 10px auto;">

        <label>Règle de Date</label>
        <select id="lib-days">
            <option value="0">JOURNÉE (Jetter Soir 22h)</option>
            <option value="48">48 Heures (Donuts...)</option>
            <option value="72">72 Heures</option>
        </select>
        
        <label>Objectif de Cuisson (Lundi -> Dim)</label>
        <div class="target-grid">
            <div class="target-box"><label>L</label><input type="number" id="t-1"></div>
            <div class="target-box"><label>M</label><input type="number" id="t-2"></div>
            <div class="target-box"><label>M</label><input type="number" id="t-3"></div>
            <div class="target-box"><label>J</label><input type="number" id="t-4"></div>
            <div class="target-box"><label>V</label><input type="number" id="t-5"></div>
            <div class="target-box"><label>S</label><input type="number" id="t-6"></div>
            <div class="target-box"><label>D</label><input type="number" id="t-0"></div>
        </div>

        <button class="btn" onclick="app.pvp.saveLib()" style="background:#d97706;">Enregistrer</button>
        <button class="btn" onclick="app.pvp.delLib()" style="background:#ef4444;" id="btn-del-lib">Supprimer</button>
        <button class="btn" onclick="document.getElementById('modal-pvp-lib').classList.add('hidden')" style="background:#eee;color:#333;">Fermer</button>
    </div>
  </div>

  <div id="modal-pvp-stock" class="modal-bc hidden">
      <div class="modal-card">
          <h3 style="color:#d97706">Modifier Rayon</h3>
          <input type="hidden" id="stock-id">
          <h4 id="stock-name" style="text-align:center;"></h4>
          <label>Quantité</label><input type="number" id="stock-qty">
          <label style="margin-top:15px;color:#64748b">Date Sortie (Prod)</label><input type="datetime-local" id="stock-start">
          <label style="color:#ef4444">Date Fin (Jeter)</label><input type="datetime-local" id="stock-end">
          <button class="btn" onclick="app.pvp.saveStock()" style="background:#d97706;">Valider Correction</button>
          <button class="btn" onclick="app.pvp.delStock()" style="background:#ef4444;">Retirer du Rayon</button>
          <button class="btn" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')" style="background:#eee;color:#333;">Annuler</button>
      </div>
  </div>

  <header id="app-header" class="hidden">
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
    <div id="user-badge" class="user-badge">...</div>
  </header>

  <main>
    <div id="view-home">
        <div id="alert-box" style="display:none;background:#ef4444;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;font-weight:bold;">⚠️ Vérifier Dates !</div>
        
        <div class="home-grid">
            <div class="home-btn" onclick="app.nav('frais')" style="background: linear-gradient(135deg, #003896 0%, #002366 100%);"><i class="fas fa-barcode home-icon"></i><br>DLC FRAIS</div>
            <div class="home-btn" onclick="app.nav('pvp')" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%);"><i class="fas fa-bread-slice home-icon"></i><br>GESTION PVP</div>
        </div>
        <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;"><i class="fas fa-users"></i> Équipe</div>
    </div>

    <div id="view-frais" class="hidden">
        <div class="tabs">
            <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
            <div class="tab" id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
        </div>
        <div id="frais-scan">
            <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;"><video id="video" style="width:100%;height:100%;object-fit:cover;"></video></div>
            <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
            <div class="card">
                <input id="frais-ean" placeholder="EAN" oninput="if(this.value.length>8) app.frais.api(this.value)">
                <select id="frais-fam"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
                <input id="frais-name" placeholder="Nom">
                <div style="display:flex;gap:10px;"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qté"></div>
                <button class="btn" onclick="app.frais.add()">AJOUTER</button>
            </div>
        </div>
        <div id="frais-list" class="hidden"></div>
    </div>

    <div id="view-pvp" class="hidden">
        <div class="tabs">
            <div class="tab active" id="tp-1" onclick="app.pvp.tab('stock')">RAYON</div>
            <div class="tab" id="tp-2" onclick="app.pvp.tab('bib')">BIBLIOTHÈQUE</div>
            <div class="tab" id="tp-3" onclick="app.pvp.tab('calc')">BESOINS</div>
        </div>
        <div id="pvp-stock"></div>
        <div id="pvp-bib" class="hidden">
            <button class="btn" onclick="app.pvp.openLib()" style="background:#eee;color:#333;margin-bottom:15px;">+ Créer Produit</button>
            <div id="lib-list"></div>
        </div>
        <div id="pvp-calc" class="hidden"></div>
    </div>

    <div id="view-team" class="hidden">
        <div class="card">
            <input id="new-u-name" placeholder="Nom"><input id="new-u-code" placeholder="Code">
            <button class="btn" onclick="app.saveUser()">Créer Staff</button>
        </div>
        <div class="card" id="user-list"></div>
    </div>
  </main>

  <nav id="app-nav" class="hidden">
      <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left" style="font-size:24px;"></i><br><span style="font-size:10px;">RETOUR</span></div>
      <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large" style="font-size:24px;"></i><br><span style="font-size:10px;">MENU</span></div>
  </nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const db = getFirestore(initializeApp({ apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA", authDomain: "araujo-exploitation.firebaseapp.com", projectId: "araujo-exploitation" }));

// SPLIT DATA REFS
const docUsers = doc(db, "store_master", "DATA_USERS");
const docFrais = doc(db, "store_master", "DATA_FRAIS");
const docPVP = doc(db, "store_master", "DATA_PVP");
const docLegacy = doc(db, "store_master", "STOCK_MAGASIN_LIVE"); // Old one

const codeReader = new ZXing.BrowserMultiFormatReader();

window.app = {
    data: { frais: [], users: [], pvpLib: [], pvpStock: [], checkedNeeds: [] },
    viewHistory: [],
    closedFamilies: new Set(),
    
    common: {
        showBarcode: function(ean, name, imgUrl=null) { 
            document.getElementById('modal-barcode').classList.remove('hidden'); 
            document.getElementById('bc-name').innerText=name; 
            let imgEl = document.getElementById('bc-img-display');
            if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display='block'; } else { imgEl.style.display='none'; }
            if(ean) {
                try{JsBarcode("#barcode", ean, {format:"EAN13", height:80, displayValue:true});}
                catch(e){try{JsBarcode("#barcode", ean, {format:"CODE128", height:80, displayValue:true});}catch(e2){}}
            } else { document.getElementById('barcode').style.display='none'; }
        },
        tsToInput: function(ts) {
            let d = new Date(ts);
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        },
        calculateEnd: function(startTs, hours) {
            let start = new Date(startTs);
            let end = new Date(startTs);
            let h = parseInt(hours);
            if (h === 0) { end.setHours(22, 0, 0, 0); } else { end.setHours(end.getHours() + h); }
            return end.getTime();
        },
        cleanName: function(name) { return name.toUpperCase().replace(/^[\d\s\.,xX]+(G|KG|ML|CL|L|P)?\s*/g, ''); },
        compressImg: function(file, callback) {
            let reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                let img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    let canvas = document.createElement('canvas'); let ctx = canvas.getContext('2d');
                    let max = 350; // REDUIT DE 600 à 350
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.5)); // QUALITE REDUITE DE 0.7 à 0.5
                };
            };
        }
    },

    init: async function() {
        // LOAD SPLIT DATA
        try {
            const [uSnap, fSnap, pSnap] = await Promise.all([getDoc(docUsers), getDoc(docFrais), getDoc(docPVP)]);
            
            if(uSnap.exists()) this.data.users = uSnap.data().list || [];
            if(fSnap.exists()) this.data.frais = fSnap.
