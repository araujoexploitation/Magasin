<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Store Master v29 - Visual DLC</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  /* --- DESIGN SYSTEM --- */
  :root {
    --primary: #0055AA; --accent: #E2001A; --success: #10b981; --warning: #f59e0b;
    --bg: #F4F6F9; --surface: #ffffff; --text: #1e293b; --radius: 16px;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: system-ui, -apple-system, sans-serif; }
  body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* HEADER */
  header {
    background: var(--surface); padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
    display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.05); z-index: 50;
  }
  .brand { font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

  /* TABS (Pour basculer entre Scan et Liste) */
  .tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
  .tab { flex: 1; text-align: center; padding: 10px; font-weight: 600; font-size: 14px; color: #64748b; border-radius: 10px; cursor: pointer; transition: 0.2s; }
  .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* MAIN */
  main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
  .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
  
  /* INPUTS */
  .input-group label { display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px; }
  input, select { width: 100%; padding: 16px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; background: #fff; outline: none; }
  input:focus { border-color: var(--primary); }

  /* PHOTO PREVIEW */
  .photo-box { 
    width: 100%; height: 150px; background: #f1f5f9; border-radius: 12px; 
    display: flex; align-items: center; justify-content: center; overflow: hidden; 
    margin-bottom: 15px; border: 2px dashed #cbd5e1; position: relative;
  }
  .photo-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
  .photo-btn { position: absolute; bottom: 10px; right: 10px; background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  /* LISTE DLC (Code Couleur) */
  .dlc-item { 
    display: flex; align-items: center; padding: 15px; margin-bottom: 10px; 
    background: white; border-radius: 12px; border-left: 6px solid #ccc; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
  }
  .dlc-red { border-left-color: var(--accent); background: #FEF2F2; }
  .dlc-orange { border-left-color: var(--warning); background: #FFF7ED; }
  .dlc-green { border-left-color: var(--success); }
  
  .dlc-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; margin-right: 15px; }
  .dlc-info { flex: 1; }
  .dlc-date { font-weight: bold; font-size: 14px; }
  
  /* NAV & UTILS */
  nav { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; }
  .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; cursor: pointer; }
  .nav-btn.active { color: var(--primary); } .nav-btn i { font-size: 24px; margin-bottom: 4px; }
  
  .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; background: var(--primary); color: white; cursor: pointer; }
  .hidden { display: none !important; }
  .overlay { position: fixed; inset: 0; background: var(--primary); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
</style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <h1 style="color: white; margin-bottom: 20px;">Store Master</h1>
    <input type="password" id="login-pass" placeholder="Code (2008)" style="text-align: center; margin-bottom: 20px; max-width: 200px;">
    <button class="btn" style="background: white; color: var(--primary); max-width: 200px;" onclick="window.app.login()">Connexion</button>
  </div>

  <header>
    <div class="brand">STORE MASTER</div>
    <div style="font-size:12px; font-weight:bold; color:var(--success);">CLOUD OK</div>
  </header>

  <main>
    <div id="view-home">
      <div class="card" onclick="window.app.nav('frais')" style="text-align:center; cursor:pointer; padding:30px;">
        <i class="fas fa-barcode" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
        <h3 style="margin:0;">DLC / FRAIS</h3>
        <p style="color:#64748b; font-size:13px;">Scanner, Photo & Liste</p>
      </div>
      <div class="card" onclick="window.app.nav('reception')" style="text-align:center; cursor:pointer;">
        <i class="fas fa-truck" style="font-size:30px; color:var(--success); margin-bottom:10px;"></i>
        <h4 style="margin:0;">Réception</h4>
      </div>
      <div class="card" onclick="window.app.exportCSV()" style="text-align:center; cursor:pointer;">
        <i class="fas fa-file-csv" style="font-size:30px; color:#64748b; margin-bottom:10px;"></i>
        <h4 style="margin:0;">Rapport</h4>
      </div>
    </div>

    <div id="view-frais" class="hidden">
      <div class="tabs">
        <div id="tab-scan" class="tab active" onclick="window.app.switchTab('scan')">NOUVEAU (SCAN)</div>
        <div id="tab-list" class="tab" onclick="window.app.switchTab('list')">VOIR LISTE</div>
      </div>

      <div id="content-scan">
        <div class="card">
          <div class="photo-box" onclick="document.getElementById('cam-input').click()">
            <img id="frais-img">
            <div id="photo-placeholder" style="text-align:center; color:#94a3b8;">
              <i class="fas fa-camera" style="font-size:30px;"></i><br>Photo
            </div>
            <div class="photo-btn"><i class="fas fa-camera"></i></div>
            <input type="file" id="cam-input" accept="image/*" capture="environment" class="hidden" onchange="window.app.handlePhoto(this)">
          </div>

          <div class="input-group">
            <label>Code Barre (EAN)</label>
            <input type="number" id="frais-ean" placeholder="Scanner..." oninput="if(this.value.length>=8) window.app.scanApi(this.value)">
          </div>
          <div class="input-group">
            <label>Nom du Produit</label>
            <input type="text" id="frais-name" placeholder="Ex: Yaourt Fraise">
          </div>
          <div class="input-group">
            <label>Date Limite (DLC)</label>
            <input type="date" id="frais-date">
          </div>
          <button class="btn" onclick="window.app.addFrais()">ENREGISTRER</button>
        </div>
      </div>

      <div id="content-list" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; font-weight:bold; color:#64748b;">
          <span><i class="fas fa-circle" style="color:var(--accent)"></i> J-0</span>
          <span><i class="fas fa-circle" style="color:var(--warning)"></i> J+1</span>
          <span><i class="fas fa-circle" style="color:var(--success)"></i> J+2</span>
        </div>
        <div id="list-frais-container"></div>
      </div>
    </div>

    <div id="view-reception" class="hidden">
      <div class="card">
        <h3>Nouvelle Réception</h3>
        <input type="text" id="rec-four" placeholder="Fournisseur">
        <input type="number" id="rec-temp" placeholder="Température °C">
        <button class="btn" style="background:var(--success)" onclick="window.app.addRec()">Valider</button>
      </div>
      <div id="list-rec-container"></div>
    </div>

  </main>

  <nav>
    <div class="nav-btn" onclick="window.app.nav('home')"><i class="fas fa-th-large"></i>Menu</div>
    <div class="nav-btn" onclick="window.app.nav('frais'); window.app.switchTab('scan')"><i class="fas fa-plus-circle"></i>Ajouter</div>
    <div class="nav-btn" onclick="window.app.nav('frais'); window.app.switchTab('list')"><i class="fas fa-list"></i>Liste</div>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA", authDomain: "araujo-exploitation.firebaseapp.com", databaseURL: "https://araujo-exploitation-default-rtdb.europe-west1.firebasedatabase.app", projectId: "araujo-exploitation", storageBucket: "araujo-exploitation.firebasestorage.app", messagingSenderId: "292878114487", appId: "1:292878114487:web:2a450227310e970ce1b732" };
  
  const db = getFirestore(initializeApp(firebaseConfig));
  const docRef = doc(db, "store_master", "v29");

  window.app = {
    data: { frais: [], reception: [] },
    
    init: function() {
      onSnapshot(docRef, (s) => {
        if(s.exists()) { this.data = {...this.data, ...s.data()}; this.renderList(); }
      });
    },

    save: async function() { await setDoc(docRef, this.data, {merge:true}); this.renderList(); },

    login: function() {
      if(document.getElementById('login-pass').value === "2008") {
        document.getElementById('login-overlay').classList.add('hidden');
        this.init();
      } else alert("Code erreur");
    },

    nav: function(v) {
      document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
      document.getElementById('view-'+v).classList.remove('hidden');
    },

    switchTab: function(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      document.getElementById('content-scan').classList.add('hidden');
      document.getElementById('content-list').classList.add('hidden');
      document.getElementById('content-'+t).classList.remove('hidden');
    },

    // FRAIS LOGIC
    scanApi: async function(ean) {
      try {
        let r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
        let d = await r.json();
        if(d.status === 1) {
          if(navigator.vibrate) navigator.vibrate(200);
          document.getElementById('frais-name').value = d.product.product_name_fr || d.product.product_name;
          let img = d.product.image_small_url;
          if(img) {
             document.getElementById('frais-img').src = img;
             document.getElementById('frais-img').style.display = 'block';
             document.getElementById('photo-placeholder').style.display = 'none';
          }
        }
      } catch(e){}
    },

    handlePhoto: function(input) {
      if (input.files && input.files[0]) {
        let reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('frais-img').src = e.target.result;
          document.getElementById('frais-img').style.display = 'block';
          document.getElementById('photo-placeholder').style.display = 'none';
        }
        reader.readAsDataURL(input.files[0]);
      }
    },

    addFrais: function() {
      let ean = document.getElementById('frais-ean').value;
      let name = document.getElementById('frais-name').value;
      let date = document.getElementById('frais-date').value;
      let img = document.getElementById('frais-img').src;
      
      if(!name || !date) return alert("Nom et Date requis");
      
      this.data.frais.push({
        id: Date.now(), ean, name, date, 
        img: img.includes('data') || img.includes('http') ? img : null
      });
      this.save();
      
      // Reset
      document.getElementById('frais-name').value = "";
      document.getElementById('frais-ean').value = "";
      document.getElementById('frais-img').style.display = 'none';
      document.getElementById('photo-placeholder').style.display = 'block';
      alert("Enregistré !");
      this.switchTab('list'); // Bascule auto sur la liste après ajout
    },

    addRec: function() {
      let four = document.getElementById('rec-four').value;
      let temp = document.getElementById('rec-temp').value;
      this.data.reception.push({id:Date.now(), four, temp, date:new Date().toISOString()});
      this.save();
      document.getElementById('rec-four').value = "";
      document.getElementById('rec-temp').value = "";
      alert("Reçu !");
    },

    delItem: function(id) {
      if(confirm("Retirer le produit ?")) {
        this.data.frais = this.data.frais.filter(x => x.id !== id);
        this.save();
      }
    },

    renderList: function() {
      let today = new Date().toISOString().split('T')[0];
      
      // LOGIQUE COULEUR : J0=Rouge, J+1=Orange, J+2=Vert
      let html = this.data.frais.sort((a,b) => a.date.localeCompare(b.date)).map(i => {
        let diff = (new Date(i.date) - new Date(today)) / (86400000); // Diff en jours
        let cls = 'dlc-green'; // Par défaut vert (J+2 et plus)
        let txt = i.date;

        if (diff < 1) { // J-0 ou périmé
            cls = 'dlc-red';
            txt = "AUJOURD'HUI (" + i.date + ")";
        } else if (diff < 2) { // J+1 (donc diff entre 1 et 2)
            cls = 'dlc-orange';
            txt = "DEMAIN (" + i.date + ")";
        }

        return `
          <div class="dlc-item ${cls}">
            <img src="${i.img || 'https://via.placeholder.com/50'}" class="dlc-img">
            <div class="dlc-info">
              <div style="font-weight:bold;">${i.name}</div>
              <div class="dlc-date">${txt}</div>
            </div>
            <button onclick="window.app.delItem(${i.id})" style="background:none; border:none; color:#ccc;"><i class="fas fa-trash"></i></button>
          </div>
        `;
      }).join('');
      
      document.getElementById('list-frais-container').innerHTML = html || "<div style='text-align:center; color:#ccc; padding:20px;'>Aucun produit</div>";
      
      // Render Reception
      document.getElementById('list-rec-container').innerHTML = this.data.reception.slice(-5).map(r => 
        `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${r.four}</b> : ${r.temp}°C</div>`
      ).join('');
    },

    exportCSV: function() {
      let csv = "Date;Nom;DLC\n";
      this.data.frais.forEach(i => csv += `${new Date().toLocaleDateString()};${i.name};${i.date}\n`);
      let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'DLC.csv'; a.click();
    }
  };
</script>
</body>
</html>
