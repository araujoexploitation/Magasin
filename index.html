<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Carrefour Store Master v28.0</title>

    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
            authDomain: "araujo-exploitation.firebaseapp.com",
            projectId: "araujo-exploitation",
            storageBucket: "araujo-exploitation.firebasestorage.app",
            messagingSenderId: "292878114487",
            appId: "1:292878114487:web:2a450227310e970ce1b732"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "magasin", "data_globale");

        window.db_local = {
            dlc_items: [], pvp: [], trace: [], temp_log: [],
            checklist_answers: {}, cleaning_log: {},
            cleaning: [
                {id:1, name:"Cuisine", tasks:[{n:"Sol", days:[0,1,2,3,4,5,6], freq:1}]},
                {id:2, name:"Magasin", tasks:[{n:"Tapis Caisse", days:[0,1,2,3,4,5,6], freq:1}]}
            ],
            config: {
                rayons: ["Ultra Frais", "BOF", "Surgelé", "Fruits & Légumes"],
                pvp_types: ["Baguette", "Croissant", "Pain Choc"],
                soonDays: 3
            }
        };

        window.saveToCloud = async () => { try { await setDoc(docRef, window.db_local); } catch(e) { console.error(e); } };
        onSnapshot(docRef, (snap) => { if (snap.exists()) { window.db_local = snap.data(); refreshUI(); } });
    </script>

    <style>
        :root { --blue: #003896; --red: #ed1c24; --bg: #f5f5f5; --green: #10b981; --orange: #f59e0b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); padding-bottom: 90px; }
        header { background: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--blue); font-weight: bold; position: sticky; top:0; z-index:100; }
        
        .screen { padding: 15px; }
        .hidden { display: none !important; }
        
        /* Menu Accueil */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .module-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .module-card i { font-size: 30px; color: var(--blue); margin-bottom: 10px; }

        /* Scanner */
        #scanner-container { width: 100%; height: 180px; background: black; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 10px; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Liste DLC */
        .dlc-card { background: white; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; border-left: 5px solid #ccc; }
        .dlc-card.RED { border-left-color: var(--red); }
        .dlc-card.ORANGE { border-left-color: var(--orange); }
        .dlc-card.GREEN { border-left-color: var(--green); }
        .prod-img { width: 50px; height: 50px; border-radius: 5px; object-fit: contain; background: #fff; }

        /* Formulaire */
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; color: #666; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--blue); }
    </style>
</head>
<body>

<header>CARREFOUR STORE MASTER</header>

<div id="scr-home" class="screen">
    <div class="grid-menu">
        <div class="module-card" onclick="openModule('dlc')"><i class="fas fa-barcode"></i><h4>DLC / Scan</h4></div>
        <div class="module-card" onclick="openModule('pvp')"><i class="fas fa-bread-slice"></i><h4>PVP</h4></div>
        <div class="module-card" onclick="openModule('clean')"><i class="fas fa-pump-soap"></i><h4>Ménage</h4></div>
        <div class="module-card" onclick="openModule('temp')"><i class="fas fa-temperature-low"></i><h4>Températures</h4></div>
        <div class="module-card" onclick="openModule('trace')"><i class="fas fa-box-open"></i><h4>Traçabilité</h4></div>
        <div class="module-card" onclick="openModule('check')"><i class="fas fa-check-double"></i><h4>Checklist</h4></div>
    </div>
</div>

<div id="scr-dlc" class="screen hidden">
    <div onclick="go('home')" style="margin-bottom:15px; color:var(--blue); font-weight:bold;"><i class="fas fa-arrow-left"></i> RETOUR</div>
    
    <div id="scanner-container">
        <video id="video"></video>
    </div>

    <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <input type="text" id="in-ean" placeholder="EAN Scanné">
        <input type="text" id="in-name" placeholder="Nom du produit">
        <select id="in-rayon"><option>Ultra Frais</option><option>BOF</option><option>Surgelé</option></select>
        <div style="display:flex; gap:10px">
            <input type="date" id="in-date">
            <input type="number" id="in-qty" value="1" style="width:80px">
        </div>
        <img id="preview-img" src="" class="hidden" style="height:60px; margin: 10px 0;">
        <button class="btn-main" onclick="addDLC()">ENREGISTRER DLC</button>
    </div>

    <div id="render-dlc-list"></div>
</div>

<div id="scr-clean" class="screen hidden">
    <div onclick="go('home')">RETOUR</div>
    <div id="render-clean"></div>
</div>

<nav>
    <div class="nav-item active" onclick="go('home')"><i class="fas fa-home"></i><br>Accueil</div>
    <div class="nav-item" onclick="openModule('dlc')"><i class="fas fa-barcode"></i><br>Scan DLC</div>
</nav>

<script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentImg = "";

    function go(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('scr-' + id).classList.remove('hidden');
        codeReader.reset();
    }

    function openModule(mod) {
        go(mod);
        if(mod === 'dlc') startScan();
        refreshUI();
    }

    // --- LOGIQUE SCAN & OPEN FOOD FACTS ---
    function startScan() {
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                document.getElementById('in-ean').value = result.text;
                if(navigator.vibrate) navigator.vibrate(100);
                fetchOFF(result.text);
            }
        });
    }

    async function fetchOFF(ean) {
        try {
            const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);
            const data = await res.json();
            if(data.status === 1) {
                document.getElementById('in-name').value = data.product.product_name_fr || data.product.product_name;
                currentImg = data.product.image_small_url || "";
                if(currentImg) {
                    const pi = document.getElementById('preview-img');
                    pi.src = currentImg; pi.classList.remove('hidden');
                }
            }
        } catch(e) { console.error("Erreur OFF"); }
    }

    // --- ACTIONS ---
    function addDLC() {
        const item = {
            id: Date.now(),
            ean: document.getElementById('in-ean').value,
            name: document.getElementById('in-name').value,
            rayon: document.getElementById('in-rayon').value,
            date: document.getElementById('in-date').value,
            qty: document.getElementById('in-qty').value,
            img: currentImg
        };
        if(!item.name || !item.date) return alert("Nom et Date obligatoires");
        window.db_local.dlc_items.push(item);
        window.saveToCloud();
        // Reset
        document.getElementById('in-ean').value = "";
        document.getElementById('in-name').value = "";
        document.getElementById('preview-img').classList.add('hidden');
        currentImg = "";
    }

    function calculateStatus(dateStr) {
        const now = new Date();
        const expiry = new Date(dateStr);
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if(expiry <= today) return 'RED';
        const soon = new Date(); soon.setDate(soon.getDate() + 3);
        if(expiry <= soon) return 'ORANGE';
        return 'GREEN';
    }

    function refreshUI() {
        if(!window.db_local) return;
        
        // Liste DLC
        const render = document.getElementById('render-dlc-list');
        if(render) {
            render.innerHTML = window.db_local.dlc_items.sort((a,b) => new Date(a.date) - new Date(b.date)).map(i => {
                const status = calculateStatus(i.date);
                return `
                    <div class="dlc-card ${status}">
                        <img src="${i.img || 'https://via.placeholder.com/50'}" class="prod-img">
                        <div style="flex:1">
                            <b>${i.name}</b><br>
                            <small>${i.rayon} | DLC : ${new Date(i.date).toLocaleDateString()}</small>
                        </div>
                        <div style="font-weight:bold">x${i.qty}</div>
                        <button onclick="removeItem('dlc_items', ${i.id})" style="border:none; color:var(--red); background:none"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }).join('');
        }

        // Checklist, Températures, etc. (peuvent être ajoutés ici sur le même modèle)
    }

    function removeItem(key, id) {
        if(confirm("Supprimer ?")) {
            window.db_local[key] = window.db_local[key].filter(i => i.id !== id);
            window.saveToCloud();
        }
    }

    refreshUI();
</script>
</body>
</html>
