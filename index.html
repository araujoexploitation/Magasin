<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#ffffff" />
<title>Araujo App V3.2</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root { --primary:#003896; --accent:#E2001A; --pvp:#d97706; --salad:#00563f; --bg:#f3f4f6; --surface:#fff; --text:#1e293b; --success:#10b981; --danger:#ef4444; }
  * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family:system-ui,sans-serif; user-select:none; }
  body { margin:0; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
  .hidden{ display:none!important; }

  /* LOGIN */
  #login-overlay{ position:fixed; inset:0; z-index:10000; background:#fff; display:flex; align-items:center; justify-content:center; padding:18px; }
  .login-card{ width:min(380px, 92vw); }
  .login-help{ font-size:12px; color:#64748b; text-align:center; margin-top:10px; cursor:pointer; }
  .login-error{ display:none; background:#fee2e2; color:#991b1b; padding:10px 12px; border-radius:10px; font-weight:800; font-size:13px; margin-top:10px; }

  /* HEADER & NAV */
  header{ background:var(--surface); padding:10px; height:80px; display:flex; justify-content:center; align-items:center; box-shadow:0 4px 15px rgba(0,0,0,.05); position:relative; z-index:50; }
  .logo-header{ height:50px; object-fit:contain; }
  .user-badge{ position:absolute; right:15px; top:15px; font-size:11px; background:#e0f2fe; color:var(--primary); padding:4px 10px; border-radius:20px; font-weight:900; }
  .logout-btn{ position:absolute; left:15px; top:18px; border:none; background:#f1f5f9; color:#334155; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900; }

  main{ flex:1; overflow-y:auto; padding:15px; padding-bottom:90px; }

  nav{ position:fixed; bottom:0; width:100%; background:#fff; height:70px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 -4px 20px rgba(0,0,0,.05); z-index:100; padding:0 30px; }
  .nav-btn{ text-align:center; color:#94a3b8; cursor:pointer; font-size:12px; }
  .nav-btn i{ font-size:24px; margin-bottom:4px; }

  /* UI */
  .card{ background:var(--surface); border-radius:16px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,.03); margin-bottom:15px; }
  input, select{ width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:10px; font-size:16px; background:#fff; margin-bottom:10px; outline:none; }
  .btn{ width:100%; padding:16px; border-radius:12px; border:none; font-weight:900; font-size:16px; background:var(--primary); color:#fff; cursor:pointer; margin-top:5px; }
  .btn.secondary{ background:#eee; color:#333; }
  .btn.danger{ background:#ef4444; }
  .btn.success{ background:#00563f; }

  .tabs{ display:flex; background:#e2e8f0; padding:4px; border-radius:12px; margin-bottom:15px; }
  .tab{ flex:1; text-align:center; padding:12px; font-weight:900; font-size:12px; color:#64748b; border-radius:9px; cursor:pointer; }
  .tab.active{ background:#fff; color:var(--primary); box-shadow:0 2px 4px rgba(0,0,0,.1); }
  .tab.active-pvp{ background:#fff; color:var(--pvp); box-shadow:0 2px 4px rgba(0,0,0,.1); }
  .tab.active-salad{ background:#fff; color:var(--salad); box-shadow:0 2px 4px rgba(0,0,0,.1); }

  /* HOME MENU */
  .home-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
  .home-btn{ border-radius:18px; padding:18px 12px; min-height:115px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:#fff; font-weight:900; box-shadow:0 10px 25px rgba(0,0,0,.08); cursor:pointer; }
  .home-btn i{ font-size:28px; margin-bottom:10px; }

  /* LISTES */
  .group-header{ background:#334155; color:#fff; padding:12px 15px; border-radius:10px; margin-top:15px; font-weight:900; text-transform:uppercase; font-size:14px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .list-item{ background:#fff; border-radius:12px; padding:12px; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 3px rgba(0,0,0,.05); min-height:80px; gap:10px; }
  .swipe-wrapper{ background:#ef4444; border-radius:12px; margin-bottom:8px; overflow:hidden; position:relative; }
  .swipe-content{ background:#fff; position:relative; z-index:2; transition:transform .2s; padding:12px; display:flex; align-items:center; justify-content:space-between; min-height:80px; width:100%; gap:10px; }

  .item-img{ width:55px; height:55px; border-radius:10px; object-fit:cover; background:#f1f5f9; margin-right:12px; flex-shrink:0; display:flex; align-items:center; justify-content:center; color:#cbd5e1; font-size:20px; cursor:pointer; }
  .item-info{ flex:1; overflow:hidden; margin-right:10px; min-width:0; }
  .item-title{ font-weight:900; font-size:15px; white-space:normal; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; margin-bottom:4px; }
  .item-meta{ font-size:12px; color:#64748b; font-weight:800; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .item-meta .ean{ font-weight:900; color:#334155; }

  /* Chips */
  .chip{ font-size:11px; padding:3px 8px; border-radius:999px; font-weight:900; display:inline-flex; align-items:center; gap:6px; }
  .chip.admin{ background:#fee2e2; color:#991b1b; }
  .chip.staff{ background:#e0f2fe; color:#075985; }
  .chip.saisir{ background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; }
  .chip.warn{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
  .chip.ok{ background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
  .chip.traca{ background:#ecfeff; color:#155e75; border:1px solid #a5f3fc; }

  .small{ font-size:12px; color:#64748b; }

  /* Controls */
  .qty-ctrl{ display:flex; align-items:center; gap:10px; background:#f8fafc; width:fit-content; padding:4px 8px; border-radius:8px; border:1px solid #e2e8f0; margin-top:5px; }
  .qty-btn{ width:30px; height:30px; border-radius:6px; border:none; background:#fff; box-shadow:0 2px 3px rgba(0,0,0,.1); font-weight:900; color:var(--primary); font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; }

  .date-col{ text-align:right; width:120px; flex-shrink:0; display:flex; flex-direction:column; justify-content:center; min-width:0; }
  .d-lbl{ font-size:11px; color:#64748b; margin-bottom:2px; }
  .d-val{ font-size:14px; font-weight:900; color:var(--success); }
  .d-val.expired{ color:var(--danger); }

  /* Frais badge */
  .date-badge{ width:50px; height:50px; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; font-weight:900; flex-shrink:0; margin-left:10px; }
  .bg-red{ background:#ef4444; } .bg-orange{ background:#f59e0b; } .bg-green{ background:#10b981; } .bg-grey{ background:#94a3b8; }

  /* Modals */
  .modal-bc{ position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
  .modal-card{ background:#fff; padding:25px; border-radius:20px; width:100%; max-width:420px; max-height:85vh; overflow-y:auto; }
  .row{ display:flex; gap:10px; }

  /* Traca gallery */
  .traca-grid{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
  .traca-thumb{ width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; background:#f1f5f9; cursor:pointer; }
  .traca-card{ padding:10px; border:1px solid #e2e8f0; border-radius:14px; margin-bottom:10px; }
  .traca-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; }
  .traca-title{ font-weight:1000; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .traca-sub{ font-size:12px; color:#64748b; font-weight:800; }

  /* Save toast */
  #save-toast{
    position:fixed; top:92px; left:50%; transform:translateX(-50%);
    background:#111827; color:#fff; padding:8px 12px; border-radius:999px;
    font-size:12px; font-weight:1000; display:none; z-index:9999;
    box-shadow:0 10px 25px rgba(0,0,0,.25);
  }
</style>
</head>

<body>

  <div id="save-toast">Sauvegarde‚Ä¶</div>

  <!-- LOGIN -->
  <div id="login-overlay">
    <div class="login-card">
      <div style="text-align:center;">
        <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" style="width:200px; margin-bottom:20px;">
      </div>

      <input type="email" id="login-email" placeholder="Email" autocomplete="username" inputmode="email">
      <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
      <button class="btn success" onclick="app.auth.login()"><i class="fas fa-right-to-bracket"></i> CONNEXION</button>

      <div class="login-help" onclick="app.auth.forgot()"><i class="fas fa-unlock-keyhole"></i> Mot de passe oubli√© ?</div>
      <div id="login-error" class="login-error"></div>

      <div class="small" style="text-align:center;margin-top:14px;">
        Astuce : si tu viens de cr√©er un compte staff, utilise ‚ÄúMot de passe oubli√©‚Äù pour d√©finir son mot de passe.
      </div>
    </div>
  </div>

  <!-- BARCODE / IMAGE MODAL -->
  <div id="modal-barcode" class="modal-bc hidden">
    <div class="modal-card" style="text-align:center;">
        <h3 id="bc-name"></h3>
        <img id="bc-img-display" style="width:100%;height:240px;object-fit:contain;margin-bottom:15px;display:none;background:#f8fafc;border-radius:10px;">
        <svg id="barcode"></svg><br>
        <button class="btn secondary" style="margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
    </div>
  </div>

  <!-- EDIT FRAIS MODAL -->
  <div id="modal-edit-frais" class="modal-bc hidden">
    <div class="modal-card">
        <h3>Modifier Frais</h3>
        <input type="hidden" id="edit-id">
        <label>EAN (Code Barre)</label><input type="text" id="edit-ean" inputmode="numeric">
        <label>Nom Produit</label><input type="text" id="edit-name">
        <label>Famille</label>
        <select id="edit-famille">
          <option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option>
          <option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option>
        </select>
        <label>Qt√©</label><input type="number" id="edit-qty">
        <label>DLC</label><input type="date" id="edit-date">
        <button class="btn success" onclick="app.frais.saveEdit()">Enregistrer</button>
        <button class="btn danger" onclick="app.frais.del()">Supprimer</button>
        <button class="btn secondary" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- PVP MODALS (identiques √† ton code actuel) -->
  <div id="modal-pvp-stock" class="modal-bc hidden">
    <div class="modal-card">
      <h3 style="color:var(--pvp)">Correction Rayon (PVP)</h3>
      <input type="hidden" id="stock-id"><h4 id="stock-name" style="text-align:center;"></h4>
      <label>Quantit√©</label><input type="number" id="stock-qty">
      <label>Sortie</label><input type="datetime-local" id="stock-start">
      <label>Fin</label><input type="datetime-local" id="stock-end">
      <button class="btn" onclick="app.pvp.saveStock()" style="background:var(--pvp);">Valider</button>
      <button class="btn danger" onclick="app.pvp.delStock()">Retirer</button>
      <button class="btn secondary" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- SALADE BAR: MODAL STOCK -->
  <div id="modal-salad-stock" class="modal-bc hidden">
    <div class="modal-card">
      <h3 style="color:var(--salad)">Correction Rayon (Salade Bar)</h3>
      <input type="hidden" id="s-stock-id"><h4 id="s-stock-name" style="text-align:center;"></h4>
      <label>Quantit√©</label><input type="number" id="s-stock-qty">
      <label>Mise en rayon</label><input type="datetime-local" id="s-stock-start">
      <label>DLC / Fin</label><input type="datetime-local" id="s-stock-end">

      <button class="btn secondary" onclick="app.salad.openTracaFromStockModal()" style="margin-bottom:8px;">
        <i class="fas fa-camera"></i> Tracabilit√© (photos)
      </button>

      <button class="btn" onclick="app.salad.saveStock()" style="background:var(--salad);">Valider</button>
      <button class="btn danger" onclick="app.salad.delStock()">Retirer</button>
      <button class="btn secondary" onclick="document.getElementById('modal-salad-stock').classList.add('hidden')">Annuler</button>
    </div>
  </div>

  <!-- SALADE BAR: MODAL TRACABILITE -->
  <div id="modal-salad-traca" class="modal-bc hidden">
    <div class="modal-card">
      <input type="hidden" id="t-stock-id">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
        <div style="min-width:0;">
          <div id="t-title" style="font-weight:1000;color:var(--salad);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Tracabilit√©</div>
          <div id="t-sub" class="small"></div>
        </div>
        <button class="btn secondary" style="width:auto;padding:10px 12px;margin:0;" onclick="document.getElementById('modal-salad-traca').classList.add('hidden')">
          Fermer
        </button>
      </div>

      <div class="card" style="padding:12px;margin-top:12px;">
        <button class="btn" style="background:var(--salad);margin-top:0;" onclick="document.getElementById('t-file').click()">
          <i class="fas fa-camera"></i> Prendre une photo
        </button>
        <input type="file" id="t-file" accept="image/*" capture="environment" class="hidden" onchange="app.salad.handleTracaFile(this)">
        <div class="small" style="margin-top:8px;">
          Les photos sont conserv√©es <b>6 mois</b> puis supprim√©es automatiquement.
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin:10px 0;">
        <input id="t-search" placeholder="Rechercher dans l'historique (ex: mozza)" style="margin:0;" oninput="app.salad.renderTraca()">
        <button class="btn secondary" style="width:auto;margin:0;padding:12px 14px;" onclick="app.salad.clearTracaSearch()"><i class="fas fa-xmark"></i></button>
      </div>

      <div id="t-list"></div>
    </div>
  </div>

  <!-- HEADER -->
  <header id="app-header" class="hidden">
    <button class="logout-btn" onclick="app.auth.logout()"><i class="fas fa-right-from-bracket"></i></button>
    <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
    <div id="user-badge" class="user-badge">...</div>
  </header>

  <main>
    <div id="view-home">
      <div id="alert-box" style="display:none;background:#ef4444;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;font-weight:1000;">‚ö†Ô∏è Dates Courtes !</div>

      <div class="home-grid">
        <div class="home-btn" onclick="app.nav('frais')" style="background:linear-gradient(135deg,#003896 0%,#002366 100%);"><i class="fas fa-barcode"></i><br>DLC FRAIS</div>
        <div class="home-btn" onclick="app.nav('pvp')" style="background:linear-gradient(135deg,#d97706 0%,#b45309 100%);"><i class="fas fa-bread-slice"></i><br>GESTION PVP</div>
        <div class="home-btn" onclick="app.nav('salad')" style="background:linear-gradient(135deg,#00563f 0%,#064e3b 100%);"><i class="fas fa-bowl-food"></i><br>SALADE BAR</div>
      </div>

      <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;"><i class="fas fa-users"></i> √âquipe</div>
    </div>

    <!-- FRAIS -->
    <div id="view-frais" class="hidden">
      <div class="tabs">
        <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
        <div class="tab" id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
      </div>
      <div id="frais-scan">
        <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;"><video id="video" style="width:100%;height:100%;object-fit:cover;"></video></div>
        <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
        <div class="card">
          <input id="frais-ean" type="text" inputmode="numeric" placeholder="EAN" oninput="app.frais.handleInput(this.value)">
          <select id="frais-fam">
            <option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option>
            <option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option>
          </select>
          <input id="frais-name" placeholder="Nom">
          <div class="row"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qt√©"></div>
          <button class="btn" onclick="app.frais.add()">AJOUTER</button>
        </div>
      </div>
      <div id="frais-list" class="hidden"></div>
    </div>

    <!-- PVP (on garde ton fonctionnement actuel, pas modifi√© ici) -->
    <div id="view-pvp" class="hidden">
      <div class="card">
        <div class="small">PVP inchang√© dans cette version (tra√ßabilit√© ajout√©e au Salade Bar).</div>
      </div>
      <div class="card">
        <button class="btn secondary" onclick="alert('Colle ici ton module PVP complet si tu veux que je le r√©-injecte dans ce m√™me fichier.')">Module PVP</button>
      </div>
    </div>

    <!-- SALADE BAR -->
    <div id="view-salad" class="hidden">
      <div class="tabs">
        <div class="tab active" id="ts-1" onclick="app.salad.tab('stock')">RAYON</div>
        <div class="tab" id="ts-2" onclick="app.salad.tab('bib')">BIBLIO</div>
      </div>

      <div id="salad-stock">
        <div class="card" style="padding:12px;">
          <button class="btn secondary" style="margin-top:0;" onclick="app.salad.openTracaHistory()">
            <i class="fas fa-clock-rotate-left"></i> Historique tra√ßabilit√© (6 mois)
          </button>
          <div class="small" style="margin-top:8px;">
            Clique sur <b>üì∑</b> dans un produit Rayon pour ajouter une photo et voir l‚Äôhistorique.
          </div>
        </div>
      </div>

      <div id="salad-bib" class="hidden">
        <button class="btn secondary" onclick="app.salad.openLib()" style="margin-bottom:15px;">+ Cr√©er Produit</button>
        <div id="salad-lib-list"></div>
      </div>
    </div>

    <!-- TEAM (inchang√©, si tu veux je le r√©colle aussi) -->
    <div id="view-team" class="hidden">
      <div class="card"><div class="small">Module Team inchang√©.</div></div>
    </div>
  </main>

  <nav id="app-nav" class="hidden">
    <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i><br>RETOUR</div>
    <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large"></i><br>MENU</div>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  import { initializeAppCheck, ReCaptchaEnterpriseProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
    authDomain: "araujo-exploitation.firebaseapp.com",
    projectId: "araujo-exploitation",
    // ‚ö†Ô∏è n√©cessaire pour Firebase Storage (si diff√©rent, remplace par celui de ta console)
    storageBucket: "araujo-exploitation.appspot.com"
  };

  const appFb = initializeApp(firebaseConfig);
  const db = getFirestore(appFb);
  const auth = getAuth(appFb);
  const storage = getStorage(appFb);

  try {
    initializeAppCheck(appFb, { 
      provider: new ReCaptchaEnterpriseProvider("6LfmVXAsAAAAAKDTlkBqoKB-zSkgd5FrSk5dCylf"
),
      isTokenAutoRefreshEnabled: true
    });
  } catch(e) {}

  const docFrais = doc(db, "store_master", "DATA_FRAIS");
  const docSalad = doc(db, "store_master", "DATA_SALAD");

  const codeReader = new ZXing.BrowserMultiFormatReader();

  function uniqId() {
    return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  window.app = {
    me: { role: "admin", name:"ADMIN" }, // si tu as DATA_USERS dans ton autre code, remets ton vrai bootstrap
    data: {
      frais: [],
      saladLib: [],
      saladStock: [],
      saladTraca: [] // ‚úÖ historique tra√ßabilit√© (m√©tadonn√©es + URLs)
    },

    saveCtl: { v: { salad:0, frais:0 }, t: { salad:null, frais:null }, toastHideT:null },

    ui: {
      err: (msg) => {
        const box = document.getElementById("login-error");
        box.style.display = "block"; box.textContent = msg;
      },
      clearErr: () => {
        const box = document.getElementById("login-error");
        box.style.display = "none"; box.textContent = "";
      },
      showSaving: (txt="Sauvegarde‚Ä¶") => {
        const el = document.getElementById("save-toast");
        el.textContent = txt;
        el.style.display = "block";
        if(window.app.saveCtl.toastHideT) clearTimeout(window.app.saveCtl.toastHideT);
      },
      hideSavingSoon: () => {
        if(window.app.saveCtl.toastHideT) clearTimeout(window.app.saveCtl.toastHideT);
        window.app.saveCtl.toastHideT = setTimeout(() => {
          document.getElementById("save-toast").style.display = "none";
        }, 550);
      }
    },

    queueSave: function(sec) {
      if(!auth.currentUser) return;
      this.ui.showSaving("Sauvegarde‚Ä¶");
      this.saveCtl.v[sec]++;

      if(this.saveCtl.t[sec]) clearTimeout(this.saveCtl.t[sec]);
      this.saveCtl.t[sec] = setTimeout(async () => {
        const myV = this.saveCtl.v[sec];
        try { await this.save(sec); } catch(e) {}
        if(this.saveCtl.v[sec] !== myV) this.queueSave(sec);
        else this.ui.hideSavingSoon();
      }, 350);
    },

    common: {
      showBarcode: function(ean, name, imgUrl=null) {
        document.getElementById('modal-barcode').classList.remove('hidden');
        document.getElementById('bc-name').innerText = name || "";
        let imgEl = document.getElementById('bc-img-display');
        if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display='block'; }
        else { imgEl.style.display='none'; }

        if(ean) {
          try { JsBarcode("#barcode", ean, {format:"EAN13", height:80, displayValue:true}); }
          catch(e) { try{ JsBarcode("#barcode", ean, {format:"CODE128", height:80, displayValue:true}); } catch(e2){} }
        }
      },
      tsToInput: function(ts) {
        let d = new Date(ts);
        let local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
        return local.toISOString().slice(0, 16);
      },
      formatDate: function(ts) {
        let d = new Date(ts);
        if(isNaN(d.getTime())) return "--/--";
        let h = d.getHours(); let m = d.getMinutes();
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      },

      // ‚úÖ compression photo tra√ßabilit√© (lisible mais pas trop lourd)
      compressImgAdvanced: function(file, {max=1100, quality=0.72}={}, callback) {
        let reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          let img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');
            let w = img.width, h = img.height;

            if (w > h) { if (w > max) { h *= max/w; w = max; } }
            else { if (h > max) { w *= max/h; h = max; } }

            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', quality));
          };
        };
      }
    },

    auth: {
      login: async function() {
        window.app.ui.clearErr();
        const email = (document.getElementById("login-email").value || "").trim();
        const pass  = (document.getElementById("login-pass").value || "").trim();
        if(!email || !pass) return window.app.ui.err("Email et mot de passe requis.");
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          document.getElementById("login-pass").value = "";
        } catch(e) {
          window.app.ui.err("Connexion refus√©e. V√©rifie l‚Äôemail / mot de passe.");
        }
      },
      forgot: async function() {
        window.app.ui.clearErr();
        const email = (document.getElementById("login-email").value || "").trim();
        if(!email) return window.app.ui.err("Tape ton email puis clique ‚ÄúMot de passe oubli√©‚Äù.");
        try { await sendPasswordResetEmail(auth, email); alert("Email de r√©initialisation envoy√©."); }
        catch(e) { window.app.ui.err("Impossible d‚Äôenvoyer le reset. V√©rifie l‚Äôemail."); }
      },
      logout: async function(){ try{ await signOut(auth);}catch(e){} }
    },

    loadAll: async function() {
      const [fSnap, sSnap] = await Promise.all([getDoc(docFrais), getDoc(docSalad)]);
      this.data.frais = fSnap.exists() ? (fSnap.data().list || []) : [];

      if(sSnap.exists()) {
        let d = sSnap.data();
        this.data.saladLib = d.lib || [];
        this.data.saladStock = d.stock || [];
        this.data.saladTraca = d.traca || [];
      } else {
        this.data.saladLib = [];
        this.data.saladStock = [];
        this.data.saladTraca = [];
      }
    },

    save: async function(sec) {
      if(!auth.currentUser) throw new Error("Not logged");
      if(sec==='frais') await setDoc(docFrais, { list: this.data.frais });
      if(sec==='salad') await setDoc(docSalad, { lib: this.data.saladLib, stock: this.data.saladStock, traca: this.data.saladTraca });
    },

    nav: function(v, saveHistory = true) {
      if(this.frais?.scanning) this.frais.toggleScan();
      document.querySelectorAll('main > div').forEach(e => e.classList.add('hidden'));
      document.getElementById('view-'+v).classList.remove('hidden');
    },
    goBack: function(){ this.nav('home'); },

    bootstrapSaladLibIfEmpty: async function(){
      if(this.data.saladLib?.length) return;

      const H = (h)=>String(h);
      const D = (d)=>String(d*24);

      const items = [
        // SALADE (PHOTO SACHET)
        {family:"SALADE", name:"Batavia", days:H(48), traceHint:"PHOTO SACHET"},
        {family:"SALADE", name:"M√¢che", days:H(48), traceHint:"PHOTO SACHET"},
        {family:"SALADE", name:"M√©lange Gourmand", days:H(48), traceHint:"PHOTO SACHET"},
        {family:"SALADE", name:"Iceberg", days:H(48), traceHint:"PHOTO SACHET"},

        // BASE
        {family:"BASE", name:"Penne au basilic", days:H(48)},
        {family:"BASE", name:"Radiatori aux tomates mi-s√©ch√©es", days:H(48)},
        {family:"BASE", name:"Garganelli et graines de lin", days:H(48)},
        {family:"BASE", name:"Quinoa boulgour, tomates mi-s√©ch√©es, f√®ves de soja", days:H(48)},
        {family:"BASE", name:"Boulgour et lentilles", days:H(48)},
        {family:"BASE", name:"Farfalles au pesto", days:H(48)},
        {family:"BASE", name:"Duo de riz √† l‚Äôalgue wakam√©", days:H(48)},
        {family:"BASE", name:"Nouilles asiatiques", days:H(48)},
        {family:"BASE", name:"Trio quinoa lentilles corail", days:H(48)},
        {family:"BASE", name:"F√©ta, bl√©, l√©gumes", days:H(48)},

        // LEGUMES ET FRUITS
        {family:"LEGUMES ET FRUITS", name:"Tomates cerise marin√©es", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"L√©gumes grill√©s", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Duo de carottes", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Betterave", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"F√®ves de soja", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Pois chiches", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Avocat", days:H(24)},
        {family:"LEGUMES ET FRUITS", name:"D√©s de mangue", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Tartare de concombre", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Tartare de tomates", days:H(48)},
        {family:"LEGUMES ET FRUITS", name:"Coleslaw pommes cranberry", days:H(48)},

        // PROTEINE
        {family:"PROTEINE", name:"≈íufs durs", days:H(48)},
        {family:"PROTEINE", name:"P√¢tes saumon fum√© √† l‚Äôaneth", days:H(48)},
        {family:"PROTEINE", name:"Poulet √©minc√©", days:H(48)},
        {family:"PROTEINE", name:"Poulet pan√©", days:H(48)},
        {family:"PROTEINE", name:"Jambon cuit", days:H(48)},
        {family:"PROTEINE", name:"Thon", days:H(48)},
        {family:"PROTEINE", name:"Farfalles", days:H(48)},
        {family:"PROTEINE", name:"Poulet marin√©", days:H(48)},
        {family:"PROTEINE", name:"Ditali chorizo", days:H(48)},

        // FROMAGES
        {family:"FROMAGES", name:"Billes mozzarella", days:H(48)},
        {family:"FROMAGES", name:"Emmental", days:H(48)},
        {family:"FROMAGES", name:"Fromages italiens", days:H(48)},

        // FECULENTS (doublons potentiels, on garde)
        {family:"FECULENTS", name:"Radiatori tomate mi-s√©ch√©e", days:H(48)},
        {family:"FECULENTS", name:"P√¢tes penne au basilic", days:H(48)},
        {family:"FECULENTS", name:"Boulgour", days:H(48)},
        {family:"FECULENTS", name:"Riz sauvage", days:H(48)},

        // TOPPING
        {family:"TOPPING", name:"Noix/amandes/noix de cajou/graines de courge/raisin", days:D(7)},
        {family:"TOPPING", name:"Crumble sal√©", days:D(7)},
        {family:"TOPPING", name:"Sauce balsamique", days:D(80)},
        {family:"TOPPING", name:"Sauce Caesar", days:D(80)},
        {family:"TOPPING", name:"Sauce soja citron vert", days:D(80)},
      ];

      this.data.saladLib = items.map(x => ({ id: Date.now()+Math.floor(Math.random()*999999), img:"", ean:"", ...x }));
      await this.save("salad");
    },

    pruneTraca6Months: async function(){
      const now = Date.now();
      const cutoff = now - (183 * 24 * 60 * 60 * 1000); // ~6 mois
      const old = this.data.saladTraca.filter(r => (r.ts||0) < cutoff);

      if(old.length && this.me?.role === "admin") {
        // tentative suppression Storage (si rules autorisent)
        for(const r of old) {
          if(r.path) {
            try { await deleteObject(sRef(storage, r.path)); } catch(e) {}
          }
        }
      }
      this.data.saladTraca = this.data.saladTraca.filter(r => (r.ts||0) >= cutoff);
    },

    updateUI: function(){
      this.frais?.render?.();
      this.salad.render();
    },

    // ---- FRAIS (mini: uniquement rendu ‚Äú√Ä SAISIR J-1 18h‚Äù comme dans ta derni√®re version)
    frais: {
      scanning:false, imgUrl:"",
      tab: function(t){
        document.querySelectorAll('#view-frais .tab').forEach(e => e.classList.remove('active'));
        document.getElementById(t=='scan'?'tf-1':'tf-2').classList.add('active');
        document.getElementById('frais-scan').classList.add('hidden');
        document.getElementById('frais-list').classList.add('hidden');
        document.getElementById('frais-'+t).classList.remove('hidden');
      },
      toggleScan: function(){
        if(this.scanning){ this.scanning=false; document.getElementById('scanner-box').style.display='none'; codeReader.reset(); }
        else{
          this.scanning=true; document.getElementById('scanner-box').style.display='block';
          codeReader.decodeFromVideoDevice(null, 'video', (r) => { if(r){ this.handleInput(r.text); this.toggleScan(); } });
        }
      },
      handleInput: function(val){
        let clean = String(val||"").replace(/\D/g,'').slice(0,13);
        document.getElementById('frais-ean').value = clean;
      },
      add: async function(){
        let dateVal = document.getElementById('frais-date').value;
        if(!dateVal) return alert("Date requise");
        let parts = dateVal.split('-');
        let finalDate = new Date(parts[0], parts[1]-1, parts[2], 12, 0, 0).getTime();

        let o = {
          id: Date.now(),
          ean: document.getElementById('frais-ean').value,
          fam: document.getElementById('frais-fam').value,
          name: document.getElementById('frais-name').value,
          qty: document.getElementById('frais-qty').value,
          date: finalDate,
          img: ""
        };
        if(!o.name) return alert("Nom requis");
        window.app.data.frais.push(o);
        await window.app.save("frais");
        alert("Ajout√©");
        window.app.frais.render();
      },
      render: function(){
        const div = document.getElementById('frais-list');
        if(!div) return;
        div.innerHTML = "";
        const nowTs = Date.now();

        let grp = {};
        (window.app.data.frais||[]).slice().sort((a,b)=>(a.fam||"").localeCompare(b.fam||"") || (a.date||0)-(b.date||0))
          .forEach(i=>{ if(!grp[i.fam]) grp[i.fam]=[]; grp[i.fam].push(i); });

        Object.keys(grp).forEach(f => {
          div.innerHTML += `<div class="group-header"><span>${f}</span></div>`;
          grp[f].forEach(i => {
            const d = new Date(i.date);
            let showSaisir = false;
            if(!isNaN(d.getTime())) {
              const dlcDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
              const seuil = new Date(dlcDay); seuil.setDate(seuil.getDate()-1); seuil.setHours(18,0,0,0);
              const dlcEnd = new Date(dlcDay); dlcEnd.setHours(23,59,59,999);
              showSaisir = nowTs >= seuil.getTime() && nowTs <= dlcEnd.getTime();
            }

            div.innerHTML += `
              <div class="list-item">
                <div style="display:flex;align-items:center;flex:1;min-width:0;">
                  <div class="item-img"><i class="fas fa-barcode"></i></div>
                  <div class="item-info">
                    <div class="item-title">${i.name||""}</div>
                    <div class="item-meta">
                      <span>Qt√©: x${i.qty||0}</span>
                      <span class="ean">EAN: ${i.ean||""}</span>
                      ${showSaisir ? `<span class="chip saisir"><i class="fas fa-pen"></i> √Ä SAISIR</span>` : ``}
                    </div>
                  </div>
                </div>
                <div class="date-col">
                  <div class="d-lbl">DLC</div>
                  <div class="d-val">${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}</div>
                </div>
              </div>
            `;
          });
        });
      }
    },

    // ---- SALADE BAR
    salad: {
      currentTracaStockId: null,

      tab: function(t){
        document.querySelectorAll('#view-salad .tab').forEach(e => e.classList.remove('active-salad'));
        document.getElementById(t=='stock'?'ts-1':'ts-2').classList.add('active-salad');
        document.getElementById('salad-stock').classList.toggle('hidden', t!=='stock');
        document.getElementById('salad-bib').classList.toggle('hidden', t!=='bib');
        if(t==='stock') this.renderStock();
        else this.renderBib();
      },

      // ---- STOCK UI
      render: function(){
        // view container already holds the top card; stock content is appended under it
        this.renderStock();
        this.renderBib(); // pr√©-remplir bib si onglet bib ouvert plus tard
      },

      renderStock: function(){
        const st = document.getElementById('salad-stock');
        if(!st) return;

        // on garde la premi√®re card (historique), puis on reconstruit le reste
        const keep = st.querySelector('.card');
        st.innerHTML = "";
        if(keep) st.appendChild(keep);

        let gStock = {};
        (window.app.data.saladStock||[]).slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s => {
          const l = window.app.data.saladLib.find(x=>x.id==s.libId);
          const fam = l ? (l.family||"DIVERS") : "DIVERS";
          if(!gStock[fam]) gStock[fam]=[];
          gStock[fam].push(s);
        });

        Object.keys(gStock).sort().forEach(f => {
          st.innerHTML += `<div class="group-header" style="background:var(--salad)"><span>${f}</span></div>`;
          gStock[f].forEach(i => {
            const l = window.app.data.saladLib.find(x=>x.id==i.libId);
            const img = l?.img || "";
            const safeName = (i.name||"").replace(/'/g," ");
            const displayImg = img
              ? `<img src="${img}" class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean||""}','${safeName}','${img}')">`
              : `<div class="item-img" onclick="event.stopPropagation(); app.common.showBarcode('${i.ean||""}','${safeName}')"><i class="fas fa-bowl-food"></i></div>`;

            const dS = app.common.formatDate(i.out);
            const dE = app.common.formatDate(i.end);
            const isExp = new Date(i.end) < new Date();

            // ‚úÖ compteur tra√ßabilit√© (m√™me stockId)
            const count = (window.app.data.saladTraca||[]).filter(t => String(t.stockId)===String(i.id)).length;
            const tracaChip = count>0 ? `<span class="chip traca"><i class="fas fa-camera"></i> ${count}</span>` : `<span class="chip traca"><i class="fas fa-camera"></i> 0</span>`;

            st.innerHTML += `
              <div class="swipe-wrapper">
                <div class="swipe-content" onclick="app.salad.openEditStock(${i.id})">
                  <div style="display:flex;align-items:center;flex:1;min-width:0;">
                    ${displayImg}
                    <div style="min-width:0;">
                      <div class="item-title">${i.name||""}</div>
                      <div class="item-meta">
                        <span>Qt√©: <b>x${i.qty||0}</b></span>
                        ${i.ean?`<span class="ean">EAN: ${i.ean}</span>`:''}
                        ${tracaChip}
                      </div>
                      ${l?.traceHint ? `<div class="small" style="margin-top:4px;"><i class="fas fa-circle-info"></i> ${l.traceHint}</div>`:''}
                    </div>
                  </div>

                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                    <button class="qty-btn" title="Tracabilit√©" style="width:38px;height:38px;color:var(--salad);" onclick="event.stopPropagation(); app.salad.openTraca(${i.id})">
                      <i class="fas fa-camera"></i>
                    </button>
                    <div class="date-col" style="width:150px;">
                      <div class="d-lbl">Rayon: ${dS}</div>
                      <div class="d-val ${isExp?'expired':''}">DLC: ${dE}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        });
      },

      // ---- BIB UI (simple liste)
      renderBib: function(){
        const bib = document.getElementById('salad-lib-list');
        if(!bib) return;
        bib.innerHTML = "";

        let gLib = {};
        (window.app.data.saladLib||[]).slice()
          .sort((a,b)=>(a.family||"").localeCompare(b.family||"") || (a.name||"").localeCompare(b.name||""))
          .forEach(l => { const f=l.family||"DIVERS"; if(!gLib[f]) gLib[f]=[]; gLib[f].push(l); });

        Object.keys(gLib).sort().forEach(f => {
          bib.innerHTML += `<div class="group-header" style="background:var(--salad)"><span>${f}</span></div>`;
          gLib[f].forEach(l => {
            const img = l.img ? `<img src="${l.img}" class="item-img">` : `<div class="item-img"><i class="fas fa-bowl-food"></i></div>`;
            bib.innerHTML += `
              <div class="list-item">
                <div style="display:flex;align-items:center;flex:1;min-width:0;">
                  ${img}
                  <div class="item-info">
                    <div class="item-title">${l.name}</div>
                    <div class="item-meta">
                      <span>Conservation: <b>${l.days}h</b></span>
                      ${l.traceHint?`<span class="chip traca"><i class="fas fa-circle-info"></i> ${l.traceHint}</span>`:''}
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        });
      },

      // ---- STOCK MODAL
      openEditStock: function(id){
        const i = window.app.data.saladStock.find(x=>x.id==id);
        if(!i) return;
        document.getElementById('modal-salad-stock').classList.remove('hidden');
        document.getElementById('s-stock-id').value = id;
        document.getElementById('s-stock-name').innerText = i.name||"";
        document.getElementById('s-stock-qty').value = i.qty||0;
        document.getElementById('s-stock-start').value = window.app.common.tsToInput(i.out);
        document.getElementById('s-stock-end').value = window.app.common.tsToInput(i.end);
      },

      openTracaFromStockModal: function(){
        const id = document.getElementById('s-stock-id').value;
        if(!id) return;
        document.getElementById('modal-salad-stock').classList.add('hidden');
        app.salad.openTraca(Number(id));
      },

      saveStock: function(){
        const id = Number(document.getElementById('s-stock-id').value);
        const idx = window.app.data.saladStock.findIndex(x=>x.id==id);
        if(idx<0) return;
        window.app.data.saladStock[idx].qty = Number(document.getElementById('s-stock-qty').value || 0);
        window.app.data.saladStock[idx].out = new Date(document.getElementById('s-stock-start').value).getTime();
        window.app.data.saladStock[idx].end = new Date(document.getElementById('s-stock-end').value).getTime();
        document.getElementById('modal-salad-stock').classList.add('hidden');
        window.app.queueSave("salad");
        this.renderStock();
      },

      delStock: function(){
        const id = Number(document.getElementById('s-stock-id').value);
        window.app.data.saladStock = window.app.data.saladStock.filter(x=>x.id!==id);
        document.getElementById('modal-salad-stock').classList.add('hidden');
        window.app.queueSave("salad");
        this.renderStock();
      },

      // ---- TRACABILITE
      openTraca: function(stockId){
        this.currentTracaStockId = Number(stockId);
        document.getElementById('t-stock-id').value = String(stockId);

        const s = window.app.data.saladStock.find(x=>x.id==stockId);
        if(!s) return;

        document.getElementById('t-title').textContent = `Tra√ßabilit√© ‚Äî ${s.name||""}`;
        document.getElementById('t-sub').textContent = `DLC: ${window.app.common.formatDate(s.end)} ‚Ä¢ Qt√©: x${s.qty||0}`;

        document.getElementById('t-search').value = "";
        document.getElementById('modal-salad-traca').classList.remove('hidden');
        this.renderTraca();
      },

      openTracaHistory: function(){
        // ouvre le modal sans stockId => historique global 6 mois
        this.currentTracaStockId = null;
        document.getElementById('t-stock-id').value = "";
        document.getElementById('t-title').textContent = "Historique tra√ßabilit√© (6 mois)";
        document.getElementById('t-sub').textContent = "Toutes les photos Salade Bar";
        document.getElementById('t-search').value = "";
        document.getElementById('modal-salad-traca').classList.remove('hidden');
        this.renderTraca();
      },

      clearTracaSearch: function(){
        document.getElementById('t-search').value = "";
        this.renderTraca();
      },

      renderTraca: function(){
        const wrap = document.getElementById('t-list');
        if(!wrap) return;

        const q = (document.getElementById('t-search').value||"").trim().toLowerCase();
        const stockId = this.currentTracaStockId;

        let rows = (window.app.data.saladTraca||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));

        if(stockId) rows = rows.filter(r => String(r.stockId)===String(stockId));
        if(q) rows = rows.filter(r => (r.name||"").toLowerCase().includes(q) || (r.family||"").toLowerCase().includes(q));

        // group by (name + dlcEnd day)
        const keyOf = (r)=>{
          const d = new Date(r.dlcEnd||0);
          const day = isNaN(d.getTime()) ? "??/??" : `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
          return `${r.name||"?"}__${day}`;
        };

        const groups = {};
        for(const r of rows){
          const k = keyOf(r);
          if(!groups[k]) groups[k]=[];
          groups[k].push(r);
        }

        const keys = Object.keys(groups);
        if(!keys.length){
          wrap.innerHTML = `<div class="small" style="text-align:center;padding:18px;">Aucune photo.</div>`;
          return;
        }

        wrap.innerHTML = keys.map(k=>{
          const arr = groups[k];
          const r0 = arr[0];
          const d = new Date(r0.dlcEnd||0);
          const dlc = isNaN(d.getTime()) ? "DLC: ?" : `DLC: ${window.app.common.formatDate(r0.dlcEnd)}`;
          const head = `${r0.name||"?"} ‚Ä¢ ${dlc}`;
          const sub = `${r0.family||"DIVERS"} ‚Ä¢ ${arr.length} photo(s)`;

          const thumbs = arr.map(r => `
            <img class="traca-thumb" src="${r.url}" alt="traca"
              onclick="app.common.showBarcode('', '${(r0.name||'').replace(/'/g,' ')}', '${r.url}')">
          `).join("");

          return `
            <div class="traca-card">
              <div class="traca-head">
                <div style="min-width:0;">
                  <div class="traca-title">${head}</div>
                  <div class="traca-sub">${sub}</div>
                </div>
                <span class="chip traca"><i class="fas fa-camera"></i> ${arr.length}</span>
              </div>
              <div class="traca-grid">${thumbs}</div>
              <div class="small" style="margin-top:8px;">
                Derni√®re: ${window.app.common.formatDate(arr[0].ts)}
              </div>
            </div>
          `;
        }).join("");
      },

      handleTracaFile: function(input){
        const file = input.files && input.files[0];
        if(!file) return;
        input.value = "";

        const stockId = this.currentTracaStockId;
        const s = stockId ? window.app.data.saladStock.find(x=>x.id==stockId) : null;
        if(!s) return alert("Produit introuvable (stock).");

        const lib = window.app.data.saladLib.find(x=>x.id==s.libId);

        window.app.ui.showSaving("Upload photo‚Ä¶");
        window.app.common.compressImgAdvanced(file, {max:1100, quality:0.72}, async (dataUrl) => {
          try {
            const ts = Date.now();
            const ym = new Date(ts);
            const folder = `${ym.getFullYear()}-${String(ym.getMonth()+1).padStart(2,'0')}`;

            const id = uniqId();
            const path = `traca/salad/${folder}/${s.id}_${id}.jpg`;
            const ref = sRef(storage, path);

            await uploadString(ref, dataUrl, 'data_url');
            const url = await getDownloadURL(ref);

            window.app.data.saladTraca.push({
              id,
              ts,
              stockId: s.id,
              libId: s.libId,
              name: s.name || (lib?.name||""),
              family: lib?.family || "DIVERS",
              dlcEnd: s.end || 0,
              url,
              path
            });

            await window.app.pruneTraca6Months();
            window.app.queueSave("salad");
            window.app.ui.hideSavingSoon();
            this.renderTraca();
            this.renderStock();
          } catch(e) {
            window.app.ui.hideSavingSoon();
            alert("Upload impossible. V√©rifie Firebase Storage activ√© + r√®gles.");
          }
        });
      }
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if(!user) {
      document.getElementById('login-overlay').classList.remove('hidden');
      document.getElementById('app-header').classList.add('hidden');
      document.getElementById('app-nav').classList.add('hidden');
      return;
    }

    document.getElementById('login-overlay').classList.add('hidden');
    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('app-nav').classList.remove('hidden');
    document.getElementById('user-badge').innerText = (user.email||"USER");

    await window.app.loadAll();
    await window.app.bootstrapSaladLibIfEmpty();
    await window.app.pruneTraca6Months();

    window.app.updateUI();
  });
</script>

</body>
</html>
