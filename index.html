<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#003896"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Express Purpan"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="application-name" content="Express Purpan"/>
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png"/>
<link rel="manifest" id="pwa-manifest"/>
<title>Express Purpan V9.0</title>
<script>
// Inject PWA manifest dynamically
const manifest={name:"Express Purpan",short_name:"Purpan",display:"fullscreen",background_color:"#003896",theme_color:"#003896",start_url:window.location.href,icons:[{src:"https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png",sizes:"192x192",type:"image/png"}]};
const blob=new Blob([JSON.stringify(manifest)],{type:"application/json"});
document.getElementById('pwa-manifest').href=URL.createObjectURL(blob);
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
:root{
  --primary:#003896;--accent:#E2001A;--pvp:#d97706;--salad:#0f766e;--frigo:#0ea5e9;--todo:#7c3aed;
  --reception:#059669;--inspection:#7c3aed;
  --bg:#f3f4f6;--surface:#ffffff;--text:#1e293b;--success:#10b981;--danger:#ef4444;--muted:#64748b;
  --ce-blue:#003896;--ce-red:#E2001A;--carrefour:#003896;--carrefour-red:#E2001A;
}

/* ── CARREFOUR EXPRESS BANNER ── */
#home-banner{
  background:linear-gradient(135deg,#003896 0%,#1a50c8 50%,#003896 100%);
  border-radius:18px;
  padding:0;
  margin-bottom:16px;
  overflow:hidden;
  box-shadow:0 8px 30px rgba(0,56,150,.25);
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  min-height:72px;
}
#home-banner::before{
  content:'';position:absolute;top:0;left:0;right:0;bottom:0;
  background:repeating-linear-gradient(45deg,rgba(255,255,255,.03) 0,rgba(255,255,255,.03) 1px,transparent 1px,transparent 12px);
}
#home-banner .banner-logo-wrap{display:flex;align-items:center;gap:12px;padding:12px 16px;position:relative;z-index:2;}
#home-banner .banner-logo{height:46px;object-fit:contain;filter:brightness(10);}
#home-banner .banner-text{color:#fff;position:relative;z-index:2;}
#home-banner .banner-title{font-weight:950;font-size:15px;letter-spacing:.5px;}
#home-banner .banner-sub{font-size:11px;opacity:.75;margin-top:2px;}
#home-banner .banner-red-stripe{width:8px;background:var(--ce-red);align-self:stretch;flex-shrink:0;}

/* ── MODULE CARREFOUR & GESTION MAGASIN ── */
.module-parent-card{
  background:var(--surface);
  border-radius:18px;
  padding:0;
  box-shadow:0 4px 15px rgba(0,0,0,.06);
  margin-bottom:15px;
  overflow:hidden;
  border:2px solid #e2e8f0;
}
.module-parent-header{
  background:linear-gradient(135deg,#003896,#1a50c8);
  padding:14px 18px;
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer;
}
.module-parent-header.red-header{
  background:linear-gradient(135deg,#b91c1c,#ef4444);
}
.module-parent-header.green-header{
  background:linear-gradient(135deg,#065f46,#059669);
}
.module-parent-header i{color:#fff;font-size:22px;}
.module-parent-header-text{color:#fff;}
.module-parent-header-text .mph-title{font-weight:950;font-size:16px;}
.module-parent-header-text .mph-sub{font-size:12px;opacity:.75;margin-top:2px;}
.module-parent-body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.module-sub-btn{
  background:linear-gradient(135deg,#f8fafc,#fff);
  border:2px solid #e2e8f0;
  border-radius:14px;
  padding:14px 10px;
  text-align:center;
  cursor:pointer;
  transition:all .15s;
  position:relative;
}
.module-sub-btn:active{transform:scale(.97);}
.module-sub-btn i{font-size:22px;margin-bottom:6px;display:block;}
.module-sub-btn .msb-title{font-weight:950;font-size:13px;color:#1e293b;}
.module-sub-btn .msb-sub{font-size:11px;color:#64748b;margin-top:3px;}
.module-sub-btn.wide{grid-column:1/-1;}
.module-sub-btn.blue-accent{border-color:#bfdbfe;}
.module-sub-btn.blue-accent i{color:#003896;}
.module-sub-btn.red-accent{border-color:#fecaca;}
.module-sub-btn.red-accent i{color:#E2001A;}
.module-sub-btn.green-accent{border-color:#bbf7d0;}
.module-sub-btn.green-accent i{color:#059669;}
.module-sub-btn.purple-accent{border-color:#e9d5ff;}
.module-sub-btn.purple-accent i{color:#7c3aed;}
.module-sub-btn.orange-accent{border-color:#fed7aa;}
.module-sub-btn.orange-accent i{color:#ea580c;}

/* ── PLANNING MODULE ── */
#view-planning{animation:fadeIn .2s ease;}
#plan-employees{overflow-x:auto;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.planning-week-nav{display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:14px;padding:12px 16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.planning-week-nav button{background:#f1f5f9;border:none;border-radius:10px;padding:8px 14px;font-weight:900;cursor:pointer;font-size:16px;}
.planning-week-nav .wk-label{font-weight:950;font-size:15px;color:#1e293b;}
.planning-staff-row{background:#fff;border-radius:14px;margin-bottom:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04);}
.planning-staff-header{background:#f8fafc;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e2e8f0;}
.planning-staff-name{font-weight:950;font-size:14px;color:#1e293b;}
.planning-staff-hours{font-size:12px;font-weight:800;color:var(--primary);}
.planning-days-row{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;padding:8px;}
.planning-day-cell{border-radius:8px;padding:4px;text-align:center;cursor:pointer;min-height:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .15s;border:1.5px solid transparent;}
.planning-day-cell.off{background:#f8fafc;color:#94a3b8;}
.planning-day-cell.work{background:#dbeafe;border-color:#93c5fd;color:#1d4ed8;}
.planning-day-cell.rest{background:#fce7f3;border-color:#f9a8d4;color:#be185d;}
.planning-day-cell.work .dc-hours{font-size:10px;font-weight:800;}
.planning-day-cell .dc-day{font-size:10px;font-weight:900;margin-bottom:2px;}
.planning-day-cell .dc-content{font-size:11px;font-weight:950;}
.planning-rules-banner{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid #fcd34d;border-radius:12px;padding:12px;margin-bottom:14px;}
.planning-rules-banner h4{margin:0 0 6px 0;color:#92400e;font-size:13px;display:flex;align-items:center;gap:6px;}
.rule-chip{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.7);border-radius:20px;padding:4px 10px;font-size:11px;font-weight:800;color:#78350f;margin:3px;}
.planning-new-staff{background:#fff;border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:14px;}
.shift-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000;display:flex;align-items:flex-end;justify-content:center;padding:16px;}
.shift-modal-card{background:#fff;border-radius:20px;padding:22px;width:100%;max-width:420px;animation:slideUp .22s cubic-bezier(.34,1.56,.64,1);}
.time-input-row{display:flex;gap:10px;align-items:center;margin-bottom:12px;}
.time-input-row label{font-size:12px;font-weight:800;color:#64748b;white-space:nowrap;}
.time-input-row input{flex:1;padding:12px;border:1.5px solid #cbd5e1;border-radius:10px;font-size:16px;background:#fff;outline:none;}

/* ── CARREFOUR MODULE VIEW ── */
#view-carrefour{animation:fadeIn .2s ease;}
.carrefour-sub-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.carrefour-sub-card{
  background:#fff;border-radius:18px;padding:18px 12px;
  text-align:center;border:2px solid #e2e8f0;
  cursor:pointer;transition:all .15s;
  box-shadow:0 3px 10px rgba(0,0,0,.05);
}
.carrefour-sub-card:active{transform:scale(.97);}
.carrefour-sub-card i{font-size:28px;margin-bottom:8px;display:block;}
.carrefour-sub-card .csc-title{font-weight:950;font-size:14px;color:#1e293b;}
.carrefour-sub-card .csc-sub{font-size:11px;color:#64748b;margin-top:4px;}
.carrefour-sub-card.wide{grid-column:1/-1;}

/* ── METI MODULE ── */
#view-meti{animation:fadeIn .2s ease;}
#meti-iframe-wrap{position:fixed;inset:0;z-index:8000;background:#fff;display:flex;flex-direction:column;}
#meti-bar{background:var(--primary);padding:12px 16px;display:flex;align-items:center;gap:12px;padding-top:calc(12px + env(safe-area-inset-top));}

/* ── GESTION MAGASIN ── */
#view-gestion-magasin{animation:fadeIn .2s ease;}
.gm-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.gm-card{background:#fff;border-radius:18px;padding:18px 10px;text-align:center;cursor:pointer;color:#fff;font-weight:950;box-shadow:0 8px 20px rgba(0,0,0,.08);transition:transform .15s;}
.gm-card:active{transform:scale(.97);}
.gm-card i{font-size:24px;margin-bottom:8px;display:block;}
.gm-card .gmc-sub{font-size:11px;opacity:.8;margin-top:4px;font-weight:700;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:system-ui,sans-serif;user-select:none;}
body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
/* iOS safe area */
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
.hidden{display:none!important;}

/* ── TOAST ── */
#toast-container{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none;width:min(380px,92vw);}
.toast{background:#1e293b;color:#fff;padding:13px 16px;border-radius:14px;font-size:14px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1) forwards;pointer-events:auto;}
.toast.ok{background:#064e3b;border-left:4px solid #10b981;}
.toast.err{background:#7f1d1d;border-left:4px solid #ef4444;}
.toast.warn{background:#78350f;border-left:4px solid #f59e0b;}
.toast.info{background:#1e3a5f;border-left:4px solid #3b82f6;}
.toast-out{animation:toastOut .2s ease forwards;}
@keyframes toastIn{from{opacity:0;transform:translateY(-12px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes toastOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.94)}}

/* ── SPINNER ── */
#spinner-overlay{position:fixed;inset:0;z-index:90000;background:rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.spinner{width:48px;height:48px;border:5px solid #e2e8f0;border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── CONFIRM / PROMPT ── */
#modal-confirm,#modal-prompt{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:80000;display:flex;align-items:flex-end;justify-content:center;padding:16px;}
.dlg-card{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:420px;animation:slideUp .22s cubic-bezier(.34,1.56,.64,1);}
.dlg-title{font-size:17px;font-weight:950;margin:0 0 8px 0;}
.dlg-msg{color:var(--muted);font-size:14px;margin:0 0 20px 0;line-height:1.5;}
.dlg-btns{display:flex;gap:10px;}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}

/* ── OFFLINE ── */
#offline-banner{position:fixed;top:0;left:0;right:0;z-index:70000;background:#7f1d1d;color:#fff;text-align:center;padding:8px;font-size:13px;font-weight:800;transform:translateY(-100%);transition:transform .3s;}
#offline-banner.show{transform:translateY(0);}

/* ── LOGIN ── */
#login-overlay{position:fixed;inset:0;z-index:10000;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;}
.login-card{width:min(380px,92vw);}
.login-help{font-size:12px;color:var(--muted);text-align:center;margin-top:10px;cursor:pointer;}
.login-error{display:none;background:#fee2e2;color:#991b1b;padding:10px 12px;border-radius:10px;font-weight:800;font-size:13px;margin-top:10px;}

/* ── HEADER & NAV ── */
header{background:var(--surface);padding:10px;height:80px;display:flex;justify-content:center;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,.05);position:relative;z-index:50;}
.logo-header{height:50px;object-fit:contain;}
.user-badge{position:absolute;right:15px;top:15px;font-size:11px;background:#e0f2fe;color:var(--primary);padding:4px 10px;border-radius:20px;font-weight:900;max-width:48vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logout-btn{position:absolute;left:15px;top:18px;border:none;background:#f1f5f9;color:#334155;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;}
main{flex:1;overflow-y:auto;padding:15px;padding-bottom:92px;}
nav{position:fixed;bottom:0;width:100%;background:#fff;height:70px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.05);z-index:100;padding:0 30px;}
.nav-btn{text-align:center;color:#94a3b8;cursor:pointer;font-size:12px;}
.nav-btn i{font-size:24px;margin-bottom:4px;}

/* ── UI COMPONENTS ── */
.card{background:var(--surface);border-radius:16px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.03);margin-bottom:15px;}
input,select,textarea{width:100%;padding:14px;border:1.5px solid #cbd5e1;border-radius:10px;font-size:16px;background:#fff;margin-bottom:10px;outline:none;transition:border-color .15s;}
input:focus,select:focus,textarea:focus{border-color:var(--primary);}
input.invalid{border-color:var(--danger)!important;background:#fff5f5;}
textarea{min-height:80px;resize:none;}
.field-err{font-size:12px;color:var(--danger);font-weight:700;margin-top:-8px;margin-bottom:8px;display:none;}
.field-err.show{display:block;}
.btn{width:100%;padding:16px;border-radius:12px;border:none;font-weight:900;font-size:16px;background:var(--primary);color:#fff;cursor:pointer;margin-top:5px;transition:opacity .15s,transform .1s;}
.btn:active{transform:scale(.97);opacity:.9;}
.btn.secondary{background:#eee;color:#333;}
.btn.danger{background:var(--danger);}
.btn.success{background:#00563f;}
.btn.pvp{background:var(--pvp);}
.btn.salad{background:var(--salad);}
.btn.frigo{background:var(--frigo);}
.btn.todo{background:var(--todo);}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.tabs{display:flex;background:#e2e8f0;padding:4px;border-radius:12px;margin-bottom:15px;gap:4px;}
.tab{flex:1;text-align:center;padding:10px 4px;font-weight:900;font-size:11px;color:#64748b;border-radius:9px;cursor:pointer;transition:all .15s;}
.tab.active     {background:#fff;color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-pvp {background:#fff;color:var(--pvp);   box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-salad{background:#fff;color:var(--salad); box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-frigo{background:#fff;color:var(--frigo); box-shadow:0 2px 4px rgba(0,0,0,.1);}
.tab.active-todo{background:#fff;color:var(--todo);  box-shadow:0 2px 4px rgba(0,0,0,.1);}

/* ── HOME ── */
.home-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
.home-btn{border-radius:18px;padding:18px 10px;color:#fff;text-align:center;font-weight:950;box-shadow:0 10px 25px rgba(0,0,0,.08);cursor:pointer;line-height:1.2;position:relative;transition:transform .15s;}
.home-btn:active{transform:scale(.97);}
.home-btn i{font-size:26px;margin-bottom:8px;}
.home-btn.wide{grid-column:1/-1;}
.home-badge{position:absolute;top:10px;right:10px;min-width:28px;height:28px;padding:0 8px;border-radius:999px;background:rgba(255,255,255,.92);color:#111827;display:flex;align-items:center;justify-content:center;font-weight:950;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,.2);}
.home-badge.red{background:rgba(255,255,255,.95);color:#991b1b;}
.home-badge.blue{background:rgba(255,255,255,.95);color:#075985;}
.home-badge.purple{background:rgba(255,255,255,.95);color:#5b21b6;}

/* ── LISTS ── */
.group-header{background:#334155;color:#fff;padding:12px 15px;border-radius:10px;margin-top:15px;font-weight:950;text-transform:uppercase;font-size:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.list-item{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,.05);min-height:72px;gap:10px;animation:itemIn .2s ease;}
@keyframes itemIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.swipe-wrapper{background:var(--danger);border-radius:12px;margin-bottom:8px;overflow:hidden;position:relative;}
.swipe-content{background:#fff;position:relative;z-index:2;transition:transform 0.12s;padding:12px;display:flex;align-items:center;justify-content:space-between;min-height:72px;width:100%;gap:10px;}
.item-img{width:52px;height:52px;border-radius:10px;object-fit:cover;background:#f1f5f9;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:20px;cursor:pointer;}
.item-info{flex:1;min-width:0;overflow:hidden;}
.item-title{font-weight:950;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;}
.item-sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.right-col{flex-shrink:0;display:flex;align-items:center;gap:8px;}
.qty-ctrl{display:flex;align-items:center;gap:8px;background:#f8fafc;width:fit-content;padding:4px 8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:5px;}
.qty-btn{width:30px;height:30px;border-radius:8px;border:none;background:#fff;box-shadow:0 2px 3px rgba(0,0,0,.1);font-weight:950;color:var(--primary);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s;}
.qty-btn:active{transform:scale(.9);}
.icon-btn{width:40px;height:40px;border-radius:12px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;transition:transform .1s,opacity .1s;}
.icon-btn:active{transform:scale(.9);opacity:.85;}
.icon-btn.pvp{background:var(--pvp);}
.icon-btn.salad{background:var(--salad);}
.icon-btn.frigo{background:var(--frigo);}
.icon-btn.todo{background:var(--todo);}
.icon-btn.gray{background:#94a3b8;}
.icon-btn.red{background:var(--danger);}
.icon-btn.dark{background:#0f172a;}
.icon-btn.green{background:var(--success);}
.date-col{text-align:right;width:135px;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;}
.d-lbl{font-size:11px;color:#64748b;margin-bottom:2px;}
.d-val{font-size:13px;font-weight:950;color:var(--success);white-space:nowrap;}
.d-val.expired{color:var(--danger);}
.date-badge{width:52px;height:52px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-weight:950;flex-shrink:0;}
.bg-red{background:#ef4444;}.bg-orange{background:#f59e0b;}.bg-green{background:#10b981;}.bg-grey{background:#94a3b8;}
.chip{font-size:11px;padding:3px 8px;border-radius:999px;font-weight:950;display:inline-flex;align-items:center;gap:4px;}
.chip.warn{background:#ffedd5;color:#9a3412;}
.chip.admin{background:#fee2e2;color:#991b1b;}
.chip.staff{background:#e0f2fe;color:#075985;}
.chip.frigo{background:#e0f2fe;color:#075985;}
.chip.ok{background:#d1fae5;color:#065f46;}
.chip.late{background:#fee2e2;color:#991b1b;}
.chip.todo{background:#ede9fe;color:#5b21b6;}
.small{font-size:12px;color:var(--muted);}
.todo-check{width:36px;height:36px;border:2.5px solid #cbd5e1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;cursor:pointer;transition:all .2s;}
.todo-check.checked{background:var(--success);border-color:var(--success);color:#fff;}
.item-done{opacity:.65;background:#f8fafc;}
.item-done .item-title{text-decoration:line-through;color:#94a3b8;}

/* ── TODO SPECIFIC ── */
.zone-header{border-radius:14px;padding:14px 16px;color:#fff;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.zone-progress{height:6px;border-radius:3px;background:rgba(255,255,255,.3);margin-top:8px;overflow:hidden;}
.zone-progress-fill{height:100%;border-radius:3px;background:#fff;transition:width .4s ease;}
.task-card{background:#fff;border-radius:14px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:4px solid transparent;}
.task-card.done{opacity:.6;border-left-color:var(--success);}
.task-card.overdue{border-left-color:var(--danger);background:#fff5f5;}
.time-chip{font-size:12px;font-weight:900;padding:4px 10px;border-radius:8px;background:#f1f5f9;color:#334155;white-space:nowrap;flex-shrink:0;}
.time-chip.overdue{background:#fee2e2;color:#991b1b;}
.time-chip.done{background:#d1fae5;color:#065f46;}
.day-pill{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:800;cursor:pointer;}
.day-pill.on{background:var(--todo);color:#fff;}
.day-pill.off{background:#f1f5f9;color:#94a3b8;}
.progress-bar-wrap{background:#e2e8f0;border-radius:999px;height:8px;margin:10px 0 4px 0;overflow:hidden;}
.progress-bar-fill{height:100%;border-radius:999px;background:var(--todo);transition:width .4s ease;}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-state i{font-size:40px;margin-bottom:12px;opacity:.35;display:block;}

/* ── SEARCH ── */
.search-wrap{position:relative;margin-bottom:12px;}
.search-wrap i{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:15px;pointer-events:none;}
.search-input{padding:13px 13px 13px 40px!important;border-radius:12px!important;background:#f8fafc!important;border:1.5px solid #e2e8f0!important;font-size:15px!important;margin-bottom:0!important;}
.search-input:focus{border-color:var(--primary)!important;background:#fff!important;}
.search-no-result{text-align:center;padding:30px;color:var(--muted);font-size:14px;}

/* ── MODALS ── */
.modal-bc{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:5000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
#modal-barcode{z-index:6500;}
.modal-card{background:#fff;padding:25px;border-radius:20px;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;animation:mIn .22s cubic-bezier(.34,1.56,.64,1);}
@keyframes mIn{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
.row{display:flex;gap:10px;}
.divider{border:none;border-top:1px solid #e2e8f0;margin:16px 0;}
.color-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
.color-swatch{height:40px;border-radius:10px;cursor:pointer;border:3px solid transparent;transition:transform .1s;}
.color-swatch.selected{border-color:#1e293b;transform:scale(.95);}
.days-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}

/* ── PERMISSIONS ── */
.perm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.perm-toggle{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border-radius:10px;padding:10px 12px;gap:8px;}
.perm-toggle label{font-size:13px;font-weight:800;color:#334155;cursor:pointer;flex:1;}
.perm-toggle input[type=checkbox]{width:18px;height:18px;cursor:pointer;accent-color:var(--primary);flex-shrink:0;}
.perm-section-title{font-size:11px;font-weight:950;text-transform:uppercase;color:var(--muted);margin:12px 0 6px 0;grid-column:1/-1;}

/* ── FREQUENCY SELECTOR ── */
.freq-type-tabs{display:flex;gap:6px;margin-bottom:12px;}
.freq-tab{flex:1;padding:10px 6px;text-align:center;border-radius:10px;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;transition:all .15s;}
.freq-tab.active{border-color:var(--todo);background:var(--todo);color:#fff;}
.freq-panel{display:none;}
.freq-panel.active{display:block;}
.month-days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:10px;}
.month-day-btn{height:36px;border-radius:8px;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;background:#fff;transition:all .15s;}
.month-day-btn.on{background:var(--todo);border-color:var(--todo);color:#fff;}

/* ── RÉCEPTION MODULE ── */
.reception-card{background:var(--surface);border-radius:16px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.04);margin-bottom:12px;border-left:5px solid var(--reception);}
.supplier-chip{font-size:12px;padding:4px 10px;border-radius:20px;background:#d1fae5;color:#065f46;font-weight:900;}
.temp-display{font-size:28px;font-weight:950;color:var(--reception);}
.temp-ok{color:var(--success);}
.temp-warn{color:#f59e0b;}
.temp-err{color:var(--danger);}

/* ── INSPECTION MODULE ── */
.gear-btn{width:44px;height:44px;border-radius:50%;border:none;background:#f1f5f9;color:#334155;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:transform .3s;}
.gear-btn:hover{transform:rotate(90deg);}
.inspection-section{background:var(--surface);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.03);}
.inspection-section h4{margin:0 0 12px 0;color:var(--primary);font-size:15px;display:flex;align-items:center;gap:8px;}
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:8px;}
.kpi-card{border-radius:12px;padding:14px;text-align:center;}
.kpi-card .kpi-val{font-size:28px;font-weight:950;}
.kpi-card .kpi-lbl{font-size:11px;font-weight:800;opacity:.8;margin-top:2px;}
/* ── SUPPLIER SELECT ── */
.supplier-select-btn{padding:14px;border-radius:14px;background:linear-gradient(135deg,var(--reception),#047857);color:#fff;cursor:pointer;text-align:center;border:3px solid transparent;transition:all .15s;}
.supplier-select-btn:active{transform:scale(.97);}
.supplier-select-btn.selected{border-color:#fff;box-shadow:0 0 0 3px var(--reception);}

/* ── ÉTIQUETTES ── */
.etiq-product-row{background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;border:2px solid #e9d5ff;display:flex;align-items:center;gap:12px;}
.etiq-product-row.selected{border-color:#9333ea;background:#faf5ff;}
.etiq-check{width:28px;height:28px;border-radius:8px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;}
.etiq-check.on{background:#9333ea;border-color:#9333ea;color:#fff;}
.etiq-qty-ctrl{display:flex;align-items:center;gap:8px;}
.etiq-qty-ctrl button{width:32px;height:32px;border-radius:8px;border:none;background:#f1f5f9;font-weight:900;font-size:16px;cursor:pointer;}
.etiq-label-preview{background:linear-gradient(135deg,#9333ea,#6b21a8);color:#fff;border-radius:16px;padding:20px;text-align:center;margin:12px 0;}
.etiq-label-preview .etiq-name{font-weight:950;font-size:18px;line-height:1.2;}
.etiq-label-preview .etiq-prix-original{font-size:14px;text-decoration:line-through;opacity:.7;margin-top:6px;}
.etiq-label-preview .etiq-prix-reduit{font-size:32px;font-weight:950;margin-top:4px;}
.etiq-label-preview .etiq-pct{font-size:14px;background:rgba(255,255,255,.25);border-radius:8px;padding:4px 10px;margin-top:6px;display:inline-block;}

/* ── SUPPLIER TYPE BUTTONS ── */
.sup-type-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.sup-type-btn{padding:12px 6px;border-radius:12px;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;text-align:center;background:#fff;transition:all .15s;line-height:1.3;}
.sup-type-btn:active{transform:scale(.96);}
.sup-type-btn.frais.on{background:#d1fae5;border-color:#059669;color:#065f46;}
.sup-type-btn.surgele.on{background:#dbeafe;border-color:#1e3a8a;color:#1e3a8a;}
.sup-type-btn.sec.on{background:#fef3c7;border-color:#92400e;color:#92400e;}

/* ── PLANNING LIVRAISON ── */
.planning-card{background:#fff;border-radius:14px;padding:12px 14px;margin-bottom:8px;border:1.5px solid #e2e8f0;}
.planning-day-header{font-weight:950;font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:8px;}
.planning-delivery{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:13px;border-bottom:1px dashed #f1f5f9;}
.planning-delivery:last-child{border-bottom:none;}
.sup-badge-sm{padding:2px 7px;border-radius:6px;font-weight:900;font-size:10px;}
.sup-badge-sec{background:#fef3c7;color:#92400e;}
.sup-badge-frais{background:#d1fae5;color:#065f46;}
.sup-badge-surgele{background:#dbeafe;color:#1e3a8a;}
.today-highlight{border-left:5px solid var(--primary);background:linear-gradient(135deg,#eff6ff,#fff);}

/* ── PVP DLC BADGE ── */
.pvp-dlc-badge{position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:950;border:2px solid #fff;z-index:10;}

/* ── DLC PARENT MODULE ── */
.dlc-module-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;}
.dlc-sub-card{background:var(--surface);border-radius:18px;padding:22px 16px;box-shadow:0 4px 14px rgba(0,0,0,.06);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:8px;border:2px solid transparent;transition:all .2s;position:relative;text-align:center;}
.dlc-sub-card:active{transform:scale(.97);}
.dlc-sub-card i{font-size:30px;}
.dlc-sub-card .sub-title{font-weight:950;font-size:14px;}
.dlc-sub-card .sub-sub{font-size:11px;color:var(--muted);}
.dlc-sub-card.wide{grid-column:1/-1;}

/* ── DYNACAD ── */
#dynacad-overlay{position:fixed;inset:0;z-index:9500;background:#000;display:flex;flex-direction:column;}
#dynacad-bar{background:var(--primary);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-shrink:0;height:50px;}
#dynacad-iframe{flex:1;border:none;width:100%;background:#f8fafc;}

/* ── FRIGO HISTORY EDIT ── */
.frigo-log-row{padding:10px;border:1.5px solid #e2e8f0;border-radius:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;}

/* ── PWA INSTALL BANNER ── */
#pwa-install-banner{display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:60000;background:linear-gradient(135deg,#003896,#1a50c8);color:#fff;border-radius:18px;padding:14px 18px;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,56,150,.4);width:min(360px,92vw);animation:slideUp .3s ease;}
#pwa-install-banner .pwa-text{flex:1;min-width:0;}
#pwa-install-banner .pwa-title{font-weight:950;font-size:14px;}
#pwa-install-banner .pwa-sub{font-size:12px;opacity:.8;margin-top:2px;}
#pwa-install-banner .pwa-btn{background:#fff;color:#003896;border:none;border-radius:10px;padding:10px 16px;font-weight:950;font-size:13px;cursor:pointer;white-space:nowrap;}
#pwa-install-banner .pwa-close{background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:16px;flex-shrink:0;}



/* ── CHAT MODULE ── */
#view-chat{animation:fadeIn .2s ease;display:flex;flex-direction:column;height:100%;}
.chat-layout{display:flex;flex-direction:column;height:calc(100vh - 160px);gap:0;}
.chat-channels{display:flex;gap:8px;overflow-x:auto;padding:4px 0 12px 0;flex-shrink:0;scrollbar-width:none;}
.chat-channels::-webkit-scrollbar{display:none;}
.chat-channel-btn{display:flex;align-items:center;padding:8px 14px;border-radius:20px;background:#fff;border:2px solid #e2e8f0;font-weight:900;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .15s;color:#334155;}
.chat-channel-btn.active{background:var(--primary);border-color:var(--primary);color:#fff;}
.chat-channel-btn.active i{color:#fff!important;}
.chat-messages-wrap{flex:1;overflow-y:auto;background:#f8fafc;border-radius:16px;padding:12px;margin-bottom:10px;min-height:0;}
.chat-msg-wrap{display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;}
.chat-msg-wrap.me{flex-direction:row-reverse;}
.chat-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#1a50c8);color:#fff;font-weight:950;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-avatar.me{background:linear-gradient(135deg,#7c3aed,#5b21b6);}
.chat-bubble{max-width:72%;border-radius:16px;padding:10px 13px;}
.chat-bubble.other{background:#fff;border-bottom-left-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.06);}
.chat-bubble.me{background:linear-gradient(135deg,#003896,#1a50c8);color:#fff;border-bottom-right-radius:4px;}
.chat-sender{font-size:11px;font-weight:950;color:#64748b;margin-bottom:3px;}
.chat-text{font-size:14px;line-height:1.4;word-break:break-word;}
.chat-bubble.me .chat-text{color:#fff;}
.chat-time{font-size:10px;opacity:.6;margin-top:4px;text-align:right;}
.chat-input-row{display:flex;gap:8px;align-items:flex-end;flex-shrink:0;}
.chat-input-row textarea{flex:1;border:2px solid #e2e8f0;border-radius:14px;padding:12px 14px;font-size:15px;resize:none;min-height:48px;max-height:120px;background:#fff;font-family:inherit;outline:none;}
.chat-input-row textarea:focus{border-color:var(--primary);}
.chat-send-btn{width:48px;height:48px;border-radius:14px;background:var(--primary);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* ── CONSEILLER BANNER ── */
#conseiller-banner{display:none;position:fixed;top:0;left:0;right:0;z-index:65000;background:linear-gradient(90deg,#0891b2,#0369a1);color:#fff;padding:9px 16px;align-items:center;justify-content:space-between;font-size:13px;font-weight:900;gap:10px;}
#conseiller-banner.show{display:flex;}

/* ── HOME REORDER MODE ── */
.reorder-mode{cursor:grab!important;border:2px dashed rgba(255,255,255,.5)!important;animation:wiggle .4s ease infinite alternate;}
.reorder-mode:active,.dragging{cursor:grabbing!important;}
@keyframes wiggle{from{transform:rotate(-.5deg) scale(1)}to{transform:rotate(.5deg) scale(1.01)}}
.grip-icon{position:absolute;top:8px;left:8px;color:rgba(255,255,255,.7);font-size:14px;z-index:5;pointer-events:none;}
#home-reorder-btn{display:none;position:fixed;bottom:88px;right:16px;z-index:50000;background:linear-gradient(135deg,#7c3aed,#5b21b6);color:#fff;border:none;border-radius:50%;width:48px;height:48px;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 20px rgba(124,58,237,.5);cursor:pointer;}

/* ── ALERT NET OVERLAY ── */
#alertnet-overlay{position:fixed;inset:0;z-index:9000;background:#fff;display:none;flex-direction:column;}
#alertnet-bar{background:#dc2626;padding:12px 16px;display:flex;align-items:center;gap:12px;padding-top:calc(12px + env(safe-area-inset-top));}
#alertnet-iframe{flex:1;border:none;width:100%;background:#f8fafc;}
</style>
</head>
<body>

<div id="offline-banner"><i class="fas fa-wifi-slash"></i> Hors ligne – reconnexion en cours…</div>

<!-- PWA INSTALL BANNER -->
<div id="pwa-install-banner">
  <i class="fas fa-mobile-screen-button" style="font-size:24px;flex-shrink:0;"></i>
  <div class="pwa-text">
    <div class="pwa-title">Installer Express Purpan</div>
    <div class="pwa-sub">Accès rapide depuis l'écran d'accueil</div>
  </div>
  <button class="pwa-btn" onclick="app.installPWA()"><i class="fas fa-download"></i> Installer</button>
  <button class="pwa-close" onclick="document.getElementById('pwa-install-banner').style.display='none'">✕</button>
</div>

<!-- CONSEILLER READ-ONLY BANNER -->
<div id="conseiller-banner">
  <div><i class="fas fa-eye"></i> Accès Conseiller — <span style="font-weight:700;opacity:.85;">Lecture seule</span></div>
  <div style="font-size:11px;opacity:.75;">Les modifications sont désactivées</div>
</div>


<div id="toast-container"></div>
<div id="spinner-overlay" class="hidden"><div class="spinner"></div></div>

<!-- ── CONFIRM ── -->
<div id="modal-confirm" class="hidden">
  <div class="dlg-card">
    <p class="dlg-title" id="dlg-title">Confirmation</p>
    <p class="dlg-msg"   id="dlg-msg"></p>
    <div class="dlg-btns">
      <button class="btn secondary" style="margin:0" id="dlg-cancel">Annuler</button>
      <button class="btn danger"    style="margin:0" id="dlg-ok">Confirmer</button>
    </div>
  </div>
</div>

<!-- ── PROMPT ── -->
<div id="modal-prompt" class="hidden">
  <div class="dlg-card">
    <p class="dlg-title" id="pmt-title">Saisie</p>
    <input id="pmt-input" type="text" style="margin-bottom:12px;">
    <div class="dlg-btns">
      <button class="btn secondary" style="margin:0" id="pmt-cancel">Annuler</button>
      <button class="btn"           style="margin:0" id="pmt-ok">OK</button>
    </div>
  </div>
</div>

<!-- ── LOGIN ── -->
<div id="login-overlay">
  <div class="login-card">
    <div style="text-align:center;"><img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" style="width:200px;margin-bottom:20px;"></div>
    <input type="email" id="login-email" placeholder="Email" autocomplete="username" inputmode="email">
    <input type="password" id="login-pass" placeholder="Mot de passe" autocomplete="current-password">
    <button class="btn success" id="login-btn" onclick="app.auth.login()"><i class="fas fa-right-to-bracket"></i> CONNEXION</button>
    <div class="login-help" onclick="app.auth.forgot()"><i class="fas fa-unlock-keyhole"></i> Mot de passe oublié ?</div>
    <div id="login-error" class="login-error"></div>
    <div class="small" style="text-align:center;margin-top:14px;">Astuce : après création d'un compte staff, "Mot de passe oublié" permet de définir le mot de passe.</div>
  </div>
</div>

<!-- ── BARCODE MODAL ── -->
<div id="modal-barcode" class="modal-bc hidden">
  <div class="modal-card" style="text-align:center;">
    <h3 id="bc-name" style="margin-top:0;"></h3>
    <img id="bc-img-display" style="width:100%;height:220px;object-fit:contain;margin-bottom:15px;display:none;background:#f8fafc;border-radius:10px;">
    <svg id="barcode"></svg><br>
    <button class="btn secondary" style="margin-top:20px;" onclick="document.getElementById('modal-barcode').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ── TRACE MODAL ── -->
<div id="modal-trace" class="modal-bc hidden">
  <div class="modal-card">
    <h3 id="trace-h3" style="margin-top:0;display:flex;align-items:center;gap:10px;"><i class="fas fa-camera"></i> Tracabilité</h3>
    <div class="small" id="trace-title" style="margin-bottom:10px;"></div>
    <button class="btn" id="trace-btn-pick" onclick="document.getElementById('trace-file').click()"><i class="fas fa-image"></i> Prendre / choisir une photo</button>
    <input type="file" id="trace-file" accept="image/*" capture="environment" class="hidden">
    <img id="trace-preview" style="width:100%;height:200px;object-fit:contain;background:#f8fafc;border-radius:12px;display:none;margin-top:12px;">
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="trace-btn-save" style="margin-top:0;" onclick="app.trace.save()"><i class="fas fa-floppy-disk"></i> Enregistrer</button>
      <button class="btn secondary" style="margin-top:0;" onclick="app.trace.close()">Fermer</button>
    </div>
    <hr class="divider">
    <h4 style="margin:0 0 10px 0;">Historique (6 mois)</h4>
    <div id="trace-history" class="small">Chargement…</div>
  </div>
</div>

<!-- ── EDIT FRAIS ── -->
<div id="modal-edit-frais" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;">Modifier Frais</h3>
    <input type="hidden" id="edit-id">
    <label>EAN</label><input type="text" id="edit-ean" inputmode="numeric">
    <label>Nom Produit</label><input type="text" id="edit-name">
    <label>Famille</label>
    <select id="edit-famille"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>VOLAILLE</option><option>BOUCHERIE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
    <label>Qté</label><input type="number" id="edit-qty">
    <label>DLC</label><input type="date" id="edit-date">
    <button class="btn success" onclick="app.frais.saveEdit()">Enregistrer</button>
    <button class="btn danger"  onclick="app.frais.del()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-edit-frais').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ── PVP LIB ── -->
<div id="modal-pvp-lib" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--pvp);margin-top:0;">Produit PVP</h3>
    <input type="hidden" id="lib-id"><input type="hidden" id="lib-img-data">
    <label>Famille</label><select id="lib-fam-select" onchange="app.pvp.toggleFamInput()"></select>
    <input type="text" id="lib-fam-new" placeholder="Nouvelle famille..." class="hidden">
    <label>Nom</label><input type="text" id="lib-name">
    <label>EAN</label><input type="text" id="lib-ean" inputmode="numeric" maxlength="13">
    <button class="btn secondary" onclick="document.getElementById('cam-input').click()" style="margin-bottom:10px;">Photo</button>
    <input type="file" id="cam-input" accept="image/*" capture="environment" class="hidden">
    <img id="img-preview" style="width:110px;height:110px;object-fit:cover;border-radius:12px;display:none;margin:0 auto 10px auto;">
    <label>Conservation</label><select id="lib-days"><option value="0">JOURNÉE</option><option value="48">48H</option><option value="72">72H</option></select>
    <label>Objectifs (L→D)</label>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">
      <input type="number" id="t-1" placeholder="L" style="text-align:center;padding:6px;">
      <input type="number" id="t-2" placeholder="M" style="text-align:center;padding:6px;">
      <input type="number" id="t-3" placeholder="M" style="text-align:center;padding:6px;">
      <input type="number" id="t-4" placeholder="J" style="text-align:center;padding:6px;">
      <input type="number" id="t-5" placeholder="V" style="text-align:center;padding:6px;">
      <input type="number" id="t-6" placeholder="S" style="text-align:center;padding:6px;">
      <input type="number" id="t-0" placeholder="D" style="text-align:center;padding:6px;">
    </div>
    <button class="btn pvp"      onclick="app.pvp.saveLib()">Enregistrer</button>
    <button class="btn danger"   onclick="app.pvp.delLib()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-pvp-lib').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ── PVP STOCK ── -->
<div id="modal-pvp-stock" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--pvp);margin-top:0;">Correction Rayon</h3>
    <input type="hidden" id="stock-id"><h4 id="stock-name" style="text-align:center;margin:0 0 10px 0;"></h4>
    <label>Quantité</label><input type="number" id="stock-qty">
    <label>Sortie</label><input type="datetime-local" id="stock-start">
    <label>Fin</label><input type="datetime-local" id="stock-end">
    <button class="btn pvp"    onclick="app.pvp.saveStock()">Valider</button>
    <button class="btn danger" onclick="app.pvp.delStock()">Retirer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-pvp-stock').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ── SALAD LIB ── -->
<div id="modal-salad-lib" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--salad);margin-top:0;">Produit Salad Bar</h3>
    <input type="hidden" id="sal-lib-id">
    <label>Groupe</label>
    <select id="sal-lib-fam"><option>SALADE</option><option>BASE</option><option>LEGUMES ET FRUITS</option><option>PROTEINE</option><option>FROMAGES</option><option>FECULENTS</option><option>TOPPING</option><option>DIVERS</option></select>
    <label>Nom</label><input type="text" id="sal-lib-name">
    <label>Durée</label>
    <select id="sal-lib-hours"><option value="24">24H</option><option value="48">48H</option><option value="72">72H</option><option value="168">7J</option><option value="1920">80J</option></select>
    <button class="btn salad"  onclick="app.salad.saveLib()">Enregistrer</button>
    <button class="btn danger" onclick="app.salad.delLib()">Supprimer</button>
    <button class="btn secondary" onclick="document.getElementById('modal-salad-lib').classList.add('hidden')">Fermer</button>
  </div>
</div>

<!-- ── FRIGO LOG ── -->
<div id="modal-frigo-log" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;color:var(--frigo);"><i class="fas fa-temperature-half"></i> Température frigo</h3>
    <label>Frigo</label><select id="frigo-log-fridge"></select>
    <label>Température (°C)</label><input type="number" id="frigo-log-temp" inputmode="decimal" step="0.1" placeholder="Ex: 3.6">
    <label>Date / heure</label><input type="datetime-local" id="frigo-log-time">
    <div class="row" style="margin-top:12px;">
      <button class="btn frigo" style="margin-top:0;" onclick="app.frigo.saveLog()"><i class="fas fa-check"></i> Valider</button>
      <button class="btn secondary" style="margin-top:0;" onclick="document.getElementById('modal-frigo-log').classList.add('hidden')">Annuler</button>
    </div>
  </div>
</div>

<!-- ── TODO ZONE MODAL ── -->
<div id="modal-todo-zone" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--todo);margin-top:0;" id="todo-zone-modal-title"><i class="fas fa-map-marker-alt"></i> Zone</h3>
    <input type="hidden" id="tz-id">
    <label>Nom de la zone</label>
    <input type="text" id="tz-name" placeholder="Ex: RÉSERVE, RAYON, CAISSE...">
    <div class="field-err" id="err-tz-name">Nom requis</div>
    <label>Couleur</label>
    <div class="color-grid" id="tz-color-grid"></div>
    <input type="hidden" id="tz-color" value="#7c3aed">
    <div class="row" style="margin-top:8px;">
      <button class="btn todo"   style="margin-top:0;" onclick="app.todo.saveZone()">Enregistrer</button>
      <button class="btn danger" style="margin-top:0;" id="tz-del-btn" onclick="app.todo.delZone()">Supprimer</button>
    </div>
    <button class="btn secondary" onclick="document.getElementById('modal-todo-zone').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ── TODO TASK MODAL ── -->
<div id="modal-todo-task" class="modal-bc hidden">
  <div class="modal-card">
    <h3 style="color:var(--todo);margin-top:0;" id="todo-task-modal-title"><i class="fas fa-list-check"></i> Tâche</h3>
    <input type="hidden" id="tt-id">
    <label>Zone</label>
    <select id="tt-zone"></select>
    <label>Nom de la tâche</label>
    <input type="text" id="tt-name" placeholder="Ex: Nettoyer le sol, Faire l'inventaire...">
    <div class="field-err" id="err-tt-name">Nom requis</div>
    <label>Heure cible</label>
    <input type="time" id="tt-time" placeholder="Ex: 08:00">
    <label>Fréquence</label>
    <div class="freq-type-tabs">
      <div class="freq-tab active" id="freq-daily-tab"   onclick="app.todo._setFreq('daily')">Journalier</div>
      <div class="freq-tab"        id="freq-weekly-tab"  onclick="app.todo._setFreq('weekly')">Hebdo</div>
      <div class="freq-tab"        id="freq-monthly-tab" onclick="app.todo._setFreq('monthly')">Mensuel</div>
      <div class="freq-tab"        id="freq-yearly-tab"  onclick="app.todo._setFreq('yearly')">Annuel</div>
    </div>
    <!-- Journalier : tous les jours -->
    <div class="freq-panel active" id="freq-panel-daily">
      <div class="small" style="color:var(--muted);text-align:center;padding:8px;">Tâche active tous les jours</div>
    </div>
    <!-- Hebdomadaire : jours de la semaine -->
    <div class="freq-panel" id="freq-panel-weekly">
      <label>Jours d'application</label>
      <div class="days-row" id="tt-days-row"></div>
      <div class="field-err" id="err-tt-days">Sélectionner au moins un jour</div>
    </div>
    <!-- Mensuel : jour du mois -->
    <div class="freq-panel" id="freq-panel-monthly">
      <label>Jours du mois</label>
      <div class="month-days-grid" id="tt-month-days-grid"></div>
      <div class="field-err" id="err-tt-days-m">Sélectionner au moins un jour</div>
    </div>
    <!-- Annuel : date exacte -->
    <div class="freq-panel" id="freq-panel-yearly">
      <label>Date (chaque année)</label>
      <input type="text" id="tt-yearly-date" placeholder="JJ/MM (ex: 01/01)" inputmode="numeric" maxlength="5">
    </div>
    <label>Notes (optionnel)</label>
    <textarea id="tt-notes" placeholder="Instructions, détails…"></textarea>
    <div class="row" style="margin-top:8px;">
      <button class="btn todo"   style="margin-top:0;" onclick="app.todo.saveTask()">Enregistrer</button>
      <button class="btn danger" style="margin-top:0;" id="tt-del-btn" onclick="app.todo.delTask()">Supprimer</button>
    </div>
    <button class="btn secondary" onclick="document.getElementById('modal-todo-task').classList.add('hidden')">Annuler</button>
  </div>
</div>

<!-- ── HEADER ── -->
<header id="app-header" class="hidden">
  <button class="logout-btn" onclick="app.auth.logout()"><i class="fas fa-right-from-bracket"></i></button>
  <img src="https://raw.githubusercontent.com/araujoexploitation/Magasin/main/LOGO.png" class="logo-header">
  <div id="user-badge" class="user-badge">...</div>
</header>

<main>
  <!-- HOME -->
  <div id="view-home">


    <div id="home-edit-bar" style="display:none;background:linear-gradient(135deg,#7c3aed,#5b21b6);border-radius:16px;padding:14px 16px;margin-bottom:12px;color:#fff;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div style="font-weight:950;font-size:15px;"><i class="fas fa-hand-pointer"></i> Maintenez et glissez pour réorganiser</div>
          <div style="font-size:12px;opacity:.8;margin-top:3px;">Les modules se déplacent au toucher • Sauvegarde automatique</div>
        </div>
        <button onclick="app.homeOrder.stopEdit()" style="background:rgba(255,255,255,.25);border:none;color:#fff;border-radius:12px;padding:10px 16px;font-weight:950;cursor:pointer;white-space:nowrap;flex-shrink:0;"><i class="fas fa-check"></i> Terminé</button>
      </div>
    </div>
    <div class="home-grid" id="home-grid">
      <div class="home-btn wide" onclick="app.nav('dlc')" style="background:linear-gradient(135deg,#003896,#1e40af);position:relative;">
        <div id="badge-frais" class="home-badge red hidden">0</div>
        <i class="fas fa-barcode"></i><br>GESTION DLC
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Frais • PVP • Salad Bar • Too Good To Go</div>
      </div>
      <div class="home-btn" onclick="app.nav('frigo')" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);">
        <div id="badge-frigo" class="home-badge blue hidden">0</div>
        <i class="fas fa-temperature-half"></i><br>TEMPÉRATURES
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Relevés restants</div>
      </div>
      <div class="home-btn" onclick="app.nav('todo')" style="background:linear-gradient(135deg,#7c3aed,#5b21b6);">
        <div id="badge-todo" class="home-badge purple hidden">0</div>
        <i class="fas fa-list-check"></i><br>CHECK-LIST
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Tâches du jour</div>
      </div>
      <div class="home-btn" onclick="app.nav('reception')" style="background:linear-gradient(135deg,#059669,#047857);">
        <div id="badge-reception" class="home-badge hidden" style="background:rgba(255,255,255,.92);color:#065f46;">0</div>
        <i class="fas fa-truck-ramp-box"></i><br>RÉCEPTION
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Contrôle livraison</div>
      </div>
      <div class="home-btn" onclick="app.nav('chat')" style="background:linear-gradient(135deg,#0891b2,#0369a1);">
        <div id="badge-chat" class="home-badge hidden" style="background:rgba(255,255,255,.92);color:#0369a1;">0</div>
        <i class="fas fa-comments"></i><br>MESSAGERIE
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Canaux de discussion</div>
      </div>





      <!-- GESTION MAGASIN (parent) - inclut aussi Module Carrefour -->
      <div class="home-btn wide" onclick="app.nav('gestion-magasin')" style="background:linear-gradient(135deg,#0f766e,#134e4a);">
        <i class="fas fa-building"></i><br>GESTION MAGASIN
        <div class="small" style="color:rgba(255,255,255,.8);margin-top:6px;">Planning • Inspection • Carrefour • Chat</div>
      </div>
    </div>
    <div class="card hidden" id="btn-team" onclick="app.nav('team')" style="text-align:center;cursor:pointer;margin-bottom:10px;"><i class="fas fa-gear"></i> Paramètres & Équipe</div>
  </div>

  <!-- GESTION DLC - Module parent -->
  <div id="view-dlc" class="hidden">
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-weight:950;font-size:20px;color:var(--primary);"><i class="fas fa-barcode"></i> GESTION DLC</div>
      <div class="small" style="margin-top:4px;">Sélectionnez un module</div>
    </div>
    <div id="alert-box" style="display:none;background:linear-gradient(135deg,#dc2626,#ef4444);color:white;padding:14px;border-radius:14px;margin-bottom:14px;text-align:center;font-weight:950;font-size:16px;box-shadow:0 4px 20px rgba(239,68,68,.35);"><i class="fas fa-triangle-exclamation"></i> ⚠️ Produits à DATES COURTES — Action requise !</div>
    <div class="dlc-module-grid">
      <div class="dlc-sub-card wide" onclick="app.nav('frais')" style="border-color:#003896;background:linear-gradient(135deg,#eff6ff,#fff);">
        <div id="badge-frais-dlc" style="display:none;background:#ef4444;color:#fff;border-radius:20px;padding:2px 10px;font-size:12px;font-weight:950;margin-bottom:4px;">0 à DLC</div>
        <i class="fas fa-barcode" style="color:#003896;"></i>
        <div class="sub-title" style="color:#003896;">DLC FRAIS</div>
        <div class="sub-sub">Scanner, lister, Too Good To Go</div>
      </div>
      <div class="dlc-sub-card" onclick="app.nav('pvp')" style="border-color:var(--pvp);background:linear-gradient(135deg,#fffbeb,#fff);">
        <div id="badge-pvp-dlc" style="display:none;background:#ef4444;color:#fff;border-radius:20px;padding:2px 8px;font-size:11px;font-weight:950;margin-bottom:4px;">0 à jeter</div>
        <i class="fas fa-bread-slice" style="color:var(--pvp);"></i>
        <div class="sub-title" style="color:var(--pvp);">GESTION PVP</div>
        <div class="sub-sub">Dates courtes rayon</div>
      </div>
      <div class="dlc-sub-card" onclick="app.nav('salad')" style="border-color:var(--salad);background:linear-gradient(135deg,#f0fdf4,#fff);">
        <i class="fas fa-bowl-food" style="color:var(--salad);"></i>
        <div class="sub-title" style="color:var(--salad);">SALAD BAR</div>
        <div class="sub-sub">DLC + Traçabilité</div>
      </div>
      <div class="dlc-sub-card wide" onclick="app.tgtgPortal.open()" style="border-color:#006B3C;background:linear-gradient(135deg,#f0fdf4,#fff);">
        <i class="fas fa-leaf" style="color:#006B3C;font-size:28px;"></i>
        <div class="sub-title" style="color:#006B3C;">TOO GOOD TO GO — PORTAIL</div>
        <div class="sub-sub">Gérer vos paniers sur store.toogoodtogo.com</div>
      </div>
      <div class="dlc-sub-card wide" onclick="app.nav('etiquettes')" style="border-color:#9333ea;background:linear-gradient(135deg,#faf5ff,#fff);">
        <i class="fas fa-tag" style="color:#9333ea;font-size:28px;"></i>
        <div class="sub-title" style="color:#9333ea;">ÉTIQUETTES -50%</div>
        <div class="sub-sub">Impression Brother TD-2120N • Démarque</div>
      </div>
    </div>
  </div>

  <!-- FRAIS -->
  <div id="view-frais" class="hidden">
    <div class="tabs">
      <div class="tab active" id="tf-1" onclick="app.frais.tab('scan')">SCAN</div>
      <div class="tab"        id="tf-3" onclick="app.frais.tab('tgtg')" style="color:#006B3C;">TOO GOOD TO GO</div>
      <div class="tab"        id="tf-2" onclick="app.frais.tab('list')">LISTE</div>
    </div>
    <div class="card" id="frais-today-card" style="border-left:6px solid var(--primary);">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:950;">DLC aujourd'hui</div>
        <div class="chip warn" id="frais-today-chip"><i class="fas fa-calendar-day"></i> 0</div>
      </div>
    </div>
    <div id="frais-scan">
      <div id="scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;border-radius:12px;overflow:hidden;">
        <video id="video" style="width:100%;height:100%;object-fit:cover;"></video>
      </div>
      <button class="btn" onclick="app.frais.toggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
      <div class="card">
        <input id="frais-ean" type="text" inputmode="numeric" placeholder="EAN" oninput="app.frais.handleInput(this.value)">
        <select id="frais-fam"><option>SNACKING</option><option>TRAITEUR</option><option>ULTRA FRAIS</option><option>CHARCUTERIE</option><option>BOUCHERIE</option><option>VOLAILLE</option><option>FROMAGE</option><option>SAURISSERIE</option><option>DIVERS</option></select>
        <input id="frais-name" placeholder="Nom">
        <div class="row"><input type="date" id="frais-date"><input type="number" id="frais-qty" placeholder="Qté"></div>
        <button class="btn" onclick="app.frais.add()">AJOUTER</button>
      </div>
    </div>
    <!-- TOO GOOD TO GO -->
    <div id="frais-tgtg" class="hidden">
      <div class="card" style="border-left:5px solid #006B3C;background:linear-gradient(135deg,#f0fdf4,#fff);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div style="font-size:32px;">🍃</div>
          <div>
            <div style="font-weight:950;font-size:16px;color:#006B3C;">Too Good To Go</div>
            <div class="small">Scannez ou cherchez un produit à déduire du stock</div>
          </div>
        </div>
        <div id="tgtg-scanner-box" style="height:200px;background:black;margin-bottom:10px;display:none;border-radius:12px;overflow:hidden;">
          <video id="tgtg-video" style="width:100%;height:100%;object-fit:cover;"></video>
        </div>
        <button class="btn" style="background:#006B3C;" onclick="app.frais.tgtgToggleScan()"><i class="fas fa-camera"></i> SCANNER</button>
        <div class="search-wrap" style="margin-top:10px;">
          <i class="fas fa-magnifying-glass"></i>
          <input class="search-input" type="search" id="tgtg-search" placeholder="Rechercher un produit…" oninput="app.frais.renderTgtg()" autocomplete="off">
        </div>
        <div id="tgtg-result-list" style="margin-top:8px;"></div>
      </div>
    </div>
    <div id="frais-list" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="frais-search" placeholder="Rechercher un produit frais…" oninput="app.frais.render()" autocomplete="off">
      </div>
      <div id="frais-list-items"></div>
    </div>
  </div>

  <!-- PVP -->
  <div id="view-pvp" class="hidden">
    <div class="tabs">
      <div class="tab active-pvp" id="tp-1" onclick="app.pvp.tab('stock')">RAYON</div>
      <div class="tab"            id="tp-2" onclick="app.pvp.tab('bib')">BIBLIOTHÈQUE</div>
      <div class="tab"            id="tp-3" onclick="app.pvp.tab('calc')">BESOINS</div>
    </div>
    <div id="pvp-stock"></div>
    <div id="pvp-bib" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="pvp-search" placeholder="Rechercher un produit PVP…" oninput="app.pvp.render()" autocomplete="off">
      </div>
      <button class="btn secondary" id="pvp-create-btn" onclick="app.pvp.openLib()" style="margin-bottom:12px;">+ Créer Produit</button>
      <div id="lib-list"></div>
    </div>
    <div id="pvp-calc" class="hidden"></div>
  </div>

  <!-- SALAD BAR -->
  <div id="view-salad" class="hidden">
    <div class="tabs">
      <div class="tab active-salad" id="ts-1" onclick="app.salad.tab('stock')">RAYON</div>
      <div class="tab"              id="ts-2" onclick="app.salad.tab('bib')">BIBLIOTHÈQUE</div>
    </div>
    <div id="salad-stock"></div>
    <div id="salad-bib" class="hidden">
      <div class="search-wrap">
        <i class="fas fa-magnifying-glass"></i>
        <input class="search-input" type="search" id="salad-search" placeholder="Rechercher un produit Salad Bar…" oninput="app.salad.render()" autocomplete="off">
      </div>
      <button class="btn secondary" id="salad-create-btn" onclick="app.salad.openLib()" style="margin-bottom:12px;">+ Créer Produit</button>
      <div id="salad-lib-list"></div>
    </div>
  </div>

  <!-- FRIGO -->
  <div id="view-frigo" class="hidden">
    <div class="tabs">
      <div class="tab active-frigo" id="tfr-1" onclick="app.frigo.tab('take')">À FAIRE</div>
      <div class="tab"              id="tfr-2" onclick="app.frigo.tab('fridges')">FRIGOS</div>
      <div class="tab"              id="tfr-3" onclick="app.frigo.tab('history')">HISTO</div>
    </div>
    <div class="card" style="border-left:6px solid var(--frigo);">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-weight:950;">Relevés du jour restants</div>
        <div class="chip frigo" id="frigo-remaining-chip"><i class="fas fa-list-check"></i> 0</div>
      </div>
      <div class="small" style="margin-top:6px;">Fréquence : <b id="frigo-perday-label">2</b> relevé(s) / frigo / jour</div>
    </div>
    <div id="frigo-take"></div>
    <div id="frigo-fridges" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 10px 0;color:var(--frigo);">Paramètres</h3>
        <label>Fréquence (relevés / frigo / jour)</label>
        <select id="frigo-perday" onchange="app.frigo.setPerDay(this.value)">
          <option value="1">1 / jour</option><option value="2">2 / jour</option>
          <option value="3">3 / jour</option><option value="4">4 / jour</option>
        </select>
      </div>
      <button class="btn frigo" onclick="app.frigo.addFridge()"><i class="fas fa-plus"></i> Ajouter un frigo</button>
      <div id="frigo-list" style="margin-top:12px;"></div>
    </div>
    <div id="frigo-history" class="hidden"></div>
  </div>

  <!-- TODO / CHECK-LIST -->
  <div id="view-todo" class="hidden">
    <div class="tabs">
      <div class="tab active-todo" id="tt-1" onclick="app.todo.tab('today')">AUJOURD'HUI</div>
      <div class="tab"             id="tt-4" onclick="app.todo.tab('tomorrow')">À VENIR</div>
      <div class="tab"             id="tt-2" onclick="app.todo.tab('config')">CONFIGURER</div>
      <div class="tab"             id="tt-3" onclick="app.todo.tab('history')">HISTORIQUE</div>
    </div>
    <div id="todo-today"></div>
    <div id="todo-tomorrow" class="hidden"></div>
    <div id="todo-config" class="hidden"></div>
    <div id="todo-history" class="hidden"></div>
  </div>

  <!-- RÉCEPTION -->
  <div id="view-reception" class="hidden">
    <div class="tabs">
      <div class="tab active" style="color:var(--reception);" id="trec-1" onclick="app.reception.tab('new')">NOUVEAU</div>
      <div class="tab"        id="trec-3" onclick="app.reception.tab('planning')">PLANNING</div>
      <div class="tab"        id="trec-4" onclick="app.reception.tab('tracking')" style="color:#0369a1;">🚚 CAMION</div>
      <div class="tab"        id="trec-2" onclick="app.reception.tab('history')">HISTORIQUE</div>
    </div>
    <div id="reception-new">
      <div class="card" style="border-left:5px solid var(--reception);">
        <h3 style="margin-top:0;color:var(--reception);"><i class="fas fa-truck-ramp-box"></i> Contrôle à la réception</h3>
        <label>Fournisseur</label>
        <!-- Étape 1 : choisir le fournisseur -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;" id="rec-supplier-grid">
          <div class="supplier-select-btn" id="sup-btn-011" onclick="app.reception.selectSupplier('011')">
            <div style="font-weight:950;font-size:13px;">COLOMIERS</div><div style="font-size:10px;opacity:.8;">011</div>
          </div>
          <div class="supplier-select-btn" id="sup-btn-392" onclick="app.reception.selectSupplier('392')">
            <div style="font-weight:950;font-size:13px;">PLAISANCE</div><div style="font-size:10px;opacity:.8;">392</div>
          </div>
          <div class="supplier-select-btn" id="sup-btn-032" onclick="app.reception.selectSupplier('032')">
            <div style="font-weight:950;font-size:13px;">ST GILES</div><div style="font-size:10px;opacity:.8;">032</div>
          </div>
        </div>
        <!-- Étape 2 : choisir le type (dynamique) -->
        <div id="rec-type-section" style="display:none;margin-bottom:12px;">
          <label>Type de livraison</label>
          <div class="sup-type-grid" id="rec-type-grid"></div>
        </div>
        <!-- Étape 3 : résumé sélection + temp -->
        <div id="rec-selected-supplier" style="display:none;margin-bottom:12px;">
          <div style="background:#f0fdf4;border:2px solid var(--reception);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:950;" id="rec-sup-label">—</div>
              <div class="small" id="rec-sup-type-label">—</div>
            </div>
            <button onclick="app.reception.clearSupplier()" style="border:none;background:#fee2e2;color:#991b1b;border-radius:8px;padding:6px 10px;font-weight:900;cursor:pointer;">Changer</button>
          </div>
        </div>
        <div id="rec-temp-section" style="display:none;">
          <label>Température à réception (°C)</label>
          <div style="background:#f8fafc;border-radius:12px;padding:10px;margin-bottom:10px;">
            <div class="small" id="rec-temp-range-label" style="font-weight:800;color:#475569;margin-bottom:6px;"></div>
            <input type="number" id="rec-temp" inputmode="decimal" step="0.1" placeholder="Ex: 3.5" oninput="app.reception._updateTempStatus()">
            <div id="rec-temp-status"></div>
          </div>
        </div>
        <label>Produit / Nature de la livraison</label>
        <input type="text" id="rec-product" placeholder="Ex: Viande fraîche, Légumes, Poisson…">
        <label>Date et heure de contrôle</label>
        <input type="datetime-local" id="rec-datetime">
        <label>Observations / Non-conformités</label>
        <textarea id="rec-notes" placeholder="État emballage, odeur, couleur, quantité…"></textarea>
        <label>Photo (optionnel)</label>
        <button class="btn secondary" style="margin-bottom:8px;" onclick="document.getElementById('rec-photo-input').click()"><i class="fas fa-camera"></i> Prendre une photo</button>
        <input type="file" id="rec-photo-input" accept="image/*" capture="environment" class="hidden">
        <img id="rec-photo-preview" style="width:100%;max-height:180px;object-fit:contain;border-radius:12px;display:none;margin-bottom:10px;background:#f8fafc;">
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn success" style="margin-top:0;" onclick="app.reception.save(true)"><i class="fas fa-check"></i> CONFORME</button>
          <button class="btn danger"  style="margin-top:0;" onclick="app.reception.save(false)"><i class="fas fa-xmark"></i> NON CONFORME</button>
        </div>
      </div>
    </div>
    <div id="reception-history" class="hidden"></div>
    <div id="reception-planning" class="hidden"></div>
    <div id="reception-tracking" class="hidden">
      <div class="card" style="border-left:5px solid #0369a1;background:linear-gradient(135deg,#eff6ff,#fff);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div style="font-size:32px;">🚚</div>
          <div>
            <div style="font-weight:950;font-size:16px;color:#0369a1;">Suivi des Camions</div>
            <div class="small">MyTravis — Carrefour logistique</div>
          </div>
        </div>
        <div style="background:#f0f7ff;border-radius:10px;padding:12px;margin-bottom:16px;">
          <div class="small" style="font-weight:800;color:#0369a1;margin-bottom:4px;">IDENTIFIANTS</div>
          <div style="font-weight:900;font-size:14px;">ID : <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b4dedbdad5c0dcd5daebd5c6d5c1dedbeb80f4d2c6d5dad7dcddc7d19ad7d5c6c6d1d2dbc1c69ad7dbd9">[email&#160;protected]</a></div>
          <div style="font-weight:900;font-size:14px;color:#64748b;">MDP : KzD?VB&amp;6bNnS5.3</div>
        </div>
        <button class="btn" style="background:#0369a1;" onclick="app.mytravis.open()"><i class="fas fa-external-link-alt"></i> Ouvrir MyTravis</button>
      </div>
    </div>
  </div>
  <div id="view-inspection" class="hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h2 style="margin:0;font-size:18px;color:var(--primary);"><i class="fas fa-chart-bar"></i> Inspection & Rapports</h2>
      <button class="gear-btn" id="inspection-settings-btn" onclick="app.nav('team')" title="Paramètres équipe"><i class="fas fa-gear"></i></button>
    </div>
    <div id="inspection-content"></div>
  </div>

  <!-- ÉTIQUETTES -50% -->
  <div id="view-etiquettes" class="hidden">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
      <div style="font-size:28px;">🏷️</div>
      <div>
        <div style="font-weight:950;font-size:18px;color:#9333ea;">Étiquettes -50%</div>
        <div class="small">Imprimante Brother TD-2120N</div>
      </div>
    </div>
    <div class="card" style="border-left:5px solid #9333ea;">
      <div style="font-weight:950;margin-bottom:10px;color:#9333ea;"><i class="fas fa-triangle-exclamation"></i> Produits à date du jour</div>
      <div id="etiq-product-list"></div>
      <button class="btn" style="background:#9333ea;margin-top:8px;" onclick="app.etiquettes.loadProducts()"><i class="fas fa-rotate"></i> Actualiser la liste</button>
    </div>
    <div class="card" id="etiq-config-card" style="display:none;">
      <h3 style="margin-top:0;color:#9333ea;"><i class="fas fa-sliders"></i> Configuration impression</h3>
      <div id="etiq-items-config"></div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" style="background:#9333ea;" onclick="app.etiquettes.printAll()"><i class="fas fa-print"></i> IMPRIMER TOUT</button>
      </div>
    </div>
    <div class="card" style="background:#f8f4ff;border:1px dashed #9333ea;">
      <h4 style="margin-top:0;color:#9333ea;"><i class="fas fa-network-wired"></i> Connexion imprimante</h4>
      <input id="etiq-printer-ip" placeholder="IP imprimante (ex: 192.168.1.50)" style="margin-bottom:8px;">
      <input id="etiq-printer-port" placeholder="Port (défaut: 9100)" value="9100" style="margin-bottom:8px;">
      <div id="etiq-printer-status" class="small" style="color:var(--muted);margin-bottom:8px;">Non connecté</div>
      <button class="btn secondary" onclick="app.etiquettes.testPrinter()"><i class="fas fa-plug"></i> Tester la connexion</button>
    </div>
  </div>

  <!-- MODULE CARREFOUR (parent) -->
  <div id="view-carrefour" class="hidden">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
      <button class="qty-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i></button>
      <div>
        <div style="font-weight:950;font-size:20px;color:#003896;"><i class="fas fa-store"></i> MODULE CARREFOUR</div>
        <div class="small" style="margin-top:2px;">Outils et accès franchise Carrefour Express</div>
      </div>
    </div>
    <div class="dlc-module-grid">
      <div class="dlc-sub-card" onclick="app.dynacad.open()" style="border-color:#0f172a;background:linear-gradient(135deg,#f8fafc,#fff);">
        <i class="fas fa-store" style="color:#0f172a;font-size:30px;"></i>
        <div class="sub-title" style="color:#0f172a;">DYNACAD</div>
        <div class="sub-sub">Planogrammes</div>
      </div>
      <div class="dlc-sub-card" onclick="app.metiPortal.open()" style="border-color:var(--carrefour-red);background:linear-gradient(135deg,#fff5f5,#fff);">
        <i class="fas fa-laptop" style="color:var(--carrefour-red);font-size:30px;"></i>
        <div class="sub-title" style="color:var(--carrefour-red);">METI</div>
        <div class="sub-sub">Portail VPN</div>
      </div>
      <div class="dlc-sub-card" onclick="app.alertNet.open()" style="border-color:#dc2626;background:linear-gradient(135deg,#fff5f5,#fff);">
        <i class="fas fa-bell" style="color:#dc2626;font-size:30px;"></i>
        <div class="sub-title" style="color:#dc2626;">ALERT NET</div>
        <div class="sub-sub">Alertes Carrefour</div>
      </div>
      <div class="dlc-sub-card" onclick="app.mytravis.open()" style="border-color:#0891b2;background:linear-gradient(135deg,#f0f9ff,#fff);">
        <i class="fas fa-truck" style="color:#0891b2;font-size:30px;"></i>
        <div class="sub-title" style="color:#0891b2;">MY TRAVIS</div>
        <div class="sub-sub">Suivi camions</div>
      </div>
    </div>
  </div>

  <!-- GESTION MAGASIN (parent) -->
  <div id="view-gestion-magasin" class="hidden">
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-weight:950;font-size:20px;color:#0891b2;"><i class="fas fa-building"></i> GESTION MAGASIN</div>
      <div class="small" style="margin-top:4px;">Outils de gestion • Franchise Carrefour Express</div>
    </div>
    <div class="dlc-module-grid">
      <div class="dlc-sub-card" onclick="app.nav('planning')" style="border-color:#0891b2;background:linear-gradient(135deg,#ecfeff,#fff);">
        <i class="fas fa-calendar-days" style="color:#0891b2;font-size:30px;"></i>
        <div class="sub-title" style="color:#0891b2;">PLANNING RH</div>
        <div class="sub-sub">Planification équipe</div>
      </div>
      <div class="dlc-sub-card" onclick="app.inspection.render();app.nav('inspection')" style="border-color:#475569;background:linear-gradient(135deg,#f8fafc,#fff);">
        <i class="fas fa-chart-bar" style="color:#475569;font-size:30px;"></i>
        <div class="sub-title" style="color:#475569;">INSPECTION</div>
        <div class="sub-sub">Rapports & export</div>
      </div>
      <div class="dlc-sub-card wide" onclick="app.nav('carrefour')" style="border-color:#003896;background:linear-gradient(135deg,#eff6ff,#fff);">
        <i class="fas fa-store" style="color:#003896;font-size:30px;"></i>
        <div class="sub-title" style="color:#003896;">MODULE CARREFOUR</div>
        <div class="sub-sub">Dynacad • METI • Alert Net • Outils franchise</div>
      </div>
      <div class="dlc-sub-card wide" onclick="app.nav('chat')" style="border-color:#0891b2;background:linear-gradient(135deg,#f0f9ff,#fff);">
        <div id="badge-chat-gm" style="display:none;background:#ef4444;color:#fff;border-radius:20px;padding:2px 8px;font-size:11px;font-weight:950;margin-bottom:4px;">0 nouveau(x)</div>
        <i class="fas fa-comments" style="color:#0891b2;font-size:30px;"></i>
        <div class="sub-title" style="color:#0891b2;">MESSAGERIE</div>
        <div class="sub-sub">Canaux de discussion équipe</div>
      </div>
    </div>
  </div>

  <!-- PLANNING MODULE -->
  <div id="view-planning" class="hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h2 style="margin:0;font-size:18px;color:#0891b2;"><i class="fas fa-calendar-days"></i> Planning RH</h2>
    </div>
    <!-- Règles RH France info card -->
    <div class="card" style="border-left:5px solid #0891b2;margin-bottom:12px;">
      <div style="font-weight:950;color:#0891b2;margin-bottom:8px;"><i class="fas fa-scale-balanced"></i> Règles droit du travail France</div>
      <div style="font-size:13px;line-height:1.8;color:#334155;">
        <b>⏱ Durée max quotidienne :</b> 10h/jour (dérogation 12h possible)<br>
        <b>📅 Durée max hebdomadaire :</b> 48h/semaine (44h en moyenne sur 12 semaines)<br>
        <b>😴 Repos quotidien :</b> 11h consécutives minimum<br>
        <b>📆 Repos hebdomadaire :</b> 35h consécutives (2 jours dont dimanche)<br>
        <b>🔴 Jours de repos :</b> 2 jours/semaine minimum<br>
        <b>🌙 Travail de nuit :</b> 21h–6h → majoration 25%<br>
        <b>🏖 Congés payés :</b> 2.5 jours ouvrables/mois
      </div>
    </div>

    <!-- Planning builder -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="font-weight:950;color:#0891b2;">Semaine <span id="plan-week-label"></span></div>
        <div style="display:flex;gap:8px;">
          <button class="qty-btn" onclick="app.planning.prevWeek()"><i class="fas fa-chevron-left"></i></button>
          <button class="qty-btn" onclick="app.planning.nextWeek()"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div id="plan-employees" style="margin-bottom:12px;"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn" style="background:#0891b2;margin-top:0;flex:1;" onclick="app.planning.addEmployee()"><i class="fas fa-user-plus"></i> Ajouter employé</button>
        <button class="btn secondary" style="margin-top:0;" onclick="app.planning.exportCSV()"><i class="fas fa-file-csv"></i></button>
      </div>
    </div>

    <!-- Weekly summary -->
    <div class="card" id="plan-summary" style="display:none;">
      <div style="font-weight:950;color:#0891b2;margin-bottom:8px;"><i class="fas fa-chart-bar"></i> Récapitulatif</div>
      <div id="plan-summary-content"></div>
    </div>
  </div>

  <!-- TEAM -->
  <div id="view-team" class="hidden">
    <div class="card" style="border-left:5px solid #003896;background:linear-gradient(135deg,#eff6ff,#fff);">
      <h3 style="margin-top:0;color:#003896;"><i class="fas fa-grip-vertical"></i> Réorganiser l'écran d'accueil</h3>
      <p class="small" style="color:#64748b;margin-bottom:12px;">Déplacez les modules à votre convenance. Les modifications sont instantanées.</p>
      <button class="btn" onclick="app.nav('home');setTimeout(()=>app.homeOrder.startEdit(),100)"><i class="fas fa-arrows-up-down-left-right"></i> Réorganiser les modules</button>
    </div>
    <div class="card" style="border-left:5px solid #0891b2;background:linear-gradient(135deg,#f0f9ff,#fff);">
      <h3 style="margin-top:0;color:#0891b2;"><i class="fas fa-eye"></i> Rôle Conseiller Franchise</h3>
      <p class="small" style="color:#64748b;margin-bottom:10px;">Le rôle <b>Conseiller</b> donne un accès en <b>lecture seule</b> à toute l'application — le conseiller peut consulter mais ne peut rien modifier. Créez un compte dédié ci-dessous avec le rôle "conseiller (lecture seule)".</p>
      <div style="background:#e0f2fe;border-radius:10px;padding:10px 12px;font-size:13px;color:#0369a1;font-weight:800;">
        <i class="fas fa-info-circle"></i> Créez un compte avec le rôle <b>conseiller (lecture seule)</b> dans le formulaire ci-dessous.
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0;">Créer un compte staff</h3>
      <input id="new-u-name"  placeholder="Nom (ex: LUCAS)" autocomplete="off">
      <input id="new-u-email" placeholder="Email (ex: lucas@...)" inputmode="email" autocomplete="off">
      <select id="new-u-role"><option value="staff">staff</option><option value="conseiller">conseiller (lecture seule)</option><option value="admin">admin</option></select>
      <button class="btn" onclick="app.team.createStaff()">Créer + envoyer lien mot de passe</button>
      <div class="small">Le staff clique "Mot de passe oublié" sur l'écran de login.</div>
    </div>
    <div class="card">
      <h3 style="margin-top:0;">Utilisateurs</h3>
      <div id="user-list"></div>
    </div>
  </div>
  <!-- CHAT MODULE -->
  <div id="view-chat" class="hidden">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      <button class="qty-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i></button>
      <div>
        <div style="font-weight:950;font-size:18px;color:var(--primary);"><i class="fas fa-comments"></i> Messagerie</div>
        <div class="small" style="margin-top:2px;">Communication équipe Express Purpan</div>
      </div>
    </div>
    <div class="chat-layout">
      <div class="chat-channels" id="chat-channel-list"></div>
      <div class="chat-messages-wrap" id="chat-messages">
        <div style="text-align:center;padding:20px;color:#94a3b8;">Sélectionnez un canal</div>
      </div>
      <div class="chat-input-row">
        <textarea id="chat-input" placeholder="Écrivez un message…" rows="1" onkeydown="app.chat.sendOnEnter(event)"></textarea>
        <button class="chat-send-btn" onclick="app.chat.send()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</main>

<!-- DYNACAD OVERLAY (fullscreen iframe) -->
<div id="dynacad-overlay" style="display:none;">
  <div id="dynacad-bar">
    <button onclick="app.dynacad.close()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:13px;"><i class="fas fa-arrow-left"></i> RETOUR</button>
    <span style="font-weight:950;font-size:15px;"><i class="fas fa-store"></i> DYNACAD Carrefour</span>
    <button onclick="app.dynacad.openExternal()" style="margin-left:auto;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:12px;"><i class="fas fa-external-link-alt"></i> Ouvrir</button>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;background:#f0f4f8;">
    <!-- Login helper shown when iframe is blocked -->
    <div id="dynacad-login-helper" style="padding:20px;text-align:center;">
      <div style="background:#fff;border-radius:16px;padding:24px;max-width:340px;margin:0 auto;box-shadow:0 8px 30px rgba(0,0,0,.1);">
        <div style="font-size:36px;margin-bottom:12px;">🔐</div>
        <div style="font-weight:950;font-size:17px;color:#003896;margin-bottom:8px;">Connexion Dynacad</div>
        <div class="small" style="margin-bottom:16px;">Cliquez sur le bouton ci-dessous pour ouvrir Dynacad avec vos identifiants pré-remplis.</div>
        <div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:16px;text-align:left;">
          <div class="small" style="font-weight:800;color:#64748b;margin-bottom:4px;">IDENTIFIANTS</div>
          <div style="font-weight:900;font-size:14px;">ID : jonathan_araujo_4</div>
          <div style="font-weight:900;font-size:14px;color:#64748b;">MDP : PurpanCHU32?</div>
        </div>
        <button onclick="app.dynacad.openExternal()" class="btn" style="background:#003896;"><i class="fas fa-external-link-alt"></i> Ouvrir Dynacad</button>
        <div class="small" style="margin-top:10px;color:#94a3b8;">Les identifiants sont copiés dans le presse-papier</div>
      </div>
    </div>
    <iframe id="dynacad-iframe" src="about:blank" style="flex:1;border:none;width:100%;display:none;"></iframe>
  </div>
</div>

<!-- METI OVERLAY (fullscreen iframe) -->
<div id="meti-overlay" style="display:none;position:fixed;inset:0;z-index:9500;background:#000;flex-direction:column;">
  <div style="background:var(--carrefour-red);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-shrink:0;height:50px;">
    <button onclick="app.metiPortal.close()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:13px;"><i class="fas fa-arrow-left"></i> RETOUR</button>
    <span style="font-weight:950;font-size:15px;"><i class="fas fa-laptop"></i> METI — VPN Carrefour</span>
    <button onclick="app.metiPortal.openExternal()" style="margin-left:auto;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:12px;"><i class="fas fa-external-link-alt"></i> Ouvrir</button>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;background:#f0f4f8;overflow-y:auto;">
    <div style="padding:20px;text-align:center;">
      <div style="background:#fff;border-radius:16px;padding:24px;max-width:400px;margin:0 auto;box-shadow:0 8px 30px rgba(0,0,0,.1);">
        <div style="font-size:36px;margin-bottom:12px;">🔐</div>
        <div style="font-weight:950;font-size:17px;color:var(--carrefour-red);margin-bottom:8px;">Connexion METI</div>
        <div class="small" style="margin-bottom:16px;line-height:1.6;">Le portail METI nécessite une connexion VPN Pulse Secure. Assurez-vous d'être connecté au VPN avant d'accéder à ce module.</div>
        <div style="background:#fff5f5;border:1.5px solid #fca5a5;border-radius:10px;padding:12px;margin-bottom:16px;text-align:left;">
          <div class="small" style="font-weight:900;color:var(--carrefour-red);margin-bottom:6px;"><i class="fas fa-triangle-exclamation"></i> PRÉREQUIS VPN</div>
          <div style="font-size:13px;line-height:1.7;">
            1. Aller sur <b>vpnportal.carrefour.com/franchise</b><br>
            2. Cliquer sur <b>Démarrer</b> (application Pulse)<br>
            3. Cliquer sur <b>Ouvrir Pulse Secure</b><br>
            4. Cliquer sur <b>Oui / Toujours</b><br>
            5. Vérifier la connexion dans la barre système
          </div>
        </div>
        <button onclick="app.metiPortal.openExternal()" class="btn" style="background:var(--carrefour-red);"><i class="fas fa-external-link-alt"></i> Accéder à METI</button>
        <button onclick="window.open('https://vpnportal.carrefour.com/franchise','_blank','noopener')" class="btn secondary" style="margin-top:8px;"><i class="fas fa-shield"></i> Ouvrir VPN Portal</button>
      </div>
    </div>
  </div>
</div>

<!-- MYTRAVIS OVERLAY -->
<div id="mytravis-overlay" style="display:none;position:fixed;inset:0;z-index:9500;background:#000;flex-direction:column;">
  <div style="background:#0369a1;color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-shrink:0;height:50px;">
    <button onclick="app.mytravis.close()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:13px;"><i class="fas fa-arrow-left"></i> RETOUR</button>
    <span style="font-weight:950;font-size:15px;">🚚 MyTravis — Suivi camion</span>
    <button onclick="app.mytravis.openExternal()" style="margin-left:auto;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:900;cursor:pointer;font-size:12px;"><i class="fas fa-external-link-alt"></i> Ouvrir</button>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;">
    <iframe id="mytravis-iframe" src="about:blank" style="flex:1;border:none;width:100%;"></iframe>
  </div>
</div>

<nav id="app-nav" class="hidden">
  <div class="nav-btn" onclick="app.goBack()"><i class="fas fa-arrow-left"></i><br>RETOUR</div>
  <div class="nav-btn" onclick="app.nav('home')"><i class="fas fa-th-large"></i><br>MENU</div>
</nav>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,doc,setDoc,getDoc,collection,addDoc,getDocs,deleteDoc,
  query,where,orderBy,limit,doc as fDoc,onSnapshot,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,onAuthStateChanged,signInWithEmailAndPassword,signOut,
  sendPasswordResetEmail,createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getStorage,ref as sRef,uploadString,getDownloadURL,deleteObject
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const FB={
  apiKey:"AIzaSyA0ffa4Nfa7kGLyaEcAocU9YzIhzmx3SkA",
  authDomain:"araujo-exploitation.firebaseapp.com",
  projectId:"araujo-exploitation",
  storageBucket:"araujo-exploitation.firebasestorage.app",
  messagingSenderId:"292878114487",
  appId:"1:292878114487:web:2a450227310e970ce1b732"
};
const appFb=initializeApp(FB);
const db=getFirestore(appFb);
const auth=getAuth(appFb);
const storage=getStorage(appFb);
const sec=initializeApp(FB,"Secondary");
const secAuth=getAuth(sec);

const docUsers=doc(db,"store_master","DATA_USERS");
const docFrais=doc(db,"store_master","DATA_FRAIS");
const docPVP  =doc(db,"store_master","DATA_PVP");
const docSalad=doc(db,"store_master","DATA_SALAD");
const docFrigo=doc(db,"store_master","DATA_FRIGO");
const docTodo =doc(db,"store_master","DATA_TODO");
const colTodoLogs=collection(db,"todo_logs");
// Expose for chat module
window._db=db;
window._fbChat={collection,query,orderBy,limit,onSnapshot,addDoc,serverTimestamp,where,getDocs,deleteDoc,doc,setDoc,getDoc};
const colReception=collection(db,"reception_logs");
const TRACE_PREFIX={salad:"salad_traca",pvp:"pvp_traca"};
const colTraceFor=(mod,pid)=>collection(db,TRACE_PREFIX[mod],String(pid),"items");

const codeReader=new ZXing.BrowserMultiFormatReader();

// ── ZONE COLOR PALETTE ──
const ZONE_COLORS=[
  "#7c3aed","#1d4ed8","#0891b2","#15803d",
  "#d97706","#dc2626","#db2777","#475569"
];

// ── FRENCH DAY LABELS (getDay() = 0=Sun) ──
const DAY_LABELS=["D","L","M","M","J","V","S"];
const DAY_FULL  =["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];

// ── DATE UTILITIES ──
const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;};
const tsToInput=ts=>{const d=new Date(ts),l=new Date(d.getTime()-d.getTimezoneOffset()*60000);return l.toISOString().slice(0,16);};
const inputToTs=v=>{if(!v)return Date.now();const t=new Date(v).getTime();return isNaN(t)?Date.now():t;};
const formatDate=ts=>{const d=new Date(ts);if(isNaN(d.getTime()))return "--/--";return `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
const dayBounds=ts=>{const d=new Date(ts||Date.now()),s=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0).getTime(),e=new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999).getTime();return{start:s,end:e};};

// ── TOAST / UI HELPERS ──
const toast=(msg,type='info',dur=3200)=>{
  const icons={ok:'circle-check',err:'circle-xmark',warn:'triangle-exclamation',info:'circle-info'};
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<i class="fas fa-${icons[type]||'circle-info'}"></i><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{el.classList.add('toast-out');setTimeout(()=>el.remove(),220);},dur);
};
const spin=s=>document.getElementById('spinner-overlay').classList.toggle('hidden',!s);
const dlgConfirm=(title,msg,danger=true)=>new Promise(r=>{
  const m=document.getElementById('modal-confirm');
  const ok=document.getElementById('dlg-ok');
  const can=document.getElementById('dlg-cancel');
  document.getElementById('dlg-title').textContent=title;
  document.getElementById('dlg-msg').textContent=msg;
  ok.className=`btn ${danger?'danger':'success'}`;ok.style.margin='0';
  m.classList.remove('hidden');
  const done=v=>{m.classList.add('hidden');ok.onclick=null;can.onclick=null;r(v);};
  ok.onclick=()=>done(true);can.onclick=()=>done(false);
});
const dlgPrompt=(title,def='',type='text')=>new Promise(r=>{
  const m=document.getElementById('modal-prompt');
  const inp=document.getElementById('pmt-input');
  const ok=document.getElementById('pmt-ok');
  const can=document.getElementById('pmt-cancel');
  document.getElementById('pmt-title').textContent=title;
  inp.type=type;inp.value=def||'';
  m.classList.remove('hidden');
  setTimeout(()=>inp.focus(),120);
  const done=v=>{m.classList.add('hidden');ok.onclick=null;can.onclick=null;inp.onkeydown=null;r(v);};
  ok.onclick=()=>done(inp.value);
  can.onclick=()=>done(null);
  inp.onkeydown=e=>{if(e.key==='Enter')done(inp.value);if(e.key==='Escape')done(null);};
});

// ── SALAD DEFAULTS ──
const SALAD_DEF=[
  {family:"SALADE",name:"Batavia",hours:48},{family:"SALADE",name:"Mâche",hours:48},{family:"SALADE",name:"Melange Gourmand",hours:48},{family:"SALADE",name:"Iceberg",hours:48},
  {family:"BASE",name:"Penne au basilic",hours:48},{family:"BASE",name:"Garganelli et graines de lin",hours:48},{family:"BASE",name:"Quinoa Boulgour,Tomates mi-séches,feves de soja",hours:48},{family:"BASE",name:"Boulgour et lentilles",hours:48},{family:"BASE",name:"Farfalles au pesto",hours:48},
  {family:"LEGUMES ET FRUITS",name:"Tomates cerise marinées",hours:48},{family:"LEGUMES ET FRUITS",name:"Légumes Grillées",hours:48},{family:"LEGUMES ET FRUITS",name:"Duo de carrotes",hours:48},{family:"LEGUMES ET FRUITS",name:"Betrave",hours:48},{family:"LEGUMES ET FRUITS",name:"Pois Chiches",hours:48},{family:"LEGUMES ET FRUITS",name:"Avocat",hours:24},
  {family:"PROTEINE",name:"Œufs durs",hours:48},{family:"PROTEINE",name:"Poulet émincé",hours:48},{family:"PROTEINE",name:"Jambon Cuit",hours:48},{family:"PROTEINE",name:"Thon",hours:48},
  {family:"FROMAGES",name:"Billes mozzarella",hours:48},{family:"FROMAGES",name:"Emmental",hours:48},
  {family:"FECULENTS",name:"Boulgour",hours:48},{family:"FECULENTS",name:"Riz sauvage",hours:48},
  {family:"TOPPING",name:"Crumble Salé",hours:168},{family:"TOPPING",name:"Sauce Balsamique",hours:1920},{family:"TOPPING",name:"Sauce Caesar",hours:1920}
].map(x=>({...x,id:null}));

window.app={
  me:null,
  data:{
    frais:[],users:[],pvpLib:[],pvpStock:[],checkedNeeds:[],
    saladLib:[],saladStock:[],
    frigo:{perDay:2,fridges:[],logs:[]},
    todo:{zones:[],tasks:[]},
    todoLogs:[], // today's completions
    reception:[] // reception logs in memory (last 30 days)
  },
  viewHistory:[],closed:new Set(),debounceTimer:null,saveTimers:{},

  // ── TOASTS / HELPERS ──
  ok:m=>toast(m,'ok'),err:m=>toast(m,'err',5000),warn:m=>toast(m,'warn'),info:m=>toast(m,'info'),

  // ── OFFLINE ──
  initOffline(){
    const b=document.getElementById('offline-banner');
    window.addEventListener('offline',()=>b.classList.add('show'));
    window.addEventListener('online', ()=>b.classList.remove('show'));
    if(!navigator.onLine)b.classList.add('show');
  },

  // ── AUTH ──
  auth:{
    login:async function(){
      const e=(document.getElementById('login-email').value||'').trim();
      const p=(document.getElementById('login-pass').value||'').trim();
      const box=document.getElementById('login-error');
      box.style.display='none';
      if(!e||!p){box.style.display='block';box.textContent='Email et mot de passe requis.';return;}
      const btn=document.getElementById('login-btn');
      btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';
      try{await signInWithEmailAndPassword(auth,e,p);document.getElementById('login-pass').value='';}
      catch(err){box.style.display='block';box.textContent='Connexion refusée. Vérifie l\'email / mot de passe.';}
      finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-right-to-bracket"></i> CONNEXION';}
    },
    forgot:async function(){
      const e=(document.getElementById('login-email').value||'').trim();
      const box=document.getElementById('login-error');
      if(!e){box.style.display='block';box.textContent='Tape ton email puis clique "Mot de passe oublié".';return;}
      try{await sendPasswordResetEmail(auth,e);toast('Email de réinitialisation envoyé.','ok');}
      catch(err){box.style.display='block';box.textContent='Impossible d\'envoyer le reset.';}
    },
    logout:async function(){
      if(window.app._todoUnsubscribe){try{window.app._todoUnsubscribe();}catch(e){}}
      try{await signOut(auth);}catch(e){}
    }
  },

  saveDebounced(sec,delay=350){
    if(this.saveTimers[sec])clearTimeout(this.saveTimers[sec]);
    this.saveTimers[sec]=setTimeout(async()=>{try{await this.save(sec);}catch(e){}},delay);
  },

  loadAll:async function(){
    const[uS,fS,pS,sS,frS,tdS]=await Promise.all([
      getDoc(docUsers),getDoc(docFrais),getDoc(docPVP),getDoc(docSalad),getDoc(docFrigo),getDoc(docTodo)
    ]);
    this.data.users=uS.exists()?(uS.data().list||[]):[];
    this.data.frais=fS.exists()?(fS.data().list||[]):[];
    if(pS.exists()){const d=pS.data();this.data.pvpLib=d.lib||[];this.data.pvpStock=d.stock||[];this.data.checkedNeeds=d.needs||[];}
    else{this.data.pvpLib=[];this.data.pvpStock=[];this.data.checkedNeeds=[];}
    if(sS.exists()){const d=sS.data();this.data.saladLib=d.lib||[];this.data.saladStock=d.stock||[];}
    else{this.data.saladLib=[];this.data.saladStock=[];}
    if(frS.exists()){const d=frS.data()||{};this.data.frigo.perDay=Number(d.perDay||2);this.data.frigo.fridges=d.fridges||[];this.data.frigo.logs=d.logs||[];}
    else{this.data.frigo={perDay:2,fridges:[],logs:[]};}
    if(tdS.exists()){const d=tdS.data()||{};this.data.todo.zones=d.zones||[];this.data.todo.tasks=d.tasks||[];}
    else{this.data.todo={zones:[],tasks:[]};}
  },

  _todoUnsubscribe:null,

  _startTodoSync(){
    if(this._todoUnsubscribe){try{this._todoUnsubscribe();}catch(e){}}
    const today=todayStr();
    try{
      const q=query(colTodoLogs,where("date","==",today));
      this._todoUnsubscribe=onSnapshot(q,snap=>{
        this.data.todoLogs=[];
        snap.forEach(d=>this.data.todoLogs.push({_id:d.id,...d.data()}));
        this.todo.renderToday();
        this.updateHomeBadges();
      },err=>{/* silently ignore permission errors */});
    }catch(e){}
  },

  loadReceptionLogs:async function(){
    try{
      const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);
      const cutTs=cutoff.getTime();
      const q=query(colReception,where("ts",">=",cutTs),orderBy("ts","desc"),limit(200));
      const snap=await getDocs(q);
      this.data.reception=[];
      snap.forEach(d=>this.data.reception.push({_id:d.id,...d.data()}));
    }catch(e){this.data.reception=[];}
  },

  loadTodoLogs:async function(){
    // Load today's completions
    const today=todayStr();
    try{
      const q=query(colTodoLogs,where("date","==",today));
      const snap=await getDocs(q);
      this.data.todoLogs=[];
      snap.forEach(d=>this.data.todoLogs.push({_id:d.id,...d.data()}));
    }catch(e){this.data.todoLogs=[];}
  },

  save:async function(sec){
    if(!auth.currentUser)throw new Error("Not logged");
    if(sec==='users')await setDoc(docUsers,{list:this.data.users});
    if(sec==='frais')await setDoc(docFrais,{list:this.data.frais});
    if(sec==='pvp')  await setDoc(docPVP,  {lib:this.data.pvpLib,stock:this.data.pvpStock,needs:this.data.checkedNeeds});
    if(sec==='salad')await setDoc(docSalad,{lib:this.data.saladLib,stock:this.data.saladStock});
    if(sec==='frigo')await setDoc(docFrigo,{perDay:Number(this.data.frigo.perDay||2),fridges:this.data.frigo.fridges||[],logs:this.data.frigo.logs||[]});
    if(sec==='todo') await setDoc(docTodo, {zones:this.data.todo.zones||[],tasks:this.data.todo.tasks||[]});
  },

  afterLoginBootstrap:async function(){
    spin(true);
    try{
      await this.loadAll();
      if(!this.data.users.length){
        const email=auth.currentUser.email||"";
        const name=(email.split("@")[0]||"ADMIN").toUpperCase();
        this.data.users=[{uid:auth.currentUser.uid,email,name,role:"admin"}];
        await this.save("users");
      }
      if(!this.data.saladLib.length){
        this.data.saladLib=SALAD_DEF.map(x=>({id:Date.now()+Math.floor(Math.random()*1000000),family:x.family,name:x.name,hours:x.hours}));
        await this.save("salad");
      }
      this.me=this.data.users.find(u=>u.uid===auth.currentUser.uid)||null;
      if(!this.me){toast('Compte non autorisé.','err');await signOut(auth);return;}

      await this.loadTodoLogs();
      await this.loadReceptionLogs();

      // Start real-time sync for today's todo logs
      this._startTodoSync();

      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('app-header').classList.remove('hidden');
      document.getElementById('app-nav').classList.remove('hidden');
      document.getElementById('user-badge').innerText=this.me.name||(this.me.email||"USER");
      const isAdmin=this.me.role==='admin';
      const isConseiller=this.me.role==='conseiller';
      if(isAdmin)document.getElementById('btn-team').classList.remove('hidden');
      else document.getElementById('btn-team').classList.add('hidden');
      // Bannière bleue lecture seule pour conseiller
      const cb=document.getElementById('conseiller-banner');
      if(cb)cb.classList.toggle('show',isConseiller);
      // Masquer le bouton de réorganisation si pas admin
      const reorgBtn=document.getElementById('home-reorder-btn');
      if(reorgBtn)reorgBtn.style.display=isAdmin?'flex':'none';

      // Show/hide create buttons based on permissions
      const pvpCreateBtn=document.getElementById('pvp-create-btn');
      if(pvpCreateBtn)pvpCreateBtn.style.display=this.canDo('pvpLib')?'':'none';
      const saladCreateBtn=document.getElementById('salad-create-btn');
      if(saladCreateBtn)saladCreateBtn.style.display=this.canDo('saladLib')?'':'none';

      this.updateUI();
    }finally{spin(false);}
  },

  updateUI(){
    this.frais.render();this.pvp.render();this.salad.render();
    this.frigo.render();this.todo.renderToday();
    this.team.renderUsers();this.checkAlerts();this.updateHomeBadges();
  },

  updateDlcBadges(){
    // Count frais DLC today
    const today=new Date();today.setHours(0,0,0,0);
    const fraisCount=window.app.data.frais.filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;}).length;
    const fb=document.getElementById('badge-frais-dlc');
    if(fb){fb.style.display=fraisCount>0?'inline-block':'none';fb.textContent=fraisCount+' à DLC';}
    // Count PVP expired today
    const pvpCount=window.app.data.pvpStock.filter(i=>new Date(i.end)<new Date()).length;
    const pb=document.getElementById('badge-pvp-dlc');
    if(pb){pb.style.display=pvpCount>0?'inline-block':'none';pb.textContent=pvpCount+' à jeter';}
  },

  updateHomeBadges(){
    // Frais
    const today=new Date();today.setHours(0,0,0,0);
    const fraisCnt=this.data.frais.filter(i=>{const d=new Date(i.date);return !isNaN(d.getTime())&&d<=today;}).length;
    const bf=document.getElementById('badge-frais');
    if(bf){bf.textContent=fraisCnt;bf.classList.toggle('hidden',fraisCnt===0);}
    const chip=document.getElementById('frais-today-chip');
    if(chip)chip.innerHTML=`<i class="fas fa-calendar-day"></i> ${fraisCnt}`;

    // Frigo
    const frigoRem=this.frigo.remainingTodayTotal();
    const bfr=document.getElementById('badge-frigo');
    if(bfr){bfr.textContent=frigoRem;bfr.classList.toggle('hidden',frigoRem===0);}
    const frigoChip=document.getElementById('frigo-remaining-chip');
    if(frigoChip)frigoChip.innerHTML=`<i class="fas fa-list-check"></i> ${frigoRem}`;
    const frigoLabel=document.getElementById('frigo-perday-label');
    if(frigoLabel)frigoLabel.textContent=this.data.frigo.perDay||2;

    // Todo
    const todayTasks=this.todo.todayTaskList();
    const doneTodayIds=new Set(this.data.todoLogs.map(l=>String(l.taskId)));
    const pending=todayTasks.filter(t=>!doneTodayIds.has(String(t.id))).length;
    const bt=document.getElementById('badge-todo');
    if(bt){bt.textContent=pending;bt.classList.toggle('hidden',pending===0);}
  },

  nav(v,saveHistory=true){
    if(this.frais&&this.frais.scanning)this.frais.toggleScan();
    if(this.frais&&this.frais.tgtgScanning)this.frais.tgtgToggleScan();
    const cur=document.querySelector('main > div:not(.hidden)');
    if(saveHistory&&cur)this.viewHistory.push(cur.id.replace('view-',''));
    document.querySelectorAll('main > div').forEach(e=>e.classList.add('hidden'));
    const el=document.getElementById('view-'+v);
    if(el)el.classList.remove('hidden');
    if(v==='dlc'){this.updateDlcBadges();this.checkAlerts();}
    if(v==='todo'){this.todo.renderToday();this.todo.tab('today');}
    if(v==='reception'){this.reception.init();this.reception.tab('new');}
    if(v==='inspection'){this.inspection.render();}
    if(v==='etiquettes'){this.etiquettes.loadProducts();}
    if(v==='planning'){this.planning.render();}
    if(v==='chat'){this.chat.render();}
    if(v==='home'){this._maybeShowInstallPrompt();}
  },
  goBack(){if(this.viewHistory.length)this.nav(this.viewHistory.pop(),false);else this.nav('home',false);},
  toggleFam(id){if(this.closed.has(id))this.closed.delete(id);else this.closed.add(id);this.updateUI();},
  checkAlerts(){
    const a=this.data.frais.some(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&(d-new Date())/(1000*60*60*24)<1;});
    const box=document.getElementById('alert-box');
    if(box)box.style.display=a?'block':'none';
    // Badge rouge sur le bouton DLC de l'accueil
    const bf=document.getElementById('badge-frais');
    if(bf){const cnt=this.data.frais.filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=new Date();}).length;bf.textContent=cnt;bf.classList.toggle('hidden',cnt===0);}
  },

  common:{
    showBarcode(ean,name,imgUrl=null){
      document.getElementById('modal-barcode').classList.remove('hidden');
      document.getElementById('bc-name').innerText=name||"";
      const imgEl=document.getElementById('bc-img-display');
      if(imgUrl){imgEl.src=imgUrl;imgEl.style.display='block';}else{imgEl.style.display='none';}
      if(ean){try{JsBarcode("#barcode",ean,{format:"EAN13",height:80,displayValue:true});}catch(e){try{JsBarcode("#barcode",ean,{format:"CODE128",height:80,displayValue:true});}catch(e2){}}}
      else{try{document.querySelector("#barcode").innerHTML="";}catch(e){}}
    },
    parseDateLocal(dateStr){if(!dateStr)return null;const p=dateStr.split('-');return new Date(p[0],p[1]-1,p[2],12,0,0).getTime();},
    dateToInputLocal(ts){if(!ts)return"";const d=new Date(ts);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;},
    tsToInput,formatDate,inputToTs,dayBounds,
    calculateEnd(startTs,hours){
      const h=parseInt(hours||0,10);
      if(h===0){
        // JOURNÉE → fin du jour courant à 22:00
        const d=new Date(startTs);
        return new Date(d.getFullYear(),d.getMonth(),d.getDate(),22,0,0,0).getTime();
      }
      // Calcul en millisecondes pur — fiable quelle que soit la durée
      return startTs + h * 3600 * 1000;
    },
    cleanName(name){return(name||"").toUpperCase().replace(/^[\d\s\.,xX]+(G|KG|ML|CL|L|P)?\s*/g,'');},
    randPwd(len=14){const c="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";let o="";for(let i=0;i<len;i++)o+=c[Math.floor(Math.random()*c.length)];return o;},
    compressImg(file,callback){const r=new FileReader();r.readAsDataURL(file);r.onload=e=>{const img=new Image();img.src=e.target.result;img.onload=()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');const mx=600;let w=img.width,h=img.height;if(w>h){if(w>mx){h*=mx/w;w=mx;}}else{if(h>mx){w*=mx/h;h=mx;}}c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);callback(c.toDataURL('image/jpeg',0.7));};};},
    isASaisir(dlcTs){if(!dlcTs)return false;const dlc=new Date(dlcTs);if(isNaN(dlc.getTime()))return false;const thr=new Date(dlc.getFullYear(),dlc.getMonth(),dlc.getDate()-1,18,0,0,0).getTime();const eod=new Date(dlc.getFullYear(),dlc.getMonth(),dlc.getDate(),23,59,59,999).getTime();const now=Date.now();return now>=thr&&now<=eod;}
  },

  // ── PERMISSIONS ──
  // Définition de toutes les permissions disponibles
  PERMS:{
    saladLib:    {label:'Modifier bibliothèque Salad Bar', icon:'fa-leaf',           group:'DLC'},
    saladStock:  {label:'Saisir stock Salad Bar',         icon:'fa-bowl-food',       group:'DLC'},
    pvpLib:      {label:'Modifier bibliothèque PVP',      icon:'fa-store',           group:'DLC'},
    pvpStock:    {label:'Saisir stock PVP',               icon:'fa-boxes-stacked',   group:'DLC'},
    fraisEdit:   {label:'Modifier / supprimer Frais',     icon:'fa-calendar-xmark',  group:'DLC'},
    frigoConfig: {label:'Configurer les frigos',          icon:'fa-temperature-low', group:'TEMPÉRATURES'},
    frigoSaisie: {label:'Saisir relevés frigo',           icon:'fa-pen-to-square',   group:'TEMPÉRATURES'},
    todoConfig:  {label:'Configurer la check-list',       icon:'fa-list-check',      group:'CHECK-LIST'},
    todoSaisie:  {label:'Valider tâches check-list',      icon:'fa-circle-check',    group:'CHECK-LIST'},
    dynacad:     {label:'Accès Dynacad',                  icon:'fa-store',           group:'CARREFOUR'},
    meti:        {label:'Accès METI (VPN Carrefour)',     icon:'fa-laptop',          group:'CARREFOUR'},
    planning:    {label:'Accès Planning RH',              icon:'fa-calendar-days',   group:'GESTION MAGASIN'},
    mytravis:    {label:'Suivi camion MyTravis',          icon:'fa-truck',           group:'RÉCEPTION'},
  },

  // Vérifie si l'utilisateur courant peut faire une action
  // admin = tout par défaut, staff = selon permissions
  canDo(perm){
    const me=this.me;
    if(!me)return false;
    if(me.role==='admin')return true;
    if(me.role==='conseiller')return false; // lecture seule — jamais de modification
    if(me.permissions&&me.permissions[perm]===true)return true;
    return false;
  },

  // ── TEAM ──
  team:{
    ensureAdmin(){if(!window.app.me||window.app.me.role!=='admin'){toast('Accès admin requis.','err');return false;}return true;},
    createStaff:async function(){
      if(!this.ensureAdmin())return;
      const name=(document.getElementById('new-u-name').value||'').trim().toUpperCase();
      const email=(document.getElementById('new-u-email').value||'').trim().toLowerCase();
      const role=document.getElementById('new-u-role').value||'staff';
      if(!name||!email)return toast('Nom + email requis.','warn');
      if(window.app.data.users.some(u=>(u.email||'').toLowerCase()===email))return toast('Email déjà présent.','warn');
      spin(true);
      try{
        const tmp=window.app.common.randPwd();
        const cred=await createUserWithEmailAndPassword(secAuth,email,tmp);
        window.app.data.users.push({uid:cred.user.uid,email,name,role});
        await window.app.save('users');
        await sendPasswordResetEmail(secAuth,email);
        try{await signOut(secAuth);}catch(e){}
        document.getElementById('new-u-name').value='';document.getElementById('new-u-email').value='';
        toast('Compte créé + email reset envoyé.','ok');this.renderUsers();
      }catch(e){
        const code=String(e?.code||'');
        if(code.includes('email-already-in-use'))toast('Email déjà utilisé.','err');
        else if(code.includes('invalid-email'))toast('Email invalide.','err');
        else toast('Erreur création compte.','err');
        try{await signOut(secAuth);}catch(err){}
      }finally{spin(false);}
    },
    resetPwd:async function(email){if(!this.ensureAdmin())return;if(!email)return;try{await sendPasswordResetEmail(auth,email);toast('Reset envoyé.','ok');}catch(e){toast('Impossible d\'envoyer le reset.','err');}},
    setRole:async function(uid,role){if(!this.ensureAdmin())return;const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;u.role=role;await window.app.save('users');this.renderUsers();},
    setName:async function(uid){if(!this.ensureAdmin())return;const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;const n=await dlgPrompt('Nom :',u.name||'');if(!n)return;u.name=n.trim().toUpperCase();await window.app.save('users');this.renderUsers();},
    renderUsers(){
      const wrap=document.getElementById('user-list');if(!wrap)return;
      const users=(window.app.data.users||[]).slice().sort((a,b)=>(a.role||'').localeCompare(b.role||'')||(a.name||'').localeCompare(b.name||''));
      if(!users.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-users-slash"></i>Aucun utilisateur.</div>`;return;}
      wrap.innerHTML=users.map(u=>{
        const chip=u.role==='admin'?`<span class="chip admin">ADMIN</span>`:`<span class="chip staff">STAFF</span>`;
        const permsBlock=u.role==='staff'?`
          <div style="margin-top:10px;">
            <div style="font-size:11px;font-weight:950;text-transform:uppercase;color:#64748b;margin-bottom:8px;">Permissions par module</div>
            ${(() => {
              const grouped = {};
              Object.entries(window.app.PERMS).forEach(([key,def]) => {
                const g = def.group || 'AUTRES';
                if(!grouped[g]) grouped[g] = [];
                grouped[g].push({key, ...def});
              });
              return Object.entries(grouped).map(([grp, perms]) => `
                <div style="margin-bottom:10px;">
                  <div style="font-size:10px;font-weight:950;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;padding:4px 8px;background:#f8fafc;border-radius:6px;">${grp}</div>
                  <div class="perm-grid">
                    ${perms.map(({key:k,label,icon}) => `
                    <div class="perm-toggle">
                      <label for="perm-${u.uid}-${k}"><i class="fas ${icon}" style="margin-right:5px;color:#64748b;"></i>${label}</label>
                      <input type="checkbox" id="perm-${u.uid}-${k}" ${(u.permissions||{})[k]?'checked':''} onchange="app.team.togglePerm('${u.uid}','${k}',this.checked)">
                    </div>`).join('')}
                  </div>
                </div>`).join('');
            })()}
          </div>`:'<div class="small" style="margin-top:6px;color:var(--muted);">Admin : accès complet à tout.</div>';
        return `<div style="padding:12px;border-bottom:1px solid #eee;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="min-width:0;"><div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.name||"(Sans nom)"} ${chip}</div><div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email||""}</div></div>
            <div style="display:flex;gap:8px;flex-shrink:0;">
              <button class="qty-btn" onclick="app.team.setName('${u.uid}')"><i class="fas fa-pen"></i></button>
              <button class="qty-btn" onclick="app.team.resetPwd('${u.email||''}')"><i class="fas fa-unlock-keyhole"></i></button>
            </div>
          </div>
          <div style="margin-top:10px;">
            <select onchange="app.team.setRole('${u.uid}',this.value)" style="margin:0;padding:10px;font-size:14px;">
              <option value="staff" ${u.role==='staff'?'selected':''}>staff</option>
              <option value="conseiller" ${u.role==='conseiller'?'selected':''}>conseiller (lecture seule)</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
            </select>
          </div>
          ${permsBlock}
        </div>`;
      }).join('');
    },

    togglePerm:async function(uid,perm,val){
      if(!this.ensureAdmin())return;
      const u=window.app.data.users.find(x=>x.uid===uid);if(!u)return;
      if(!u.permissions)u.permissions={};
      u.permissions[perm]=val;
      try{await window.app.save('users');toast(val?'Permission accordée.':'Permission retirée.','ok');}
      catch(e){toast('Erreur sauvegarde.','err');}
    }
  },

  // ── TRACE ──
  trace:{
    ctx:null,imgData:'',
    open:async function(mod,pid,name){
      document.getElementById('trace-file').value='';
      this.ctx={moduleKey:mod,productId:String(pid),productName:name||''};
      this.imgData='';
      document.getElementById('trace-preview').style.display='none';document.getElementById('trace-preview').src='';
      document.getElementById('trace-title').textContent=name||'';
      const h3=document.getElementById('trace-h3');
      const bp=document.getElementById('trace-btn-pick');
      const bs=document.getElementById('trace-btn-save');
      if(mod==='salad'){h3.style.color='var(--salad)';bp.className='btn salad';bs.className='btn salad';}
      else{h3.style.color='var(--pvp)';bp.className='btn pvp';bs.className='btn pvp';}
      document.getElementById('modal-trace').classList.remove('hidden');
      await this.loadHistory(true);
    },
    close(){document.getElementById('modal-trace').classList.add('hidden');this.ctx=null;this.imgData='';document.getElementById('trace-file').value='';},
    loadHistory:async function(cleanup=false){
      const wrap=document.getElementById('trace-history');wrap.textContent='Chargement…';
      const ctx=this.ctx;if(!ctx)return(wrap.textContent='—');
      const cutoff=Date.now()-(180*24*60*60*1000);
      if(cleanup){try{const qOld=query(colTraceFor(ctx.moduleKey,ctx.productId),where("createdAt","<",cutoff),limit(50));const s=await getDocs(qOld);const dels=[];s.forEach(d=>dels.push(deleteDoc(d.ref)));if(dels.length)await Promise.allSettled(dels);}catch(e){}}
      try{
        const q=query(colTraceFor(ctx.moduleKey,ctx.productId),orderBy("createdAt","desc"),limit(15));
        const snap=await getDocs(q);const rows=[];
        snap.forEach(d=>{const dt=d.data();if((dt.createdAt||0)>=cutoff)rows.push({_docId:d.id,...dt});});
        if(!rows.filter(r=>r.path).length){wrap.innerHTML="<div class='small'>Aucune photo récente.</div>";return;}
        wrap.innerHTML=rows.filter(r=>r.path).map(r=>{
          const when=formatDate(r.createdAt);
          const sp=(r.path||'').replace(/'/g,"\\'");const si=(r._docId||'').replace(/'/g,"\\'");
          return `<div style="padding:10px;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="min-width:0;"><div style="font-weight:900;">${when}</div><div class="small" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.path||''}</div></div>
            <div style="display:flex;gap:8px;flex-shrink:0;">
              <button class="icon-btn dark" onclick="app.trace.view('${sp}')"><i class="fas fa-eye"></i></button>
              <button class="icon-btn red"  onclick="app.trace.delOne('${si}','${sp}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
        }).join('');
      }catch(e){wrap.innerHTML="<div class='small'>Impossible de charger (Firestore rules).</div>";}
    },
    view:async function(path){if(!path)return;try{const url=await getDownloadURL(sRef(storage,path));window.app.common.showBarcode("","Tracabilité",url);}catch(e){toast('Photo introuvable.','err');}},
    delOne:async function(docId,path){
      const ctx=this.ctx;if(!ctx||!docId)return;
      const ok=await dlgConfirm('Supprimer photo','Supprimer cette tracabilité ?');if(!ok)return;
      try{await deleteDoc(doc(db,TRACE_PREFIX[ctx.moduleKey],String(ctx.productId),"items",String(docId)));}catch(e){}
      try{if(path)await deleteObject(sRef(storage,path));}catch(e){}
      await this.loadHistory(false);
    },
    save:async function(){
      const ctx=this.ctx;if(!ctx)return;if(!this.imgData)return toast('Aucune photo.','warn');
      const ts=Date.now();const d=new Date(ts);
      const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const sid=String(ctx.productId).replace(/[^a-zA-Z0-9_-]/g,'_');
      const path=`${TRACE_PREFIX[ctx.moduleKey]}/${sid}/${ym}/${ts}.jpg`;
      spin(true);
      try{
        await uploadString(sRef(storage,path),this.imgData,'data_url');
        await addDoc(colTraceFor(ctx.moduleKey,ctx.productId),{productId:String(ctx.productId),productName:ctx.productName,createdAt:ts,path});
        toast('Tracabilité enregistrée.','ok');
        this.imgData='';document.getElementById('trace-preview').style.display='none';document.getElementById('trace-preview').src='';document.getElementById('trace-file').value='';
        await this.loadHistory(true);
      }catch(e){toast('Erreur tracabilité.','err');}
      finally{spin(false);}
    }
  },

  // ── FRAIS ──
  frais:{
    scanning:false,tgtgScanning:false,imgUrl:'',
    tab(t){
      document.querySelectorAll('#view-frais .tab').forEach(e=>e.classList.remove('active'));
      const tabMap={scan:'tf-1',tgtg:'tf-3',list:'tf-2'};
      document.getElementById(tabMap[t]).classList.add('active');
      ['frais-scan','frais-tgtg','frais-list'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('frais-'+t).classList.remove('hidden');
      if(t==='list'){this.render();}
      if(t==='tgtg'){this.renderTgtg();}
    },
    toggleScan(){
      if(this.scanning){this.scanning=false;document.getElementById('scanner-box').style.display='none';try{codeReader.reset();}catch(e){}}
      else{this.scanning=true;document.getElementById('scanner-box').style.display='block';codeReader.decodeFromVideoDevice(null,'video',(r)=>{if(r){this.handleInput(r.text);this.toggleScan();}});}
    },
    tgtgToggleScan(){
      if(this.tgtgScanning){this.tgtgScanning=false;document.getElementById('tgtg-scanner-box').style.display='none';try{codeReader.reset();}catch(e){}}
      else{this.tgtgScanning=true;document.getElementById('tgtg-scanner-box').style.display='block';codeReader.decodeFromVideoDevice(null,'tgtg-video',(r)=>{if(r){this.tgtgHandleScan(r.text);this.tgtgToggleScan();}});}
    },
    tgtgHandleScan(ean){
      // Find product by EAN in frais list and deduct qty
      const match=window.app.data.frais.find(i=>String(i.ean||'')===String(ean));
      if(match){this.tgtgDeduct(match.id,true);}
      else{document.getElementById('tgtg-search').value=ean;this.renderTgtg();}
    },
    tgtgDeduct:async function(id,fromScan=false){
      const idx=window.app.data.frais.findIndex(x=>x.id==id);
      if(idx<0)return;
      const item=window.app.data.frais[idx];
      const currentQty=Number(item.qty||0);
      if(currentQty<=1){
        // Remove completely
        window.app.data.frais.splice(idx,1);
        toast(`${item.name} retiré du stock (Too Good To Go)`,fromScan?'ok':'info',3000);
      } else {
        window.app.data.frais[idx].qty=currentQty-1;
        toast(`${item.name} : ${currentQty}→${currentQty-1}`,'ok',2000);
      }
      spin(true);try{await window.app.save('frais');}catch(e){toast('Erreur synchro.','err');}finally{spin(false);}
      this.renderTgtg();this.render();window.app.updateHomeBadges();
    },
    renderTgtg(){
      const wrap=document.getElementById('tgtg-result-list');if(!wrap)return;
      const q=(document.getElementById('tgtg-search')?.value||'').toLowerCase().trim();
      const today=new Date();today.setHours(0,0,0,0);
      // Show products expiring today or with search
      const items=window.app.data.frais.filter(i=>{
        if(q){return(i.name||'').toLowerCase().includes(q)||(i.ean||'').includes(q);}
        const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;
      }).sort((a,b)=>new Date(a.date)-new Date(b.date));
      if(!items.length){
        wrap.innerHTML=`<div class="empty-state" style="padding:20px 0;"><i class="fas fa-check-circle" style="color:#006B3C;"></i>${q?'Aucun résultat':'Aucun produit à retirer aujourd\'hui 🎉'}</div>`;
        return;
      }
      wrap.innerHTML=items.map(i=>{
        const d=new Date(i.date);const dateStr=!isNaN(d.getTime())?d.toLocaleDateString('fr'):'?';
        return`<div class="list-item" style="border-left:4px solid #006B3C;">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:900;font-size:14px;">${i.name||''}</div>
            <div class="small">x${i.qty||0} • DLC: ${dateStr} • ${i.fam||''}</div>
          </div>
          <button onclick="app.frais.tgtgDeduct(${i.id})" style="background:#006B3C;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;white-space:nowrap;"><i class="fas fa-minus"></i> -1</button>
        </div>`;
      }).join('');
    },
    handleInput(val){
      const clean=String(val||'').replace(/\D/g,'').slice(0,13);
      document.getElementById('frais-ean').value=clean;
      if(window.app.debounceTimer)clearTimeout(window.app.debounceTimer);
      window.app.debounceTimer=setTimeout(()=>{if(clean.length===13)this.api(clean);},250);
    },
    api:async function(ean){try{const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${ean}.json`);const d=await r.json();if(d.status==1){document.getElementById('frais-name').value=d.product.product_name_fr||'';this.imgUrl=d.product.image_front_small_url||'';}}catch(e){}},
    add:async function(){
      const dateVal=document.getElementById('frais-date').value;
      const name=document.getElementById('frais-name').value;
      if(!name||!dateVal){toast('Nom et date requis.','warn');return;}
      const o={id:Date.now(),ean:document.getElementById('frais-ean').value,fam:document.getElementById('frais-fam').value,name,qty:document.getElementById('frais-qty').value,date:window.app.common.parseDateLocal(dateVal),img:this.imgUrl};
      window.app.data.frais.push(o);
      spin(true);try{await window.app.save('frais');toast('Produit ajouté.','ok');}catch(e){toast('Erreur sauvegarde.','err');}finally{spin(false);}
      this.imgUrl='';document.getElementById('frais-name').value='';document.getElementById('frais-ean').value='';
      window.app.updateHomeBadges();
    },
    render(){
      const div=document.getElementById('frais-list-items');if(!div)return;
      const q=(document.getElementById('frais-search')?.value||'').toLowerCase().trim();
      const grp={};
      const filtered=q?window.app.data.frais.filter(i=>(i.name||'').toLowerCase().includes(q)||(i.fam||'').toLowerCase().includes(q)||(i.ean||'').includes(q)):window.app.data.frais;
      filtered.slice().sort((a,b)=>(a.fam||'').localeCompare(b.fam||'')||(a.date||0)-(b.date||0)).forEach(i=>{if(!grp[i.fam])grp[i.fam]=[];grp[i.fam].push(i);});
      if(!Object.keys(grp).length){div.innerHTML=`<div class="empty-state"><i class="fas fa-box-open"></i>Aucun produit frais.</div>`;return;}
      const parts=[];
      for(const f in grp){
        const id='F-'+f;const c=window.app.closed.has(id);
        parts.push(`<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
        if(c)continue;
        grp[f].forEach(i=>{
          const d=new Date(i.date);let badge='bg-grey';
          if(!isNaN(d.getTime())){const diff=(d-new Date())/(1000*60*60*24);badge=diff<0?'bg-red':(diff<2?'bg-orange':'bg-green');}
          const sn=(i.name||'').replace(/'/g,' ');
          const img=i.img?`<img src="${i.img}" class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${sn}','${i.img}')">`:`<div class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${sn}')"><i class="fas fa-barcode"></i></div>`;
          const sc=window.app.common.isASaisir(i.date)?`<span class="chip warn"><i class="fas fa-triangle-exclamation"></i> À SAISIR</span>`:'';
          parts.push(`<div class="swipe-wrapper"><div class="swipe-content" onclick="app.frais.openEdit(${i.id})">
            <div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div class="item-info"><div class="item-title">${i.name||''}</div><div class="item-sub">x${i.qty||0} • ${i.ean||'EAN ?'} ${sc}</div></div></div>
            <div class="right-col"><div class="date-badge ${badge}"><span>${!isNaN(d.getTime())?d.getDate():'?'}</span><span style="font-size:10px;">${!isNaN(d.getTime())?d.toLocaleString('fr',{month:'short'}):'Err'}</span></div></div>
          </div></div>`);
        });
      }
      div.innerHTML=parts.join('');
    },
    openEdit(id){
      if(!window.app.canDo('fraisEdit')){toast('Permission refusée.','err');return;}
      const i=window.app.data.frais.find(x=>x.id==id);
      document.getElementById('modal-edit-frais').classList.remove('hidden');
      document.getElementById('edit-id').value=id;document.getElementById('edit-famille').value=i.fam;
      document.getElementById('edit-qty').value=i.qty;document.getElementById('edit-name').value=i.name;
      document.getElementById('edit-ean').value=i.ean;document.getElementById('edit-date').value=window.app.common.dateToInputLocal(i.date);
    },
    saveEdit:async function(){
      const id=document.getElementById('edit-id').value;
      const idx=window.app.data.frais.findIndex(x=>String(x.id)===String(id));
      if(idx>-1){
        window.app.data.frais[idx].fam=document.getElementById('edit-famille').value;
        window.app.data.frais[idx].qty=document.getElementById('edit-qty').value;
        window.app.data.frais[idx].name=document.getElementById('edit-name').value;
        window.app.data.frais[idx].ean=document.getElementById('edit-ean').value;
        window.app.data.frais[idx].date=window.app.common.parseDateLocal(document.getElementById('edit-date').value);
        spin(true);try{await window.app.save('frais');}catch(e){toast('Erreur.','err');}finally{spin(false);}
        document.getElementById('modal-edit-frais').classList.add('hidden');
        this.render();window.app.checkAlerts();window.app.updateHomeBadges();toast('Modifié.','ok');
      }
    },
    del:async function(){
      const ok=await dlgConfirm('Supprimer','Supprimer ce produit ?');if(!ok)return;
      const id=document.getElementById('edit-id').value;
      window.app.data.frais=window.app.data.frais.filter(x=>String(x.id)!==String(id));
      spin(true);try{await window.app.save('frais');toast('Supprimé.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-edit-frais').classList.add('hidden');
      this.render();window.app.checkAlerts();window.app.updateHomeBadges();
    }
  },

  // ── PVP ──
  pvp:{
    tab(t){
      document.querySelectorAll('#view-pvp .tab').forEach(e=>e.classList.remove('active-pvp'));
      document.getElementById(t==='stock'?'tp-1':(t==='bib'?'tp-2':'tp-3')).classList.add('active-pvp');
      ['pvp-stock','pvp-bib','pvp-calc'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('pvp-'+t).classList.remove('hidden');
    },
    toggleFamInput(){const v=document.getElementById('lib-fam-select').value;document.getElementById('lib-fam-new').classList.toggle('hidden',v!=='new');},
    openLib(id=null){
      if(!window.app.canDo('pvpLib')){toast('Permission refusée.','err');return;}
      document.getElementById('modal-pvp-lib').classList.remove('hidden');
      const uF=[...new Set(window.app.data.pvpLib.map(i=>i.family||'DIVERS'))].sort();
      document.getElementById('lib-fam-select').innerHTML=uF.map(f=>`<option value="${f}">${f}</option>`).join('')+`<option value="new">+ Créer...</option>`;
      if(id){const i=window.app.data.pvpLib.find(x=>x.id==id);document.getElementById('lib-id').value=id;document.getElementById('lib-name').value=i.name;document.getElementById('lib-ean').value=i.ean||'';document.getElementById('lib-days').value=i.days||0;document.getElementById('lib-img-data').value=i.img||'';document.getElementById('img-preview').src=i.img||'';document.getElementById('img-preview').style.display=i.img?'block':'none';document.getElementById('lib-fam-select').value=i.family||'DIVERS';for(let k=0;k<7;k++)document.getElementById('t-'+k).value=(i.targets||{})[k]||'';}
      else{document.getElementById('lib-id').value='';document.getElementById('lib-name').value='';document.getElementById('lib-ean').value='';document.getElementById('lib-img-data').value='';document.getElementById('img-preview').style.display='none';for(let k=0;k<7;k++)document.getElementById('t-'+k).value='';}
    },
    saveLib:async function(){
      if(!document.getElementById('lib-name').value.trim())return toast('Nom requis.','warn');
      const id=document.getElementById('lib-id').value;
      const fam=document.getElementById('lib-fam-select').value==='new'?(document.getElementById('lib-fam-new').value||'DIVERS').toUpperCase():document.getElementById('lib-fam-select').value;
      const o={id:id?Number(id):Date.now(),family:fam,name:document.getElementById('lib-name').value,ean:document.getElementById('lib-ean').value,img:document.getElementById('lib-img-data').value,days:document.getElementById('lib-days').value,targets:{}};
      for(let k=0;k<7;k++)o.targets[k]=document.getElementById('t-'+k).value;
      if(id){const idx=window.app.data.pvpLib.findIndex(x=>String(x.id)===String(id));if(idx>-1)window.app.data.pvpLib[idx]=o;}else window.app.data.pvpLib.push(o);
      spin(true);try{await window.app.save('pvp');toast('Enregistré.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-pvp-lib').classList.add('hidden');this.render();
    },
    delLib:async function(){
      const ok=await dlgConfirm('Supprimer produit','Supprimer ce produit de la bibliothèque ?');if(!ok)return;
      const id=document.getElementById('lib-id').value;
      window.app.data.pvpLib=window.app.data.pvpLib.filter(x=>String(x.id)!==String(id));
      spin(true);try{await window.app.save('pvp');toast('Supprimé.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-pvp-lib').classList.add('hidden');this.render();
    },
    addStock:async function(libId){
      if(!window.app.canDo('pvpStock')){toast('Permission refusée.','err');return;}
      const l=window.app.data.pvpLib.find(x=>x.id==libId);
      const q=await dlgPrompt('Quantité ?','1','number');
      if(q===null)return;
      const n=Number(q||0);if(n<=0)return toast('Quantité invalide.','warn');
      const now=Date.now();
      const end=window.app.common.calculateEnd(now,l.days);
      const entry={id:now,libId,name:l.name,ean:l.ean,qty:n,out:now,end,days:l.days};
      window.app.data.pvpStock.push(entry);
      this.render();
      spin(true);
      try{await window.app.save('pvp');toast(`${n}× ${l.name} sorti — fin: ${formatDate(end)}`,'ok',4000);}
      catch(e){toast('Erreur sauvegarde.','err');}
      finally{spin(false);}
    },
    openEditStock(id){
      const i=window.app.data.pvpStock.find(x=>x.id==id);
      document.getElementById('modal-pvp-stock').classList.remove('hidden');
      document.getElementById('stock-id').value=id;document.getElementById('stock-name').innerText=i.name;
      document.getElementById('stock-qty').value=i.qty;document.getElementById('stock-start').value=tsToInput(i.out);document.getElementById('stock-end').value=tsToInput(i.end);
    },
    saveStock:async function(){
      const idx=window.app.data.pvpStock.findIndex(x=>String(x.id)===String(document.getElementById('stock-id').value));if(idx<0)return;
      const qty=Number(document.getElementById('stock-qty').value||0);
      const out=new Date(document.getElementById('stock-start').value).getTime();
      const end=new Date(document.getElementById('stock-end').value).getTime();
      if(!isFinite(qty)||qty<0)return toast('Quantité invalide.','warn');
      if(isNaN(out)||isNaN(end))return toast('Dates invalides.','warn');
      window.app.data.pvpStock[idx].qty=qty;window.app.data.pvpStock[idx].out=out;window.app.data.pvpStock[idx].end=end;
      document.getElementById('modal-pvp-stock').classList.add('hidden');
      this.render();
      spin(true);try{await window.app.save('pvp');toast('Mis à jour.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
    },
    delStock:async function(){
      const ok=await dlgConfirm('Retirer','Retirer ce produit du rayon ?');if(!ok)return;
      const id=document.getElementById('stock-id').value;
      window.app.data.pvpStock=window.app.data.pvpStock.filter(x=>String(x.id)!==String(id));
      document.getElementById('modal-pvp-stock').classList.add('hidden');
      this.render();
      spin(true);try{await window.app.save('pvp');toast('Retiré.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
    },
    changeQty:async function(id,delta){
      const idx=window.app.data.pvpStock.findIndex(x=>x.id==id);
      if(idx>-1){
        const n=Number(window.app.data.pvpStock[idx].qty||0)+delta;
        if(n<=0)window.app.data.pvpStock.splice(idx,1);else window.app.data.pvpStock[idx].qty=n;
        this.render();
        try{await window.app.save('pvp');}catch(e){toast('Erreur synchro.','err');}
      }
    },
    toggleNeed:async function(libId){
      const idx=window.app.data.checkedNeeds.indexOf(libId);
      if(idx>-1)window.app.data.checkedNeeds.splice(idx,1);else window.app.data.checkedNeeds.push(libId);
      this.render();try{await window.app.save('pvp');}catch(e){}
    },
    render(){
      const bib=document.getElementById('lib-list');
      if(bib){
        const q=(document.getElementById('pvp-search')?.value||'').toLowerCase().trim();
        const allLib=window.app.data.pvpLib.slice().sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)));
        const filtered=q?allLib.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.family||'').toLowerCase().includes(q)||(l.ean||'').includes(q)):allLib;

        if(!window.app.data.pvpLib.length){bib.innerHTML=`<div class="empty-state"><i class="fas fa-bread-slice"></i>Bibliothèque vide.</div>`;}
        else if(!filtered.length){bib.innerHTML=`<div class="search-no-result"><i class="fas fa-magnifying-glass" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px;"></i>Aucun résultat pour "<b>${q}</b>"</div>`;}
        else{
          const canEdit=window.app.canDo('pvpLib');
          const canStock=window.app.canDo('pvpStock');
          if(q){
            // En mode recherche : liste plate sans groupes
            bib.innerHTML=filtered.map(l=>{
              const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
              const sn=(l.name||'').replace(/'/g,' ');
              const fam=`<span class="chip" style="background:#f1f5f9;color:#475569;">${l.family||'DIVERS'}</span>`;
              return `<div class="list-item" onclick="app.common.showBarcode('${l.ean||''}','${sn}','${l.img||''}')">
                <div style="display:flex;align-items:center;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.days||0}h • ${fam}</div></div></div>
                <div class="right-col">
                  ${canEdit?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                  <button class="icon-btn dark" onclick="event.stopPropagation();app.trace.open('pvp','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                  ${canStock?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                </div>
              </div>`;
            }).join('');
          } else {
            // Mode normal : groupé par famille
            const gL={};filtered.forEach(l=>{const f=l.family||'DIVERS';if(!gL[f])gL[f]=[];gL[f].push(l);});
            const parts=[];Object.keys(gL).sort().forEach(f=>{
              const id='L-'+f;const c=window.app.closed.has(id);
              parts.push(`<div class="group-header" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
              if(c)return;
              gL[f].forEach(l=>{
                const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;
                const sn=(l.name||'').replace(/'/g,' ');
                parts.push(`<div class="list-item" onclick="app.common.showBarcode('${l.ean||''}','${sn}','${l.img||''}')">
                  <div style="display:flex;align-items:center;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.days||0}h • ${l.ean||'EAN ?'}</div></div></div>
                  <div class="right-col">
                    ${canEdit?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                    <button class="icon-btn dark" onclick="event.stopPropagation();app.trace.open('pvp','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                    ${canStock?`<button class="icon-btn pvp" onclick="event.stopPropagation();app.pvp.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                  </div>
                </div>`);
              });
            });
            bib.innerHTML=parts.join('');
          }
        }
      }
      const st=document.getElementById('pvp-stock');
      if(st){
        const now=new Date();
        const expired=window.app.data.pvpStock.filter(i=>new Date(i.end)<now);
        const expiredBadge=expired.length>0?`<div style="background:#fee2e2;border-left:5px solid #ef4444;border-radius:12px;padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;"><div style="font-weight:950;color:#991b1b;"><i class="fas fa-triangle-exclamation"></i> ${expired.length} produit(s) à retirer du rayon aujourd'hui</div></div>`:'';
        if(!window.app.data.pvpStock.length){st.innerHTML=`<div class="empty-state"><i class="fas fa-store-slash"></i>Rayon vide.</div>`;return;}
        const gS={};window.app.data.pvpStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s=>{const l=window.app.data.pvpLib.find(x=>x.id==s.libId);const f=l?l.family:'DIVERS';if(!gS[f])gS[f]=[];gS[f].push(s);});
        const parts=[expiredBadge];Object.keys(gS).sort().forEach(f=>{const id='S-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--pvp)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(c)return;gS[f].forEach(i=>{const dS=formatDate(i.out);const dE=formatDate(i.end);const isExp=new Date(i.end)<now;const l=window.app.data.pvpLib.find(x=>x.id==i.libId);const img=l?.img?`<img src="${l.img}" class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${(i.name||'').replace(/'/g,' ')}','${l.img}')">`:`<div class="item-img" onclick="event.stopPropagation();app.common.showBarcode('${i.ean||''}','${(i.name||'').replace(/'/g,' ')}')"><i class="fas fa-bread-slice"></i></div>`;parts.push(`<div class="swipe-wrapper"><div class="swipe-content ${isExp?'style="border-left:4px solid #ef4444;"':''}"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${i.name}</div><div class="qty-ctrl"><button class="qty-btn" onclick="app.pvp.changeQty(${i.id},-1)">-</button><b>${i.qty}</b><button class="qty-btn" onclick="app.pvp.changeQty(${i.id},1)">+</button></div></div></div><div class="right-col"><button class="icon-btn frigo" onclick="app.trace.open('pvp','${i.libId}','${(i.name||'').replace(/'/g,' ')}')"><i class="fas fa-camera"></i></button><div class="date-col" onclick="app.pvp.openEditStock(${i.id})" style="cursor:pointer;"><div class="d-lbl">Sortie: ${dS}</div><div class="d-val ${isExp?'expired':''}">FIN: ${dE} <i class="fas fa-pen" style="font-size:10px;"></i></div></div></div></div></div>`);});});
        st.innerHTML=parts.join('');
      }
      const cl=document.getElementById('pvp-calc');
      if(cl){
        const tom=new Date();tom.setDate(tom.getDate()+1);const tn=new Date(tom.getFullYear(),tom.getMonth(),tom.getDate(),12,0,0,0).getTime();
        const gT={};let doneH='';let hasNeeds=false;const avail={};
        window.app.data.pvpStock.forEach(s=>{if((s.end||0)>=tn)avail[s.libId]=(avail[s.libId]||0)+Number(s.qty||0);});
        window.app.data.pvpLib.forEach(l=>{const target=Number((l.targets||{})[tom.getDay()]||0);if(target<=0)return;const av=Number(avail[l.id]||0);const need=Math.max(0,target-av);if(need<=0)return;hasNeeds=true;const isC=window.app.data.checkedNeeds.includes(l.id);const img=l.img?`<img src="${l.img}" class="item-img">`:`<div class="item-img"><i class="fas fa-bread-slice"></i></div>`;const h=`<div class="list-item ${isC?'item-done':''}" style="border-left:5px solid var(--pvp);"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;">${img}<div style="min-width:0;"><div class="item-title">${l.name}</div><div style="color:var(--pvp);font-weight:950;">À SORTIR : ${need} <span class="small">(objectif ${target} • dispo ${av})</span></div></div></div><div class="todo-check ${isC?'checked':''}" onclick="app.pvp.toggleNeed(${l.id})"><i class="fas fa-check"></i></div></div>`;if(isC)doneH+=h;else{const f=l.family||'DIVERS';if(!gT[f])gT[f]=[];gT[f].push(h);}});
        const parts=[`<h4 style="text-align:center;color:var(--primary);">À SORTIR DEMAIN</h4>`];
        if(!hasNeeds)parts.push(`<div class="empty-state"><i class="fas fa-check-circle"></i>Rien de prévu</div>`);
        else Object.keys(gT).sort().forEach(f=>{const id='N-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--primary)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(!c)parts.push(gT[f].join(''));});
        parts.push(`<h4 style="text-align:center;color:#64748b;margin-top:20px;">TERMINÉ</h4>`);
        parts.push(doneH||`<div class="empty-state" style="padding:20px;"><i class="fas fa-hourglass-start"></i>Rien de fait</div>`);
        cl.innerHTML=parts.join('');
      }
    }
  },

  // ── SALAD ──
  salad:{
    tab(t){document.querySelectorAll('#view-salad .tab').forEach(e=>e.classList.remove('active-salad'));document.getElementById(t==='stock'?'ts-1':'ts-2').classList.add('active-salad');document.getElementById('salad-stock').classList.add('hidden');document.getElementById('salad-bib').classList.add('hidden');document.getElementById('salad-'+t).classList.remove('hidden');},
    openLib(id=null){if(!window.app.canDo('saladLib')){toast('Permission refusée.','err');return;}document.getElementById('modal-salad-lib').classList.remove('hidden');if(id){const i=window.app.data.saladLib.find(x=>x.id==id);document.getElementById('sal-lib-id').value=i.id;document.getElementById('sal-lib-fam').value=i.family||'DIVERS';document.getElementById('sal-lib-name').value=i.name||'';document.getElementById('sal-lib-hours').value=String(i.hours||48);}else{document.getElementById('sal-lib-id').value='';document.getElementById('sal-lib-fam').value='SALADE';document.getElementById('sal-lib-name').value='';document.getElementById('sal-lib-hours').value='48';}},
    saveLib:async function(){if(!window.app.canDo('saladLib')){toast('Permission refusée.','err');return;}const id=document.getElementById('sal-lib-id').value;const name=(document.getElementById('sal-lib-name').value||'').trim();if(!name)return toast('Nom requis.','warn');const o={id:id?Number(id):Date.now(),family:document.getElementById('sal-lib-fam').value||'DIVERS',name,hours:Number(document.getElementById('sal-lib-hours').value||48)};if(id){const idx=window.app.data.saladLib.findIndex(x=>String(x.id)===String(id));if(idx>-1)window.app.data.saladLib[idx]=o;}else window.app.data.saladLib.push(o);document.getElementById('modal-salad-lib').classList.add('hidden');this.render();spin(true);try{await window.app.save('salad');toast('Enregistré.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);};},
    delLib:async function(){if(!window.app.canDo('saladLib')){toast('Permission refusée.','err');return;}const ok=await dlgConfirm('Supprimer','Supprimer ce produit ?');if(!ok)return;const id=document.getElementById('sal-lib-id').value;window.app.data.saladLib=window.app.data.saladLib.filter(x=>String(x.id)!==String(id));document.getElementById('modal-salad-lib').classList.add('hidden');this.render();spin(true);try{await window.app.save('salad');toast('Supprimé.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);};},
    addStock:async function(libId){
      if(!window.app.canDo('saladStock')){toast('Permission refusée.','err');return;}
      const l=window.app.data.saladLib.find(x=>x.id==libId);
      if(!l)return toast('Produit introuvable.','err');
      const q=await dlgPrompt('Quantité ?','1','number');
      if(q===null)return;
      const n=Number(q||0);
      if(n<=0)return toast('Quantité invalide.','warn');
      const now=Date.now();
      const entry={id:now,libId,name:l.name,qty:n,out:now,end:window.app.common.calculateEnd(now,l.hours),hours:l.hours};
      window.app.data.saladStock.push(entry);
      spin(true);
      try{
        await window.app.save('salad');
        toast(`${n}× ${l.name} sorti — fin: ${formatDate(entry.end)}`,'ok',4000);
        this.render();
      }catch(e){
        // Rollback on error
        window.app.data.saladStock=window.app.data.saladStock.filter(x=>x.id!==entry.id);
        toast('Erreur sauvegarde.','err');
      }finally{spin(false);}
    },
    changeQty:async function(id,delta){
      const idx=window.app.data.saladStock.findIndex(x=>x.id==id);
      if(idx>-1){
        const n=Number(window.app.data.saladStock[idx].qty||0)+delta;
        if(n<=0)window.app.data.saladStock.splice(idx,1);
        else window.app.data.saladStock[idx].qty=n;
        this.render();
        try{await window.app.save('salad');}catch(e){toast('Erreur synchro.','err');}
      }
    },
    openEditStock:async function(id){
      const i=window.app.data.saladStock.find(x=>x.id==id);
      const q=await dlgPrompt('Quantité :',String(i.qty||0),'number');
      if(q===null)return;
      const n=Number(q||0);
      if(n<=0)window.app.data.saladStock=window.app.data.saladStock.filter(x=>x.id!==id);
      else i.qty=n;
      this.render();
      try{await window.app.save('salad');}catch(e){toast('Erreur synchro.','err');}
    },
    render(){
      const bib=document.getElementById('salad-lib-list');
      if(bib){
        const q=(document.getElementById('salad-search')?.value||'').toLowerCase().trim();
        const allLib=window.app.data.saladLib.slice().sort((a,b)=>window.app.common.cleanName(a.name).localeCompare(window.app.common.cleanName(b.name)));
        const filtered=q?allLib.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.family||'').toLowerCase().includes(q)):allLib;

        if(!window.app.data.saladLib.length){bib.innerHTML=`<div class="empty-state"><i class="fas fa-bowl-food"></i>Bibliothèque vide.</div>`;}
        else if(!filtered.length){bib.innerHTML=`<div class="search-no-result"><i class="fas fa-magnifying-glass" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px;"></i>Aucun résultat pour "<b>${q}</b>"</div>`;}
        else{
          const canEdit=window.app.canDo('saladLib');
          const canStock=window.app.canDo('saladStock');
          if(q){
            bib.innerHTML=filtered.map(l=>{
              const sn=(l.name||'').replace(/'/g,' ');
              const fam=`<span class="chip" style="background:#f1f5f9;color:#475569;">${l.family||'DIVERS'}</span>`;
              return `<div class="list-item">
                <div style="display:flex;align-items:center;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.hours||48}h • ${fam}</div></div></div>
                <div class="right-col">
                  ${canEdit?`<button class="icon-btn salad" onclick="app.salad.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                  <button class="icon-btn dark" onclick="app.trace.open('salad','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                  ${canStock?`<button class="icon-btn salad" onclick="app.salad.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                </div>
              </div>`;
            }).join('');
          } else {
            const gL={};filtered.forEach(l=>{const f=l.family||'DIVERS';if(!gL[f])gL[f]=[];gL[f].push(l);});
            const parts=[];Object.keys(gL).sort().forEach(f=>{
              const id='SL-'+f;const c=window.app.closed.has(id);
              parts.push(`<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);
              if(c)return;
              gL[f].forEach(l=>{
                const sn=(l.name||'').replace(/'/g,' ');
                parts.push(`<div class="list-item">
                  <div style="display:flex;align-items:center;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title">${l.name}</div><div class="item-sub">${l.hours||48}h</div></div></div>
                  <div class="right-col">
                    ${canEdit?`<button class="icon-btn salad" onclick="app.salad.openLib(${l.id})"><i class="fas fa-pen"></i></button>`:''}
                    <button class="icon-btn dark" onclick="app.trace.open('salad','${l.id}','${sn}')"><i class="fas fa-camera"></i></button>
                    ${canStock?`<button class="icon-btn salad" onclick="app.salad.addStock(${l.id})"><i class="fas fa-plus"></i></button>`:''}
                  </div>
                </div>`);
              });
            });
            bib.innerHTML=parts.join('');
          }
        }
      }
      const st=document.getElementById('salad-stock');
      if(st){
        if(!window.app.data.saladStock.length){st.innerHTML=`<div class="empty-state"><i class="fas fa-store-slash"></i>Rayon vide.</div>`;return;}
        const gS={};window.app.data.saladStock.slice().sort((a,b)=>(a.end||0)-(b.end||0)).forEach(s=>{const l=window.app.data.saladLib.find(x=>x.id==s.libId);const f=l?l.family:'DIVERS';if(!gS[f])gS[f]=[];gS[f].push(s);});
        const parts=[];Object.keys(gS).sort().forEach(f=>{const id='SS-'+f;const c=window.app.closed.has(id);parts.push(`<div class="group-header" style="background:var(--salad)" onclick="app.toggleFam('${id}')"><span>${f}</span><i class="fas fa-chevron-${c?'right':'down'}"></i></div>`);if(c)return;gS[f].forEach(i=>{const dS=formatDate(i.out);const dE=formatDate(i.end);const isExp=new Date(i.end)<new Date();const sn=(i.name||'').replace(/'/g,' ');parts.push(`<div class="swipe-wrapper" style="background:#0b4f4a;"><div class="swipe-content"><div style="display:flex;align-items:center;flex:1;min-width:0;gap:12px;"><div class="item-img"><i class="fas fa-bowl-food"></i></div><div style="min-width:0;"><div class="item-title" onclick="app.salad.openEditStock(${i.id})">${i.name}</div><div class="qty-ctrl"><button class="qty-btn" onclick="app.salad.changeQty(${i.id},-1)">-</button><b>${i.qty}</b><button class="qty-btn" onclick="app.salad.changeQty(${i.id},1)">+</button></div></div></div><div class="right-col"><button class="icon-btn dark" onclick="app.trace.open('salad','${i.libId}','${sn}')"><i class="fas fa-camera"></i></button><div class="date-col"><div class="d-lbl">Sortie: ${dS}</div><div class="d-val ${isExp?'expired':''}">FIN: ${dE}</div></div></div></div></div>`);});});
        st.innerHTML=parts.join('');
      }
    }
  },

  // ── FRIGO ──
  frigo:{
    tab(t){document.querySelectorAll('#view-frigo .tab').forEach(e=>e.classList.remove('active-frigo'));document.getElementById(t==='take'?'tfr-1':(t==='fridges'?'tfr-2':'tfr-3')).classList.add('active-frigo');['frigo-take','frigo-fridges','frigo-history'].forEach(id=>document.getElementById(id).classList.add('hidden'));document.getElementById('frigo-'+t).classList.remove('hidden');},
    remainingTodayTotal(){const pd=Number(window.app.data.frigo.perDay||2);const{start,end}=dayBounds();const today=(window.app.data.frigo.logs||[]).filter(l=>(l.ts||0)>=start&&(l.ts||0)<=end);let tot=0;(window.app.data.frigo.fridges||[]).forEach(fr=>{const done=today.filter(l=>String(l.fridgeId)===String(fr.id)).length;tot+=Math.max(0,pd-done);});return tot;},
    remainingForFridgeToday(fid){const pd=Number(window.app.data.frigo.perDay||2);const{start,end}=dayBounds();const done=(window.app.data.frigo.logs||[]).filter(l=>String(l.fridgeId)===String(fid)&&(l.ts||0)>=start&&(l.ts||0)<=end).length;return Math.max(0,pd-done);},
    setPerDay:async function(v){if(!window.app.canDo('frigoConfig')){toast('Permission refusée.','err');this.render();return;}window.app.data.frigo.perDay=Number(v||2);await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    addFridge:async function(){if(!window.app.canDo('frigoConfig')){toast('Permission refusée.','err');return;}const n=await dlgPrompt('Nom du frigo :',`FRIGO ${(window.app.data.frigo.fridges||[]).length+1}`);if(!n)return;window.app.data.frigo.fridges.push({id:Date.now(),name:n.trim().toUpperCase()});await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    renameFridge:async function(id){if(!window.app.canDo('frigoConfig')){toast('Permission refusée.','err');return;}const f=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(id));if(!f)return;const n=await dlgPrompt('Renommer :',f.name||'');if(!n)return;f.name=n.trim().toUpperCase();await window.app.save('frigo');this.render();},
    delFridge:async function(id){if(!window.app.canDo('frigoConfig')){toast('Permission refusée.','err');return;}const f=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(id));if(!f)return;const ok=await dlgConfirm(`Supprimer ${f.name}`,`Supprimer ce frigo ? Les relevés restent en historique.`);if(!ok)return;window.app.data.frigo.fridges=window.app.data.frigo.fridges.filter(x=>String(x.id)!==String(id));await window.app.save('frigo');this.render();window.app.updateHomeBadges();},
    openLogModal(fid=null){if(!window.app.canDo('frigoSaisie')){toast('Permission refusée.','err');return;}const sel=document.getElementById('frigo-log-fridge');sel.innerHTML=(window.app.data.frigo.fridges||[]).map(fr=>`<option value="${fr.id}">${fr.name||"FRIGO"}</option>`).join('');if(fid)sel.value=String(fid);document.getElementById('frigo-log-temp').value='';document.getElementById('frigo-log-time').value=tsToInput(Date.now());document.getElementById('modal-frigo-log').classList.remove('hidden');},
    saveLog:async function(){
      const fid=document.getElementById('frigo-log-fridge').value;const fr=(window.app.data.frigo.fridges||[]).find(x=>String(x.id)===String(fid));
      const temp=Number(document.getElementById('frigo-log-temp').value);const ts=inputToTs(document.getElementById('frigo-log-time').value);
      if(!fr)return toast('Frigo invalide.','warn');if(isNaN(temp))return toast('Température invalide.','warn');
      window.app.data.frigo.logs.push({id:Date.now(),fridgeId:fr.id,fridgeName:fr.name||'',temp,ts,user:window.app.me?.name||window.app.me?.email||'USER'});
      const cutoff=Date.now()-(90*24*60*60*1000);window.app.data.frigo.logs=window.app.data.frigo.logs.filter(l=>(l.ts||0)>=cutoff);
      spin(true);try{await window.app.save('frigo');toast('Relevé enregistré.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-frigo-log').classList.add('hidden');this.render();window.app.updateHomeBadges();
    },
    editLog:async function(id,currentTemp){
      const newTemp=await dlgPrompt('Modifier la température :',String(currentTemp),'number');
      if(newTemp===null)return;
      const t=parseFloat(newTemp);if(isNaN(t))return toast('Température invalide.','warn');
      const idx=window.app.data.frigo.logs.findIndex(l=>String(l.id)===String(id));
      if(idx<0)return;
      window.app.data.frigo.logs[idx].temp=t;
      spin(true);try{await window.app.save('frigo');toast('Relevé modifié.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      this.render();
    },
    deleteLog:async function(id){
      const ok=await dlgConfirm('Supprimer','Supprimer ce relevé de température ?');if(!ok)return;
      window.app.data.frigo.logs=window.app.data.frigo.logs.filter(l=>String(l.id)!==String(id));
      spin(true);try{await window.app.save('frigo');toast('Relevé supprimé.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      this.render();window.app.updateHomeBadges();
    },
    render(){
      try{document.getElementById('frigo-perday').value=String(window.app.data.frigo.perDay||2);}catch(e){}
      const take=document.getElementById('frigo-take');
      if(take){
        const fridges=window.app.data.frigo.fridges||[];
        if(!fridges.length){take.innerHTML=`<div class="card"><b>Aucun frigo</b><div class="small">Créez des frigos dans l'onglet FRIGOS.</div></div>`;return;}
        take.innerHTML=fridges.map(fr=>{const rem=window.app.frigo.remainingForFridgeToday(fr.id);const done=(window.app.data.frigo.perDay||2)-rem;const chip=rem>0?`<span class="chip warn"><i class="fas fa-circle-exclamation"></i> ${rem} restant</span>`:`<span class="chip ok"><i class="fas fa-check"></i> OK</span>`;return`<div class="list-item" style="border-left:6px solid var(--frigo);"><div style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;"><div class="item-img" style="color:var(--frigo)"><i class="fas fa-snowflake"></i></div><div style="min-width:0;"><div class="item-title">${fr.name||"FRIGO"}</div><div class="item-sub">${done}/${window.app.data.frigo.perDay||2} relevé(s) • ${chip}</div></div></div><div class="right-col"><button class="icon-btn frigo" onclick="app.frigo.openLogModal('${fr.id}')"><i class="fas fa-plus"></i></button></div></div>`;}).join('');
      }
      const list=document.getElementById('frigo-list');
      if(list){
        const fridges=window.app.data.frigo.fridges||[];
        const canCfg=window.app.canDo('frigoConfig');
        // Show/hide add fridge button
        const addBtn=document.querySelector('#view-frigo .btn.frigo');
        if(addBtn)addBtn.style.display=canCfg?'':'none';
        // Show/hide frequency config
        const paramCard=document.querySelector('#frigo-fridges .card');
        if(paramCard)paramCard.style.display=canCfg?'':'none';
        list.innerHTML=fridges.length?fridges.map(fr=>`<div class="list-item"><div style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;"><div class="item-img" style="color:var(--frigo)"><i class="fas fa-snowflake"></i></div><div style="min-width:0;"><div class="item-title">${fr.name||"FRIGO"}</div><div class="item-sub">fréquence: ${window.app.data.frigo.perDay||2}/jour</div></div></div><div class="right-col">${canCfg?`<button class="icon-btn frigo" onclick="app.frigo.renameFridge('${fr.id}')"><i class="fas fa-pen"></i></button><button class="icon-btn red" onclick="app.frigo.delFridge('${fr.id}')"><i class="fas fa-trash"></i></button>`:''}</div></div>`).join(''):`<div class="empty-state"><i class="fas fa-snowflake"></i>Aucun frigo.</div>`;
      }
      const hist=document.getElementById('frigo-history');
      if(hist){
        const logs=(window.app.data.frigo.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
        const cutoff=Date.now()-(7*24*60*60*1000);const recent=logs.filter(l=>(l.ts||0)>=cutoff);
        if(!recent.length){hist.innerHTML=`<div class="card"><b>Aucun relevé récent</b><div class="small">Les 7 derniers jours s'affichent ici.</div></div>`;return;}
        const byDay={};recent.forEach(l=>{const d=new Date(l.ts);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;if(!byDay[k])byDay[k]=[];byDay[k].push(l);});
        hist.innerHTML=Object.keys(byDay).sort().reverse().map(k=>{
          const d=new Date(k.replace(/-/g,'/'));const title=d.toLocaleDateString('fr',{weekday:'long',year:'numeric',month:'short',day:'numeric'});
          return`<div class="group-header" style="background:var(--frigo)"><span>${title}</span><span class="small" style="color:rgba(255,255,255,.8)">${byDay[k].length} relevé(s)</span></div>`
          +byDay[k].map(l=>`<div class="frigo-log-row">
            <div style="flex:1;min-width:0;">
              <div style="font-weight:950;">${l.fridgeName||'FRIGO'} • <span style="color:var(--frigo);">${l.temp}°C</span></div>
              <div class="small">${formatDate(l.ts)} • Par ${l.user||'USER'}</div>
            </div>
            <div style="display:flex;gap:6px;flex-shrink:0;">
              <button class="icon-btn frigo" onclick="app.frigo.editLog('${l.id}',${l.temp})" title="Modifier"><i class="fas fa-pen"></i></button>
              <button class="icon-btn red" onclick="app.frigo.deleteLog('${l.id}')" title="Supprimer"><i class="fas fa-trash"></i></button>
            </div>
          </div>`).join('');
        }).join('');
      }
    }
  },

  // ══════════════════════════════════════════════════
  // ── TODO MODULE (with real-time sync) ──
  // ══════════════════════════════════════════════════
  todo:{
    _editingTaskDays: new Set(),
    _editingMonthDays: new Set(),
    _editingFreq: 'weekly',
    _unsubscribeLogs: null,

    tab(t){
      document.querySelectorAll('#view-todo .tab').forEach(e=>e.classList.remove('active-todo'));
      const tabMap={today:'tt-1',tomorrow:'tt-4',config:'tt-2',history:'tt-3'};
      if(document.getElementById(tabMap[t]))document.getElementById(tabMap[t]).classList.add('active-todo');
      ['todo-today','todo-tomorrow','todo-config','todo-history'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
      const panel=document.getElementById('todo-'+t);if(panel)panel.classList.remove('hidden');
      if(t==='today')this.renderToday();
      if(t==='tomorrow')this.renderTomorrow();
      if(t==='config'){
        if(!window.app.canDo('todoConfig')){
          document.getElementById('todo-config').innerHTML='<div class="empty-state"><i class="fas fa-lock"></i>Accès réservé aux administrateurs et aux utilisateurs autorisés.</div>';
          return;
        }
        this.renderConfig();
      }
      if(t==='history')this.renderHistory();
    },

    // Realtime listener for today's logs
    subscribeToday(){
      if(this._unsubscribeLogs){try{this._unsubscribeLogs();}catch(e){}}
      const {onSnapshot}=window._fsImports||{};
      if(!onSnapshot){return;}
      const today=todayStr();
      try{
        const q=window._fsQuery(colTodoLogs,window._fsWhere("date","==",today));
        this._unsubscribeLogs=onSnapshot(q,snap=>{
          window.app.data.todoLogs=[];
          snap.forEach(d=>window.app.data.todoLogs.push({_id:d.id,...d.data()}));
          this.renderToday();window.app.updateHomeBadges();
        });
      }catch(e){}
    },

    // Check if a task is applicable for a given date
    isTaskForDate(task, date){
      const freq=task.freq||'weekly';
      const dow=date.getDay();
      const dom=date.getDate();
      const month=date.getMonth()+1;
      if(freq==='daily') return true;
      if(freq==='weekly') return (task.days||[]).includes(dow);
      if(freq==='monthly') return (task.monthDays||[]).includes(dom);
      if(freq==='yearly'){
        const md=task.yearlyDate||'';if(!md)return false;
        const[d,m]=(md.split('/')).map(Number);
        return dom===d&&month===m;
      }
      return false;
    },

    todayTaskList(){
      const today=new Date();
      return (window.app.data.todo.tasks||[]).filter(t=>this.isTaskForDate(t,today));
    },

    tomorrowTaskList(){
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      return (window.app.data.todo.tasks||[]).filter(t=>this.isTaskForDate(t,tomorrow));
    },

    isDone(taskId){
      return window.app.data.todoLogs.some(l=>String(l.taskId)===String(taskId));
    },

    checkTask:async function(taskId){
      if(!window.app.canDo('todoSaisie')){toast('Permission refusée.','err');return;}
      if(this.isDone(taskId))return;
      const task=(window.app.data.todo.tasks||[]).find(t=>String(t.id)===String(taskId));
      const zone=(window.app.data.todo.zones||[]).find(z=>String(z.id)===String(task?.zoneId));
      const today=todayStr();
      const logEntry={taskId:String(taskId),taskName:task?.name||'',zoneId:String(task?.zoneId||''),zoneName:zone?.name||'',date:today,ts:Date.now(),user:window.app.me?.name||(window.app.me?.email||'USER')};
      try{
        const ref=await addDoc(colTodoLogs,logEntry);
        window.app.data.todoLogs.push({_id:ref.id,...logEntry});
        this.renderToday();window.app.updateHomeBadges();
        toast(`✓ ${task?.name||'Tâche'} effectuée !`,'ok',2000);
      }catch(e){toast('Erreur enregistrement.','err');}
    },

    uncheckTask:async function(taskId){
      const log=window.app.data.todoLogs.find(l=>String(l.taskId)===String(taskId));
      if(!log)return;
      try{
        await deleteDoc(fDoc(db,'todo_logs',log._id));
        window.app.data.todoLogs=window.app.data.todoLogs.filter(l=>l._id!==log._id);
        this.renderToday();window.app.updateHomeBadges();
        toast('Tâche décochée.','info',2000);
      }catch(e){toast('Erreur.','err');}
    },

    renderToday(){
      const wrap=document.getElementById('todo-today');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=this.todayTaskList();
      const now=new Date();
      const nowMin=now.getHours()*60+now.getMinutes();
      const dateLabel=now.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'long'});
      const done=tasks.filter(t=>this.isDone(t.id)).length;
      const pct=tasks.length>0?Math.round(done/tasks.length*100):0;

      if(!zones.length||!tasks.length){
        wrap.innerHTML=`
          <div style="text-align:center;padding:20px;">
            <div style="font-weight:950;font-size:18px;color:var(--todo);margin-bottom:4px;">${dateLabel}</div>
          </div>
          <div class="empty-state">
            <i class="fas fa-list-check"></i>
            ${!zones.length?'Créez des zones et des tâches dans l\'onglet <b>CONFIGURER</b>.':'Aucune tâche prévue aujourd\'hui.'}
          </div>`;
        return;
      }

      const parts=[`
        <div style="background:linear-gradient(135deg,var(--todo),#5b21b6);border-radius:18px;padding:18px;margin-bottom:16px;color:#fff;">
          <div style="font-weight:950;font-size:17px;">${dateLabel}</div>
          <div style="font-size:13px;opacity:.85;margin-bottom:12px;">${done} / ${tasks.length} tâche${tasks.length>1?'s':''}</div>
          <div style="background:rgba(255,255,255,.25);border-radius:999px;height:8px;overflow:hidden;">
            <div style="height:100%;border-radius:999px;background:#fff;width:${pct}%;transition:width .5s ease;"></div>
          </div>
          <div style="text-align:right;font-size:12px;margin-top:4px;opacity:.9;">${pct}%</div>
        </div>
      `];

      zones.forEach(z=>{
        const zoneTasks=tasks.filter(t=>String(t.zoneId)===String(z.id)).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
        if(!zoneTasks.length)return;
        const zDone=zoneTasks.filter(t=>this.isDone(t.id)).length;
        const zPct=zoneTasks.length>0?Math.round(zDone/zoneTasks.length*100):0;
        parts.push(`
          <div style="background:${z.color||'var(--todo)'};border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:950;font-size:15px;text-transform:uppercase;">${z.name||'ZONE'}</div>
              <div style="font-size:12px;opacity:.9;">${zDone}/${zoneTasks.length}</div>
            </div>
            <div style="height:5px;border-radius:3px;background:rgba(255,255,255,.3);margin-top:8px;overflow:hidden;">
              <div style="height:100%;border-radius:3px;background:#fff;width:${zPct}%;transition:width .5s;"></div>
            </div>
          </div>
        `);
        zoneTasks.forEach(t=>{
          const done=this.isDone(t.id);
          const log=done?window.app.data.todoLogs.find(l=>String(l.taskId)===String(t.id)):null;
          let taskMin=Infinity;
          if(t.time){const[h,m]=(t.time||'00:00').split(':').map(Number);taskMin=h*60+(m||0);}
          const overdue=!done&&taskMin!==Infinity&&nowMin>taskMin+15;
          const cardClass=done?'done':(overdue?'overdue':'');
          const freqLabel=t.freq==='monthly'?'mensuel':t.freq==='yearly'?'annuel':t.freq==='daily'?'quotidien':'';
          parts.push(`
            <div class="task-card ${cardClass}" style="border-left-color:${z.color||'var(--todo)'};${done?'border-left-color:var(--success);':''}${overdue?'border-left-color:var(--danger);':''}">
              ${t.time?`<span class="time-chip ${done?'done':(overdue?'overdue':'')}">${t.time}</span>`:''}
              <div style="flex:1;min-width:0;">
                <div style="font-weight:900;font-size:14px;${done?'text-decoration:line-through;color:#94a3b8;':''}">${t.name||''}${freqLabel?` <span class="chip" style="background:#f1f5f9;color:#64748b;font-size:10px;">${freqLabel}</span>`:''}</div>
                ${t.notes?`<div class="small" style="margin-top:2px;">${t.notes}</div>`:''}
                ${done&&log?`<div class="small" style="margin-top:3px;color:var(--success);"><i class="fas fa-check-circle"></i> ${log.user} • ${formatDate(log.ts)}</div>`:''}
                ${overdue?`<div class="small" style="color:var(--danger);margin-top:2px;"><i class="fas fa-clock"></i> En retard</div>`:''}
              </div>
              <div class="todo-check ${done?'checked':''}" onclick="app.todo.${done?'uncheckTask':'checkTask'}('${t.id}')">
                <i class="fas fa-check"></i>
              </div>
            </div>
          `);
        });
        parts.push('<div style="margin-bottom:8px;"></div>');
      });

      const unzonedTasks=tasks.filter(t=>!zones.find(z=>String(z.id)===String(t.zoneId))).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
      if(unzonedTasks.length){
        parts.push(`<div style="background:#475569;border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;">SANS ZONE</div></div>`);
        unzonedTasks.forEach(t=>{
          const done=this.isDone(t.id);
          const log=done?window.app.data.todoLogs.find(l=>String(l.taskId)===String(t.id)):null;
          parts.push(`<div class="task-card ${done?'done':''}"><div style="flex:1;min-width:0;"><div style="font-weight:900;${done?'text-decoration:line-through;color:#94a3b8;':''}">${t.name||''}</div>${done&&log?`<div class="small" style="color:var(--success);"><i class="fas fa-check-circle"></i> ${log.user}</div>`:''}${t.notes?`<div class="small">${t.notes}</div>`:''}</div><div class="todo-check ${done?'checked':''}" onclick="app.todo.${done?'uncheckTask':'checkTask'}('${t.id}')"><i class="fas fa-check"></i></div></div>`);
        });
      }
      wrap.innerHTML=parts.join('');
    },

    renderTomorrow(){
      const wrap=document.getElementById('todo-tomorrow');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=this.tomorrowTaskList();
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      const dateLabel=tomorrow.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'long'});
      const FREQ_LABELS={daily:'Quotidien',weekly:'Hebdo',monthly:'Mensuel',yearly:'Annuel'};

      if(!tasks.length){
        wrap.innerHTML=`
          <div style="text-align:center;padding:20px;">
            <div style="font-weight:950;font-size:18px;color:var(--todo);margin-bottom:4px;">${dateLabel}</div>
          </div>
          <div class="empty-state"><i class="fas fa-calendar-check"></i>Aucune tâche prévue demain.</div>`;
        return;
      }

      const parts=[`
        <div style="background:linear-gradient(135deg,#475569,#334155);border-radius:18px;padding:18px;margin-bottom:16px;color:#fff;">
          <div style="font-weight:950;font-size:17px;">${dateLabel}</div>
          <div style="font-size:13px;opacity:.85;margin-top:4px;">${tasks.length} tâche${tasks.length>1?'s':''} prévue${tasks.length>1?'s':''}</div>
        </div>
      `];

      zones.forEach(z=>{
        const zoneTasks=tasks.filter(t=>String(t.zoneId)===String(z.id)).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00'));
        if(!zoneTasks.length)return;
        parts.push(`<div style="background:${z.color||'var(--todo)'};border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;font-size:15px;">${z.name||'ZONE'}</div></div>`);
        zoneTasks.forEach(t=>{
          const freqLabel=FREQ_LABELS[t.freq||'weekly']||'';
          parts.push(`<div class="task-card">
            ${t.time?`<span class="time-chip">${t.time}</span>`:''}
            <div style="flex:1;min-width:0;">
              <div style="font-weight:900;font-size:14px;">${t.name||''} <span class="chip" style="background:#f1f5f9;color:#64748b;font-size:10px;">${freqLabel}</span></div>
              ${t.notes?`<div class="small" style="margin-top:2px;">${t.notes}</div>`:''}
            </div>
            <div style="width:32px;height:32px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;color:#94a3b8;"><i class="fas fa-clock"></i></div>
          </div>`);
        });
        parts.push('<div style="margin-bottom:8px;"></div>');
      });

      const unzoned=tasks.filter(t=>!zones.find(z=>String(z.id)===String(t.zoneId)));
      if(unzoned.length){
        parts.push(`<div style="background:#475569;border-radius:14px;padding:14px 16px;margin-bottom:4px;color:#fff;"><div style="font-weight:950;">SANS ZONE</div></div>`);
        unzoned.forEach(t=>{parts.push(`<div class="task-card"><div style="flex:1;font-weight:900;">${t.name||''}</div></div>`);});
      }
      wrap.innerHTML=parts.join('');
    },

    renderConfig(){
      const wrap=document.getElementById('todo-config');if(!wrap)return;
      const zones=window.app.data.todo.zones||[];
      const tasks=window.app.data.todo.tasks||[];
      const FREQ_LABELS={daily:'Quotidien',weekly:'Hebdo',monthly:'Mensuel',yearly:'Annuel'};
      const parts=[`<button class="btn todo" style="margin-bottom:15px;" onclick="app.todo.openZone()"><i class="fas fa-plus"></i> Créer une zone</button>`];
      if(!zones.length){
        parts.push(`<div class="empty-state"><i class="fas fa-map-marker-alt"></i>Aucune zone créée.<br><span class="small">Une zone = un espace physique (Réserve, Rayon, Caisse…)</span></div>`);
      } else {
        zones.forEach(z=>{
          const zt=tasks.filter(t=>String(t.zoneId)===String(z.id));
          parts.push(`
            <div class="card" style="border-left:5px solid ${z.color||'var(--todo)'};">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;">
                <div>
                  <div style="font-weight:950;font-size:16px;color:${z.color||'var(--todo)'};">${z.name||'Zone'}</div>
                  <div class="small">${zt.length} tâche${zt.length>1?'s':''}</div>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="icon-btn todo" onclick="app.todo.openZone('${z.id}')"><i class="fas fa-pen"></i></button>
                  <button class="icon-btn todo" onclick="app.todo.openTask(null,'${z.id}')" title="Ajouter tâche"><i class="fas fa-plus"></i></button>
                </div>
              </div>
          `);
          if(zt.length){
            zt.sort((a,b)=>(a.time||'').localeCompare(b.time||'')).forEach(t=>{
              const freqLabel=FREQ_LABELS[t.freq||'weekly']||'Hebdo';
              let schedLabel='';
              if(!t.freq||t.freq==='weekly')schedLabel=(t.days||[]).map(d=>DAY_LABELS[d]).join(' ');
              else if(t.freq==='daily')schedLabel='Tous les jours';
              else if(t.freq==='monthly')schedLabel='Jours: '+(t.monthDays||[]).join(', ');
              else if(t.freq==='yearly')schedLabel=t.yearlyDate||'?/?';
              parts.push(`
                <div class="list-item" style="min-height:60px;border-left:3px solid ${z.color||'var(--todo)'};">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:900;font-size:14px;">${t.time?`<span class="time-chip" style="font-size:11px;margin-right:6px;">${t.time}</span>`:''}${t.name||''}</div>
                    <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
                      <span class="chip" style="background:#ede9fe;color:#5b21b6;">${freqLabel}</span>
                      <span class="small">${schedLabel}</span>
                    </div>
                    ${t.notes?`<div class="small" style="margin-top:3px;">${t.notes}</div>`:''}
                  </div>
                  <button class="icon-btn todo" style="flex-shrink:0;" onclick="app.todo.openTask('${t.id}')"><i class="fas fa-pen"></i></button>
                </div>
              `);
            });
          } else {
            parts.push(`<div class="small" style="text-align:center;padding:10px;color:#cbd5e1;">Aucune tâche — <span style="color:var(--todo);cursor:pointer;" onclick="app.todo.openTask(null,'${z.id}')">+ ajouter</span></div>`);
          }
          parts.push('</div>');
        });
      }
      wrap.innerHTML=parts.join('');
    },

    renderHistory:async function(){
      const wrap=document.getElementById('todo-history');if(!wrap)return;
      wrap.innerHTML=`<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin" style="font-size:30px;color:var(--todo);"></i></div>`;
      try{
        const sevenDaysAgo=new Date();sevenDaysAgo.setDate(sevenDaysAgo.getDate()-6);
        const cutStr=`${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth()+1).padStart(2,'0')}-${String(sevenDaysAgo.getDate()).padStart(2,'0')}`;
        const q=query(colTodoLogs,where("date",">=",cutStr),orderBy("date","desc"),limit(500));
        const snap=await getDocs(q);
        const logs=[];snap.forEach(d=>logs.push({_id:d.id,...d.data()}));
        if(!logs.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-clock-rotate-left"></i>Aucun historique cette semaine.</div>`;return;}
        const byDay={};
        logs.forEach(l=>{if(!byDay[l.date])byDay[l.date]=[];byDay[l.date].push(l);});
        const parts=[];
        Object.keys(byDay).sort().reverse().forEach(day=>{
          const d=new Date(day+'T12:00:00');
          const label=d.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'short'});
          const dl=byDay[day];
          const byZone={};dl.forEach(l=>{const k=l.zoneName||'Sans zone';if(!byZone[k])byZone[k]=[];byZone[k].push(l);});
          parts.push(`<div class="group-header" style="background:var(--todo)"><span>${label}</span><span class="small" style="color:rgba(255,255,255,.8)">${dl.length} tâche${dl.length>1?'s':''}</span></div>`);
          Object.keys(byZone).sort().forEach(zn=>{
            parts.push(`<div style="padding:4px 0 4px 10px;font-weight:800;font-size:12px;color:var(--todo);text-transform:uppercase;">${zn}</div>`);
            byZone[zn].sort((a,b)=>(a.ts||0)-(b.ts||0)).forEach(l=>{
              parts.push(`<div style="padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
                <div><div style="font-weight:900;font-size:13px;">${l.taskName||''}</div><div class="small"><i class="fas fa-user"></i> ${l.user||''}</div></div>
                <div class="small" style="white-space:nowrap;color:var(--todo);font-weight:800;">${formatDate(l.ts)}</div>
              </div>`);
            });
          });
        });
        wrap.innerHTML=parts.join('');
      }catch(e){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-circle-exclamation"></i>Impossible de charger l'historique.</div>`;}
    },

    // ── ZONE MODAL ──
    openZone(id=null){
      const m=document.getElementById('modal-todo-zone');m.classList.remove('hidden');
      document.getElementById('todo-zone-modal-title').innerHTML=id?'<i class="fas fa-pen"></i> Modifier Zone':'<i class="fas fa-plus"></i> Créer une Zone';
      document.getElementById('tz-del-btn').style.display=id?'block':'none';
      document.getElementById('tz-id').value=id||'';
      const grid=document.getElementById('tz-color-grid');
      const cur=id?(window.app.data.todo.zones||[]).find(z=>String(z.id)===String(id))?.color||ZONE_COLORS[0]:ZONE_COLORS[0];
      grid.innerHTML=ZONE_COLORS.map(c=>`<div class="color-swatch ${c===cur?'selected':''}" style="background:${c};" onclick="app.todo._selectColor('${c}',this)"></div>`).join('');
      document.getElementById('tz-color').value=cur;
      if(id){const z=(window.app.data.todo.zones||[]).find(x=>String(x.id)===String(id));document.getElementById('tz-name').value=z?.name||'';}
      else{document.getElementById('tz-name').value='';}
      document.getElementById('err-tz-name').classList.remove('show');document.getElementById('tz-name').classList.remove('invalid');
    },
    _selectColor(color,el){
      document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
      el.classList.add('selected');document.getElementById('tz-color').value=color;
    },
    saveZone:async function(){
      const name=(document.getElementById('tz-name').value||'').trim().toUpperCase();
      if(!name){document.getElementById('tz-name').classList.add('invalid');document.getElementById('err-tz-name').classList.add('show');return;}
      const id=document.getElementById('tz-id').value;
      const color=document.getElementById('tz-color').value||ZONE_COLORS[0];
      const o={id:id?Number(id):Date.now(),name,color};
      if(id){const idx=(window.app.data.todo.zones||[]).findIndex(z=>String(z.id)===String(id));if(idx>-1)window.app.data.todo.zones[idx]=o;}
      else{if(!window.app.data.todo.zones)window.app.data.todo.zones=[];window.app.data.todo.zones.push(o);}
      spin(true);try{await window.app.save('todo');toast('Zone enregistrée.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-zone').classList.add('hidden');this.renderConfig();this.renderToday();
    },
    delZone:async function(){
      const id=document.getElementById('tz-id').value;if(!id)return;
      const ok=await dlgConfirm('Supprimer zone','Supprimer cette zone ? Les tâches de cette zone seront aussi supprimées.');if(!ok)return;
      window.app.data.todo.zones=(window.app.data.todo.zones||[]).filter(z=>String(z.id)!==String(id));
      window.app.data.todo.tasks=(window.app.data.todo.tasks||[]).filter(t=>String(t.zoneId)!==String(id));
      spin(true);try{await window.app.save('todo');toast('Zone supprimée.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-zone').classList.add('hidden');this.renderConfig();this.renderToday();
    },

    // ── FREQUENCY HELPERS ──
    _setFreq(freq){
      this._editingFreq=freq;
      ['daily','weekly','monthly','yearly'].forEach(f=>{
        document.getElementById(`freq-${f}-tab`).classList.toggle('active',f===freq);
        document.getElementById(`freq-panel-${f}`).classList.toggle('active',f===freq);
      });
    },
    _renderMonthDaysGrid(){
      const grid=document.getElementById('tt-month-days-grid');if(!grid)return;
      let html='';
      for(let d=1;d<=31;d++){
        const on=this._editingMonthDays.has(d);
        html+=`<button type="button" class="month-day-btn ${on?'on':''}" onclick="app.todo._toggleMonthDay(${d})">${d}</button>`;
      }
      grid.innerHTML=html;
    },
    _toggleMonthDay(d){
      if(this._editingMonthDays.has(d))this._editingMonthDays.delete(d);else this._editingMonthDays.add(d);
      this._renderMonthDaysGrid();
    },

    // ── TASK MODAL ──
    openTask(id=null,defaultZoneId=null){
      const m=document.getElementById('modal-todo-task');m.classList.remove('hidden');
      document.getElementById('todo-task-modal-title').innerHTML=id?'<i class="fas fa-pen"></i> Modifier Tâche':'<i class="fas fa-plus"></i> Créer une Tâche';
      document.getElementById('tt-del-btn').style.display=id?'block':'none';
      document.getElementById('tt-id').value=id||'';
      const zSel=document.getElementById('tt-zone');
      zSel.innerHTML=(window.app.data.todo.zones||[]).map(z=>`<option value="${z.id}">${z.name||'Zone'}</option>`).join('');
      if(id){
        const t=(window.app.data.todo.tasks||[]).find(x=>String(x.id)===String(id));
        if(t){
          zSel.value=String(t.zoneId||'');
          document.getElementById('tt-name').value=t.name||'';
          document.getElementById('tt-time').value=t.time||'';
          document.getElementById('tt-notes').value=t.notes||'';
          const freq=t.freq||'weekly';
          this._editingFreq=freq;
          this._editingTaskDays=new Set((t.days||[]).map(d=>Number(d)));
          this._editingMonthDays=new Set((t.monthDays||[]).map(d=>Number(d)));
          document.getElementById('tt-yearly-date').value=t.yearlyDate||'';
          this._setFreq(freq);
        }
      } else {
        document.getElementById('tt-name').value='';document.getElementById('tt-time').value='';document.getElementById('tt-notes').value='';
        document.getElementById('tt-yearly-date').value='';
        if(defaultZoneId)zSel.value=String(defaultZoneId);
        this._editingFreq='weekly';
        this._editingTaskDays=new Set([1,2,3,4,5]);
        this._editingMonthDays=new Set();
        this._setFreq('weekly');
      }
      this._renderDayPills();
      this._renderMonthDaysGrid();
      document.getElementById('err-tt-name').classList.remove('show');
      document.getElementById('tt-name').classList.remove('invalid');
    },
    _renderDayPills(){
      const row=document.getElementById('tt-days-row');if(!row)return;
      const order=[1,2,3,4,5,6,0];
      row.innerHTML=order.map(d=>{
        const on=this._editingTaskDays.has(d);
        return`<span class="day-pill ${on?'on':'off'}" onclick="app.todo._toggleDay(${d})">${DAY_LABELS[d]}</span>`;
      }).join('');
    },
    _toggleDay(d){
      if(this._editingTaskDays.has(d))this._editingTaskDays.delete(d);else this._editingTaskDays.add(d);
      this._renderDayPills();
    },
    saveTask:async function(){
      const name=(document.getElementById('tt-name').value||'').trim();
      if(!name){document.getElementById('tt-name').classList.add('invalid');document.getElementById('err-tt-name').classList.add('show');return;}
      const freq=this._editingFreq||'weekly';
      // Validate
      if(freq==='weekly'&&!this._editingTaskDays.size){document.getElementById('err-tt-days').classList.add('show');return;}
      if(freq==='monthly'&&!this._editingMonthDays.size){document.getElementById('err-tt-days-m').classList.add('show');return;}
      const id=document.getElementById('tt-id').value;
      const o={
        id:id?Number(id):Date.now(),
        zoneId:Number(document.getElementById('tt-zone').value)||0,
        name,
        time:document.getElementById('tt-time').value||'',
        freq,
        days:freq==='weekly'?[...this._editingTaskDays].sort():[],
        monthDays:freq==='monthly'?[...this._editingMonthDays].sort():[],
        yearlyDate:freq==='yearly'?(document.getElementById('tt-yearly-date').value||''):'',
        notes:(document.getElementById('tt-notes').value||'').trim()
      };
      if(id){const idx=(window.app.data.todo.tasks||[]).findIndex(t=>String(t.id)===String(id));if(idx>-1)window.app.data.todo.tasks[idx]=o;}
      else{if(!window.app.data.todo.tasks)window.app.data.todo.tasks=[];window.app.data.todo.tasks.push(o);}
      spin(true);try{await window.app.save('todo');toast('Tâche enregistrée.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-task').classList.add('hidden');this.renderConfig();this.renderToday();window.app.updateHomeBadges();
    },
    delTask:async function(){
      const id=document.getElementById('tt-id').value;if(!id)return;
      const ok=await dlgConfirm('Supprimer tâche','Supprimer cette tâche ?');if(!ok)return;
      window.app.data.todo.tasks=(window.app.data.todo.tasks||[]).filter(t=>String(t.id)!==String(id));
      spin(true);try{await window.app.save('todo');toast('Tâche supprimée.','ok');}catch(e){toast('Erreur.','err');}finally{spin(false);}
      document.getElementById('modal-todo-task').classList.add('hidden');this.renderConfig();this.renderToday();window.app.updateHomeBadges();
    }
  },

  // ══════════════════════════════════════════════════
  // ── RÉCEPTION MODULE ──
  // ══════════════════════════════════════════════════
  reception:{
    _photoData:'',
    _currentSupplierCode:null,
    _currentType:null,

    // Supplier catalog — each can have multiple types
    SUPPLIERS:{
      '011':{name:'COLOMIERS 011', types:['sec','frais','surgele']},
      '392':{name:'PLAISANCE 392', types:['frais','surgele','sec']},
      '032':{name:'ST GILES 032',  types:['surgele','frais','sec']}
    },
    TYPE_CONFIG:{
      frais:   {label:'FRAIS',    icon:'fa-snowflake',    tempMin:0,  tempMax:4,   color:'#065f46', bg:'#d1fae5'},
      surgele: {label:'SURGELÉ',  icon:'fa-temperature-arrow-down', tempMin:-23,tempMax:-18,color:'#1e3a8a', bg:'#dbeafe'},
      sec:     {label:'SEC',      icon:'fa-box',          tempMin:null,tempMax:null,color:'#92400e', bg:'#fef3c7'}
    },

    // Planning des livraisons extrait du fichier logistique
    PLANNING:{
      0:{ // Dimanche
        livraisons:[]
      },
      1:{ // Lundi
        livraisons:[
          {sup:'011',name:'COLOMIERS 011',type:'sec',  label:'Livraison Sec/Épicerie',heure:'09H00-11H00',info:'CDE Mercredi → LIV Lundi'},
          {sup:'032',name:'ST GILES 032', type:'surgele',label:'Livraison Surgelés',heure:'08H30-09H30',info:'CDE Mercredi → LIV Lundi'},
        ]
      },
      2:{ // Mardi
        livraisons:[
          {sup:'011',name:'COLOMIERS 011',type:'sec',  label:'Livraison Sec/Bazar',  heure:'09H00-11H00',info:'CDE Lundi → LIV Mardi a.m'},
          {sup:'392',name:'PLAISANCE 392',type:'frais',label:'Livraison Produits Frais',heure:'7H',       info:'CDE Samedi → LIV Mardi'},
        ]
      },
      3:{ // Mercredi
        livraisons:[
          {sup:'032',name:'ST GILES 032', type:'surgele',label:'Livraison Surgelés', heure:'08H30-09H30',info:'CDE Lundi → LIV Mercredi'},
        ]
      },
      4:{ // Jeudi
        livraisons:[
          {sup:'011',name:'COLOMIERS 011',type:'sec',  label:'Livraison Sec/Épicerie',heure:'09H00-11H00',info:'CDE Mercredi → LIV Jeudi a.m'},
          {sup:'392',name:'PLAISANCE 392',type:'frais',label:'Livraison Produits Frais',heure:'7H',       info:'CDE Mardi → LIV Jeudi'},
        ]
      },
      5:{ // Vendredi
        livraisons:[
          {sup:'032',name:'ST GILES 032', type:'surgele',label:'Livraison Surgelés', heure:'08H30-09H30',info:'CDE Mercredi → LIV Vendredi'},
        ]
      },
      6:{ // Samedi
        livraisons:[
          {sup:'392',name:'PLAISANCE 392',type:'frais',label:'Livraison Produits Frais',heure:'7H',      info:'CDE Mardi → LIV Samedi'},
        ]
      }
    },

    init(){
      const inp=document.getElementById('rec-datetime');
      if(inp)inp.value=tsToInput(Date.now());
      const fi=document.getElementById('rec-photo-input');
      if(fi&&!fi._wired){fi._wired=true;fi.addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{window.app.reception._photoData=b64;const prev=document.getElementById('rec-photo-preview');prev.src=b64;prev.style.display='block';});});}
    },

    selectSupplier(code){
      this._currentSupplierCode=code;
      this._currentType=null;
      // Highlight supplier button
      document.querySelectorAll('.supplier-select-btn').forEach(b=>b.classList.remove('selected'));
      const btn=document.getElementById('sup-btn-'+code);if(btn)btn.classList.add('selected');
      // Hide final selection display, show type grid
      document.getElementById('rec-selected-supplier').style.display='none';
      document.getElementById('rec-temp-section').style.display='none';
      document.getElementById('rec-type-section').style.display='block';
      // Build type buttons
      const sup=this.SUPPLIERS[code];
      const grid=document.getElementById('rec-type-grid');
      grid.innerHTML=sup.types.map(t=>{
        const tc=this.TYPE_CONFIG[t];
        return`<div class="sup-type-btn ${t}" onclick="app.reception.selectType('${t}')" style="border-color:${tc.bg};">
          <i class="fas ${tc.icon}" style="font-size:18px;color:${tc.color};display:block;margin-bottom:4px;"></i>
          <div style="color:${tc.color};font-size:11px;">${tc.label}</div>
        </div>`;
      }).join('');
    },

    selectType(type){
      this._currentType=type;
      const code=this._currentSupplierCode;
      const sup=this.SUPPLIERS[code];
      const tc=this.TYPE_CONFIG[type];
      // Mark type button active
      document.querySelectorAll('.sup-type-btn').forEach(b=>b.classList.remove('on'));
      document.querySelectorAll(`.sup-type-btn.${type}`).forEach(b=>b.classList.add('on'));
      // Hide type grid, show summary
      setTimeout(()=>{
        document.getElementById('rec-type-section').style.display='none';
        document.getElementById('rec-selected-supplier').style.display='block';
        document.getElementById('rec-sup-label').textContent=sup.name+' • '+tc.label;
        let typeLabel='';
        if(type==='sec')typeLabel='SEC — Pas de contrôle température';
        else typeLabel=`${tc.label} — Plage: ${tc.tempMin}°C à ${tc.tempMax}°C`;
        document.getElementById('rec-sup-type-label').textContent=typeLabel;
        // Show/hide temp
        const ts=document.getElementById('rec-temp-section');
        if(type==='sec'){ts.style.display='none';if(document.getElementById('rec-temp'))document.getElementById('rec-temp').value='';}
        else{
          ts.style.display='block';
          document.getElementById('rec-temp-range-label').textContent=`Plage acceptée : ${tc.tempMin}°C à ${tc.tempMax}°C`;
          document.getElementById('rec-temp').placeholder=type==='frais'?'Ex: 2.5':'Ex: -20';
          document.getElementById('rec-temp-status').innerHTML='';
        }
      },120);
    },

    clearSupplier(){
      this._currentSupplierCode=null;this._currentType=null;
      document.querySelectorAll('.supplier-select-btn').forEach(b=>b.classList.remove('selected'));
      document.getElementById('rec-selected-supplier').style.display='none';
      document.getElementById('rec-type-section').style.display='none';
      document.getElementById('rec-temp-section').style.display='none';
    },

    _updateTempStatus(){
      const type=this._currentType;if(!type||type==='sec')return;
      const tc=this.TYPE_CONFIG[type];
      const v=parseFloat(document.getElementById('rec-temp').value);
      const div=document.getElementById('rec-temp-status');
      if(isNaN(v)){div.innerHTML='';return;}
      const ok=v>=tc.tempMin&&v<=tc.tempMax;
      div.innerHTML=ok
        ?`<div style="background:#d1fae5;color:#065f46;padding:10px;border-radius:10px;font-weight:900;margin-bottom:8px;"><i class="fas fa-check-circle"></i> ${v}°C — DANS LA NORME (${tc.tempMin}°C à ${tc.tempMax}°C)</div>`
        :`<div style="background:#fee2e2;color:#991b1b;padding:10px;border-radius:10px;font-weight:900;margin-bottom:8px;"><i class="fas fa-triangle-exclamation"></i> ${v}°C — HORS NORME ! (${tc.tempMin}°C à ${tc.tempMax}°C)</div>`;
    },

    tab(t){
      document.querySelectorAll('#view-reception .tab').forEach(e=>e.classList.remove('active'));
      const tabMap={new:'trec-1',history:'trec-2',planning:'trec-3',tracking:'trec-4'};
      if(document.getElementById(tabMap[t]))document.getElementById(tabMap[t]).classList.add('active');
      document.getElementById('reception-new').classList.toggle('hidden',t!=='new');
      document.getElementById('reception-history').classList.toggle('hidden',t!=='history');
      document.getElementById('reception-planning').classList.toggle('hidden',t!=='planning');
      const trackEl=document.getElementById('reception-tracking');
      if(trackEl)trackEl.classList.toggle('hidden',t!=='tracking');
      if(t==='history')this.renderHistory();
      if(t==='planning')this.renderPlanning();
    },

    renderPlanning(){
      const wrap=document.getElementById('reception-planning');if(!wrap)return;
      const now=new Date();const today=now.getDay();
      const jours=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
      const TYPE_COLORS={sec:'sec',frais:'frais',surgele:'surgele'};
      const parts=[`
        <div class="card" style="border-left:5px solid var(--reception);margin-bottom:16px;">
          <div style="font-weight:950;font-size:15px;color:var(--reception);margin-bottom:4px;"><i class="fas fa-calendar-alt"></i> Planning des livraisons</div>
          <div class="small">Magasin Express Purpan • Code 32364</div>
          <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
            <span class="sup-badge-sm sup-badge-sec">SEC 09H00-11H00</span>
            <span class="sup-badge-sm sup-badge-frais">FRAIS 07H00</span>
            <span class="sup-badge-sm sup-badge-surgele">SURGELÉ 08H30-09H30</span>
          </div>
        </div>
      `];
      // Show from today cycling through the week
      for(let offset=0;offset<7;offset++){
        const dow=(today+offset)%7;
        const plan=this.PLANNING[dow];
        if(!plan||!plan.livraisons.length)continue;
        const isToday=offset===0;
        const dateLabel=isToday?'Aujourd\'hui':offset===1?'Demain':jours[dow];
        parts.push(`<div class="planning-card${isToday?' today-highlight':''}">
          <div class="planning-day-header">
            ${isToday?'<span style="background:var(--reception);color:#fff;border-radius:6px;padding:2px 8px;font-size:12px;">AUJOURD\'HUI</span>':''}
            <span>${dateLabel}</span>
          </div>`);
        plan.livraisons.forEach(l=>{
          const tc=this.TYPE_CONFIG[l.type]||{};
          parts.push(`<div class="planning-delivery">
            <span class="sup-badge-sm sup-badge-${l.type}">${(tc.label||l.type).toUpperCase()}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:900;font-size:13px;">${l.name}</div>
              <div class="small">${l.label} • ⏰ ${l.heure}</div>
              <div class="small" style="color:#94a3b8;">${l.info}</div>
            </div>
            <button onclick="app.reception.tab('new');setTimeout(()=>app.reception.selectSupplier('${l.sup}'),100);" style="background:var(--reception);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-weight:900;cursor:pointer;font-size:11px;"><i class="fas fa-check"></i></button>
          </div>`);
        });
        parts.push('</div>');
      }
      wrap.innerHTML=parts.join('');
    },

    save:async function(conform){
      const code=this._currentSupplierCode;const type=this._currentType;
      if(!code||!type)return toast('Sélectionnez un fournisseur et un type.','warn');
      const sup=this.SUPPLIERS[code];const tc=this.TYPE_CONFIG[type];
      const product=(document.getElementById('rec-product').value||'').trim();
      if(!product)return toast('Produit requis.','warn');
      const ts=inputToTs(document.getElementById('rec-datetime').value)||Date.now();
      let temp=null;let tempOk=true;
      if(type!=='sec'){
        const tv=document.getElementById('rec-temp').value;
        if(tv===''||isNaN(parseFloat(tv)))return toast('Température requise.','warn');
        temp=parseFloat(tv);tempOk=temp>=tc.tempMin&&temp<=tc.tempMax;
        if(!tempOk&&conform){const ok=await dlgConfirm('Température hors norme','Hors norme. Confirmer quand même CONFORME ?');if(!ok)return;}
      }
      const entry={ts,date:todayStr(),supplier:sup.name,supplierCode:code,supplierType:type,product,temp,tempMin:tc.tempMin,tempMax:tc.tempMax,tempOk,conform,notes:(document.getElementById('rec-notes').value||'').trim(),photo:this._photoData||'',user:window.app.me?.name||(window.app.me?.email||'USER')};
      spin(true);
      try{
        const ref=await addDoc(colReception,entry);
        window.app.data.reception.unshift({_id:ref.id,...entry});
        document.getElementById('rec-product').value='';document.getElementById('rec-notes').value='';
        if(document.getElementById('rec-temp'))document.getElementById('rec-temp').value='';
        document.getElementById('rec-temp-status').innerHTML='';
        document.getElementById('rec-photo-preview').style.display='none';
        document.getElementById('rec-datetime').value=tsToInput(Date.now());
        document.getElementById('rec-photo-input').value='';this._photoData='';
        toast(conform?`✓ ${sup.name} (${tc.label}) — Conforme`:`⚠ ${sup.name} — NON CONFORME`,'ok',4000);
      }catch(e){toast('Erreur sauvegarde.','err');}finally{spin(false);}
    },

    renderHistory(){
      const wrap=document.getElementById('reception-history');if(!wrap)return;
      const logs=(window.app.data.reception||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
      if(!logs.length){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-truck-ramp-box"></i>Aucun contrôle enregistré.</div>`;return;}
      const byDay={};logs.forEach(l=>{const d=l.date||todayStr();if(!byDay[d])byDay[d]=[];byDay[d].push(l);});
      const parts=[];
      Object.keys(byDay).sort().reverse().forEach(day=>{
        const d=new Date(day+'T12:00:00');
        const label=d.toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'short',year:'numeric'});
        parts.push(`<div class="group-header" style="background:var(--reception)"><span>${label}</span><span class="small" style="color:rgba(255,255,255,.8)">${byDay[day].length} contrôle(s)</span></div>`);
        byDay[day].forEach(l=>{
          const conformBadge=l.conform?`<span class="chip ok"><i class="fas fa-check"></i> CONFORME</span>`:`<span class="chip warn"><i class="fas fa-triangle-exclamation"></i> NON CONFORME</span>`;
          const tc=this.TYPE_CONFIG[l.supplierType]||{color:'#475569'};
          const tempInfo=l.temp!==null&&l.temp!==undefined?`<span style="font-weight:950;color:${l.tempOk!==false?'#10b981':'#ef4444'};font-size:16px;">${l.temp}°C</span> <span class="small">(${l.tempMin??'?'}°C à ${l.tempMax??'?'}°C)</span>`:'<span class="small">Sec — pas de temp.</span>';
          parts.push(`<div class="reception-card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
              <div style="font-weight:950;font-size:15px;color:${tc.color};">${l.supplier||''} <span class="small">${l.supplierType||''}</span></div>${conformBadge}
            </div>
            <div style="font-size:14px;font-weight:700;margin-bottom:6px;">${l.product||''}</div>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">${tempInfo}<span class="small">${formatDate(l.ts)}</span><span class="small"><i class="fas fa-user"></i> ${l.user||''}</span></div>
            ${l.notes?`<div class="small" style="margin-top:4px;color:#475569;font-style:italic;">${l.notes}</div>`:''}
            ${l.photo?`<img src="${l.photo}" style="width:100%;max-height:140px;object-fit:contain;border-radius:10px;margin-top:8px;">`:''}</div>`);
        });
      });
      wrap.innerHTML=parts.join('');
    }
  },

  // ══════════════════════════════════════════════════
  // ── INSPECTION MODULE ──
  // ══════════════════════════════════════════════════
  inspection:{
    render:async function(){
      const wrap=document.getElementById('inspection-content');if(!wrap)return;
      wrap.innerHTML=`<div style="text-align:center;padding:30px;"><i class="fas fa-spinner fa-spin" style="font-size:30px;color:var(--primary);"></i></div>`;
      try{
        const today=new Date();today.setHours(0,0,0,0);const todayTs=today.getTime();
        const weekAgo=todayTs-(7*24*60*60*1000);const monthAgo=todayTs-(30*24*60*60*1000);
        const todoLogs=window.app.data.todoLogs||[];const todayTasks=window.app.todo.todayTaskList();
        const todoDone=todoLogs.length;const todoTotal=todayTasks.length;const todoPct=todoTotal>0?Math.round(todoDone/todoTotal*100):0;
        const frigoRem=window.app.frigo.remainingTodayTotal();const frigoTotal=(window.app.data.frigo.fridges||[]).length*(window.app.data.frigo.perDay||2);const frigoDone=frigoTotal-frigoRem;
        const recLogs=(window.app.data.reception||[]).filter(r=>(r.ts||0)>=monthAgo);const recConform=recLogs.filter(r=>r.conform).length;const recNonConform=recLogs.filter(r=>!r.conform).length;
        const fraisAlerts=window.app.data.frais.filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;}).length;
        const users=window.app.data.users||[];const frigoLogs7=(window.app.data.frigo.logs||[]).filter(l=>(l.ts||0)>=weekAgo);
        const parts=[];
        parts.push(`<div class="kpi-grid"><div class="kpi-card" style="background:linear-gradient(135deg,var(--todo),#5b21b6);color:#fff;"><div class="kpi-val">${todoPct}%</div><div class="kpi-lbl">CHECK-LIST</div></div><div class="kpi-card" style="background:linear-gradient(135deg,var(--frigo),#0369a1);color:#fff;"><div class="kpi-val">${frigoDone}/${frigoTotal}</div><div class="kpi-lbl">RELEVÉS FRIGO</div></div><div class="kpi-card" style="background:linear-gradient(135deg,var(--reception),#047857);color:#fff;"><div class="kpi-val">${recConform}</div><div class="kpi-lbl">CONF. (30J)</div></div><div class="kpi-card" style="background:linear-gradient(135deg,${recNonConform>0?'#ef4444,#b91c1c':'#6b7280,#374151'});color:#fff;"><div class="kpi-val">${recNonConform}</div><div class="kpi-lbl">NON CONF. (30J)</div></div></div>${fraisAlerts>0?`<div style="background:#fee2e2;border-left:5px solid #ef4444;border-radius:12px;padding:14px;margin-bottom:12px;font-weight:900;color:#991b1b;"><i class="fas fa-triangle-exclamation"></i> ${fraisAlerts} produit(s) frais à DLC !</div>`:''}`);
        parts.push(`<div class="inspection-section"><h4><i class="fas fa-users"></i> Équipe (${users.length})</h4>${users.map(u=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;"><div style="font-weight:800;">${u.name||u.email||'?'} ${u.role==='admin'?'<span class="chip admin">ADMIN</span>':'<span class="chip staff">STAFF</span>'}</div><div class="small">${u.email||''}</div></div>`).join('')}</div>`);
        if(frigoLogs7.length){const avgTemp=(frigoLogs7.reduce((s,l)=>s+(l.temp||0),0)/frigoLogs7.length).toFixed(1);const maxTemp=Math.max(...frigoLogs7.map(l=>l.temp||0)).toFixed(1);const minTemp=Math.min(...frigoLogs7.map(l=>l.temp||0)).toFixed(1);parts.push(`<div class="inspection-section"><h4><i class="fas fa-temperature-half" style="color:var(--frigo);"></i> Températures (7 jours)</h4><div class="kpi-grid"><div class="kpi-card" style="background:#f0f9ff;"><div class="kpi-val" style="color:var(--frigo);font-size:22px;">${avgTemp}°C</div><div class="kpi-lbl" style="color:#0369a1;">MOYENNE</div></div><div class="kpi-card" style="background:#f0f9ff;"><div class="kpi-val" style="color:#ef4444;font-size:22px;">${maxTemp}°C</div><div class="kpi-lbl" style="color:#0369a1;">MAX</div></div></div><div class="small">Min: ${minTemp}°C • ${frigoLogs7.length} relevé(s)</div></div>`);}
        const recNC=(window.app.data.reception||[]).filter(r=>!r.conform&&(r.ts||0)>=monthAgo);
        if(recNC.length){parts.push(`<div class="inspection-section" style="border-left:4px solid #ef4444;"><h4 style="color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Non-conformités (30J)</h4>${recNC.slice(0,5).map(r=>`<div style="padding:8px 0;border-bottom:1px solid #fee2e2;"><div style="font-weight:800;">${r.supplier||'?'} — ${r.product||'?'}</div><div class="small">${formatDate(r.ts)} • ${r.temp}°C (lim. ${r.tempLimit}°C) • ${r.user||''}</div>${r.notes?`<div class="small" style="color:#7f1d1d;">${r.notes}</div>`:''}</div>`).join('')}${recNC.length>5?`<div class="small" style="text-align:center;margin-top:8px;">+ ${recNC.length-5} autre(s)</div>`:''}</div>`);}
        parts.push(`<div class="inspection-section"><h4><i class="fas fa-file-export"></i> Exporter</h4><button class="export-btn" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('frigo')"><i class="fas fa-temperature-half"></i> Export températures (CSV)</button><button class="export-btn" style="background:linear-gradient(135deg,var(--reception),#047857);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('reception')"><i class="fas fa-truck-ramp-box"></i> Export réceptions (CSV)</button><button class="export-btn" style="background:linear-gradient(135deg,var(--todo),#5b21b6);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('todo')"><i class="fas fa-list-check"></i> Export check-list (CSV)</button><button class="export-btn" style="background:linear-gradient(135deg,var(--pvp),#b45309);color:#fff;margin-bottom:10px;" onclick="app.inspection.exportCSV('tracabilite')"><i class="fas fa-camera"></i> Export traçabilités PVP+Salad (CSV)</button></div>`);
        wrap.innerHTML=parts.join('');
      }catch(e){wrap.innerHTML=`<div class="empty-state"><i class="fas fa-circle-exclamation"></i>Erreur de chargement.</div>`;}
    },
    exportCSV(type){
      let rows=[];let filename='';
      if(type==='frigo'){filename='temperatures.csv';rows=[['Frigo','Temperature','Date','Heure','Operateur']];(window.app.data.frigo.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(l=>{const d=new Date(l.ts||0);rows.push([l.fridgeName||'',l.temp||'',d.toLocaleDateString('fr'),d.toLocaleTimeString('fr'),l.user||'']);});}
      else if(type==='reception'){filename='receptions.csv';rows=[['Date','Heure','Fournisseur','Produit','Temperature','Limite','Conforme','Operateur','Observations']];(window.app.data.reception||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(l=>{const d=new Date(l.ts||0);rows.push([d.toLocaleDateString('fr'),d.toLocaleTimeString('fr'),l.supplier||'',l.product||'',l.temp||'',l.tempLimit||'',l.conform?'OUI':'NON',l.user||'',l.notes||'']);});}
      else if(type==='todo'){filename='checklist.csv';rows=[['Date','Zone','Tache','Operateur','Heure']];(window.app.data.todoLogs||[]).forEach(l=>{const d=new Date(l.ts||0);rows.push([l.date||'',l.zoneName||'',l.taskName||'',l.user||'',d.toLocaleTimeString('fr')]);});}
      else if(type==='tracabilite'){
        filename='tracabilites_pvp_salad.csv';
        rows=[['Module','Produit','Date','Heure','Operateur','Photo URL']];
        // We don't have local trace data — explain
        toast('Les traçabilités sont stockées dans Firebase Storage. Utilisez l\'interface web Firebase pour un export complet.','info',6000);
        rows.push(['INFO','Les photos de traçabilité sont dans Firebase Storage > pvp_trace / salad_trace','','','','']);
        // Export the list of pvp/salad stock items with names as reference
        window.app.data.pvpStock.forEach(s=>{rows.push(['PVP',s.name||'',new Date(s.out||0).toLocaleDateString('fr'),new Date(s.out||0).toLocaleTimeString('fr'),'','Voir Firebase Storage > pvp_trace/'+s.libId]);});
        window.app.data.saladStock.forEach(s=>{rows.push(['SALAD BAR',s.name||'',new Date(s.out||0).toLocaleDateString('fr'),new Date(s.out||0).toLocaleTimeString('fr'),'','Voir Firebase Storage > salad_trace/'+s.libId]);});
      }
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
      toast('Export CSV téléchargé.','ok');
    }
  },

  // ══════════════════════════════════════════════════
  // ── DYNACAD MODULE ──
  // ══════════════════════════════════════════════════
  dynacad:{
    _url:'https://dynacad.fr.carrefour.com/',
    _loginUrl:'https://dynacad.fr.carrefour.com/',
    _id:'jonathan_araujo_4',
    _pwd:'PurpanCHU32?',

    open(){
      const overlay=document.getElementById('dynacad-overlay');
      if(overlay)overlay.style.display='flex';
      // Try to put credentials in clipboard for convenience
      try{navigator.clipboard.writeText(this._id+'\n'+this._pwd);}catch(e){}
      toast('Identifiants copiés dans le presse-papier','info',3000);
    },

    close(){
      const overlay=document.getElementById('dynacad-overlay');
      if(overlay)overlay.style.display='none';
      // Clear iframe
      const frame=document.getElementById('dynacad-iframe');
      if(frame)frame.src='about:blank';
    },

    openExternal(){
      // Copy credentials to clipboard then open URL
      try{
        const text=`Identifiant: ${this._id}\nMot de passe: ${this._pwd}`;
        navigator.clipboard.writeText(text).then(()=>{
          toast('Identifiants copiés ! Collez-les sur la page de connexion.','ok',4000);
        }).catch(()=>{});
      }catch(e){}
      window.open(this._url,'_blank','noopener');
    }
  },

  // ══════════════════════════════════════════════════
  // ── ÉTIQUETTES MODULE (Brother TD-2120N) ──
  // ══════════════════════════════════════════════════
  etiquettes:{
    _items:[],

    loadProducts(){
      const today=new Date();today.setHours(23,59,59,999);
      const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);yesterday.setHours(23,59,59,999);
      this._items=window.app.data.frais
        .filter(i=>{const d=new Date(i.date);return!isNaN(d.getTime())&&d<=today;})
        .map(i=>({fraisId:i.id,name:i.name,fam:i.fam||'',qty:Number(i.qty||0),date:i.date,price:'',pct:50,printQty:1,selected:true}));
      this.renderProductList();
    },

    renderProductList(){
      const wrap=document.getElementById('etiq-product-list');if(!wrap)return;
      if(!this._items.length){
        wrap.innerHTML=`<div style="text-align:center;padding:20px;color:#9333ea;"><i class="fas fa-check-circle" style="font-size:30px;margin-bottom:8px;display:block;"></i><div style="font-weight:900;">Aucun produit à DLC aujourd\'hui 🎉</div></div>`;
        document.getElementById('etiq-config-card').style.display='none';
        return;
      }
      wrap.innerHTML=this._items.map((it,idx)=>`
        <div class="etiq-product-row ${it.selected?'selected':''}">
          <div class="etiq-check ${it.selected?'on':''}" onclick="app.etiquettes.toggleItem(${idx})">
            <i class="fas fa-check" style="${it.selected?'':'opacity:0'}"></i>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:900;font-size:14px;">${it.name}</div>
            <div class="small">${it.fam} • x${it.qty} • DLC: ${new Date(it.date).toLocaleDateString('fr')}</div>
          </div>
        </div>
      `).join('');
      document.getElementById('etiq-config-card').style.display='block';
      this.renderConfigSection();
    },

    toggleItem(idx){this._items[idx].selected=!this._items[idx].selected;this.renderProductList();},

    renderConfigSection(){
      const wrap=document.getElementById('etiq-items-config');if(!wrap)return;
      const selected=this._items.filter(it=>it.selected);
      if(!selected.length){wrap.innerHTML=`<div class="small" style="text-align:center;padding:10px;color:var(--muted);">Sélectionnez des produits ci-dessus</div>`;return;}
      wrap.innerHTML=selected.map(it=>{
        const realIdx=this._items.indexOf(it);
        const prixOrig=parseFloat(it.price||0);
        const prixReduit=it.price?(prixOrig*(1-it.pct/100)).toFixed(2):'';
        return`<div style="background:#faf5ff;border-radius:14px;padding:14px;margin-bottom:12px;border:2px solid #e9d5ff;">
          <div style="font-weight:950;font-size:15px;color:#9333ea;margin-bottom:10px;"><i class="fas fa-tag"></i> ${it.name}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
            <div>
              <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">Prix original (€)</label>
              <input type="number" step="0.01" min="0" placeholder="Ex: 4.90" value="${it.price}" oninput="app.etiquettes.setPrice(${realIdx},this.value)" style="margin:0;padding:10px;border-radius:8px;border:1.5px solid #d8b4fe;font-size:14px;">
            </div>
            <div>
              <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">Réduction %</label>
              <input type="number" min="1" max="99" value="${it.pct}" oninput="app.etiquettes.setPct(${realIdx},this.value)" style="margin:0;padding:10px;border-radius:8px;border:1.5px solid #d8b4fe;font-size:14px;">
            </div>
          </div>
          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:800;color:#6b21a8;display:block;margin-bottom:4px;">Nb d'étiquettes à imprimer</label>
            <div class="etiq-qty-ctrl">
              <button onclick="app.etiquettes.setPrintQty(${realIdx},${it.printQty-1})">−</button>
              <span style="font-weight:950;font-size:20px;min-width:36px;text-align:center;">${it.printQty}</span>
              <button onclick="app.etiquettes.setPrintQty(${realIdx},${it.printQty+1})">+</button>
              <span class="small" style="margin-left:4px;">/ 50 max</span>
            </div>
          </div>
          ${it.price?`<div class="etiq-label-preview">
            <div class="etiq-name">${it.name}</div>
            <div class="etiq-prix-original">${prixOrig.toFixed(2)} €</div>
            <div class="etiq-prix-reduit">${prixReduit} €</div>
            <div class="etiq-pct">-${it.pct}%</div>
            <div style="font-size:11px;margin-top:6px;opacity:.85;">DLC: ${new Date(it.date).toLocaleDateString('fr')} • TOO GOOD TO GO • ${it.printQty} étiquette(s)</div>
          </div>`:`<div class="small" style="text-align:center;color:#9333ea;opacity:.6;padding:8px;">Entrez un prix pour voir l'aperçu</div>`}
        </div>`;
      }).join('');
    },

    setPrice(idx,v){this._items[idx].price=v;this.renderConfigSection();},
    setPct(idx,v){this._items[idx].pct=Math.max(1,Math.min(99,parseInt(v)||50));this.renderConfigSection();},
    setPrintQty(idx,v){this._items[idx].printQty=Math.max(1,Math.min(50,parseInt(v)||1));this.renderConfigSection();},

    buildZpl(it){
      const prixOrig=parseFloat(it.price||0).toFixed(2);
      const prixReduit=(parseFloat(it.price||0)*(1-it.pct/100)).toFixed(2);
      const dlcStr=new Date(it.date).toLocaleDateString('fr');
      const nameLine1=(it.name||'').substring(0,22);
      const nameLine2=(it.name||'').length>22?(it.name||'').substring(22,44):'';
      // ZPL for Brother TD-2120N 62mm width, 203dpi
      return `^XA^MMT
^PW480
^LL320
^CF0,30^FO15,10^FD${nameLine1}^FS
${nameLine2?`^CF0,30^FO15,45^FD${nameLine2}^FS`:''}
^FO15,${nameLine2?85:55}^GB450,3,3^FS
^CF0,60^FO15,${nameLine2?95:65}^FD${prixReduit} EUR^FS
^CF0,22^FO250,${nameLine2?105:75}^FDau lieu de ${prixOrig} EUR^FS
^FO15,${nameLine2?160:130}^GB450,3,3^FS
^CF0,48^FO15,${nameLine2?170:140}^FD-${it.pct}%^FS
^CF0,22^FO110,${nameLine2?183:153}^FDTOO GOOD TO GO^FS
^CF0,18^FO15,${nameLine2?225:195}^FDDLC: ${dlcStr}^FS
^XZ`;
    },

    printAll:async function(){
      const toprint=this._items.filter(it=>it.selected&&it.price&&parseFloat(it.price)>0);
      if(!toprint.length)return toast('Sélectionnez des produits avec un prix valide.','warn');
      const ip=(document.getElementById('etiq-printer-ip')?.value||'').trim();
      const port=parseInt(document.getElementById('etiq-printer-port')?.value||'9100');
      let allZpl='';
      toprint.forEach(it=>{for(let i=0;i<it.printQty;i++)allZpl+=this.buildZpl(it)+'\n';});
      const totalLabels=toprint.reduce((s,it)=>s+it.printQty,0);

      if(!ip){
        toast(`Pas d'IP configurée — téléchargement ZPL (${totalLabels} étiquettes).`,'warn',5000);
        this._downloadZpl(allZpl,totalLabels);return;
      }
      toast(`Envoi de ${totalLabels} étiquette(s) vers ${ip}:${port}…`,'info',3000);
      try{
        const resp=await fetch(`http://${ip}/print`,{method:'POST',headers:{'Content-Type':'text/plain','Accept':'*/*'},body:allZpl,signal:AbortSignal.timeout(10000)});
        if(resp.ok){toast(`✓ ${totalLabels} étiquette(s) imprimée(s) !`,'ok',4000);}
        else{throw new Error('HTTP '+resp.status);}
      }catch(e){
        toast('Connexion imprimante échouée — téléchargement ZPL.','warn',4000);
        this._downloadZpl(allZpl,totalLabels);
      }
    },

    _downloadZpl(zpl,n){
      const blob=new Blob([zpl],{type:'application/octet-stream'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`etiquettes_${n}x.zpl`;a.click();URL.revokeObjectURL(url);
    },

    testPrinter:async function(){
      const ip=(document.getElementById('etiq-printer-ip')?.value||'').trim();
      if(!ip)return toast('Entrez l\'IP de l\'imprimante.','warn');
      const port=parseInt(document.getElementById('etiq-printer-port')?.value||'9100');
      const status=document.getElementById('etiq-printer-status');
      status.textContent='Test en cours…';status.style.color='#f59e0b';
      try{
        const r=await fetch(`http://${ip}/`,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(4000)});
        status.textContent=`✓ Imprimante accessible — ${ip}:${port}`;status.style.color='#10b981';
        toast('Imprimante accessible !','ok');
      }catch(e){
        status.textContent=`✗ Non accessible — vérifiez IP et réseau`;status.style.color='#ef4444';
        toast('Imprimante non accessible. Vérifiez l\'IP et le réseau Wi-Fi.','warn',5000);
      }
    }
  },

  // ══════════════════════════════════════════════════
  // ── METI PORTAL MODULE ──
  // ══════════════════════════════════════════════════
  metiPortal:{
    _url:'https://vpnportal.carrefour.com/dana/user/#',
    open(){
      const el=document.getElementById('meti-overlay');
      if(el)el.style.display='flex';
    },
    close(){
      const el=document.getElementById('meti-overlay');
      if(el)el.style.display='none';
    },
    openExternal(){
      window.open(this._url,'_blank','noopener');
    }
  },

  // ══════════════════════════════════════════════════
  // ── MYTRAVIS MODULE ──
  // ══════════════════════════════════════════════════
  mytravis:{
    _url:'https://mytravis.fr.carrefour.com/mytravis',
    _id:'jonathan_araujo_4@franchise.carrefour.com',
    _pwd:'KzD?VB&6bNnS5.3',
    open(){
      const el=document.getElementById('mytravis-overlay');
      if(el){el.style.display='flex';}
      // Try to load in iframe
      const frame=document.getElementById('mytravis-iframe');
      if(frame&&frame.src==='about:blank'){
        try{navigator.clipboard.writeText(this._id+'\n'+this._pwd);}catch(e){}
        frame.src=this._url;
        toast('Identifiants copiés dans le presse-papier','info',3000);
      }
    },
    close(){
      const el=document.getElementById('mytravis-overlay');
      if(el)el.style.display='none';
      const frame=document.getElementById('mytravis-iframe');
      if(frame)frame.src='about:blank';
    },
    openExternal(){
      try{navigator.clipboard.writeText(this._id+'\n'+this._pwd);}catch(e){}
      window.open(this._url,'_blank','noopener');
      toast('Identifiants copiés ! Collez-les sur la page de connexion.','ok',4000);
    }
  },

  // ══════════════════════════════════════════════════
  // ── TOO GOOD TO GO PORTAL ──
  // ══════════════════════════════════════════════════
  tgtgPortal:{
    _url:'https://store.toogoodtogo.com/stores',
    _id:'jonathan_araujo_4@franchise.carrefour.com',
    _pwd:'KzD?VB&6bNnS5.3',
    open(){
      try{navigator.clipboard.writeText(this._id+'\n'+this._pwd);}catch(e){}
      window.open(this._url,'_blank','noopener');
      toast('Identifiants copiés ! Utilisez-les sur la page Too Good To Go.','ok',4000);
    }
  },

  // ══════════════════════════════════════════════════
  // ── PLANNING RH MODULE ──
  // ══════════════════════════════════════════════════
  planning:{
    _weekOffset:0,
    _employees:[],

    init(){
      if(!this._employees.length){
        // Load from localStorage if available
        try{const s=JSON.parse(localStorage.getItem('planning_employees')||'[]');if(s.length)this._employees=s;}catch(e){}
      }
    },

    save(){try{localStorage.setItem('planning_employees',JSON.stringify(this._employees));}catch(e){}},

    getWeekDates(){
      const now=new Date();
      const day=now.getDay();
      const mondayOffset=day===0?-6:1-day;
      const monday=new Date(now);
      monday.setDate(now.getDate()+mondayOffset+this._weekOffset*7);
      monday.setHours(0,0,0,0);
      const dates=[];
      for(let i=0;i<7;i++){const d=new Date(monday);d.setDate(monday.getDate()+i);dates.push(d);}
      return dates;
    },

    prevWeek(){this._weekOffset--;this.render();},
    nextWeek(){this._weekOffset++;this.render();},

    addEmployee:async function(){
      const name=await dlgPrompt('Nom de l\'employé :');
      if(!name||!name.trim())return;
      const id=Date.now();
      const days={L:null,M:null,MM:null,J:null,V:null,S:null,D:null};
      this._employees.push({id,name:name.trim().toUpperCase(),schedule:{}});
      this.save();
      this.render();
    },

    // Validate RH rules for an employee
    validateSchedule(emp){
      const days=this.getWeekDates();
      const dayLabels=['L','M','MM','J','V','S','D'];
      const warnings=[];
      let totalHours=0;
      let restDays=0;

      days.forEach((date,i)=>{
        const key=date.toISOString().slice(0,10);
        const shift=emp.schedule[key];
        if(!shift||shift.type==='rest'){restDays++;return;}
        if(shift.start&&shift.end){
          const [sh,sm]=shift.start.split(':').map(Number);
          const [eh,em]=shift.end.split(':').map(Number);
          let h=(eh*60+em-sh*60-sm)/60;
          if(h<0)h+=24;
          if(h>10)warnings.push(`${dayLabels[i]}: journée > 10h (${h.toFixed(1)}h)`);
          totalHours+=h;
        }
      });

      if(restDays<2)warnings.push(`Repos insuffisants: ${restDays} jour(s) (min. 2)`);
      if(totalHours>48)warnings.push(`Semaine > 48h (${totalHours.toFixed(1)}h)`);

      return{totalHours,restDays,warnings};
    },

    render(){
      this.init();
      const dates=this.getWeekDates();
      const labelEl=document.getElementById('plan-week-label');
      if(labelEl){
        const opts={day:'2-digit',month:'2-digit'};
        labelEl.textContent=`${dates[0].toLocaleDateString('fr',opts)} – ${dates[6].toLocaleDateString('fr',opts)}`;
      }

      const wrap=document.getElementById('plan-employees');
      if(!wrap)return;
      const DAY_NAMES=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
      const today=new Date().toISOString().slice(0,10);

      if(!this._employees.length){
        wrap.innerHTML=`<div class="empty-state"><i class="fas fa-users"></i><br>Aucun employé. Ajoutez-en un pour commencer.</div>`;
        document.getElementById('plan-summary').style.display='none';
        return;
      }

      // Header row with day names (Skello style)
      const headerHtml=`<div style="display:grid;grid-template-columns:120px repeat(7,1fr);gap:4px;margin-bottom:6px;padding:0 2px;">
        <div></div>
        ${dates.map((d,i)=>{
          const isToday=d.toISOString().slice(0,10)===today;
          return`<div style="text-align:center;padding:6px 2px;border-radius:8px;background:${isToday?'#003896':'#f1f5f9'};color:${isToday?'#fff':'#64748b'};">
            <div style="font-size:11px;font-weight:950;">${DAY_NAMES[i]}</div>
            <div style="font-size:13px;font-weight:950;">${d.getDate()}</div>
          </div>`;
        }).join('')}
      </div>`;

      const rowsHtml=this._employees.map(emp=>{
        const {totalHours,restDays,warnings}=this.validateSchedule(emp);
        const hasWarn=warnings.length>0;
        const cellsHtml=dates.map(date=>{
          const key=date.toISOString().slice(0,10);
          const shift=emp.schedule[key]||{type:'rest'};
          const isRest=!shift||shift.type==='rest';
          const isToday=key===today;
          if(isRest){
            return`<div onclick="app.planning.editShift('${emp.id}','${key}','${date.toLocaleDateString('fr')}')"
              style="text-align:center;cursor:pointer;min-height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1.5px dashed ${isToday?'#bfdbfe':'#e2e8f0'};background:${isToday?'#eff6ff':'#f8fafc'};">
              <i class="fas fa-moon" style="color:#cbd5e1;font-size:14px;"></i>
            </div>`;
          }
          const h=(()=>{const[sh,sm]=shift.start.split(':').map(Number);const[eh,em]=shift.end.split(':').map(Number);let v=(eh*60+em-sh*60-sm)/60;if(v<0)v+=24;return v;})();
          const col=h>9?'#fee2e2':h>7?'#dbeafe':'#d1fae5';
          const tc=h>9?'#991b1b':h>7?'#1e40af':'#065f46';
          return`<div onclick="app.planning.editShift('${emp.id}','${key}','${date.toLocaleDateString('fr')}')"
            style="text-align:center;cursor:pointer;min-height:50px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:${col};border:1.5px solid ${tc}20;">
            <div style="font-size:10px;font-weight:950;color:${tc};">${shift.start||'?'}</div>
            <div style="font-size:9px;color:${tc};opacity:.7;">${h.toFixed(1)}h</div>
            <div style="font-size:10px;font-weight:950;color:${tc};">${shift.end||'?'}</div>
          </div>`;
        }).join('');
        return`<div style="display:grid;grid-template-columns:120px repeat(7,1fr);gap:4px;margin-bottom:6px;padding:0 2px;">
          <div style="display:flex;align-items:center;gap:8px;padding:0 4px;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#003896,#1a50c8);color:#fff;font-weight:950;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">${(emp.name||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2)}</div>
            <div style="min-width:0;">
              <div style="font-weight:950;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${emp.name||'?'}</div>
              <div style="display:flex;gap:4px;">
                <span style="font-size:10px;font-weight:900;color:#0891b2;">${totalHours.toFixed(0)}h</span>
                <span style="font-size:10px;font-weight:900;background:${restDays>=2?'#d1fae5':'#fee2e2'};color:${restDays>=2?'#065f46':'#991b1b'};border-radius:4px;padding:0 4px;">${restDays}R</span>
                ${hasWarn?'<i class="fas fa-triangle-exclamation" style="color:#f59e0b;font-size:10px;margin-top:1px;"></i>':''}
              </div>
            </div>
          </div>
          ${cellsHtml}
        </div>
        ${hasWarn?`<div style="background:#fef3c7;border-left:4px solid #f59e0b;border-radius:8px;padding:6px 10px;margin:-2px 2px 6px 2px;font-size:11px;color:#92400e;"><i class="fas fa-triangle-exclamation"></i> ${warnings.join(' • ')}</div>`:''}`;
      }).join('');

      wrap.innerHTML=headerHtml+rowsHtml;

      // Summary
      const summaryEl=document.getElementById('plan-summary');
      const summaryContent=document.getElementById('plan-summary-content');
      if(summaryEl&&summaryContent&&this._employees.length){
        summaryEl.style.display='block';
        const totalWeekHours=this._employees.reduce((s,e)=>s+this.validateSchedule(e).totalHours,0);
        const workersDays=this._employees.flatMap(e=>dates.map(d=>{const k=d.toISOString().slice(0,10);const s=e.schedule[k];return s&&s.type!=='rest'?1:0;})).reduce((a,b)=>a+b,0);
        summaryContent.innerHTML=`
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
            <div style="background:#eff6ff;border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:20px;font-weight:950;color:#0891b2;">${this._employees.length}</div>
              <div style="font-size:11px;color:#64748b;">Employés</div>
            </div>
            <div style="background:#f0fdf4;border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:20px;font-weight:950;color:#059669;">${totalWeekHours.toFixed(0)}h</div>
              <div style="font-size:11px;color:#64748b;">Total semaine</div>
            </div>
            <div style="background:#fdf4ff;border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:20px;font-weight:950;color:#7c3aed;">${workersDays}</div>
              <div style="font-size:11px;color:#64748b;">Présences</div>
            </div>
          </div>`;
      }
    },

    editShift:async function(empId,dateKey,dateLabel){
      const emp=this._employees.find(e=>String(e.id)===String(empId));if(!emp)return;
      const shift=emp.schedule[dateKey]||{type:'rest'};
      const isRest=!shift||shift.type==='rest';

      const choice=await dlgConfirm(
        `${emp.name} — ${dateLabel}`,
        isRest?'Ce jour est un repos. Définir un horaire ?':'Supprimer ce créneau (→ repos) ?',
        false
      );
      if(!choice)return;

      if(isRest){
        // Set a shift
        const start=await dlgPrompt('Heure de début (HH:MM):','09:00');
        if(!start)return;
        const end=await dlgPrompt('Heure de fin (HH:MM):','17:00');
        if(!end)return;
        emp.schedule[dateKey]={type:'work',start:start.trim(),end:end.trim()};
      }else{
        emp.schedule[dateKey]={type:'rest'};
      }
      this.save();
      this.render();
    },

    removeEmployee:async function(empId){
      const ok=await dlgConfirm('Supprimer cet employé ?','Cette action supprime l\'employé et son planning.',true);
      if(!ok)return;
      this._employees=this._employees.filter(e=>String(e.id)!==String(empId));
      this.save();
      this.render();
    },

    exportCSV(){
      const dates=this.getWeekDates();
      const dayNames=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
      const header=['Employé',...dates.map((d,i)=>`${dayNames[i]} ${d.toLocaleDateString('fr')}`), 'Total heures'];
      const rows=[header];
      this._employees.forEach(emp=>{
        const {totalHours}=this.validateSchedule(emp);
        const row=[emp.name,...dates.map(d=>{
          const key=d.toISOString().slice(0,10);
          const s=emp.schedule[key]||{type:'rest'};
          return s.type==='rest'?'Repos':`${s.start||'?'}-${s.end||'?'}`;
        }),totalHours.toFixed(1)+'h'];
        rows.push(row);
      });
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='planning.csv';a.click();URL.revokeObjectURL(url);
      toast('Planning exporté en CSV','ok');
    }
  },



  // ══════════════════════════════════════════════════
  // ── HOME MODULE REORDER (drag-and-drop touch+mouse) ──
  // ══════════════════════════════════════════════════
  homeOrder:{
    _editing:false,
    _drag:null, // {el, startX, startY, origIdx, clone, lastTarget}

    startEdit(){
      this._editing=true;
      const bar=document.getElementById('home-edit-bar');
      const reorgBtn=document.getElementById('home-reorder-btn');
      if(bar)bar.style.display='block';
      if(reorgBtn)reorgBtn.style.display='none';
      const grid=document.getElementById('home-grid');
      if(!grid)return;
      // Add visual cues to every module button
      grid.querySelectorAll('.home-btn').forEach(btn=>{
        btn.classList.add('reorder-mode');
        // Add grip icon if not already there
        if(!btn.querySelector('.grip-icon')){
          const g=document.createElement('div');
          g.className='grip-icon';
          g.innerHTML='<i class="fas fa-grip-vertical"></i>';
          btn.prepend(g);
        }
        // Wire drag events
        btn.addEventListener('touchstart',this._onTouchStart.bind(this),{passive:false});
        btn.addEventListener('mousedown',this._onMouseDown.bind(this));
      });
    },

    stopEdit(){
      this._editing=false;
      const bar=document.getElementById('home-edit-bar');
      const reorgBtn=document.getElementById('home-reorder-btn');
      if(bar)bar.style.display='none';
      if(reorgBtn)reorgBtn.style.display='flex';
      const grid=document.getElementById('home-grid');
      if(!grid)return;
      grid.querySelectorAll('.home-btn').forEach(btn=>{
        btn.classList.remove('reorder-mode','drag-over');
        btn.querySelectorAll('.grip-icon').forEach(e=>e.remove());
        // Remove event listeners by cloning
        const newBtn=btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn,btn);
      });
      this._saveOrder();
      toast('✓ Ordre enregistré','ok',2000);
    },

    _saveOrder(){
      try{
        const ids=Array.from(document.querySelectorAll('#home-grid .home-btn')).map(b=>b.dataset.mid||b.textContent.trim().slice(0,20));
        localStorage.setItem('home_order',JSON.stringify(ids));
      }catch(e){}
    },

    _getPos(e){
      const t=e.touches?e.touches[0]:e;
      return{x:t.clientX,y:t.clientY};
    },

    _onTouchStart(e){
      if(!this._editing)return;
      e.preventDefault();
      const btn=e.currentTarget;
      this._startDrag(btn,e.touches[0].clientX,e.touches[0].clientY);
      const move=ev=>{ev.preventDefault();this._moveDrag(ev.touches[0].clientX,ev.touches[0].clientY);};
      const end=()=>{this._endDrag();document.removeEventListener('touchmove',move);document.removeEventListener('touchend',end);};
      document.addEventListener('touchmove',move,{passive:false});
      document.addEventListener('touchend',end);
    },

    _onMouseDown(e){
      if(!this._editing)return;
      this._startDrag(e.currentTarget,e.clientX,e.clientY);
      const move=ev=>this._moveDrag(ev.clientX,ev.clientY);
      const end=()=>{this._endDrag();document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',end);};
      document.addEventListener('mousemove',move);
      document.addEventListener('mouseup',end);
    },

    _startDrag(btn,x,y){
      btn.classList.add('dragging');
      // Create ghost clone
      const r=btn.getBoundingClientRect();
      const clone=btn.cloneNode(true);
      clone.style.cssText=`position:fixed;left:${r.left}px;top:${r.top}px;width:${r.width}px;height:${r.height}px;opacity:.85;pointer-events:none;z-index:99999;transform:scale(1.04);box-shadow:0 12px 40px rgba(0,0,0,.3);transition:none;border-radius:18px;`;
      document.body.appendChild(clone);
      btn.style.opacity='.3';
      this._drag={el:btn,x,y,ox:r.left,oy:r.top,clone,lastTarget:null};
    },

    _moveDrag(x,y){
      if(!this._drag)return;
      const d=this._drag;
      const dx=x-d.x, dy=y-d.y;
      d.clone.style.left=(parseFloat(d.clone.style.left)+dx)+'px';
      d.clone.style.top=(parseFloat(d.clone.style.top)+dy)+'px';
      d.x=x; d.y=y;
      // Find element under pointer
      d.clone.style.display='none';
      const under=document.elementFromPoint(x,y);
      d.clone.style.display='';
      const target=under&&under.closest('.home-btn');
      if(target&&target!==d.el&&target!==d.lastTarget){
        const grid=document.getElementById('home-grid');
        const btns=Array.from(grid.querySelectorAll('.home-btn'));
        const fromIdx=btns.indexOf(d.el);
        const toIdx=btns.indexOf(target);
        if(fromIdx>-1&&toIdx>-1){
          if(fromIdx<toIdx)grid.insertBefore(d.el,target.nextSibling);
          else grid.insertBefore(d.el,target);
        }
        d.lastTarget=target;
      }
    },

    _endDrag(){
      if(!this._drag)return;
      const{el,clone}=this._drag;
      el.style.opacity='';
      el.classList.remove('dragging');
      clone.remove();
      this._drag=null;
    }
  },

  // ══════════════════════════════════════════════════
  // ── ALERT NET MODULE ──
  // ══════════════════════════════════════════════════
  alertNet:{
    _url:'https://alertnet.carrefour.com/carrefour/users/login',
    _id:'m31555BF',
    _pwd:'P16P2!',
    open(){
      // Copy credentials to clipboard
      try{navigator.clipboard.writeText(this._id+':'+this._pwd);}catch(e){}
      // Open overlay with login helper
      const ov=document.getElementById('alertnet-overlay');
      if(ov){ov.style.display='flex';}
      toast('Identifiants copiés — '+this._id,'info',3000);
    },
    close(){
      const ov=document.getElementById('alertnet-overlay');
      if(ov)ov.style.display='none';
      const fr=document.getElementById('alertnet-iframe');
      if(fr)fr.src='about:blank';
    },
    openExternal(){
      try{navigator.clipboard.writeText(this._id+'\n'+this._pwd);}catch(e){}
      window.open(this._url,'_blank','noopener');
      toast('Identifiants copiés ! Collez-les sur Alert Net.','ok',4000);
    }
  },

  // ══════════════════════════════════════════════════
  // ── CHAT MODULE ──
  // ══════════════════════════════════════════════════
  chat:{
    _channel:'general',
    _unsubscribe:null,
    _channels:[
      {id:'general',   name:'# général',       icon:'fa-hashtag',  color:'#003896'},
      {id:'dlc',       name:'# dates courtes',  icon:'fa-calendar-xmark', color:'#dc2626'},
      {id:'reception', name:'# réception',      icon:'fa-truck-ramp-box', color:'#059669'},
      {id:'planning',  name:'# planning',       icon:'fa-calendar-days',  color:'#0891b2'},
      {id:'direction', name:'🔒 direction',     icon:'fa-lock',     color:'#7c3aed', adminOnly:true},
    ],

    render(){
      const wrap=document.getElementById('chat-channel-list');
      const msgWrap=document.getElementById('chat-messages');
      if(!wrap||!msgWrap)return;

      // Render channel list
      const me=window.app.me||{};
      const channels=this._channels.filter(c=>!c.adminOnly||(me.role==='admin'));
      wrap.innerHTML=channels.map(c=>`
        <div class="chat-channel-btn ${this._channel===c.id?'active':''}" onclick="app.chat.selectChannel('${c.id}')">
          <i class="fas ${c.icon}" style="color:${c.color};margin-right:8px;"></i>
          <span>${c.name}</span>
        </div>`).join('');

      this.loadMessages();
    },

    selectChannel(id){
      this._channel=id;
      if(this._unsubscribe){try{this._unsubscribe();}catch(e){}}
      this.render();
    },

    loadMessages(){
      const wrap=document.getElementById('chat-messages');
      if(!wrap)return;
      wrap.innerHTML='<div style="text-align:center;padding:20px;color:#94a3b8;font-size:14px;"><i class="fas fa-spinner fa-spin"></i> Chargement…</div>';

      try{
        const{collection,query,orderBy,limit,onSnapshot,addDoc,serverTimestamp}=window._fbChat;
        const colRef=collection(window._db,'chat_'+this._channel);
        const q=query(colRef,orderBy('ts','desc'),limit(50));
        this._unsubscribe=onSnapshot(q,snap=>{
          const msgs=[];snap.forEach(d=>msgs.push({id:d.id,...d.data()}));
          msgs.reverse();
          this._renderMessages(msgs);
          this._updateBadges(0);
        },()=>{wrap.innerHTML='<div style="text-align:center;padding:20px;color:#94a3b8;">Chargement impossible.</div>';});
      }catch(e){
        wrap.innerHTML='<div style="text-align:center;padding:20px;color:#94a3b8;">Firebase non disponible.</div>';
      }
    },

    _renderMessages(msgs){
      const wrap=document.getElementById('chat-messages');
      if(!wrap)return;
      const me=window.app.me||{};
      if(!msgs.length){
        wrap.innerHTML='<div style="text-align:center;padding:30px;color:#94a3b8;"><i class="fas fa-comment-slash" style="font-size:30px;margin-bottom:8px;display:block;opacity:.3;"></i>Aucun message dans ce canal.</div>';
        return;
      }
      wrap.innerHTML=msgs.map(m=>{
        const isMe=m.userId===me.uid;
        const ts=m.ts?new Date(m.ts.toMillis?m.ts.toMillis():(m.ts||0)):new Date();
        const timeStr=ts.toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'});
        const dateStr=ts.toLocaleDateString('fr',{day:'numeric',month:'short'});
        const initials=(m.userName||'?').split(' ').map(x=>x[0]||'').join('').toUpperCase().slice(0,2);
        return`<div class="chat-msg-wrap ${isMe?'me':''}">
          ${!isMe?`<div class="chat-avatar">${initials}</div>`:''}
          <div class="chat-bubble ${isMe?'me':'other'}">
            ${!isMe?`<div class="chat-sender">${m.userName||'?'}</div>`:''}
            <div class="chat-text">${(m.text||'').replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>
            <div class="chat-time">${dateStr} ${timeStr}</div>
          </div>
          ${isMe?`<div class="chat-avatar me">${initials}</div>`:''}
        </div>`;
      }).join('');
      // Scroll to bottom
      wrap.scrollTop=wrap.scrollHeight;
    },

    send:async function(){
      const inp=document.getElementById('chat-input');
      const text=(inp?.value||'').trim();
      if(!text)return;
      const me=window.app.me;
      if(!me)return toast('Connexion requise.','err');
      inp.value='';
      try{
        const{collection,addDoc,serverTimestamp}=window._fbChat;
        await addDoc(collection(window._db,'chat_'+this._channel),{
          text,
          userId:me.uid,
          userName:me.name||me.email||'USER',
          ts:serverTimestamp(),
          channel:this._channel
        });
      }catch(e){toast('Erreur envoi message.','err');inp.value=text;}
    },

    sendOnEnter(e){if((e.key==='Enter')&&!e.shiftKey){e.preventDefault();this.send();}},

    _updateBadges(unread){
      const b=document.getElementById('badge-chat-gm');
      if(b){b.textContent=unread+' nouveau(x)';b.style.display=unread>0?'inline-block':'none';}
    }
  },

  // ══════════════════════════════════════════════════
  // ── PWA INSTALL PROMPT ──
  // ══════════════════════════════════════════════════
  _deferredInstallPrompt:null,

  _initInstallPrompt(){
    window.addEventListener('beforeinstallprompt',e=>{
      e.preventDefault();
      this._deferredInstallPrompt=e;
      // Show install banner
      setTimeout(()=>this._maybeShowInstallPrompt(),2000);
    });
    window.addEventListener('appinstalled',()=>{
      const b=document.getElementById('pwa-install-banner');
      if(b)b.style.display='none';
      toast('✓ Application installée avec succès !','ok',4000);
    });
  },

  _maybeShowInstallPrompt(){
    if(!this._deferredInstallPrompt)return;
    // Check if already installed
    if(window.matchMedia('(display-mode: fullscreen)').matches||
       window.matchMedia('(display-mode: standalone)').matches)return;
    const b=document.getElementById('pwa-install-banner');
    if(b)b.style.display='flex';
  },

  installPWA:async function(){
    const b=document.getElementById('pwa-install-banner');
    if(!this._deferredInstallPrompt){
      toast('Pour ajouter : utilisez le menu partage de votre navigateur → "Sur l\'écran d\'accueil".','info',6000);
      return;
    }
    this._deferredInstallPrompt.prompt();
    const{outcome}=await this._deferredInstallPrompt.userChoice;
    this._deferredInstallPrompt=null;
    if(b)b.style.display='none';
  }

};
globalThis.app = window.app;
window.app.initOffline();
window.app._initInstallPrompt();

// Wire photo inputs
document.getElementById('cam-input').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{document.getElementById('img-preview').src=b64;document.getElementById('img-preview').style.display='block';document.getElementById('lib-img-data').value=b64;});});
document.getElementById('trace-file').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;window.app.common.compressImg(f,b64=>{window.app.trace.imgData=b64;document.getElementById('trace-preview').src=b64;document.getElementById('trace-preview').style.display='block';});});

// Auth state
onAuthStateChanged(auth,async user=>{
  if(!user){
    document.getElementById('login-overlay').classList.remove('hidden');
    document.getElementById('app-header').classList.add('hidden');
    document.getElementById('app-nav').classList.add('hidden');
    window.app.me=null;
    window.app.data={frais:[],users:[],pvpLib:[],pvpStock:[],checkedNeeds:[],saladLib:[],saladStock:[],frigo:{perDay:2,fridges:[],logs:[]},todo:{zones:[],tasks:[]},todoLogs:[],reception:[]};
    return;
  }
  await window.app.afterLoginBootstrap();
});
</script>
<!-- BOUTON FLOTTANT RÉORGANISER (admin seulement) -->
<button id="home-reorder-btn" title="Réorganiser les modules" onclick="app.homeOrder.startEdit()">
  <i class="fas fa-grip-vertical"></i>
</button>
</body>
</html>
